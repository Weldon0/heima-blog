# ğŸ“šæå®¢å›­M-4ã€ä¸ªäººä¸­å¿ƒã€‘

## 01-é¡µé¢ç»“æ„

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ ¹æ®æ¨¡æ¿æ­å»ºä¸ªäººä¸­å¿ƒé¡µé¢ç»“æ„

**æ­¥éª¤**ï¼š

1. æ ¹æ®æ¨¡æ¿ä¿®æ”¹ Profile é¡µé¢ç»“æ„

## 02-è·å–ç”¨æˆ·ä¿¡æ¯å¹¶å±•ç¤º

è¯¥åŠŸèƒ½åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥æ¥å®ç°ï¼š

1. å‘é€è¯·æ±‚è·å–ç”¨æˆ·ä¿¡æ¯
2. é¡µé¢åˆ†å‘è·å–ç”¨æˆ·ä¿¡æ¯çš„ action
3. å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ° redux ä¸­
4. è·å–ç”¨æˆ·ä¿¡æ¯å¹¶å±•ç¤º

## 03-ç”¨æˆ·ä¿¡æ¯-å‘é€è¯·æ±‚è·å–æ•°æ®

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå‘é€è¯·æ±‚è·å–ç”¨æˆ·ä¿¡æ¯

**æ­¥éª¤**ï¼š

1. æ ¹æ®æ¥å£å‡†å¤‡æ‰€éœ€ç±»å‹
2. åˆ›å»º actions/profile.ts æ–‡ä»¶
3. åˆ›å»ºè·å–ç”¨æˆ·ä¿¡æ¯çš„ action

**æ ¸å¿ƒä»£ç **ï¼š

types/data.d.ts ä¸­ï¼š

```ts
// æˆ‘çš„ - ä¸ªäººä¿¡æ¯
export type User = {
  id: string;
  name: string;
  photo: string;
  art_count: number;
  follow_count: number;
  fans_count: number;
  like_count: number;
};
```

actions/profile.ts ä¸­ï¼š

```ts
import { http } from '@/utils';
import type { RootThunkAction } from '@/types/store';
import type { User } from '@/types/data';


type UserResponse = {
  message: string;
  data: User;
};


// æˆ‘çš„é¡µé¢ - è·å–ä¸ªäººä¿¡æ¯
export const getUser = (): RootThunkAction => {
  return async (dispatch) => {
    const res = await http.get<UserResponse>('/user');
    console.log(res);
  };
};
```

## 04-ç”¨æˆ·ä¿¡æ¯-ç»„ä»¶åˆ†å‘ action

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåœ¨æˆ‘çš„é¡µé¢ä¸­åˆ†å‘è·å–ç”¨æˆ·ä¿¡æ¯çš„ action

**æ ¸å¿ƒä»£ç **ï¼š

Profile/index.tsx ä¸­ï¼š

```tsx
import { useEffect } from 'react';
import { useDispatch } from 'react-redux';
import { getUser } from '@/store/actions';


const Profile = () => {
  const dispatch = useDispatch();


  useEffect(() => {
    dispatch(getUser());
  }, [dispatch]);


  // ...
};
```

## 05-ç”¨æˆ·ä¿¡æ¯-å­˜å‚¨åˆ° redux

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° redux ä¸­

**æ­¥éª¤**ï¼š

1. å‡†å¤‡ä¿å­˜çŠ¶æ€åˆ° redux çš„ action ç±»å‹
2. åœ¨è·å–ä¸ªäººä¿¡æ¯çš„ action ä¸­å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ° redux ä¸­
3. åˆ›å»º reducers/profile.tsï¼Œå¹¶å®Œæˆå­˜å‚¨ç”¨æˆ·ä¿¡æ¯çš„åŠŸèƒ½
4. åœ¨ reducers/index.ts ä¸­ï¼Œå°† profile åˆå¹¶åˆ°æ ¹ reducer ä¸­

**æ ¸å¿ƒä»£ç **ï¼š

types/store.d.ts ä¸­ï¼š

```ts
import type { User } from '../data';


// å°† ProfileAction è”åˆåˆ° redux action ç±»å‹ä¸­
type RootAction = LoginAction | ProfileAction;


export type ProfileAction = {
  type: 'profile/getUser';
  payload: User;
};
```

actions/profile.ts ä¸­ï¼š

```ts
export const getUser = (): RootThunkAction => {
  return async (dispatch) => {
    const res = await http.get<UserResponse>('/user');
    const { data, message } = res.data;


    // å­˜å‚¨ redux ä¸­
    // å› ä¸ºå·²ç»æœ‰ TS ç±»å‹ï¼Œæ‰€ä»¥ï¼Œæ­¤å¤„ä»£ç éƒ½æ˜¯æœ‰æç¤ºçš„
    dispatch({ type: 'profile/getUser', payload: data });
  };
};
```

reducers/profile.ts ä¸­ï¼š

```ts
import type { User } from '@/types/data';
import type { ProfileAction } from '@/types/store';
type ProfileState = {
  user: User;
};


const initialState = {
  user: {},
} as ProfileState;


const profile = (state = initialState, action: ProfileAction): ProfileState => {
  switch (action.type) {
    case 'profile/getUser':
      return {
        ...state,
        user: action.payload,
      };
    default:
      return state;
  }
};


export default profile;
```

reducers/index.ts ä¸­ï¼š

```ts
import profile from './profile';


const rootReducer = combineReducers({
  // ...
  profile,
});
```

## 06-ç”¨æˆ·ä¿¡æ¯-å±•ç¤ºç”¨æˆ·ä¿¡æ¯

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå±•ç¤ºç”¨æˆ·ä¿¡æ¯

**åˆ†æè¯´æ˜**ï¼š

TS æ”¯æŒç´¢å¼•æŸ¥è¯¢ç±»å‹ï¼ˆç´¢å¼•è®¿é—®ç±»å‹ï¼‰ï¼Œç”¨æ¥æŸ¥è¯¢å±æ€§çš„ç±»å‹

```ts
type RootState = {
  name: string;
};


// T1 çš„ç±»å‹æ˜¯ï¼šname å±æ€§çš„ç±»å‹ string
type T1 = RootState['name'];
```

**æ­¥éª¤**ï¼š

1. å¯¼å…¥ useSelector
2. è°ƒç”¨ useSelector è·å– user çŠ¶æ€
3. ä» user å¯¹è±¡ä¸­è§£æ„å‡ºç”¨æˆ·æ•°æ®å¹¶å±•ç¤ºåœ¨é¡µé¢ä¸­

**æ ¸å¿ƒä»£ç **ï¼š

```tsx
import { useSelector } from 'react-redux';
import { RootState } from '@/types/store';


const Profile = () => {
  // const { user } = useSelector<RootState, RootState['profile']>(state => state.profile)
  const { user } = useSelector((state: RootState) => state.profile);


  const { photo, name, like_count, follow_count, fans_count, art_count } = user;


  // ...
  // åœ¨ JSX ä¸­æ¸²æŸ“ä» redux ä¸­æ‹¿åˆ°çš„çŠ¶æ€æ•°æ®å³å¯
};
```

## 07-å°è£… axios å“åº”å·¥å…·ç±»å‹

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå°è£…å·¥å…·ç±»å‹ç»Ÿä¸€å¤„ç† axios çš„å“åº”ç±»å‹

**åˆ†æè¯´æ˜**ï¼š

å¯¹äºé¡¹ç›®æ¥å£æ¥è¯´ï¼Œä»»ä½•ä¸€ä¸ªæ¥å£è¿”å›çš„é¡¶å±‚æ•°æ®æ ¼å¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æœ‰ï¼š

1. éƒ½æœ‰ message å±æ€§ï¼Œç±»å‹ä¸º string ï¼ˆå›ºå®šï¼‰
2. éƒ½æœ‰ data å±æ€§ï¼Œä½†æ˜¯å…·ä½“æ˜¯ä»€ä¹ˆç±»å‹ä¸ç¡®å®šï¼ˆå˜åŒ–ï¼‰

```ts
// ç™»å½•
type LoginResponse = {
  message: string;
  data: Token;
};
// ç”¨æˆ·
type UserResponse = {
  message: string;
  data: User;
};
```

é—®é¢˜ï¼šTS ç±»å‹ä¸­ï¼Œä»€ä¹ˆç±»å‹å¯ä»¥é…åˆå¤šç§ç±»å‹ä½¿ç”¨ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä½¿ç”¨æ—¶æŒ‡å®šæ˜ç¡®ç±»å‹ï¼Ÿ**æ³›å‹**

**æ­¥éª¤**ï¼š

1. åœ¨ types/data.d.ts ä¸­ï¼Œåˆ›å»ºæ³›å‹å·¥å…·ç±»å‹ ApiResponse
2. é€šè¿‡è¯¥æ³›å‹å·¥å…·ç±»å‹ï¼Œç»Ÿä¸€å¤„ç† axios å“åº”ç±»å‹

**æ ¸å¿ƒä»£ç **ï¼š

types/data.d.ts ä¸­ï¼š

```ts
// æ³›å‹å·¥å…·ç±»å‹
type ApiResponse<Data> = {
  message: string;
  data: Data;
};


// ç»Ÿä¸€å¤„ç†axioså“åº”ç±»å‹ï¼š
// ç™»å½•
export type LoginResponse = ApiResponse<Token>;
// ç”¨æˆ·
export type UserResponse = ApiResponse<User>;
```

actions/login.ts ä¸­ï¼š

```ts
import type { LoginResponse } from '@/types/data';
```

actions/profile.ts ä¸­ï¼š

```ts
import type { UserResponse } from '@/types/data';
```

## 08-ä¸ªäººä¿¡æ¯-é¡µé¢ç»“æ„

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ ¹æ®æ¨¡æ¿å±•ç¤ºä¸ªäººä¿¡æ¯é¡µé¢

**æ­¥éª¤**ï¼š

1. å°† Edit æ¨¡æ¿æ‹·è´åˆ° Profile ç›®å½•ä¸­
2. åœ¨ App.tsx ä¸­é…ç½®ä¸ªäººä¿¡æ¯é¡µé¢çš„è·¯ç”±
3. åœ¨ App.scss ä¸­ç»Ÿä¸€è°ƒæ•´ NavBarã€List çš„æ ·å¼

**æ ¸å¿ƒä»£ç **ï¼š

App.tsx ä¸­ï¼š

```tsx
import ProfileEdit from './pages/Profile/Edit';


const App = () => {
  return (
    // ...
    <Route path="/profile/edit">
      <ProfileEdit />
    </Route>
  );
};
```

App.scss ä¸­ï¼š

```scss
.adm-list-default {
  border: none;
  font-size: 16px;
}
.adm-nav-bar-title {
  font-size: 17px;
}
.adm-nav-bar-back-arrow {
  font-size: 17px;
}
```

## 09-ä¸ªäººä¿¡æ¯-è·å–å¹¶å±•ç¤ºä¸ªäººä¿¡æ¯

**ç›®æ ‡**ï¼šèƒ½å¤Ÿè·å–å¹¶å±•ç¤ºç¼–è¾‘æ—¶çš„ä¸ªäººä¿¡æ¯

**æ­¥éª¤**ï¼š

1. åœ¨ types/data.d.ts ä¸­ï¼Œæ ¹æ®æ¥å£å‡†å¤‡å¥½è¿”å›æ•°æ®ç±»å‹
2. åœ¨ actions/profile.ts ä¸­ï¼Œåˆ›å»ºè·å–ç¼–è¾‘æ—¶ä¸ªäººä¿¡æ¯çš„ action
3. åœ¨ types/store.d.ts ä¸­ï¼Œåˆ›å»ºç›¸åº”çš„ redux action ç±»å‹
4. åœ¨ actions ä¸­åˆ†å‘ä¿®æ”¹ redux çŠ¶æ€çš„ action
5. åœ¨ reducers ä¸­å¤„ç†è¯¥ actionï¼Œå¹¶å°†çŠ¶æ€å­˜å‚¨åˆ° redux ä¸­

**æ ¸å¿ƒä»£ç **ï¼š

types/data.d.ts ä¸­ï¼š

```ts
export type UserProfile = {
  id: string;
  photo: string;
  name: string;
  mobile: string;
  gender: number;
  birthday: string;
  intro: string;
};
export type UserProfileResponse = ApiResponse<UserProfile>;
```

actions/profile.ts ä¸­ï¼š

```ts
import type { UserProfileResponse } from '@/types/data';


export const getUserProfile = (): RootThunkAction => {
  return async (dispatch) => {
    const res = await http.get<UserProfileResponse>('/user/profile');
    dispatch({ type: 'profile/getUserProfile', payload: res.data.data });
  };
};
```

types/store/d.ts ä¸­ï¼š

```ts
import type { UserProfile } from './data';
export type ProfileAction =
  // ...
  {
    type: 'profile/getUserProfile';
    payload: UserProfile;
  };
```

reducers/profile.ts ä¸­ï¼š

```ts
// æ³¨æ„ï¼šä»¥ä¸‹ä»£ç ä¸ºç®€åŒ–ä»£ç 


import type { UserProfile } from '@/types/data';


type ProfileState = {
  // ...
  userProfile: UserProfile;
};


const initialState = {
  // ...
  userProfile: {},
} as ProfileState;


const profile = (state = initialState, action: ProfileAction): ProfileState => {
  switch (action.type) {
    // ...
    case 'profile/getUserProfile':
      return {
        ...state,
        userProfile: action.payload,
      };
  }
};
```

Profile/Edit/index.tsx ä¸­ï¼š

```tsx
import { useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { getUserProfile } from '@/store/actions';
import type { RootState } from '@/types/store';


const ProfileEdit = () => {
  const dispatch = useDispatch();
  const { userProfile } = useSelector((state: RootState) => state.profile);


  useEffect(() => {
    dispatch(getUserProfile());
  }, [dispatch]);


  const { photo, name, intro, gender, birthday } = userProfile;


  // JSX ä¸­å±•ç¤ºç”¨æˆ·ä¿¡æ¯
  return (
    // ...
    <Item
      arrow
      extra={
        <span className={classNames('intro', intro && 'normal')}>{intro}</span>
      }
    >
      {intro || 'æœªå¡«å†™'}
    </Item>
  );
};
```

## 10-è‡ªå®šä¹‰ hooks

**ç›®æ ‡**ï¼šèƒ½å¤ŸçŸ¥é“ä»€ä¹ˆæ˜¯è‡ªå®šä¹‰ hooks

**åˆ†æè¯´æ˜**ï¼š

é™¤äº†ä½¿ç”¨ React æä¾›çš„ hooks ä¹‹å¤–ï¼Œå¼€å‘è€…è¿˜å¯ä»¥åˆ›å»ºè‡ªå·±çš„ hooksï¼Œä¹Ÿå°±æ˜¯è‡ªå®šä¹‰ hooks

é—®é¢˜ï¼šä¸ºä»€ä¹ˆè¦åˆ›å»ºè‡ªå®šä¹‰ hooksï¼Ÿ

å›ç­”ï¼š**å®ç°çŠ¶æ€é€»è¾‘å¤ç”¨**ï¼Œä¹Ÿå°±æ˜¯å°†ä¸çŠ¶æ€ç›¸å…³çš„é€»è¾‘ä»£ç å°è£…åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œå“ªä¸ªåœ°æ–¹ç”¨åˆ°äº†ï¼Œå“ªä¸ªåœ°æ–¹è°ƒç”¨å³å¯

å°è£…è‡ªå®šä¹‰ hook ä¸å°è£…æ™®é€šå‡½æ•°çš„åŒºåˆ«ï¼š**æ˜¯å¦åŒ…å«äº†çŠ¶æ€é€»è¾‘**ï¼Œå¦‚æœéœ€è¦åŒ…å« React çŠ¶æ€é€»è¾‘ï¼Œé‚£ä¹ˆï¼Œå°±å¾—ç”¨è‡ªå®šä¹‰ hookï¼›è€Œå¦‚æœå°è£…çš„å†…å®¹ä¸æ¶‰åŠçŠ¶æ€ï¼Œæ­¤æ—¶ï¼Œå°±ç”¨æ™®é€šçš„å‡½æ•°å°è£…å³å¯ã€‚

å¦‚ä½•ç†è§£çŠ¶æ€é€»è¾‘ï¼Ÿ**å¯ä»¥ç®€å•çš„ç†è§£ä¸ºä»£ç ä¸­æ˜¯å¦åŒ…å« React hooksï¼Œæ¯”å¦‚ï¼ŒuseStateã€useEffectã€useRef ç­‰ï¼Œé‚£ä¹ˆå°±å¾—ä½¿ç”¨è‡ªå®šä¹‰ hook æ¥å°è£…**

è‡ªå®šä¹‰ hooks çš„ç‰¹ç‚¹ï¼š

1. åç§°å¿…é¡»ä»¥ `use` å¼€å¤´
2. å’Œå†…ç½®çš„ React Hooks ä¸€æ ·ï¼Œè‡ªå®šä¹‰ hook ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°

- React Hooksï¼ˆä¸ç®¡æ˜¯å†…ç½®çš„è¿˜æ˜¯è‡ªå®šä¹‰çš„ï¼‰åªèƒ½åœ¨å‡½æ•°ç»„ä»¶æˆ–å…¶ä»–è‡ªå®šä¹‰ hook å†…ä½¿ç”¨

```ts
// åˆ›å»ºè‡ªå®šä¹‰ hooks å‡½æ•°
const useXxx = (params) => {
  // ...
  // éœ€è¦å¤ç”¨çš„çŠ¶æ€é€»è¾‘ä»£ç 
  // ...


  return xxx
}


// ä½¿ç”¨è‡ªå®šä¹‰ hooks å‡½æ•°
const Hello = () => {
  const xxx = useXxx(...)
}
```

- è¯´æ˜ï¼šè‡ªå®šä¹‰ hooks å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥å®Œå…¨æŒ‰ç…§å¯¹å‡½æ•°çš„ç†è§£ï¼Œæ¥ç†è§£è‡ªå®šä¹‰ hooks
  - æ¯”å¦‚ï¼šå‚æ•°å’Œè¿”å›å€¼éƒ½å¯ä»¥å¯é€‰çš„ï¼Œå¯ä»¥æä¾›ä¹Ÿå¯ä»¥ä¸æä¾›ï¼Œæ ¹æ®å®é™…çš„éœ€æ±‚æ¥å®ç°å³å¯

**æ€»ç»“**ï¼š

1. è‡ªå®šä¹‰ hooks æ˜¯å‡½æ•°å—ï¼Ÿ æ˜¯
2. è‡ªå®šä¹‰ hooks çš„åç§°æœ‰ä»€ä¹ˆçº¦æŸï¼Ÿå¿…é¡»ä»¥ `use` å¼€å¤´
3. è‡ªå®šä¹‰ hooks å¯ä»¥æ²¡æœ‰å‚æ•°æˆ–è¿”å›å€¼å—ï¼Ÿå¯ä»¥

## 11-è‡ªå®šä¹‰ hooks-åˆ†æè¦å°è£…çš„ä»£ç é€»è¾‘

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåˆ†æè¦å°è£…çš„ä»£ç é€»è¾‘æ‰¾åˆ°ç›¸åŒç‚¹å’Œä¸åŒç‚¹

**åˆ†æè¯´æ˜**ï¼š

å‡½æ•°å°è£…çš„åŸºæœ¬æ€æƒ³ï¼šå°†ç›¸åŒçš„é€»è¾‘ç›´æ¥æ‹·è´åˆ°å‡½æ•°ä¸­ï¼Œä¸åŒçš„æ•°æ®æˆ–é€»è¾‘é€šè¿‡å‡½æ•°å‚æ•°ä¼ å…¥ã€‚éœ€è¦è¿”å›æ•°æ®ï¼Œå°±é€šè¿‡å‡½æ•°è¿”å›å€¼è¿”å›

```tsx
// ä¸åŒï¼šå¯¼å…¥çš„ action å‡½æ•°ä¸åŒ
import { getUser } from '@/store/actions';
import { getUserProfile } from '@/store/actions';


const Profile = () => {
  // ä¸åŒï¼š è·å–åˆ°çš„çŠ¶æ€ä¸åŒ
  //  æ³¨æ„ï¼šè™½ç„¶ï¼Œæ­¤å¤„ä¸¤ä¸ªè·å–åˆ°çš„éƒ½æ˜¯ 'profile'ï¼Œä½†ï¼Œå®é™…ä¸Šå…¶ä»–é¡µé¢è·å–åˆ°çš„æ•°æ®å¯èƒ½ä¸åŒ
  const { user } = useSelector<RootState, RootState['profile']>(
    (state) => state.profile,
  );
  const { userProfile } = useSelector<RootState, RootState['profile']>(
    (state) => state.profile,
  );


  useEffect(() => {
    // ä¸åŒï¼šåˆ†å‘çš„ action å‡½æ•°ä¸åŒ
    dispatch(getUser());
    dispatch(getUserProfile());
  }, [dispatch]);


  // ä¸åŒï¼šè·å–åˆ°çš„çŠ¶æ€ä¸åŒ
  const { photo, name, like_count, follow_count, fans_count, art_count } = user;
  const { photo, name, intro, gender, birthday } = userProfile;


  // ...
};
```

åˆ†æä»¥ä¸Šã€æˆ‘çš„é¡µé¢ã€‘å’Œã€ä¸ªäººä¿¡æ¯é¡µé¢ã€‘ä¸­è·å–æ•°æ®çš„é€»è¾‘ï¼Œæœ‰ä¸¤ä¸ªä¸åŒç‚¹ï¼š

1. åˆ†å‘çš„ action å‡½æ•°ä¸åŒ
2. è·å–çš„çŠ¶æ€ä¸åŒ

æ‰€ä»¥ï¼Œåªéœ€è¦æŠŠè¿™ä¸¤ç‚¹ä½œä¸ºè‡ªå®šä¹‰ hooks çš„**å‚æ•°**å³å¯

è€Œè¿™ä¸¤ä¸ªåŠŸèƒ½æœ€ç»ˆçš„ç›®çš„ï¼Œéƒ½æ˜¯ä¸ºäº†æ‹¿åˆ°ç›¸åº”çš„åº”ç”¨çŠ¶æ€ã€‚å› æ­¤ï¼ŒæŠŠæ‹¿åˆ°çš„åº”ç”¨çŠ¶æ€ï¼Œä½œä¸ºè‡ªå®šä¹‰ hooks çš„**è¿”å›å€¼**å³å¯

```js
// å°†ä¸åŒçš„å†…å®¹ï¼Œä½œä¸ºå‡½æ•°å‚æ•°ä¼ å…¥
const useInitialState = (action, stateName) => {
  // éœ€è¦å¤ç”¨çš„çŠ¶æ€é€»è¾‘ä»£ç ï¼ˆ ç›¸åŒçš„é€»è¾‘ä»£ç  ï¼‰


  // æœ€ç»ˆï¼Œè¯¥æ“ä½œéœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œæœ€ç»ˆå°±é€šè¿‡ è¿”å›å€¼ æ¥è¿”å›
  return state;
};


// ä½¿ç”¨è‡ªå®šä¹‰ hooksï¼š
const { userProfile } = useInitialState(getUserProfile, 'profile');
const { photo, name, intro, gender, birthday } = userProfile;


const { user } = useInitialState(getUser, 'profile');
const { photo, name, like_count, follow_count, fans_count, art_count } = user;
```

## 12-è‡ªå®šä¹‰ hooks-å®ç°è‡ªå®šä¹‰ hooks-ä¸è€ƒè™‘ç±»å‹

**ç›®æ ‡**ï¼šèƒ½å¤Ÿé€šè¿‡ JS ä»£ç å®ç°è‡ªå®šä¹‰ hooks

**æ­¥éª¤**ï¼š

1. åˆ›å»º utils/use-initial-state.ts æ–‡ä»¶
2. åˆ›å»º useInitialState å‡½æ•°ï¼ˆè‡ªå®šä¹‰ hookï¼‰
3. å¯¼å…¥ç”¨åˆ°çš„åŒ…
4. å°†ç›¸åŒçš„é€»è¾‘ï¼Œç›´æ¥å°è£…åˆ° useInitialState å‡½æ•°ä¸­
5. å°†ä¸åŒçš„åœ°æ–¹ï¼Œä½œä¸º useInitialState å‡½æ•°çš„å‚æ•°
6. å°†æ‹¿åˆ°çš„çŠ¶æ€ä½œä¸º useInitialState å‡½æ•°çš„è¿”å›å€¼

**æ ¸å¿ƒä»£ç **ï¼š

utils/use-initial-state.ts ä¸­ï¼š

```ts
// å¯¼å…¥ç”¨åˆ°çš„åŒ…
import { useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import type { RootState } from '@/types/store';


// åˆ›å»º useInitialState å‡½æ•°ï¼ˆè‡ªå®šä¹‰ hookï¼‰
const useInitialState = (action: any, stateName: any) => {
  const dispatch = useDispatch();
  const state = useSelector((state: RootState) => state[stateName]);


  useEffect(() => {
    dispatch(action());
  }, [dispatch, action]);


  return state;
};


export { useInitialState };
```

Profile/Edit.tsx ä¸­ï¼š

```tsx
import { useInitialState } from '@/utils/use-initial-state';


const ProfileEdti = () => {
  const { userProfile } = useInitialState(getUserProfile, 'profile');
  // ...
};
```

## 13-è‡ªå®šä¹‰ hooks-ä¸ºå®ç°çš„è‡ªå®šä¹‰ hooks æ·»åŠ ç±»å‹

**ç›®æ ‡**ï¼šèƒ½å¤Ÿä¸ºå®ç°çš„è‡ªå®šä¹‰ hooks æ·»åŠ ç±»å‹

**åˆ†æè¯´æ˜**ï¼š

å¯¹äº useInitialState è¿™ä¸ªè‡ªå®šä¹‰ hook æ¥è¯´ï¼Œåªéœ€è¦ä¸ºå‚æ•°æŒ‡å®šç±»å‹å³å¯

1. å‚æ•° actionï¼šå°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥ï¼Œç›´æ¥æŒ‡å®šä¸ºæœ€ç®€å•çš„å‡½æ•°ç±»å‹å³å¯
2. å‚æ•° stateNameï¼š
   - stateName è¡¨ç¤ºä» Redux çŠ¶æ€ä¸­å–å‡ºçš„çŠ¶æ€åç§°ï¼Œæ¯”å¦‚ï¼Œ`'profile'` æˆ– `'login'`
   - æ‰€ä»¥ï¼ŒstateName åº”è¯¥æ˜¯ RootState ä¸­çš„æ‰€æœ‰çŠ¶æ€åç§°ä¸­çš„ä»»æ„ä¸€ä¸ª
   - ä½†æ˜¯ï¼Œå…·ä½“æ˜¯å“ªä¸€ä¸ªä¸ç¡®å®šï¼Œåªæœ‰åœ¨ä½¿ç”¨è¯¥å‡½æ•°æ—¶æ‰èƒ½ç¡®å®šä¸‹æ¥
   - é—®é¢˜ï¼šå¦‚æœä¸€ä¸ªç±»å‹ä¸ç¡®å®šï¼Œåº”è¯¥æ˜¯ä»€ä¹ˆ TS ä¸­çš„ä»€ä¹ˆç±»å‹æ¥å®ç°ï¼Ÿ**æ³›å‹**

```ts
// Redux æ•´ä¸ªåº”ç”¨ï¼ŒçŠ¶æ€çš„ç±»å‹
// ç›®å‰ï¼ŒRedux ä¸­å·²ç»æœ‰ä¸¤ä¸ªçŠ¶æ€ï¼šloginï¼ˆç™»å½•æ—¶çš„çŠ¶æ€ï¼‰å’Œ profileï¼ˆæˆ‘çš„ - ä¸ªäººä¿¡æ¯ï¼‰
// RootState => { login: Token; profile: ProfileState; a: B }
type RootState = ReturnType<typeof store.getState>


// å¸Œæœ›ï¼Œåœ¨ä½¿ç”¨ useInitialState è‡ªå®šä¹‰ hook çš„æ—¶å€™ï¼Œåªåº”è¯¥è·å–åˆ° Redux ä¸­å·²æœ‰çš„çŠ¶æ€ï¼Œä½†æ˜¯ï¼Œè·å–å“ªä¸€ä¸ªçŠ¶æ€æ—¶ä¸ç¡®å®šçš„ï¼Œåªæœ‰åœ¨è°ƒç”¨æ—¶æ‰èƒ½ç¡®å®š
// å› ä¸º stateName åªèƒ½æ˜¯ Redux å·²æœ‰çŠ¶æ€ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œæ‰€ä»¥ï¼ŒstateName çš„å–å€¼èŒƒå›´ï¼š'login' | 'profile' | 'a'
// è€Œæ­¤å¤„ä¸èƒ½ç›´æ¥å†™æ­»ä¸€ä¸ªè”åˆç±»å‹ï¼Œå› ä¸º Redux ä¸­çš„çŠ¶æ€å°†æ¥æ˜¯ä¼šå˜åŒ–ï¼ˆå°†æ¥è¿˜è¦ç»§ç»­å¾€ redux ä¸­æ·»åŠ çŠ¶æ€ï¼‰
// æ—¢ç„¶ä¸èƒ½å†™æ­»ï¼Œå°±å¾—åŠ¨æ€è·å–ï¼Œä¹Ÿå°±æ˜¯ Redux çŠ¶æ€ç±»å‹ RootState ä¸­æœ‰å“ªäº›çŠ¶æ€ï¼Œå°±æ‹¿åˆ°è¿™äº›çŠ¶æ€çš„åå­—å³å¯
// é‚£ä¹Ÿå°±æ˜¯è¦è·å–åˆ° RootState å¯¹è±¡ç±»å‹ä¸­ï¼Œæ‰€æœ‰é”®çš„é›†åˆï¼š	keyof RootState => 'login' | 'profile' | 'a'
const useInitialState = (action: () => void, stateName: keyof RootState) {}


// ä½¿ç”¨æ³›å‹ï¼š
// S extends keyof RootState è¡¨ç¤ºï¼šåˆ›å»ºäº†ä¸€ä¸ªæ³›å‹çš„ç±»å‹å˜é‡å«åšï¼šS
// é€šè¿‡ extends å…³é”®å­—æ¥ç»™ ç±»å‹å˜é‡S æ·»åŠ äº†æ³›å‹çº¦æŸ
// çº¦æŸï¼šS çš„ç±»å‹åº”è¯¥æ˜¯ keyof RootState ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯ï¼š'login' | 'profile' | 'a'
// const useInitialState = <S extends keyof RootState>(action: () => void, stateName: S) {}
const useInitialState = <StateName extends keyof RootState>(action: () => void, stateName: StateName) {}


// -- å¯¹æ¯”ä»¥ä¸Šä¸¤ç§æ–¹å¼çš„åŒºåˆ« --
// 1 è¿™ç§æ–¹å¼ï¼šåœ¨è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œæœ€ç»ˆå¾—åˆ°çš„è¿”å›å€¼ç±»å‹ï¼šToken | ProfileState | B ä¹Ÿå°±æ˜¯å°†æ‰€æœ‰å¯èƒ½å‡ºç°çš„æƒ…å†µéƒ½åˆ—ä¸¾å‡ºæ¥äº†
const useInitialState = (action: () => void, stateName: keyof RootState) {}


// 2 è¿™ç§æ–¹å¼ï¼šåœ¨è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œæœ€ç»ˆå¾—åˆ°çš„è¿”å›å€¼ç±»å‹ï¼šæ˜¯æŸä¸€ä¸ªçŠ¶æ€çš„ç±»å‹ï¼Œè¿™ä¸ªç±»å‹ç”±æˆ‘ä»¬ä¼ å…¥çš„ stateName ç±»å†³å®š
//					 æ¯”å¦‚ï¼ŒuseInitialState(getUser, 'profile') è¿”å›å€¼ç±»å‹ï¼Œå°±æ˜¯ profile è¿™ä¸ªé”®å¯¹åº”çš„ç±»å‹ï¼šProfileState
const useInitialState = <StateName extends keyof RootState>(action: () => void, stateName: StateName) {}


// è°ƒç”¨ï¼š
useInitialState(getUser, 'login')
useInitialState(getUser, 'profile')
useInitialState(getUser, 'a')


// åŸæ¥è®²è¿‡çš„æ³›å‹åŸºç¡€ï¼š
function id<Type>(value: Type): Type {
  return value
}


id<number>(10)
// çœç•¥ç±»å‹ä¸å†™ï¼š
id(10)
```

**æ ¸å¿ƒä»£ç **ï¼š

utils/use-initial-state.ts ä¸­ï¼š

```ts
// StateName æ˜¯æ³›å‹ç±»å‹å˜é‡çš„åç§°
// extends è¡¨ç¤ºè¦éµå¾ªçš„æ³›å‹çº¦æŸ
// keyof RootState ç”¨æ¥è·å– Redux çŠ¶æ€ä¸­æ‰€æœ‰çš„ keyï¼Œå³ï¼šæ‰€æœ‰çŠ¶æ€åç§°ä¸­çš„ä»»æ„ä¸€ä¸ª
// å°†ç±»å‹å˜é‡ä½œä¸ºå‚æ•° stateName çš„ç±»å‹
// è§£é‡Šï¼šçº¦æŸå‚æ•° stateName åªèƒ½æ˜¯ RootState æ‰€æœ‰çŠ¶æ€åç§°ä¸­çš„ä»»æ„ä¸€ä¸ª
const useInitialState = <StateName extends keyof RootState>(
  action: () => void,
  stateName: StateName,
) => {
  const state = useSelector((state: RootState) => state[stateName]);
  // ...
};
```

- å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```ts
// å¯¼å…¥ç”¨åˆ°çš„åŒ…
import { useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import type { RootState } from '@/types/store';


// åˆ›å»º useInitialState å‡½æ•°ï¼ˆè‡ªå®šä¹‰ hookï¼‰
const useInitialState = <StateName extends keyof RootState>(
  action: () => void,
  stateName: StateName,
) => {
  const dispatch = useDispatch();
  const state = useSelector((state: RootState) => state[stateName]);
  // const state = useSelector<RootState, RootState[StateName]>(
  //   state => state[stateName]
  // )


  useEffect(() => {
    dispatch(action());
  }, [dispatch, action]);


  return state;
};


export { useInitialState };
```

## 14-è‡ªå®šä¹‰ hooks-æ”¹é€ ä¸ªäººä¿¡æ¯

**ç›®æ ‡**ï¼šèƒ½å¤Ÿä½¿ç”¨å°è£…å¥½çš„è‡ªå®šä¹‰ hook æ”¹é€ è·å–ä¸ªäººä¿¡æ¯åŠŸèƒ½

**æ­¥éª¤**ï¼š

1. å¯¼å…¥è‡ªå®šä¹‰ hook
2. è°ƒç”¨è‡ªå®šä¹‰ hookï¼Œå¹¶ä¼ å…¥ç›¸åº”çš„å‚æ•°ï¼ŒéªŒè¯æ˜¯å¦æœ‰æ˜ç¡®çš„ç±»å‹æç¤º
3. é€šè¿‡è¿”å›å€¼ï¼Œæ‹¿åˆ°å¯¹åº”çš„çŠ¶æ€

**æ ¸å¿ƒä»£ç **ï¼š

Profile/Edit/index.tsx ä¸­ï¼š

```tsx
import { useInitialState } from '@/utils/use-initial-state';


const ProfileEdit = () => {
  const { userProfile } = useInitialState(getUserProfile, 'profile');


  // ...
};
```

## 15-ä¿®æ”¹æ˜µç§°-æ¸²æŸ“ä¿®æ”¹æ˜µç§°ç»„ä»¶

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ ¹æ®æ¨¡æ¿æ¸²æŸ“ä¿®æ”¹æ˜µç§°ç»„ä»¶

**æ­¥éª¤**ï¼š

1. åœ¨ Edit ç›®å½•ä¸­åˆ›å»º components æ–‡ä»¶å¤¹
2. å°†å‡†å¤‡å¥½çš„ä¿®æ”¹æ˜µç§°çš„æ¨¡æ¿ï¼ˆEditInputï¼‰æ‹·è´åˆ° components ç›®å½•ä¸­
3. ä» antd-mobile ä¸­å¯¼å…¥ Popup ç»„ä»¶
4. å¯¼å…¥ä¿®æ”¹æ˜µç§°ç»„ä»¶ï¼Œåœ¨ Popup ç»„ä»¶ä¸­æ¸²æŸ“

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
import { Popup } from 'antd-mobile';
import EditInput from './components/EditInput';


const ProfileEdit = () => {
  return (
    // ...
    <Popup visible={inputVisible} position="right">
      <EditInput />
    </Popup>
  );
};
```

## 16-ä¿®æ”¹æ˜µç§°-å±•ç¤ºä¿®æ”¹æ˜µç§°ç»„ä»¶

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåœ¨ç‚¹å‡»ä¿®æ”¹æ˜µç§°æ—¶å±•ç¤ºå¼¹å‡ºå±‚

**æ­¥éª¤**ï¼š

1. å‡†å¤‡æ§åˆ¶å¼¹å‡ºå±‚å±•ç¤ºæˆ–éšè—çš„çŠ¶æ€ inputVisibleï¼Œé»˜è®¤å€¼ä¸º false
2. ä½¿ç”¨çŠ¶æ€ inputVisible æ§åˆ¶ Popup ç»„ä»¶çš„å±•ç¤ºå’Œéšè—
3. ç»™æ˜µç§°ç»‘å®šç‚¹å‡»äº‹ä»¶
4. åœ¨ç‚¹å‡»äº‹ä»¶ä¸­ä¿®æ”¹çŠ¶æ€ inputVisible ä¸º true æ¥å±•ç¤ºå¼¹å‡ºå±‚

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
import { useState } from 'react'


const ProfileEdit = () => {
  const [inputVisible, setInputVisible] = useState(false)


  const onInputShow = () => {
    setInputVisible(true)
  }


  return (
    // ...
    <Item onClick={onInputShow}>
      æ˜µç§°
    </Item>


    <Popup visible={inputVisible}>
      <EditInput />
    </Popup>
  )
}
```

:::details æ ·å¼æœ‰é—®é¢˜?

> å¼¹å±‚ä¸å æ»¡å±å¹•ï¼Œä»¥åŠæŒ‰é’®å±•ç¤ºé”™ä½é—®é¢˜

```css
 :global {
    .adm-popup-body-position-right {
      left: 0;
    }


.logout {
      position: absolute;
      bottom: 60px;
      width: 100%;
      height: 44px;
      padding: 0 16px;
      display: flex;

      .btn {
        width: calc(100% - 32px);
        height: 100%;
        border-radius: 4px;
        color: #fff;
        font-size: 16px;
        background: linear-gradient(315deg, #fe4f4f, #fc6627);
      }
    }
```



:::

## 17-ä¿®æ”¹æ˜µç§°-éšè—ä¿®æ”¹æ˜µç§°ç»„ä»¶

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåœ¨ä¿®æ”¹æ˜µç§°ç»„ä»¶ç‚¹å‡»è¿”å›æ—¶éšè—

**åˆ†æè¯´æ˜**ï¼š

Edit ç»„ä»¶å’Œ EditInput ç»„ä»¶ä¹‹é—´æ˜¯çˆ¶å­ç»„ä»¶çš„å…³ç³»

ç›®æ ‡æ˜¯é€šè¿‡ EditInput å­ç»„ä»¶æ¥éšè—å¼¹å‡ºå±‚ï¼Œä¹Ÿå°±æ˜¯åœ¨å­ç»„ä»¶ä¸­ä¿®æ”¹çˆ¶ç»„ä»¶ä¸­çš„çŠ¶æ€

æ‰€ä»¥ï¼Œæ­¤å¤„é€šè¿‡**å­åˆ°çˆ¶çš„ç»„ä»¶é€šè®¯**æ¥è§£å†³

**æ­¥éª¤**ï¼š

1. åœ¨ Edit ç»„ä»¶ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæ§åˆ¶å¼¹å‡ºå±‚éšè—çš„å‡½æ•°
2. å°†è¯¥å‡½æ•°ä½œä¸ºå±æ€§ä¼ é€’ç»™å­ç»„ä»¶ EditInput
3. åœ¨ EditInput å­ç»„ä»¶ä¸­ï¼Œé€šè¿‡ props æ¥æ”¶è¯¥å±æ€§
4. ä¸º EditInput ç»„ä»¶çš„ props æŒ‡å®šç±»å‹
5. åœ¨ç‚¹å‡»å¯¼èˆªæ è¿”å›æŒ‰é’®æ—¶ï¼Œè°ƒç”¨è¯¥å…³é—­å‡½æ•°å³å¯

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
const ProfileEdit = () => {
  const onInputHide = () => {
    setInputVisible(false);
  };


  return (
    // ...
    <EditInput onClose={onInputHide} />
  );
};
```

Edit/components/EditInput/index.tsx ä¸­ï¼š

```tsx
type Props = {
  onClose: () => void;
};
const EditInput = ({ onClose }: Props) => {
  return <NavBar onBack={onClose}>ç¼–è¾‘æ˜µç§°</NavBar>;
};
```

## 18-ä¿®æ”¹æ˜µç§°-å¼¹å‡ºå±‚æ˜¾ç¤ºæ˜µç§°

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåœ¨å¼¹å‡ºå±‚æ–‡æœ¬æ¡†ä¸­å±•ç¤ºæ˜µç§°

**æ­¥éª¤**ï¼š

1. ä¸º EditInput ç»„ä»¶æ·»åŠ  value å±æ€§ï¼Œç”¨äºæ¥æ”¶æ˜µç§°
2. åœ¨ Edit ç»„ä»¶ä¸­å°†æ˜µç§°ä¼ é€’ç»™ EditInput ç»„ä»¶
3. åœ¨ EditInput ç»„ä»¶ä¸­åˆ›å»ºä¸€ä¸ªçŠ¶æ€ï¼Œé»˜è®¤å€¼ä¸ºæ¥æ”¶åˆ°çš„æ˜µç§°
4. ä¸º Input ç»„ä»¶è®¾ç½® value æ¥å±•ç¤ºæ˜µç§°
5. ä¸º Input ç»„ä»¶è®¾ç½® onChange æ¥ä¿®æ”¹æ˜µç§°

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
<EditInput value={name} onClose={onInputHide} />
```

Edit/components/EditInput/index.tsx ä¸­ï¼š

```tsx
import { useState } from 'react';


type Props = {
  value: string;
};
const EditInput = ({ value }: Props) => {
  const [inputValue, setInputValue] = useState(value);


  return (
    // ...
    <Input placeholder="è¯·è¾“å…¥" value={inputValue} onChange={setInputValue} />
  );
};
```

## 19-ä¿®æ”¹æ˜µç§°-æäº¤æ—¶æ‹¿åˆ°æ˜µç§°å›ä¼ ç»™çˆ¶ç»„ä»¶

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåœ¨ç‚¹å‡»æäº¤æ—¶æ‹¿åˆ°æ˜µç§°å¹¶å›ä¼ ç»™çˆ¶ç»„ä»¶

**åˆ†æè¯´æ˜**ï¼š

ç”¨æˆ·ä¸ªäººä¿¡æ¯çš„çŠ¶æ€æ˜¯åœ¨ Edit çˆ¶ç»„ä»¶ä¸­æ‹¿åˆ°çš„ï¼Œæ‰€ä»¥ï¼Œä¿®æ”¹ç”¨æˆ·ä¸ªäººä¿¡æ¯ä¹Ÿåº”è¯¥ç”± Edit çˆ¶ç»„ä»¶å‘èµ·

å› æ­¤ï¼Œéœ€è¦å°†ä¿®æ”¹åçš„æ˜µç§°å›ä¼ ç»™ Edit çˆ¶ç»„ä»¶

**æ­¥éª¤**ï¼š

1. ä¸º EditInput ç»„ä»¶æ·»åŠ  onUpdateName å‡½æ•°å±æ€§
2. åœ¨ Edit ç»„ä»¶ä¸­ä¸º EditInput ç»„ä»¶ä¼ é€’ onUpdateName å±æ€§
3. ä¸ºæäº¤æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
4. åœ¨ç‚¹å‡»äº‹ä»¶ä¸­ï¼Œè°ƒç”¨çˆ¶ç»„ä»¶ä¼ é€’è¿‡æ¥çš„ onUpdateName å‡½æ•°ï¼Œå°†æ˜µç§°å›ä¼ ç»™çˆ¶ç»„ä»¶

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
const ProfileEdit = () => {
  const onUpdateName = (value: string) => {
    console.log('çˆ¶ç»„ä»¶æ‹¿åˆ°ä¿®æ”¹åçš„æ˜µç§°ï¼š', value);


    onInputHide();
  };


  return (
    // ...
    <EditInput onUpdateName={onUpdateName} />
  );
};
```

Edit/components/EditInput/index.tsx ä¸­ï¼š

```tsx
type Props = {
  // ...
  onUpdateName: (name: string) => void;
};


const EditInput = ({ onUpdateName }: Props) => {
  // ...
  const onSave = () => {
    onUpdateName(inputValue);
  };


  return (
    // ...
    <NavBar
      right={
        <span className="commit-btn" onClick={onSave}>
          æäº¤
        </span>
      }
    >
      ç¼–è¾‘æ˜µç§°
    </NavBar>
  );
};
```

## 20-ä¿®æ”¹æ˜µç§°-å‘é€è¯·æ±‚

**ç›®æ ‡**ï¼šèƒ½å¤Ÿä¿®æ”¹ç”¨æˆ·æ˜µç§°

**åˆ†æè¯´æ˜**ï¼š

1. è¯¥æ¥å£æ²¡æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥ï¼Œä¸éœ€è¦é¢å¤–å®šä¹‰æ¥å£è¿”å›æ•°æ®çš„ç±»å‹
2. ä¸ç®¡ä¿®æ”¹æ˜µç§°è¿˜æ˜¯ç®€ä»‹ï¼Œéƒ½æ˜¯é€šè¿‡åŒä¸€ä¸ªæ¥å£æ¥ä¿®æ”¹çš„ï¼Œå› æ­¤ï¼Œå¯ä»¥é€šè¿‡ä¼ å…¥ä¸åŒçš„å‚æ•°æ¥å¤ç”¨è¯¥ action

**æ­¥éª¤**ï¼š

1. åˆ›å»º updateUserProfile action
2. ä¸ºè¯¥ action æŒ‡å®šå‚æ•°ï¼Œå‚æ•°ç±»å‹ä¸ºè¦ä¿®æ”¹çš„ç”¨æˆ·ä¿¡æ¯
3. å‘é€è¯·æ±‚ä¿®æ”¹ç”¨æˆ·æ•°æ®

**æ ¸å¿ƒä»£ç **ï¼š

ProfileEdit.tsx ä¸­ï¼š

```tsx
// æ›´æ–°ç”¨æˆ·æ˜µç§°
const onUpdateName = (name: string) => {
  // ä¿®æ”¹æ˜µç§°
  dispatch(updateUserProfile({ name }));
  // ä¿®æ”¹ç®€ä»‹
  // dispatch(updateUserProfile({ intro }))
};
```

actions/profile.ts ä¸­ï¼š

```tsx
import type { UserProfile } from '@/types/data';


export const updateUserProfile = (
  // å‚æ•°ä¸º UserProfile ä¸­çš„ä»»æ„å±æ€§ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨è¯¥ action æ—¶ï¼Œå¯ä»¥ä¼ å…¥ä»»æ„çš„ç”¨æˆ·ä¿¡æ¯
  // ä»è€Œæ¥å®ç°è¯¥æ¥å£çš„å¤ç”¨
  userProfile: Partial<UserProfile>,
): RootThunkAction => {
  return async (dispatch) => {
    await http.patch('/user/profile', userProfile);
  };
};
```

## 21-ä¿®æ”¹æ˜µç§°-æ›´æ–° redux çŠ¶æ€

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ›´æ–°ç”¨æˆ·æ˜µç§°çŠ¶æ€

**æ­¥éª¤**ï¼š

1. åœ¨ types/store.d.ts ä¸­æ·»åŠ æ›´æ–°ç”¨æˆ·ä¸ªäººèµ„æ–™çš„ action ç±»å‹
2. åœ¨ actions ä¸­åˆ†å‘ action ä»¥æ›´æ–°ç”¨æˆ·æ˜µç§°çŠ¶æ€
3. åœ¨ reducers ä¸­æ›´æ–°ç”¨æˆ·æ˜µç§°

**æ ¸å¿ƒä»£ç **ï¼š

types/store.d.ts ä¸­ï¼š

```ts
export type ProfileAction =
  // ...
  {
    type: 'profile/update';
    payload: Partial<UserProfile>;
  };
```

actions/profile.ts ä¸­ï¼š

```ts
export const updateUserProfile = (
  userProfile: Partial<UserProfile>,
): RootThunkAction => {
  return async (dispatch) => {
    await http.patch('/user/profile', userProfile);


    // åˆ†å‘ action ä»¥æ›´æ–°ç”¨æˆ·æ˜µç§°
    dispatch({ type: 'profile/update', payload: userProfile });
  };
};
```

reducers/profile.ts ä¸­ï¼š

```ts
const profile = (state = initialState, action: ProfileAction): ProfileState => {
    // ...
    case 'profile/update':
      return {
        ...state,
        userProfile: {
          ...state.userProfile,
          ...action.payload
        }
      }
  }
}
```

## 22-ä¿®æ”¹æ˜µç§°-å®Œæˆä¿®æ”¹

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°ä¿®æ”¹æ˜µç§°å¹¶æç¤ºæ›´æ–°æˆåŠŸ

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
import { useDispatch } from 'react-redux';
import { updateUserProfile } from '@/store/actions';


const ProfileEdit = () => {
  // ...
  const onUpdateName = async (value: string) => {
    await dispatch(updateUserProfile({ name: value }));
    Toast.show({
      content: 'æ›´æ–°æˆåŠŸ',
      duration: 1000,
    });
    // å…³é—­å¼¹å‡ºå±‚
    onInputHide();
  };
};
```

## 23-ä¿®æ”¹ç®€ä»‹-å¤ç”¨ä¿®æ”¹æ˜µç§°å¼¹å‡ºå±‚

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå¤ç”¨ä¿®æ”¹æ˜µç§°å¼¹å‡ºå±‚

**åˆ†æè¯´æ˜**ï¼š

ä¿®æ”¹ç®€ä»‹å¼¹å‡ºå±‚æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š

1. åˆ›å»ºä¸€ä¸ªæ–°çš„å¼¹å‡ºå±‚ï¼Œä¹Ÿå°±æ˜¯å‚è€ƒä¿®æ”¹æ˜µç§°çš„å¼¹å‡ºå±‚é‡å†™ä¸€é
2. å¤ç”¨ä¿®æ”¹æ˜µç§°çš„å¼¹å‡ºå±‚

æ­¤å¤„ï¼Œæˆ‘ä»¬é€‰æ‹©å¤ç”¨ä¿®æ”¹æ˜µç§°çš„å¼¹å‡ºå±‚ç»„ä»¶ã€‚

è¦å¤ç”¨åŒä¸€ä¸ªç»„ä»¶ï¼Œå°±éœ€è¦åŒºåˆ†å‡ºç‚¹å‡»çš„æ˜¯æ˜µç§°è¿˜æ˜¯ç®€ä»‹ï¼Œæ­¤å¤„ï¼Œå¯ä»¥é€šè¿‡çŠ¶æ€æ¥åŒºåˆ†ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š

```ts
// åŸæ¥ï¼š
const [inputVisible, setInputVisible] = useState(false);


// ç°åœ¨ï¼š
const [inputPopup, setInputPopup] = useState({
  // type å±æ€§ï¼šç”¨äºå‘Šè¯‰ EditInput ç»„ä»¶ï¼Œå½“å‰ä¿®æ”¹çš„æ˜¯æ˜µç§°è¿˜æ˜¯ç®€ä»‹
  type: '', // 'name' or 'intro'
  // å½“å‰å€¼
  value: '',
  // å±•ç¤ºæˆ–éšè—çŠ¶æ€
  visible: false,
});


// ä½¿ç”¨ï¼š
// 1 ç‚¹å‡»ä¿®æ”¹æ˜µç§°
setInputPopup({
  type: 'name',
  value: name,
  visible: true,
});
```

**æ­¥éª¤**ï¼š

1. ä¿®æ”¹æ§åˆ¶æ˜µç§°å¼¹å‡ºå±‚çŠ¶æ€çš„ç»“æ„
2. ä¿®æ”¹æ˜µç§°å¼¹å‡ºå±‚çš„å±•ç¤ºã€éšè—æ“ä½œ
3. ä¿®æ”¹æ§åˆ¶å¼¹å‡ºå±‚çš„ visible å±æ€§å€¼
4. ä¿®æ”¹ä¼ é€’ç»™ EditInput ç»„ä»¶çš„ value å±æ€§
5. ä¸º EditInput ç»„ä»¶æ·»åŠ  type å±æ€§ï¼Œæ¥æ¥æ”¶å½“å‰å±•ç¤ºç±»å‹

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
type InputPopup = {
  type: '' | 'name' | 'intro';
  value: string;
  visible: boolean;
};
const ProfileEdit = () => {
  const [inputPopup, setInputPopup] = useState<InputPopup>({
    type: '',
    value: '',
    visible: false,
  });


  const onInputShow = () => {
    setInputPopup({
      type: 'name',
      value: name,
      visible: true,
    });
  };
  const onInputHide = () => {
    setInputPopup({
      type: '',
      value: '',
      visible: false,
    });
  };


  return (
    // ...
    <Popup visible={inputPopup.visible}>
      <EditInput type={inputPopup.type} value={inputPopup.value} />
    </Popup>
  );
};
```

EditInput/index.tsx ä¸­ï¼š

```tsx
type Props = {
  type: '' | 'name' | 'intro';
};


const EditInput = ({ type }: Props) => {
  // ...
};
```

## 24-ä¿®æ”¹ç®€ä»‹-å±•ç¤ºä¿®æ”¹ç®€ä»‹å¼¹å‡ºå±‚

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå±•ç¤ºä¿®æ”¹ç®€ä»‹å¼¹å‡ºå±‚å†…å®¹

**æ­¥éª¤**ï¼š

1. ç»™ç®€ä»‹ç»‘å®šç‚¹å‡»äº‹ä»¶
2. åœ¨ç‚¹å‡»äº‹ä»¶ä¸­ï¼Œè®¾ç½®ä¸ºç®€ä»‹çš„ä¿¡æ¯
3. åœ¨ EditInput ç»„ä»¶ä¸­ï¼Œæ ¹æ® type çš„ç±»å‹æ¥å±•ç¤ºæ˜µç§°æˆ–ç®€ä»‹ä¿¡æ¯ï¼ˆæ¯”å¦‚ï¼Œæ ‡é¢˜ã€æ–‡æœ¬æ¡†æˆ–å¯Œæ–‡æœ¬æ¡†ç­‰ï¼‰

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
const ProfileEdit = () => {
  const onIntroShow = () => {
    setInputPopup({
      type: 'intro',
      value: intro,
      visible: true,
    });
  };


  return (
    // ...
    <Item onClick={onIntroShow}>ç®€ä»‹</Item>
  );
};
```

EditInput/index.tsx ä¸­ï¼š

```tsx
import { TextArea } from 'antd-mobile';


type Props = {
  type: '' | 'name' | 'intro';
};


const EditInput = ({ type }: Props) => {
  const isName = type === 'name';


  return (
    // ...


    <div className={styles.root}>
      <NavBar>ç¼–è¾‘{isName ? 'æ˜µç§°' : 'ç®€ä»‹'}</NavBar>


      <div className="edit-input-content">
        <h3>{isName ? 'æ˜µç§°' : 'ç®€ä»‹'}</h3>
        {isName ? (
          <div className="input-wrap">
            <Input
              placeholder="è¯·è¾“å…¥"
              value={inputValue}
              onChange={setInputValue}
            />
          </div>
        ) : (
          <TextArea
            className="textarea"
            placeholder="è¯·è¾“å…¥"
            // å±•ç¤ºï¼šå³ä¸‹è§’çš„å­—æ•°ç»Ÿè®¡
            showCount
            // æŒ‡å®šå†…å®¹æœ€å¤§é•¿åº¦
            maxLength={100}
            // æŒ‡å®š æ–‡æœ¬åŸŸ å±•ç¤ºå†…å®¹çš„è¡Œæ•°ï¼ˆæ–‡æœ¬åŸŸé«˜åº¦ï¼‰
            rows={4}
            value={inputValue}
            onChange={setInputValue}
          />
        )}
      </div>
    </div>
  );
};
```

## 25-ä¿®æ”¹ç®€ä»‹-å¼¹å‡ºå±‚ä¸­å±•ç¤ºç®€ä»‹å†…å®¹

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåœ¨å¤ç”¨ä¿®æ”¹æ˜µç§°å¼¹å‡ºå±‚åæ­£ç¡®å±•ç¤ºç®€ä»‹å†…å®¹

**åˆ†æè¯´æ˜**ï¼š

é—®é¢˜ï¼šå¼¹å‡ºå±‚ä¸­æ˜µç§°å’Œç®€ä»‹ä¹‹é—´ä¼šç›¸äº’å½±å“ æ“ä½œå¦‚ä¸‹ï¼š

1. å…ˆç‚¹å‡»æ˜µç§°ï¼Œå¼¹å‡ºå±‚ä¸­å±•ç¤ºæ˜µç§°å†…å®¹ã€æ­£å¸¸ã€‘
2. å…³é—­å¼¹å‡ºå±‚åï¼Œå†ç‚¹å‡»ç®€ä»‹ï¼Œæ­¤æ—¶ï¼Œå¼¹å‡ºå±‚ä¸­å±•ç¤ºçš„ä»ç„¶æ˜¯æ˜µç§°å†…å®¹ã€Bugã€‘

é—®é¢˜åˆ†æï¼š é»˜è®¤æƒ…å†µä¸‹ï¼Œantd-mobile ä¸­çš„ Popup ç»„ä»¶åœ¨éšè—æ—¶ï¼Œä¸ä¼šé”€æ¯æ‰€æ¸²æŸ“çš„å†…å®¹ï¼Œè€Œæ˜¯éšè—ï¼ˆdisplay: noneï¼‰ã€‚

å¯¹äºç¬¬ä¸€æ¬¡ç‚¹å‡»æ˜µç§°æ¥è¯´ï¼Œä¼šå±•ç¤ºå¼¹å‡ºå±‚å†…å®¹ï¼Œå¹¶ç¬¬ä¸€æ¬¡æ‰§è¡Œ EditInput ç»„ä»¶ä¸­çš„ä»£ç ã€‚EditInput ç»„ä»¶é€šè¿‡ props æ¥æ”¶åˆ° valueï¼Œç„¶åï¼Œäº¤ç»™å†…éƒ¨çš„ `useState` hookï¼Œè¯¥ state çš„é»˜è®¤å€¼å°±æ˜¯ props.value çš„å€¼ï¼Œè¿™ä¸€åˆ‡éƒ½æ˜¯æ­£å¸¸çš„ã€‚

æ¥ä¸‹æ¥ï¼Œå…³é—­å¼¹å‡ºå±‚ï¼ŒPopup å¹¶æ²¡æœ‰é”€æ¯ç»„ä»¶å†…å®¹ã€‚æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬å†æ¬¡ç‚¹å‡»ç®€ä»‹æ—¶ï¼Œå› ä¸ºç»™ EditInput ç»„ä»¶ä¼ é€’äº†æ–°çš„å±æ€§å€¼ï¼Œæ‰€ä»¥ï¼Œå¯¹äº EditInput ç»„ä»¶æ¥è¯´ç›¸å½“äºè¿›è¡Œäº†é‡æ–°æ¸²æŸ“ã€‚ ä½†æ˜¯ï¼Œç”±äº **`useState` hook é»˜è®¤å€¼çš„ç‰¹ç‚¹åªä¼šåœ¨ç»„ä»¶ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶ç”Ÿæ•ˆ**ã€‚å› æ­¤ï¼Œè™½ç„¶ï¼ŒEditInput æ¥æ”¶åˆ°äº†ç®€ä»‹çš„ value å€¼ï¼Œä½†æ˜¯å¯¹äº useState æ¥è¯´ï¼Œè¿™æ¬¡çš„ value å€¼ä¼šè¢«å¿½ç•¥ã€‚å› æ­¤ï¼Œå±•ç¤ºåœ¨å¯Œæ–‡æœ¬æ¡†ä¸­çš„ä»ç„¶æ˜¯æ˜µç§°å†…å®¹ã€‚

```ts
// useState çš„é»˜è®¤å€¼ï¼Œåªä¼šåœ¨ç»„ä»¶ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶ç”Ÿæ•ˆ
// ä»¥åçš„æ¯æ¬¡ç»„ä»¶æ›´æ–°åçš„é‡æ–°æ¸²æŸ“ï¼Œæ‹¿åˆ°çš„å°±æ˜¯æœ€æ–°çš„ count å€¼äº†
const [count, setCount] = useState(0);


setCount(count + 1);
```

è§£å†³æ–¹å¼ï¼šåœ¨æ¯æ¬¡å±•ç¤º EditInput ç»„ä»¶ï¼Œè®© `useState` hook éƒ½èƒ½æ­£ç¡®ä½¿ç”¨ value å€¼å³å¯ã€‚

1. é€šè¿‡ useEffect ç›‘å¬ props.value å˜åŒ–

EditInput/index.tsx ä¸­ï¼š

```ts
useEffect(() => {
  // value ä¸º null æˆ– undefined æ—¶ï¼Œè®¾ç½®ä¸ºé»˜è®¤å€¼ä¸ºç©ºå­—ç¬¦ä¸²
  setInputValue(value ?? '');
}, [value]);
```

1. ä¸º Popup ç»„ä»¶æ·»åŠ  destroyOnClose å±æ€§

Edit/index.tsx ä¸­ï¼š

```tsx
<Popup
  // è¡¨ç¤ºåœ¨å…³é—­å¼¹å‡ºå±‚æ—¶ï¼Œé”€æ¯ç»„ä»¶å†…å®¹
  destroyOnClose
>
```

1. åˆ©ç”¨ç‰¹æ®Šçš„ key å±æ€§
   - React å†…éƒ¨ diff æ—¶ï¼Œé¦–å…ˆåˆ¤æ–­ key æ˜¯å¦ç›¸åŒï¼Œkey ä¸åŒç›´æ¥é‡æ–°æ¸²æŸ“è¯¥ç»„ä»¶

Edit/index.tsx ä¸­ï¼š

```tsx
<Popup>
  <EditInput key={inputPopup.type} />
</Popup>
```

## 25-ä¿®æ”¹ç®€ä»‹-å¤ç”¨æäº¤æ—¶çš„å›ä¼ é€»è¾‘

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåœ¨ç‚¹å‡»æäº¤æ—¶å¤ç”¨ä¿®æ”¹æ˜µç§°çš„å›ä¼ é€»è¾‘

**åˆ†æè¯´æ˜**ï¼š

å¤ç”¨æ—¶ï¼Œåªéœ€é¢å¤–çš„æä¾›å½“å‰çš„ type ç±»å‹å³å¯

```ts
type Props = {
  onUpdateName: (name: string) => void;
};


type Props = {
  onUpdateProfile: (type: 'name' | 'intro', value: string) => void;
};
```

**æ­¥éª¤**ï¼š

1. ä¿®æ”¹ EditInput ç»„ä»¶å›ä¼ æ•°æ®çš„å‡½æ•°å±æ€§ç±»å‹
2. ä¿®æ”¹æäº¤æŒ‰é’®ä¸­ï¼Œè°ƒç”¨å›ä¼ æ•°æ®å‡½æ•°çš„å‚æ•°
3. ä¿®æ”¹ Edit ç»„ä»¶ä¸­ä¼ é€’ç»™ EditInput çš„å±æ€§
4. ä¿®æ”¹ Edit ç»„ä»¶ä¸­æ›´æ–°ç”¨æˆ·ä¿¡æ¯çš„å‡½æ•°å‚æ•°
5. å…³é—­å¼¹å‡ºå±‚

**æ ¸å¿ƒä»£ç **ï¼š

EditInput/index.tsx ä¸­ï¼š

```tsx
type Props = {
  onUpdateProfile: (type: 'name' | 'intro', value: string) => void;
};


const EditInput = ({ onUpdateProfile }: Props) => {
  const onSave = () => {
    // é€šè¿‡è¯¥åˆ¤æ–­ï¼Œå»æ‰ type å±æ€§ä¸­çš„ '' ç±»å‹ï¼Œè§£å†³ç±»å‹ä¸ä¸€è‡´çš„é—®é¢˜
    if (type === '') return;
    onUpdateProfile(type, inputValue);
  };


  // ...
};
```

Edit/index.tsx ä¸­ï¼š

```tsx
const ProfileEdit = () => {
  const onUpdateProfile = async (type: 'name' | 'intro', value: string) => {
    await dispatch(updateUserProfile({ [type]: value }));
    onInputHide();
  };


  return (
    // ...
    <EditInput onUpdateProfile={onUpdateProfile} />
  );
};
```

## 26-ä¿®æ”¹æ€§åˆ«-æ¸²æŸ“ä¿®æ”¹æ€§åˆ«å¼¹å‡ºå±‚

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ˜¾ç¤ºä¿®æ”¹æ€§åˆ«å¼¹å‡ºå±‚

**æ­¥éª¤**ï¼š

1. å°†å‡†å¤‡å¥½çš„ä¿®æ”¹æ€§åˆ«çš„æ¨¡æ¿ï¼ˆEditListï¼‰æ‹·è´åˆ° components ç›®å½•ä¸­
2. å¯¼å…¥ä¿®æ”¹æ€§åˆ«ç»„ä»¶ï¼Œåœ¨ Popup ç»„ä»¶ä¸­æ¸²æŸ“

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
import EditList from './components/EditList';


const ProfileEdit = () => {
  return (
    // ...
    <Popup visible={true}>
      <EditList />
    </Popup>
  );
};
```

## 27-ä¿®æ”¹æ€§åˆ«-ä¿®æ”¹æ€§åˆ«å¼¹å‡ºå±‚çš„å±•ç¤ºæˆ–éšè—

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ§åˆ¶ä¿®æ”¹æ€§åˆ«å¼¹å‡ºå±‚çš„å±•ç¤ºæˆ–éšè—

**åˆ†æè¯´æ˜**ï¼š

ä¿®æ”¹æ€§åˆ«å’Œä¿®æ”¹å¤´åƒçš„å¼¹å‡ºå±‚å†…å®¹å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œå› æ­¤ï¼Œä¹Ÿå¯ä»¥å¤ç”¨åŒä¸€ä¸ªå¼¹å‡ºå±‚ç»„ä»¶

å› æ­¤ï¼Œæ¥ä¸‹æ¥è¦ä»**å¤ç”¨**çš„è§’åº¦ï¼Œè®¾è®¡ä¿®æ”¹æ€§åˆ«å¼¹å‡ºå±‚çš„é€»è¾‘ï¼ˆå¯ä»¥å‚è€ƒåˆšåˆšå®ç°çš„ä¿®æ”¹æ˜µç§°å’Œç®€ä»‹ï¼‰

**æ­¥éª¤**ï¼š

1. å‡†å¤‡ç”¨äºæ§åˆ¶ä¿®æ”¹æ€§åˆ«å¼¹å‡ºå±‚çš„çŠ¶æ€
2. ä¸ºæ€§åˆ«æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œåœ¨ç‚¹å‡»äº‹ä»¶ä¸­ä¿®æ”¹çŠ¶æ€è¿›è¡Œå±•ç¤º
3. åˆ›å»ºéšè—å¼¹å‡ºå±‚çš„æ§åˆ¶å‡½æ•°ï¼Œåœ¨ç‚¹å‡»é®ç½©æ—¶å…³é—­å¼¹å‡ºå±‚ï¼Œå¹¶ä¼ é€’ç»™ EditList ç»„ä»¶
4. ä¸º EditList ç»„ä»¶æ·»åŠ  props ç±»å‹ï¼Œå¹¶æ¥æ”¶éšè—å‡½æ•°
5. ä¸ºå–æ¶ˆæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶æ¥è§¦å‘éšè—å¼¹å‡ºå±‚

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
type ListPopup = {
  type: '' | 'gender' | 'photo'
  visible: boolean
}


const ProfileEdit = () => {
  const [listPopup, setListPopup] = useState<ListPopup>({
    type: '',
    visible: false
  })


  const onGenderShow = () => {
    setListPopup({
      type: 'gender',
      visible: true
    })
  }
  const onGenderHide = () => {
    setListPopup({
      type: '',
      visible: false
    })
  }


  return (
    // ...
    <Item
      onClick={onGenderShow}
    >
      æ€§åˆ«
    </Item>


    <Popup visible={listPopup.visible} onMaskClick={onGenderHide}>
      <EditList onClose={onGenderHide} />
    </Popup>
  )
}
```

EditList/index.tsx ä¸­ï¼š

```tsx
type Props = {
  onClose: () => void;
};


const EditList = ({ onClose }: Props) => {
  return (
    <div className="list-item" onClick={onClose}>
      å–æ¶ˆ
    </div>
  );
};
```

## 28-ä¿®æ”¹æ€§åˆ«-æ›´æ–°æ•°æ®

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°ä¿®æ”¹æ€§åˆ«åŠŸèƒ½

**æ­¥éª¤**ï¼š

1. ä¸º EditList ç»„ä»¶æ·»åŠ  type å’Œ onUpdateProfile å±æ€§åŠå…¶ç±»å‹
2. ä¸ºç”·/å¥³åˆ—è¡¨é¡¹ç»‘å®šç‚¹å‡»äº‹ä»¶
3. åœ¨ç‚¹å‡»äº‹ä»¶ä¸­æ‹¿åˆ°å½“å‰å½“å‰ç‚¹å‡»é¡¹çš„ value å€¼
4. è°ƒç”¨ onUpdateProfile å›ä¼ æ•°æ®ç»™çˆ¶ç»„ä»¶
5. åœ¨çˆ¶ç»„ä»¶ Edit ä¸­ï¼Œä¸º EditList ç»„ä»¶æŒ‡å®š onUpdateProfileï¼Œå€¼ä¸º onUpdateProfile å‡½æ•°
6. å…³é—­ä¿®æ”¹å¼¹å‡ºå±‚

**æ ¸å¿ƒä»£ç **ï¼š

EditList/index.tsx ä¸­ï¼š

```tsx
type Props = {
  type: '' | 'gender' | 'photo';
  onUpdateProfile: (type: 'gender' | 'photo', value: string) => void;
};
const EditList = ({ type, onUpdateProfile }: Props) => {
  const onItemClick = (value: string) => {
    if (type === '') return;
    onUpdateProfile(type, value);
  };


  return (
    <div className={styles.root}>
      <div className="list-item" onClick={() => onItemClick('0')}>
        ç”·
      </div>
      <div className="list-item" onClick={() => onItemClick('1')}>
        å¥³
      </div>
    </div>
  );
};
```

Edit/index.tsx ä¸­ï¼š

```tsx
const ProfileEdit = () => {
  const onUpdateProfile = () => {
    // ...
    onGenderHide();
  };


  return (
    // ...
    <EditList
      type={listPopup.type}
      // onUpdateProfile å¤ç”¨ä¿®æ”¹æ˜µç§°æˆ–ç®€ä»‹æ—¶çš„å‡½æ•°
      onUpdateProfile={onUpdateProfile}
    />
  );
};
```

:::details è°ƒç”¨æ›´æ–°ç”¨æˆ·ä¿¡æ¯çš„å‡½æ•°çš„æ—¶å€™ç±»å‹æŠ¥é”™ï¼Ÿ

> ä¸ºå‚æ•°typeæŒ‡å®šç”Ÿæ—¥å’Œæ€§åˆ«çš„å¯é€‰å±æ€§å³å¯

```js{2}
  const dispatch = useDispatch<AppDispatch>();
  const onUpdateProfile = async (type: PopType | ListPopup['type'] ,name: string) => {
    const {type: resType} = await dispatch(fetchUpdateProfile({[type]: name}));
    if (resType === fetchUpdateProfile.fulfilled.type) {
      Toast.show({
        content: "ä¿®æ”¹æˆåŠŸ",
      });
      setEditFalse();
    }
  };
```



:::

## 28-ä¿®æ”¹å¤´åƒ-å±•ç¤ºä¿®æ”¹å¤´åƒå¼¹å‡ºå±‚å†…å®¹

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå±•ç¤ºä¿®æ”¹å¤´åƒå¼¹å‡ºå±‚å†…å®¹

**åˆ†æè¯´æ˜**ï¼š

ä¿®æ”¹æ€§åˆ«å’Œä¿®æ”¹å¤´åƒå¤ç”¨åŒä¸€ä¸ªå¼¹å‡ºå±‚ç»„ä»¶ï¼Œä¸ºäº†å±•ç¤ºä¸åŒçš„å†…å®¹ï¼Œå¯ä»¥å°†å¼¹å‡ºå±‚å†…å®¹ï¼ŒæŠ½è±¡æˆæ•°æ®ï¼Œç„¶åï¼Œæ ¹æ®å½“å‰ä¼ å…¥çš„ type ç±»å‹ï¼Œæ¥å†³å®šæ¸²æŸ“å“ªç§æ•°æ®ã€‚

```tsx
const genderList = [
  { text: 'ç”·', value: '0' },
  { text: 'å¥³', value: '1' },
];


const photoList = [
  { text: 'æ‹ç…§', value: '' },
  { text: 'æœ¬åœ°é€‰æ‹©', value: '' },
];


// è¦æ¸²æŸ“çš„æ•°æ®ä¸ºï¼š
const list = type === 'gender' ? genderList : photoList;
```

**æ­¥éª¤**ï¼š

1. ä¸ºå¤´åƒåˆ—è¡¨é¡¹ç»‘å®šç‚¹å‡»äº‹ä»¶
2. åœ¨ç‚¹å‡»äº‹ä»¶ä¸­ï¼Œå±•ç¤ºå¯¹åº”å¼¹å‡ºå±‚
3. åœ¨ EditList ç»„ä»¶ä¸­ï¼Œåˆ›å»ºæ€§åˆ«å’Œå¤´åƒå¯¹åº”çš„åˆ—è¡¨æ•°æ®
4. æ ¹æ®å½“å‰ä¼ å…¥çš„ type å±æ€§ï¼Œå†³å®šè¦æ¸²æŸ“å“ªç§åˆ—è¡¨æ•°æ®
5. æ ¹æ® list æ•°ç»„ï¼Œæ¸²æŸ“åˆ—è¡¨ç»“æ„

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
const ProfileEdit = () => {
  const onPhotoShow = () => {
    setListPopup({
      type: 'photo',
      visible: true,
    });
  };


  return (
    // ...
    <Item onClick={onPhotoShow}>å¤´åƒ</Item>
  );
};
```

EditList/index.tsx ä¸­ï¼š

```tsx
const genderList = [
  { text: 'ç”·', value: '0' },
  { text: 'å¥³', value: '1' },
];


const photoList = [
  { text: 'æ‹ç…§', value: 'picture' },
  { text: 'æœ¬åœ°é€‰æ‹©', value: 'local' },
];


const EditList = ({ type, onClose, onUpdateProfile }: Props) => {
  const list = type === 'gender' ? genderList : photoList;
  return (
    <div className={styles.root}>
      {list.map((item) => (
        <div
          className="list-item"
          key={item.text}
          onClick={() => {
            if (type === '') return;
            onUpdateProfile(type, item.value);
          }}
        >
          {item.text}
        </div>
      ))}


      <div className="list-item" onClick={onClose}>
        å–æ¶ˆ
      </div>
    </div>
  );
};
```

## 29-ä¿®æ”¹å¤´åƒ-å¼¹çª—é€‰æ‹©å›¾ç‰‡

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåœ¨ç‚¹å‡»æ‹ç…§æˆ–æœ¬åœ°é€‰æ‹©æ—¶å¼¹çª—é€‰æ‹©å›¾ç‰‡

**åˆ†æè¯´æ˜**ï¼š

ä¿®æ”¹å¤´åƒçš„é€»è¾‘ä¸ä¿®æ”¹æ€§åˆ«çš„å…¶ä»–ç”¨æˆ·ä¿¡æ¯çš„é€»è¾‘ä¸åŒï¼š

1. ä¿®æ”¹æ€§åˆ«çš„å…¶ä»–ç”¨æˆ·ä¿¡æ¯ï¼šç‚¹å‡»ç”·/å¥³æˆ–è€…æäº¤æŒ‰é’®æ—¶ï¼Œç›´æ¥å‘é€è¯·æ±‚ï¼Œä¿®æ”¹åç«¯æ•°æ®å³å¯
2. ä¿®æ”¹å¤´åƒï¼šç‚¹å‡»æ‹ç…§æˆ–æœ¬åœ°é€‰æ‹©æ—¶ï¼Œ*å¼¹çª—è®©ç”¨æˆ·é€‰æ‹©å›¾ç‰‡*ï¼ˆä¸è€ƒè™‘æ‹ç…§ï¼‰ï¼Œç­‰ç”¨æˆ·é€‰æ‹©å›¾ç‰‡åï¼Œæ‰ä¼šå‘é€è¯·æ±‚ï¼Œä¿®æ”¹åå°æ•°æ®

å› æ­¤ï¼Œéœ€è¦å•ç‹¬å¤„ç†ä¿®æ”¹å¤´åƒçš„é€»è¾‘ã€‚

æ­¤æ—¶ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼šå¦‚ä½•åœ¨ç‚¹å‡»æ‹ç…§æˆ–æœ¬åœ°é€‰æ‹©æ—¶ï¼Œå¼¹çª—è®©ç”¨æˆ·é€‰æ‹©å›¾ç‰‡ï¼Ÿ

æˆ‘ä»¬çŸ¥é“ï¼ŒHTML ä¸­çš„ `input[type=file]` æ ‡ç­¾ï¼Œå¯ä»¥å®ç°å›¾ç‰‡é€‰æ‹©ã€‚æ‰€ä»¥ï¼Œæ­¤å¤„éœ€è¦ç”¨åˆ° file æ ‡ç­¾ã€‚

ä½†æ˜¯ï¼Œç‚¹å‡»é¡¹å¹¶ä¸æ˜¯ fileï¼Œå› æ­¤ï¼Œå¯ä»¥è½¬æ¢ä¸‹æ€è·¯ï¼š**åœ¨ç‚¹å‡»æ‹ç…§æˆ–æœ¬åœ°é€‰æ‹©æ—¶ï¼Œè§¦å‘ file çš„ç‚¹å‡»**å³å¯ã€‚

```tsx
// å‡è®¾ file å°±æ˜¯ input[type=file] å¯¹åº”çš„ DOM å¯¹è±¡ï¼š
file.click();
```

**æ­¥éª¤**ï¼š

1. åœ¨ Edit ç»„ä»¶ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª `input[type=file]` æ ‡ç­¾ï¼Œå¹¶ä¸”è®¾ç½®ä¸º hiddenï¼ˆéšè—è¯¥æ ‡ç­¾ï¼‰
2. åˆ›å»ºä¸€ä¸ª ref å¯¹è±¡ï¼Œæ¥æ‹¿åˆ° file æ ‡ç­¾
3. åœ¨ onUpdateProfile å›è°ƒä¸­ï¼Œåˆ¤æ–­ç±»å‹æ˜¯å¦ä¸º photo
4. å¦‚æœæ˜¯ï¼Œè§¦å‘ file çš„ç‚¹å‡»
5. å¦‚æœä¸æ˜¯ï¼Œç»§ç»­æ‰§è¡ŒåŸæ¥çš„é€»è¾‘å³å¯

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
const ProfileEdit = () => {
  const fileRef = useRef<HTMLInputElement>(null)


  const onUpdateProfile = async (
    type: 'name' | 'intro' | 'gender' | 'photo',
    value: string
  ) => {
    if (type === 'photo') {
      fileRef.current?.click()
    } else {
      // ... åŸæ¥çš„é€»è¾‘
    }
  }


  return (
    // ...
    <div className="wrapper">


      <input type="file" hidden ref={fileRef} />
    </dis>
  )
}
```

## 30-ä¿®æ”¹å¤´åƒ-ç»„è£…ä¿®æ”¹å¤´åƒçš„æ•°æ®

**ç›®æ ‡**ï¼šèƒ½å¤Ÿç»„è£…ä¿®æ”¹å¤´åƒéœ€è¦çš„æ•°æ®

**æ­¥éª¤**ï¼š

1. åˆ›å»ºå‡½æ•°ï¼Œç›‘å¬ `input[type=file]` é€‰æ‹©æ–‡ä»¶çš„å˜åŒ–
2. åœ¨å‡½æ•°ä¸­ï¼Œåˆ›å»º FormData å¯¹è±¡
3. æ ¹æ®æ¥å£ï¼Œæ‹¿åˆ°æ¥å£éœ€è¦è§„å®šçš„å‚æ•°åï¼Œå¹¶å°†é€‰æ‹©çš„æ–‡ä»¶æ·»åŠ åˆ° FormData å¯¹è±¡ä¸­

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
const ProfileEdit = () => {
  const onChangePhoto = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const photoData = new FormData();
    photoData.append('photo', file);
  };


  return (
    // ...
    <input type="file" onChange={onChangePhoto} />
  );
};
```

## 31-ä¿®æ”¹å¤´åƒ-æ›´æ–°å¤´åƒ

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°æ›´æ–°å¤´åƒ

**æ­¥éª¤**ï¼š

1. åœ¨ Edit ç»„ä»¶ä¸­ï¼Œåˆ†å‘ä¿®æ”¹å¤´åƒçš„ actionï¼Œä¼ å…¥ FormData å¯¹è±¡ï¼Œå¹¶å…³é—­å¼¹å‡ºå±‚
2. æ ¹æ®æ›´æ–°ç”¨æˆ·å¤´åƒæ¥å£ï¼Œåœ¨ types/data.ts ä¸­ï¼Œæ·»åŠ æ¥å£è¿”å›æ•°æ®çš„ç±»å‹
3. åœ¨ actions ä¸­ï¼Œåˆ›å»ºä¿®æ”¹å¤´åƒçš„ actionï¼Œæ¥æ”¶åˆ°ä¼ é€’è¿‡æ¥çš„ FormData å¯¹è±¡
4. å‘é€è¯·æ±‚ï¼Œæ›´æ–°ç”¨æˆ·å¤´åƒ
5. åˆ†å‘ action æ¥ä¿®æ”¹ redux ä¸­çš„å¤´åƒçŠ¶æ€

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
import { updateUserPhoto } from '@/store/actions';


const ProfileEdit = () => {
  // ---
  const onChangePhoto = async () => {
    // ...
    await dispatch(updateUserPhoto(photoData));
    onGenderHide();
  };
};
```

types/data.d.ts ä¸­ï¼š

```ts
export type UserPhotoResponse = ApiResponse<{
  photo: string;
}>;
```

actions/profile.ts ä¸­ï¼š

```ts
export const updateUserPhoto = (data: FormData): RootThunkAction => {
  return async (dispatch) => {
    const res = await http.patch<UserPhotoResponse>('/user/photo', data);


    dispatch({
      type: 'profile/update',
      payload: {
        photo: res.data.data.photo,
      },
    });
  };
};
```

è¡¥å……-JS è°ƒç”¨æ‘„åƒå¤´çš„èµ„æ–™ï¼š

1. [js è°ƒç”¨æ‘„åƒå¤´æ‹ç…§ä¸Šä¼ å›¾ç‰‡](https://www.cnblogs.com/51ma/p/11611487.html)
2. [html input[type=file\] çš„ capture å±æ€§](https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/capture)

## 32-ä¿®æ”¹ç”Ÿæ—¥-å±•ç¤ºæ—¥æœŸé€‰æ‹©å™¨

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåœ¨ç‚¹å‡»ç”Ÿæ—¥æ—¶å±•ç¤ºæ—¥æœŸé€‰æ‹©å™¨

**æ­¥éª¤**ï¼š

1. åˆ›å»ºçŠ¶æ€ showBirthday ç”¨æ¥æ§åˆ¶æ—¥æœŸé€‰æ‹©å™¨çš„å±•ç¤ºæˆ–éšè—
2. å°† showBirthday è®¾ç½®ä¸ºæ—¥æœŸé€‰æ‹©å™¨çš„ visible å±æ€§
3. ç»™ç”Ÿæ—¥ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œåœ¨ç‚¹å‡»äº‹ä»¶ä¸­ä¿®æ”¹ showBirthday å€¼ä¸º true æ¥å±•ç¤ºæ—¥æœŸé€‰æ‹©å™¨
4. ä¸ºæ—¥æœŸé€‰æ‹©å™¨è®¾ç½® valueï¼Œå€¼ä¸ºç”¨æˆ·çš„ç”Ÿæ—¥å€¼
5. åœ¨æ—¥æœŸé€‰æ‹©å™¨å…³é—­çš„å›è°ƒä¸­ï¼Œéšè—æ—¥æœŸé€‰æ‹©å™¨

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
const ProfileEdit = () => {
  const [showBirthday, setShowBirthday] = useState(false)


  const onBirthdayShow = () => {
    setShowBirthday(true)
  }
  const onBirthdayHide = () => {
    setShowBirthday(false)
  }


  return (
    // ...
    <Item arrow extra={birthday} onClick={onBirthdayShow}>
      ç”Ÿæ—¥
    </Item>


    <DatePicker
      visible={showBirthday}
      value={new Date(birthday)}
      onCancel={onBirthdayHide}
      title="é€‰æ‹©å¹´æœˆæ—¥"
      min={new Date(1900, 0, 1, 0, 0, 0)}
      max={new Date()}
    />
  )
}
```

## 33-ä¿®æ”¹ç”Ÿæ—¥-æ›´æ–°ç”Ÿæ—¥

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°æ›´æ–°ç”Ÿæ—¥

**æ­¥éª¤**ï¼š

1. åˆ›å»º onUpdateBirthday å‡½æ•°ï¼Œå¹¶è®¾ç½®ä¸ºæ—¥æœŸé€‰æ‹©å™¨çš„ onConfirm å±æ€§å€¼
2. é€šè¿‡è¯¥å‡½æ•°çš„å‚æ•°æ‹¿åˆ°æ—¥æœŸé€‰æ‹©å™¨ä¸­é€‰æ‹©çš„æ—¥æœŸ
3. å®‰è£… dayjs ï¼Œæ ¹æ®æ¥å£æ¥æ ¼å¼åŒ–é€‰æ‹©çš„æ—¥æœŸä¸º `'2018-12-20'`
4. ä¸ºæ›´æ–°ç”¨æˆ·ä¿¡æ¯çš„å‡½æ•° onUpdateProfile çš„ type å‚æ•°æ·»åŠ  'birthday' ç±»å‹
5. å¤ç”¨ onUpdateProfile å‡½æ•°æ¥æ›´æ–°ç”¨æˆ·ç”Ÿæ—¥

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
import dayjs from 'dayjs';


const ProfileEdit = () => {
  const onUpdateProfile = async (
    type: 'name' | 'intro' | 'gender' | 'photo' | 'birthday',
    value: string,
  ) => {
    // ...
  };
  const onUpdateBirthday = (value: Date) => {
    const birthday = dayjs(value).format('YYYY-MM-DD');


    onUpdateProfile('birthday', birthday);
    onBirthdayHide();
  };


  return (
    // ...
    <DatePicker onConfirm={onUpdateBirthday} />
  );
};
```

## 34-é€€å‡ºç™»å½•-å¼¹çª—ç¡®è®¤

**ç›®æ ‡**ï¼šèƒ½å¤Ÿç‚¹å‡»é€€å‡ºæŒ‰é’®æ—¶å¼¹çª—ç¡®è®¤æ˜¯å¦é€€å‡º

**åˆ†æè¯´æ˜**ï¼š

ä¸éœ€è¦è‡ªå®šä¹‰æ ·å¼çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ `Dialog.confirm` æ¥å¼¹çª—ç¡®è®¤å³å¯

å¦‚æœéœ€è¦è‡ªå®šä¹‰å¼¹çª—æŒ‰é’®çš„æ ·å¼ï¼Œéœ€è¦ä½¿ç”¨ `Dialog.show` åŸºç¡€æ–¹æ³•æ¥å®ç°

**æ­¥éª¤**ï¼š

1. ä¸ºé€€å‡ºç™»å½•æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
2. åœ¨ç‚¹å‡»äº‹ä»¶ä¸­ï¼Œä½¿ç”¨ Dialog å¼¹çª—è®©ç”¨æˆ·ç¡®è®¤æ˜¯å¦é€€å‡ºç™»å½•

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
const ProfileEdti = () => {
  const onLogout = () => {
    const handler = Dialog.show({
      title: 'æ¸©é¦¨æç¤º',
      content: 'äº²ï¼Œä½ ç¡®å®šé€€å‡ºå—ï¼Ÿ',
      actions: [
        [
          {
            key: 'cancel',
            text: 'å–æ¶ˆ',
            onClick: () => {
              handler.close();
            },
          },
          {
            key: 'confirm',
            text: 'é€€å‡º',
            style: {
              color: 'var(--adm-color-weak)',
            },
          },
        ],
      ],
    });
  };


  return (
    // ...
    <Button onClick={onLogout}>é€€å‡ºç™»å½•</Button>
  );
};
```

## 35-é€€å‡ºç™»å½•-åŠŸèƒ½å®Œæˆ

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°é€€å‡ºåŠŸèƒ½

**æ­¥éª¤**ï¼š

1. ä¸ºé€€å‡ºæŒ‰é’®ï¼Œç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œåœ¨ç‚¹å‡»äº‹ä»¶ä¸­åˆ†å‘é€€å‡º action
2. åœ¨ types ä¸­ï¼Œåˆ›å»ºé€€å‡ºç™»å½•çš„ action ç±»å‹
3. åœ¨ actions/login.ts ä¸­ï¼Œåˆ›å»ºé€€å‡º action
4. åœ¨é€€å‡º action ä¸­ï¼Œåˆ†å‘é€€å‡º actionï¼Œå¹¶æ¸…ç† token
5. åœ¨ reducers ä¸­ï¼Œå¤„ç†é€€å‡º action æ¸…ç©º token
6. è¿”å›ç™»å½•é¡µé¢

**æ ¸å¿ƒä»£ç **ï¼š

Edit/index.tsx ä¸­ï¼š

```tsx
const onLogout = () => {
  const handler = Dialog.show({
    actions: [
      [
        {
          text: 'é€€å‡º',
          onClick: () => {
            dispatch(logout());
            handler.close();
            history.replace('/login');
          },
        },
      ],
    ],
  });


  // ...
};
```

types/data.d.ts ä¸­ï¼š

```ts
// ç™»å½• action ç±»å‹
export type LoginAction =
  | {
      type: 'login/token';
      payload: Token;
    }
  | {
      type: 'login/logout';
    };
```

actions/login.ts ä¸­ï¼š

```ts
export const logout = (): RootThunkAction => {
  return async (dispatch) => {
    dispatch({ type: 'login/logout' });
    clearToken();
  };
};
```

reducers/login.ts ä¸­ï¼š

```ts
const login = () => {
  switch (action.type) {
    // ...
    case 'login/logout':
      return initialState;
  }
};
```

## 36-å°è£…é‰´æƒè·¯ç”±ç»„ä»¶

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå°è£…é‰´æƒè·¯ç”±ç»„ä»¶å®ç°ç™»å½•è®¿é—®æ§åˆ¶åŠŸèƒ½

**æ­¥éª¤**ï¼š

1. åœ¨ components ç›®å½•ä¸­åˆ›å»º AuthRoute è·¯ç”±ç»„ä»¶
2. åœ¨ AuthRoute ç»„ä»¶ä¸­ï¼Œå®ç°è·¯ç”±çš„ç™»å½•è®¿é—®æ§åˆ¶é€»è¾‘
3. æœªç™»å½•æ—¶ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢ï¼Œå¹¶ä¼ é€’è¦è®¿é—®çš„è·¯ç”±åœ°å€
4. ç™»å½•æ—¶ï¼Œç›´æ¥æ¸²æŸ“è¦è®¿é—®çš„è·¯ç”±

**æ ¸å¿ƒä»£ç **ï¼š

components/AuthRoute.tsx ä¸­ï¼š

```tsx
// AuthRoute ç»„ä»¶çš„ä½¿ç”¨ï¼Œä¸ è·¯ç”±è‡ªå·±çš„ Route ç»„ä»¶ç”¨æ³•ç›¸åŒ
// ä¹Ÿå°±æ˜¯è¯´ï¼šRoute èƒ½å¤Ÿæ¥å—ä»€ä¹ˆå±æ€§ï¼ŒAuthRoute ç»„ä»¶ä¹Ÿèƒ½å¤Ÿæ¥å—ä»€ä¹ˆå±æ€§
// <Route path="" component={Home} />


import { logout } from '@/store/actions/login';
import { isAuth } from '@/utils/token';
import { useDispatch } from 'react-redux';
import { Route, Redirect, RouteProps, useLocation } from 'react-router-dom';


/*
  <Route path="">
    <Home />
  </Route>


  æ³¨æ„ï¼šæ­¤å¤„çš„ children å°±æ˜¯ <Home />ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ¸²æŸ“å¥½çš„ç»„ä»¶äº†
      æ‰€ä»¥ï¼Œæ­¤å¤„ï¼Œç›´æ¥è¿”å› children å³å¯ã€‚å› ä¸ºå·²ç»æ¸²æŸ“è¿‡äº†å†…å®¹ï¼Œæ‰€ä»¥ï¼Œæ­¤å¤„ä¸éœ€è¦å†é€šè¿‡æ ‡ç­¾æ¥æ¸²æŸ“äº†
*/
export const AuthRoute = ({ children, ...rest }: RouteProps) => {
  const location = useLocation();
  const dispatch = useDispatch();
  return (
    <Route
      {...rest}
      render={() => {
        const isLogin = isAuth();
        if (isLogin) {
          // ç™»å½•
          return children;
          // return <Home />
        }


        dispatch(logout());
        // æœªç™»å½•
        return (
          <Redirect
            to={{
              pathname: '/login',
              state: {
                from: location.pathname,
              },
            }}
          />
        );
      }}
    />
  );
};
```

App.tsx ä¸­ï¼š

```tsx
import { AuthRoute } from './components/AuthRoute';


const App = () => {
  return (
    // ...
    // æ­¤å¤„ï¼Œé€šè¿‡ children æ¥æŒ‡å®šè¦æ¸²æŸ“çš„ç»„ä»¶
    <AuthRoute path="/profile/edit">
      <ProfileEdit />
    </AuthRoute>
  );
};
```

pages/Layout/index.tsx ä¸­ï¼š

```tsx
import { AuthRoute } from '@/components/AuthRoute';


const Layout = () => {
  // ...
  return (
    // ...
    <AuthRoute path="/home/profile">
      <Profile></Profile>
    </AuthRoute>
  );
};
```

## 37-ç™»å½•æ—¶è·³è½¬åˆ°ç›¸åº”é¡µé¢

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåœ¨ç™»å½•æ—¶æ ¹æ®é‡å®šå‘è·¯å¾„è·³è½¬åˆ°ç›¸åº”é¡µé¢

**æ­¥éª¤**ï¼š

1. åœ¨ Login ç»„ä»¶ä¸­å¯¼å…¥ useLocation æ¥è·å–è·¯ç”±é‡å®šå‘æ—¶ä¼ å…¥çš„ state
2. è°ƒç”¨ useLocation hook æ—¶ï¼ŒæŒ‡å®š state çš„ç±»å‹
3. ç™»å½•å®Œæˆè·³è½¬é¡µé¢æ—¶ï¼Œåˆ¤æ–­ state æ˜¯å¦å­˜åœ¨
4. å¦‚æœå­˜åœ¨ï¼Œè·³è½¬åˆ° state æŒ‡å®šçš„é¡µé¢
5. å¦‚æœä¸å­˜åœ¨ï¼Œé»˜è®¤è·³è½¬åˆ°é¦–é¡µ

**æ ¸å¿ƒä»£ç **ï¼š

pages/Login/index.tsx ä¸­ï¼š

```tsx
import { useLocation } from 'react-router-dom';


const Login = () => {
  // æ³¨æ„ï¼š state å¯èƒ½æ˜¯ä¸å­˜åœ¨çš„ï¼Œæ‰€ä»¥ï¼Œç±»å‹ä¸­è¦æ˜ç¡®åŒ…å«ä¸å­˜åœ¨çš„æƒ…å†µï¼Œå³ undefined
  const location = useLocation<{ from: string } | undefined>();


  const onFinish = async (values: LoginForm) => {
    // ...
    Toast.show({
      afterClose: () => {
        if (location.state) {
          return history.replace(location.state.from);
        }


        history.replace('/home/index');
      },
    });
  };
};
```

è¡¥å……ï¼šRoute ç»„ä»¶çš„ component å’Œ children çš„åŒºåˆ«

```tsx
// 1 ä½¿ç”¨ component å±æ€§æ¥é…ç½®è·¯ç”±
<Route path="/home" component={Home} />


// 2 ä½¿ç”¨ children å±æ€§æ¥é…ç½®è·¯ç”±
<Route path="/home">
	<Home />
</Route>


// ä»¥ä¸Šä¸¤ç§æ–¹å¼çš„åŒºåˆ«ï¼š
// ç›¸åŒç‚¹ï¼šéƒ½å¯ä»¥ç”¨æ¥é…ç½®è·¯ç”±
// ä¸åŒç‚¹ï¼š
//	1 componentï¼š è¯¥æ–¹å¼ï¼Œæˆ‘ä»¬åªæ˜¯æŠŠè¦æ¸²æŸ“çš„ç»„ä»¶ä¼ é€’ç»™äº† Route ç»„ä»¶ï¼Œæ˜¯ Route ç»„ä»¶å†…éƒ¨æ¥æ¸²æŸ“äº†ç»„ä»¶
//	2 childrenï¼š  è¯¥æ–¹å¼ï¼Œæ˜¯æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨æ¸²æŸ“çš„ç»„ä»¶ï¼ˆ<Home />ï¼‰
//	å¯¹äº Route ç»„ä»¶æ¥è¯´ï¼Œå¦‚æœä½¿ç”¨äº† component å½¢å¼ï¼Œè·¯ç”±ä¼šè‡ªåŠ¨å°†è·¯ç”±ä¿¡æ¯é€šè¿‡ props æ¥ä¼ é€’ç»™ç»„ä»¶
//										å¦‚æœä½¿ç”¨äº† children å½¢å¼ï¼Œè·¯ç”±ä¸ä¼šé€šè¿‡ props æ¥ä¼ é€’è·¯ç”±ä¿¡æ¯
```

è¡¥å……ï¼šRoute å¦‚ä½•é€šè¿‡ component/children æ¥ä¸ºç»„ä»¶ä¼ é€’äº†è·¯ç”±ä¿¡æ¯ï¼ˆå±æ€§ï¼‰ï¼Ÿ

- [React.cloneElement() API æ–‡æ¡£](https://zh-hans.reactjs.org/docs/react-api.html#isvalidelement)

```tsx
// <MyRoute path="/home" component={Home} />
const MyRoute = (component: Component) => {
  return <Component {...è·¯ç”±ä¿¡æ¯} />;
};


/*
	<MyRoute>
  	<Layout />
  </MyRoute>
*/
const MyRoute = ({ children }: any) => {
  // é€šè¿‡ React.cloneElement() æ–¹æ³•æ¥ä¸º children ä¼ é€’å±æ€§
  // æœ€ç»ˆï¼ŒLayout ç»„ä»¶ä¸­ï¼Œå°±å¯ä»¥é€šè¿‡ props æ¥æ¥æ”¶åˆ°ä¼ é€’çš„æ•°æ®äº†
  return React.cloneElement(children, {
    a: 1,
    b: 3,
    ...è·¯ç”±ä¿¡æ¯,
  });
};


/*
<MyRoute path="/home">
	<Home />
</MyRoute>
*/
// æ³¨æ„ï¼šè¿™ç§å†™æ³•æ˜¯é”™è¯¯çš„ï¼Œå› ä¸º children ä¸æ˜¯ä¸€ä¸ªç»„ä»¶åç§°ï¼Œæ‰€ä»¥ï¼Œä¸èƒ½å½“åšæ ‡ç­¾æ¥æ¸²æŸ“
// const MyRoute = (children: Children) => {
//   return <Children />
// }
```

------

## 38-ç†è§£æ— æ„Ÿåˆ·æ–° token

**ç›®æ ‡**ï¼šèƒ½å¤Ÿç†è§£ä»€ä¹ˆæ˜¯æ— æ„Ÿåˆ·æ–° token

**åˆ†æè¯´æ˜**ï¼š

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”¨åˆ°çš„ç§»åŠ¨ç«¯çš„ Appï¼ˆæ¯”å¦‚ï¼Œå¾®ä¿¡ï¼‰åªè¦ç™»å½•è¿‡ä¸€æ¬¡ï¼Œä¸€èˆ¬å°±ä¸éœ€è¦å†æ¬¡é‡æ–°ç™»å½•ï¼Œé™¤éå¾ˆé•¿æ—¶é—´æ²¡æœ‰ä½¿ç”¨è¿‡ Appã€‚ è¿™æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿè¿™å°±ç”¨åˆ°æˆ‘ä»¬è¦è®²çš„æ— æ„Ÿåˆ·æ–° token äº†ã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œç™»å½•æ—¶ä¼šæ‹¿åˆ°ä¸€ä¸ªç™»å½•æˆåŠŸçš„æ ‡è¯† tokenï¼ˆèº«ä»½ä»¤ç‰Œï¼‰ï¼Œæœ‰äº†è¿™ä¸ªä»¤ç‰Œå°±å¯ä»¥è¿›è¡Œç™»å½•åçš„æ“ä½œäº†ï¼Œæ¯”å¦‚ï¼Œè·å–ä¸ªäººèµ„æ–™ã€ä¿®æ”¹ä¸ªäººä¿¡æ¯ç­‰ç­‰ ä½†æ˜¯ï¼Œä¸ºäº†å®‰å…¨ï¼Œç™»å½•æ ‡è¯† token ä¸€èˆ¬éƒ½æ˜¯æœ‰æœ‰æ•ˆæœŸçš„ï¼Œæ¯”å¦‚ï¼Œå’±ä»¬çš„æå®¢å›­é¡¹ç›®ä¸­ token çš„æœ‰æ•ˆæœŸæ˜¯ 2 ä¸ªå°æ—¶ã€‚ å¦‚æœä¸è¿›è¡Œé¢å¤–çš„å¤„ç†ï¼Œç™»å½• 2 å°æ—¶ä»¥åï¼Œå°±å¾—å†æ¬¡ç™»å½•ã€‚ä½†æ˜¯ï¼Œè¿™ç§ç”¨æˆ·ä½“éªŒä¸å¥½ï¼Œç‰¹åˆ«æ˜¯ç§»åŠ¨ç«¯ï¼ˆä¸ç®¡æ˜¯ App è¿˜æ˜¯ H5ï¼‰ã€‚ ç›¸å¯¹æ¥è¯´ï¼Œæ›´å¥½çš„ç”¨æˆ·ä½“éªŒæ˜¯å‰é¢æåˆ°çš„å¾®ä¿¡çš„é‚£ç§æ–¹å¼ã€‚å®ƒçš„åŸç†ç®€å•æ¥è¯´æ˜¯è¿™æ ·çš„ï¼š

åœ¨ç™»å½•æ—¶ï¼ŒåŒæ—¶æ‹¿åˆ°ä¸¤ä¸ª tokenï¼š

1 ç™»å½•æˆåŠŸçš„ä»¤ç‰Œï¼š`token`2 åˆ·æ–° token çš„ä»¤ç‰Œï¼š`refresh_token`

åˆ·æ–° token çš„ä»¤ç‰Œç”¨æ¥ï¼šåœ¨ token è¿‡æœŸåï¼Œæ¢å–æ–°çš„ tokenï¼ˆç»­è´¹ï¼‰ï¼Œä»è€Œå®ç°â€œæ°¸ä¹…ç™»å½•â€æ•ˆæœã€‚ è¿™å°±æ˜¯æ‰€è°“çš„ï¼š**æ— æ„Ÿåˆ·æ–° token**ã€‚

## 39-å®ç°æ— æ„Ÿåˆ·æ–° token-æ¢å–æ–°çš„ token

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°æ— æ„Ÿåˆ·æ–° token å®ç°è‡ªåŠ¨ç™»å½•

**åˆ†æè¯´æ˜**ï¼š

æ¦‚è¿°ï¼šåœ¨ç™»å½•è¶…æ—¶æˆ–è€… token å¤±æ•ˆæ—¶ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡å™¨æ¥å£è¿”å› 401ï¼Œé€šè¿‡ refresh_token æ¢å–æ–°çš„ token è¿‡ç¨‹å¦‚ä¸‹ï¼ˆä»¥è·å–ä¸ªäººèµ„æ–™æ•°æ®ä¸ºä¾‹ï¼‰ï¼š

```text
ã€1ã€‘å‘é€è¯·æ±‚è·å–ä¸ªäººèµ„æ–™æ•°æ®
ã€2ã€‘æ¥å£è¿”å› 401ï¼Œä¹Ÿå°±æ˜¯ token å¤±æ•ˆäº†
ã€3ã€‘åœ¨å“åº”æ‹¦æˆªå™¨ä¸­ç»Ÿä¸€å¤„ç†ï¼Œæ¢å–æ–°çš„ token
ã€4ã€‘å°†æ–°çš„ token å­˜å‚¨åˆ°æœ¬åœ°ç¼“å­˜ä¸­
ã€5ã€‘**ç»§ç»­å‘é€è·å–ä¸ªäººèµ„æ–™çš„è¯·æ±‚ï¼Œå®Œæˆæ•°æ®è·å–** - å…³é”®ç‚¹
ã€6ã€‘å¦‚æœæ•´ä¸ªè¿‡ç¨‹ä¸­å‡ºç°äº†ä»»æ„å¼‚å¸¸ï¼Œä¸€èˆ¬æ¥è¯´å°±æ˜¯ refresh_token ä¹Ÿè¿‡æœŸäº†ï¼Œæ¢å– token å¤±è´¥ï¼Œæ­¤æ—¶ï¼Œè¦è¿›è¡Œé”™è¯¯å¤„ç†ï¼Œä¹Ÿå°±æ˜¯ï¼š æ¸…é™¤ tokenï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
```

axios è¯·æ±‚æ‹¦æˆªè¿‡ç¨‹è¯´æ˜ï¼š

```text
1 axios.get()
2 è¯·æ±‚æ‹¦æˆªå™¨
3 å“åº”ä»£ç 
4 å“åº”æ‹¦æˆªå™¨


ä»¥ä¸Š 4 ä¸ªæ­¥éª¤çš„æ‰§è¡Œé¡ºåºï¼š


ã€1 axios.get()ã€‘ --> ã€2 è¯·æ±‚æ‹¦æˆªå™¨ã€‘>>> æœåŠ¡å™¨å¤„ç† >>> ã€4 å“åº”æ‹¦æˆªå™¨ã€‘ --> ã€3 å“åº”ä»£ç ã€‘
```

**æ­¥éª¤**ï¼š

1. ä½¿ç”¨ try-catch å¤„ç†å¼‚å¸¸ï¼Œå‡ºç°å¼‚å¸¸æ—¶ï¼Œæ¸…é™¤ tokenï¼Œæ¸…ç©º redux tokenï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
2. åˆ¤æ–­æœ¬åœ°å­˜å‚¨ä¸­ï¼Œæ˜¯å¦æœ‰ `refresh_token`
3. å¦‚æœæ²¡æœ‰ï¼Œç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œè®©ç”¨æˆ·ç™»å½•å³å¯
4. å¦‚æœæœ‰ï¼Œå°±ä½¿ç”¨ `refresh_token` é€šè¿‡ **axios å‘é€è¯·æ±‚**ï¼Œæ¢å–æ–°çš„ token
5. å°†æ–°è·å–åˆ°çš„ token å­˜å‚¨åˆ°æœ¬åœ°ç¼“å­˜ä¸­å’Œ redux ä¸­
6. ç»§ç»­å‘é€åŸæ¥çš„è¯·æ±‚

**æ ¸å¿ƒä»£ç **ï¼š

utils/http.ts ä¸­ï¼š

```ts
// å“åº”æ‹¦æˆªå™¨
http.interceptors.response.use(undefined, async (error) => {
  // å“åº”å¤±è´¥æ—¶ï¼Œä¼šæ‰§è¡Œæ­¤å¤„çš„å›è°ƒå‡½æ•°
  if (!error.response) {
    // ç½‘è·¯è¶…æ—¶
    Toast.show({
      content: 'ç½‘ç»œç¹å¿™ï¼Œè¯·ç¨åå†è¯•',
      duration: 1000,
    });
    return Promise.reject(error);
  }


  // åœ¨æ­¤å¤„ï¼Œé€šè¿‡ refresh_token æ¥æ¢å–æ–°çš„ token
  if (error.response.status === 401) {
    try {
      // ...
      // å…ˆåˆ¤æ–­ redux ä¸­æ˜¯å¦æœ‰ refresh_token
      const { refresh_token } = store.getState().login;
      if (!refresh_token) {
        // console.log('refresh_token æ²¡æœ‰äº†')
        // // æœ¬åœ°æ²¡æœ‰
        // Toast.show({
        //   content: 'ç™»å½•è¶…æ—¶ï¼Œè¯·é‡æ–°ç™»å½•',
        //   duration: 1000,
        //   afterClose: () => {
        //     customHistory.push('/login', {
        //       from: customHistory.location.pathname
        //     })
        //   }
        // })


        // return Promise.reject(error)


        // 1 æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸
        // throw new Error(error)


        // 2 å› ä¸º try-catch æ— æ³•ç›´æ¥æ•è· Promise çš„å¼‚å¸¸ï¼Œæ‰€ä»¥ï¼Œæ­¤å¤„
        //   é€šè¿‡ await ç­‰å¾… Promise å®Œæˆã€‚ç„¶åï¼Œtry-catch å°±å¯ä»¥
        //   æ•è·åˆ°è¯¥å¼‚å¸¸äº†
        await Promise.reject(error);
      }


      // æœ‰ refresh_tokenï¼Œå°±ç”¨ refresh_token æ¢å–æ–°çš„ token
      // æ³¨æ„ï¼š
      //  1 æ­¤å¤„éœ€è¦ä½¿ç”¨ axios å‘è¯·æ±‚
      //  2 å› ä¸ºä½¿ç”¨çš„æ˜¯ axios æ‰€ä»¥ï¼Œæ­¤å¤„éœ€è¦æŒ‡å®šå®Œæ•´çš„ æ¥å£è·¯å¾„
      //  3 å¯¹äº put è¯·æ±‚æ¥æ¥è¯´ï¼Œç¬¬ 3 ä¸ªå‚æ•°æ‰è¡¨ç¤ºé…ç½®é¡¹ï¼Œæ‰èƒ½å¤Ÿè®¾ç½® è¯·æ±‚å¤´
      //  4 æ­¤å¤„çš„è¯·æ±‚å¤´ç”¨çš„æ˜¯ refresh_token è€Œä¸æ˜¯ token
      const res = await axios.put(`${baseURL}/authorizations`, null, {
        headers: {
          Authorization: `Bearer ${refresh_token}`,
        },
      });


      // console.log(res)
      // ä½¿ç”¨æ–°æ‹¿åˆ°çš„ token æ›¿æ¢æœ¬åœ°çš„ token ä»¥åŠ redux ä¸­çš„ token
      // ç»„è£…æ‰€æœ‰ token
      const tokens = {
        // token æ˜¯æœ€æ–°çš„ï¼Œæ¥å£è¿”å›çš„
        token: res.data.data.token,
        // å› ä¸ºæ¥å£æ²¡æœ‰è¿”å›æ–°çš„ refresh_tokenï¼Œæ‰€ä»¥ï¼Œéœ€è¦ä½¿ç”¨åŸæ¥çš„
        refresh_token,
      };
      setToken(tokens);
      store.dispatch({ type: 'login/token', payload: tokens });


      // ç»§ç»­å®ŒæˆåŸæ¥è¦æ‰§è¡Œçš„æ“ä½œ
      // æ¯”å¦‚ï¼Œåœ¨è·å–ä¸ªäººèµ„æ–™æ—¶ï¼Œtoken è¶…æ—¶äº†ï¼Œæœ€ç»ˆï¼Œåœ¨æ‹¿åˆ°æœ€æ–°çš„ token å
      //      è¦ç»§ç»­è·å–ä¸ªäººèµ„æ–™
      // console.dir(error)
      // å¯ä»¥é€šè¿‡ error.config æ¥æ‹¿åˆ°åŸæ¥å‘é€çš„è¯·æ±‚çš„ç›¸å…³ä¿¡æ¯
      // æ‰€ä»¥ï¼Œè¦æ‰§è¡ŒåŸæ¥çš„æ“ä½œï¼Œåªéœ€è¦å°† error.config é‡æ–°è¯·æ±‚ä¸€æ¬¡å³å¯
      // æ³¨æ„ï¼šæ­¤å¤„ï¼Œä¸€å®šè¦è¿”å› Promise çš„ç»“æœ
      return http(error.config);
    } catch (e) {
      // å¦‚æœæ¢å–æ–° token çš„è¿‡ç¨‹ä¸­ï¼Œä»£ç å‡ºé”™äº†ï¼Œä¸€èˆ¬å°±è¯´æ˜ refresh_token å¤±æ•ˆäº†
      // æ­¤æ—¶ï¼Œå°±æ¸…ç©ºtokenç„¶åè¿”å›ç™»å½•é¡µé¢
      // æ³¨æ„ï¼šåœ¨ç›´æ¥åˆ†å‘ thunk action æ—¶ï¼Œä¼šæŠ¥ç±»å‹é”™è¯¯
      // store.dispatch(logout())
      // è§£å†³æ–¹å¼ï¼šå…ˆè‡ªå·±æ‰‹åŠ¨åˆ†å‘å¯¹è±¡å½¢å¼çš„ action æ¥å®ç°é€€å‡º
      store.dispatch({ type: 'login/logout' });
      // æ‰‹åŠ¨æ¸…ç†æœ¬åœ°çš„ token
      clearToken();


      Toast.show({
        content: 'ç™»å½•è¶…æ—¶ï¼Œè¯·é‡æ–°ç™»å½•',
        duration: 1000,
        afterClose: () => {
          customHistory.push('/login', {
            from: customHistory.location.pathname,
          });
        },
      });


      return Promise.reject(error);
    }
  }
});
```