---
title: ğŸ“šæå®¢å›­M-5ã€é¦–é¡µã€‘
---

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ ¹æ®æ¨¡æ¿æ­å»ºé¦–é¡µé¡µé¢ç»“æ„

**æ­¥éª¤**ï¼š

1. æ ¹æ®æ¨¡æ¿æ­å»º Home é¡µé¢ç»“æ„

## 02-ä½¿ç”¨ antd-mobile ç»„ä»¶åº“çš„ Tabs ç»„ä»¶

**ç›®æ ‡**ï¼šèƒ½å¤ŸæŒæ¡ antd-mobile ç»„ä»¶ä¸­ Tabs ç»„ä»¶çš„ä½¿ç”¨

**æ­¥éª¤**ï¼š

1. æ‰“å¼€ antd-mobile ç»„ä»¶åº“çš„æ–‡æ¡£ï¼Œæ‰¾åˆ° Tabs ç»„ä»¶
2. æ‰¾åˆ°ç¤ºä¾‹ä»£ç ï¼Œå¹¶æ‹·è´åˆ°é¡¹ç›®ä¸­
3. åˆ†æ Tabs ç»„ä»¶çš„ç»“æ„å’ŒåŸºæœ¬ä½¿ç”¨
4. è°ƒæ•´ Tabs çš„æ ·å¼

**æ ¸å¿ƒä»£ç **ï¼š

Home/index.jsx ä¸­ï¼š

```tsx
import { Tabs } from 'antd-mobile';


const Home = () => {
  return (
    // ...
    // æ³¨æ„ï¼šæ­¤å¤„åˆ«å¿˜äº†æ·»åŠ  tabs ç±»å
    <Tabs className="tabs" activeLineMode="fixed">
      <Tabs.Tab title="æ¨è" key="1">
        æ¨èé¢‘é“çš„å†…å®¹
      </Tabs.Tab>
      <Tabs.Tab title="html" key="2">
        htmlé¢‘é“çš„å†…å®¹
      </Tabs.Tab>
      <Tabs.Tab title="å¼€å‘è€…èµ„è®¯" key="3">
        å¼€å‘è€…èµ„è®¯é¢‘é“çš„å†…å®¹
      </Tabs.Tab>
      <Tabs.Tab title="c++" key="4">
        c++é¢‘é“çš„å†…å®¹
      </Tabs.Tab>
      <Tabs.Tab title="css" key="5">
        cssé¢‘é“çš„å†…å®¹
      </Tabs.Tab>
    </Tabs>
  );
};
```

## 03-è·å–é¦–é¡µé¢‘é“åˆ—è¡¨æ•°æ®

**ç›®æ ‡**ï¼šèƒ½å¤Ÿè·å–é¦–é¡µé¢‘é“åˆ—è¡¨æ•°æ®

**åˆ†æè¯´æ˜**ï¼š

å¯¹äºé¦–é¡µæ¥è¯´ï¼Œä¸ç®¡ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œéƒ½å¯ä»¥æŸ¥çœ‹ã€‚ä½†æ˜¯ï¼Œæ˜¯å¦ç™»å½•ä¼šå¯¹åç»­çš„é¢‘é“ç®¡ç†æ“ä½œäº§ç”Ÿå½±å“ï¼š

1. å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œæ­¤æ—¶ï¼Œè·å–åˆ°çš„å°±æ˜¯ç”¨æˆ·è‡ªå·±çš„é¢‘é“æ•°æ®
   - ä¸ç®¡æ˜¯æ·»åŠ é¢‘é“è¿˜æ˜¯åˆ é™¤é¢‘é“ï¼Œæ“ä½œçš„éƒ½æ˜¯è‡ªå·±çš„æ•°æ®ï¼Œå¹¶ä¸”è¿™ä¸ªæ•°æ®æ˜¯åŒæ­¥åˆ°æœåŠ¡å™¨ä¸­çš„
2. å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œæ­¤æ—¶ï¼Œè·å–çš„æ˜¯é»˜è®¤çš„é¢‘é“åˆ—è¡¨æ•°æ®
   - æ³¨æ„ï¼š*å› ä¸ºç”¨æˆ·æœªç™»å½•ï¼Œä½†è¿˜è¦å®ç°é¢‘é“çš„æ·»åŠ æˆ–åˆ é™¤æ“ä½œå¹¶ä¸”åœ¨åˆ·æ–°é¡µé¢åï¼Œä¹Ÿè¦ä¿æŒä¿®æ”¹åçš„é¢‘é“æ•°æ®*
   - æ‰€ä»¥ï¼Œä¸ºäº†å®ç°è¯¥æ•ˆæœï¼Œåœ¨ç”¨æˆ·æœªç™»å½•æ—¶ï¼Œå°†é¢‘é“æ•°æ®ä¿å­˜åˆ°æœ¬åœ°ï¼Œåœ¨æœ¬åœ°è¿›è¡Œåç»­çš„æ“ä½œ
   - <img src="https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/image-20220320172739822.png" alt="image-20220320172739822" style="zoom:50%;" />

**æ­¥éª¤**ï¼š

1. åˆ›å»º actions/home.jsx æ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­åˆ›å»ºè·å–é¢‘é“åˆ—è¡¨æ•°æ®çš„ action å¹¶å¯¼å‡º
2. åœ¨è¯¥ action ä¸­ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•
3. å¦‚æœå·²ç™»å½•ï¼Œå‘é€è¯·æ±‚è·å–ç”¨æˆ·çš„é¢‘é“åˆ—è¡¨æ•°æ®
4. å¦‚æœæœªç™»å½•ï¼Œå…ˆåˆ¤æ–­æœ¬åœ°ç¼“å­˜ä¸­æœ‰æ²¡æœ‰é¢‘é“åˆ—è¡¨æ•°æ®
5. å¦‚æœæœ‰ï¼Œæ‹¿åˆ°æœ¬åœ°çš„é¢‘é“åˆ—è¡¨æ•°æ®
6. å¦‚æœæ²¡æœ‰ï¼Œå°±å‘é€è¯·æ±‚è·å–é»˜è®¤çš„é¢‘é“åˆ—è¡¨æ•°æ®ï¼Œå¹¶å­˜å‚¨åˆ°æœ¬åœ°ç¼“å­˜ä¸­
7. åœ¨ Home ç»„ä»¶ä¸­é€šè¿‡ useInitialState è‡ªå®šä¹‰ hook éªŒè¯æ˜¯å¦æ­£ç¡®

**æ ¸å¿ƒä»£ç **ï¼š

actions/home.js ä¸­ï¼š

```ts

import { http } from '@/utils';


const CHANNEL_KEY = 'geek-channels';
export const getUserChannel = () => {
  return async (dispatch, getState) => {
    const {
      login: { token },
    } = getState();


    if (token) {
      // ç™»å½•
      const res = await http.get('/user/channels');
      const { channels } = res.data.data;
      console.log('ç™»å½•', channels);
    } else {
      // æœªç™»å½•
      const localChannels = JSON.parse(
        localStorage.getItem(CHANNEL_KEY) || '[]',
      );


      if (localChannels.length > 0) {
        // æœ‰
        console.log('æœªç™»å½•ï¼Œæœ¬åœ°æœ‰', localChannels);
      } else {
        // æ²¡æœ‰
        const res = await http.get('/user/channels');
        const { channels } = res.data.data;
        localStorage.setItem(CHANNEL_KEY, JSON.stringify(channels));
        console.log('æœªç™»å½•ï¼Œæœ¬åœ°æ²¡æœ‰', channels);
      }
    }
  };
};
```

Home/index.jsx ä¸­ï¼š

```tsx
import { useInitialState } from '@/utils/use-initial-state';
import { getUserChannel } from '@/store/actions';


const Home = () => {
  useInitialState(getUserChannel, 'home');
};
```

## 04-æ¸²æŸ“é¢‘é“åˆ—è¡¨æ•°æ®

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ¸²æŸ“é¦–é¡µé¢‘é“åˆ—è¡¨æ•°æ®

**æ­¥éª¤**ï¼š

1. å›åˆ°è·å–é¢‘é“åˆ—è¡¨æ•°æ®çš„ action ä¸­ï¼Œåˆ†å‘ action ä»¥å°†é¢‘é“æ•°æ®ä¿å­˜åˆ° redux ä¸­
2. åˆ›å»º reducers/home.jsx æ–‡ä»¶ï¼Œå¤„ç†è·å–é¢‘é“æ•°æ®çš„ action
3. å°†çŠ¶æ€ home åˆå¹¶åˆ°æ ¹ reducer ä¸­
4. åœ¨ Home ç»„ä»¶ä¸­é€šè¿‡ useInitialState è‡ªå®šä¹‰ hook è·å–é¢‘é“åˆ—è¡¨æ•°æ®å¹¶æ¸²æŸ“

**æ ¸å¿ƒä»£ç **ï¼š

actions/home.jsx ä¸­ï¼š

```ts
export const getUserChannel = (): RootThunkAction => {
  return async (dispatch, gejsxtate) => {
    const {
      login: { token },
    } = getState();
    let userChannel = [];


    if (token) {
      // ç™»å½•
      const res = await http.get<UserChannelResponse>('/user/channels');
      const { channels } = res.data.data;
      userChannel = channels;
    } else {
      // æœªç™»å½•
      const localChannels = JSON.parse(
        localStorage.getItem(CHANNEL_KEY) ?? '[]',
      ) as Channel[];
      if (localChannels.length > 0) {
        // æœ‰
        userChannel = localChannels;
      } else {
        // æ²¡æœ‰
        const res = await http.get('/user/channels');
        const { channels } = res.data.data;
        localStorage.setItem(CHANNEL_KEY, JSON.stringify(channels));
        userChannel = channels;
      }
    }


    dispatch({ type: 'home/getUserChannel', payload: userChannel });
  };
};
```



reducers/home.js ä¸­ï¼š

```ts

const Home = (state = initialState, action) => {
  switch (action.type) {
    case 'home/getUserChannel':
      return {
        ...state,
        userChannel: action.payload,
      };
    default:
      return state;
  }
};


export default Home;
```

reducers/index.jsx ä¸­ï¼š

```ts
import home from './home';


const rootReducer = combineReducers({
  // ...
  home,
});
```

Home/index.jsx ä¸­ï¼š

> activeLineMode: fixedçš„æƒ…å†µä¸‹ï¼Œå®½åº¦æ˜¯å®šæ­»çš„ï¼Œfullå±æ€§ä¼šå¡«å……æ»¡çˆ¶é¡µç­¾

```tsx
const Home = () => {
  const { userChannel } = useInitialState(getUserChannel, 'home');


  return (
    <div className={styles.root}>
      {/* å»¶è¿Ÿæ¸²æŸ“ Tabsï¼Œè§£å†³ tab é«˜äº®ä½ç½®é”™è¯¯ */}
      {userChannel.length > 0 && (
        <Tabs className="tabs" activeLineMode="fixed">
          {userChannel.map((item) => (
            <Tabs.TabPane title={item.name} key={item.id}>
              æ¨èé¢‘é“çš„å†…å®¹
            </Tabs.TabPane>
          ))}
        </Tabs>
      )}
    </div>
  );
};
```

## 05-é¢‘é“ç®¡ç†-æ¸²æŸ“é¢‘é“ç®¡ç†å¼¹å‡ºå±‚

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ¸²æŸ“é¢‘é“ç®¡ç†å¼¹å‡ºå±‚

**æ­¥éª¤**ï¼š

1. å°†æ¨¡æ¿ Channels æ‹·è´åˆ° Home/componensç›®å½•ä¸­
2. åœ¨ Home ç»„ä»¶ä¸­å¯¼å…¥ Channels ç»„ä»¶
3. ä½¿ç”¨ Popup ç»„ä»¶æ¸²æŸ“ Channels å†…å®¹
4. åˆ›å»ºæ§åˆ¶é¢‘é“ç®¡ç†å¼¹å‡ºå±‚å±•ç¤ºæˆ–éšè—çš„çŠ¶æ€
5. æ§åˆ¶å¼¹å‡ºå±‚çš„å±•ç¤ºæˆ–éšè—

**æ ¸å¿ƒä»£ç **ï¼š

Home/index.jsx ä¸­ï¼š

```tsx
import { useState } from 'react';
import { Popup } from 'antd-mobile';
import Channels from './componenjsx/Channels';


const Home = () => {
  const [visible, setVisible] = useState(false);


  const onChannelOpen = () => {
    setVisible(true);
  };
  const onChannelClose = () => {
    setVisible(false);
  };


  return (
    <div className={styles.root}>
      <div className="tabs-opration">
        // ...
        <Icon type="iconbtn_channel" onClick={onChannelOpen} />
      </div>


      <Popup
        visible={visible}
        onMaskClick={onChannelClose}
        position="left"
        className="channel-popup"
      >
        <Channels onClose={onChannelClose} />
      </Popup>
    </div>
  );
};
```

Home/componenjsx/Channels/index.jsx ä¸­ï¼š

```tsx

const Channels = ({ onClose }) => {
  return (
    // ...
    <div className="channel-header">
      <Icon type="iconbtn_channel_close" onClick={onClose} />
    </div>
  );
};
```

## 06-é¢‘é“ç®¡ç†-æ¸²æŸ“æˆ‘çš„é¢‘é“

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ¸²æŸ“æˆ‘çš„é¢‘é“åˆ—è¡¨

**åˆ†æè¯´æ˜**ï¼š

æˆ‘çš„é¢‘é“ä¸­å±•ç¤ºçš„æ•°æ®å°±æ˜¯åœ¨é¦–é¡µä¸­è·å–åˆ°çš„ç”¨æˆ·é¢‘é“åˆ—è¡¨æ•°æ®ï¼Œå› æ­¤ï¼Œåªéœ€è¦åœ¨é¢‘é“ç®¡ç†ç»„ä»¶ä¸­æ‹¿åˆ°ç”¨æˆ·é¢‘é“åˆ—è¡¨æ•°æ®å³å¯

**æ­¥éª¤**ï¼š

1. åœ¨ Channels ä¸­ï¼Œä» redux ä¸­è·å–åˆ°ç”¨æˆ·é¢‘é“æ•°æ®
2. æ¸²æŸ“ç”¨æˆ·é¢‘é“åˆ—è¡¨æ•°æ®

**æ ¸å¿ƒä»£ç **ï¼š

Channels/index.jsx ä¸­ï¼š

```tsx
import { useSelector } from 'react-redux';


const Channels = ({ onClose }) => {
  const { userChannel } = useSelector((state) => state.home);


  return (
    // ...
    <div className="channel-list">
      {/* é€‰ä¸­æ—¶ï¼Œæ·»åŠ ç±»å selected */}
      {userChannel.map((item) => (
        <span key={item.id} className={classnames('channel-list-item')}>
          {item.name}
          <Icon type="iconbtn_tag_close" />
        </span>
      ))}
    </div>
  );
};
```

## 07-é¢‘é“ç®¡ç†-è·å–é¢‘é“æ¨è

**ç›®æ ‡**ï¼šèƒ½å¤Ÿè·å–åˆ°é¢‘é“æ¨èåˆ—è¡¨æ•°æ®

**åˆ†æè¯´æ˜**ï¼š

é¢‘é“æ¨èï¼ˆå¯é€‰é¢‘é“ï¼‰ä¸­å±•ç¤ºçš„æ˜¯é™¤äº†æˆ‘çš„é¢‘é“ä¹‹å¤–çš„å…¶ä»–é¢‘é“æ•°æ®ï¼Œç”±äºæ¥å£å¹¶æ²¡æœ‰ç›´æ¥æä¾›å¯é€‰é¢‘é“çš„æ•°æ®ï¼Œ å› æ­¤ï¼Œå¯ä»¥æ‹¿åˆ°æ‰€æœ‰é¢‘é“æ•°æ®ï¼Œç„¶åï¼Œæ’é™¤æ‰æˆ‘çš„é¢‘é“æ•°æ®ï¼Œå‰©ä¸‹çš„å°±æ˜¯å¯é€‰é¢‘é“æ•°æ®äº†ã€‚

é—®é¢˜ï¼šå¦‚ä½•ä»ä¸€ä¸ªæ•°ç»„ä¸­åˆ é™¤å¦ä¸€ä¸ªæ•°ç»„ä¸­åŒ…å«çš„å…ƒç´ ï¼Ÿ

```ts
// åŸç”Ÿæ–¹å¼ï¼š
const row = [1, 3, 5, 7];
const my = [1, 7];
// æœ€ç»ˆå¸Œæœ›æ‹¿åˆ°ï¼š[3, 5]
row.filter((itme) => my.findIndex(itemm) < 0);


// https://www.lodashjs.com/docs/lodash.differenceBy
// å¯ä»¥ä½¿ç”¨ lodash çš„ differenceBy æ–¹æ³•ï¼š


// ä»ç¬¬ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œæ’é™¤æ‰ç¬¬äºŒä¸ªæ•°ç»„ä¸­åŒ…å«çš„å…ƒç´ 
// å¦‚ä½•ç¡®å®šä¸¤ä¸ªæ•°ç»„ä¸­çš„å…ƒç´ æ˜¯å¦ç›¸åŒå‘¢ï¼Ÿæ ¹æ®ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæ¯”å¦‚ï¼Œä¼ å…¥ x è¡¨ç¤ºå¦‚æœä¸¤ä¸ªæ•°ç»„ä¸­çš„å…ƒç´ çš„ x å±æ€§
// ç›¸åŒå°±è¡¨ç¤ºä¸¤ä¸ªå…ƒç´ ç›¸åŒ
_.differenceBy([{ x: 2 }, { x: 1 }], [{ x: 1 }], 'x');
// ç»“æœä¸ºï¼š[{ 'x': 2 }]
```

**æ­¥éª¤**ï¼š

1. åœ¨ actions ä¸­ï¼Œå‘é€è¯·æ±‚ï¼Œè·å–æ‰€æœ‰é¢‘é“æ•°æ®
2. æ‹¿åˆ°æ‰€æœ‰é¢‘é“æ•°æ®æ’é™¤æ‰æˆ‘çš„é¢‘é“æ•°æ®ï¼Œå¾—åˆ°å¯é€‰é¢‘é“æ•°æ®
3. åœ¨ actions ä¸­åˆ†å‘ action å°†é¢‘é“æ¨èæ•°æ®å­˜å‚¨åˆ° redux ä¸­
4. åœ¨ reducers ä¸­å­˜å‚¨æ¨èé¢‘é“æ•°æ®

**æ ¸å¿ƒä»£ç **ï¼š

actions/home.jsx ä¸­ï¼š

```ts

export const getAllChannel = () => {
  return async (dispatch, getState) => {
      const res = await http.get('channels');
    const {
      home: { userChannel },
    } = getState();
    const restChannels = differenceBy(
      res.data.data.channels,
      userChannel,
      'id',
    );


    dispatch({ type: 'home/getAllChannel', payload: restChannels });
  };
};
```



reducers/home.jsx ä¸­ï¼š

```ts


const initialState = {
  // ...
  restChannel: [],
}


const Home = (state = initialState, action) => {
  switch (action.type) {
    // ...
    case 'home/getAllChannel':
      return {
        ...state,
        restChannel:
      }
  }
}
```

## 08-é¢‘é“ç®¡ç†-æ¸²æŸ“é¢‘é“æ¨è

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ¸²æŸ“é¢‘é“æ¨èåˆ—è¡¨

**æ ¸å¿ƒä»£ç **ï¼š

Channels/index.jsx ä¸­ï¼š

```tsx
import { useInitialState } from '@/utils/use-initial-state';
import { getAllChannel } from '@/store/actions';


const Channels = () => {
  const { restChannel } = useInitialState(getAllChannel, 'home');


  return (
    // ...
    <div className="channel-list">
      {restChannel.map((item) => (
        <span key={item.id} className="channel-list-item">
          + {item.name}
        </span>
      ))}
    </div>
  );
};
```

## 09-é¢‘é“ç®¡ç†-åˆ‡æ¢é¢‘é“ç¼–è¾‘çŠ¶æ€

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåˆ‡æ¢é¢‘é“ç¼–è¾‘çŠ¶æ€

**æ­¥éª¤**ï¼š

1. æ·»åŠ æ§åˆ¶æ˜¯å¦ä¸ºç¼–è¾‘çš„çŠ¶æ€
2. ç»™ç¼–è¾‘/ä¿å­˜æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
3. åœ¨ç‚¹å‡»äº‹ä»¶ä¸­åˆ‡æ¢ç¼–è¾‘çŠ¶æ€
4. æ ¹æ®ç¼–è¾‘çŠ¶æ€åˆ¤æ–­å±•ç¤ºä¿å­˜æˆ–ç¼–è¾‘æ–‡å­—å†…å®¹

**æ ¸å¿ƒä»£ç **ï¼š

Channels/index.jsx ä¸­ï¼š

```tsx
import { useState } from 'react';


const Channels = () => {
  const [isEdit, setIsEdit] = useState(false);


  const onChangeEdit = () => {
    setIsEdit(!isEdit);
  };


  return (
    // ...
    <div className={classnames('channel-item', isEdit && 'edit')}>
      // ...
      <span className="channel-item-edit" onClick={onChangeEdit}>
        {isEdit ? 'ä¿å­˜' : 'ç¼–è¾‘'}
      </span>
    </div>
  );
};
```

## 10-é¢‘é“ç®¡ç†-åˆ‡æ¢é¢‘é“å’Œé«˜äº®

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°åˆ‡æ¢é¢‘é“åŠŸèƒ½

**åˆ†æè¯´æ˜**ï¼š

é¦–é¡µé¡¶éƒ¨çš„é¢‘é“å’Œé¢‘é“ç®¡ç†ä¸­çš„æˆ‘çš„é¢‘é“æ˜¯å…³è”åœ¨ä¸€èµ·çš„ï¼š

1. ç‚¹å‡»é¢‘é“ç®¡ç†ä¸­çš„æˆ‘çš„é¢‘é“æ—¶ï¼Œé¦–é¡µé¡¶éƒ¨çš„é¢‘é“ä¼šåˆ‡æ¢ï¼Œå¹¶é«˜äº®
2. ç‚¹å‡»é¦–é¡µé¡¶éƒ¨çš„é¢‘é“æ—¶ï¼Œé¢‘é“ç®¡ç†å¯¹åº”çš„é¢‘é“ä¹Ÿè¦é«˜äº®

å› æ­¤ï¼Œéœ€è¦å‡†å¤‡ä¸€ä¸ªçŠ¶æ€ç”¨æ¥è®°å½•å½“å‰é€‰ä¸­é¢‘é“ï¼Œå¹¶ä¸”ä¸¤ä¸ªç»„ä»¶ä¸­éƒ½éœ€è¦ç”¨åˆ°è¯¥çŠ¶æ€ï¼Œæ‰€ä»¥ï¼Œå¯ä»¥ç›´æ¥å°†è¯¥çŠ¶æ€å­˜å‚¨åˆ° redux ä¸­ï¼Œå®ç°çŠ¶æ€å…±äº«ã€‚ ç„¶åï¼Œä¸ç®¡æ˜¯é¦–é¡µé¡¶éƒ¨çš„é¢‘é“è¿˜æ˜¯é¢‘é“ç®¡ç†ä¸­çš„æˆ‘çš„é¢‘é“ï¼Œåªéœ€è¦åœ¨ç‚¹å‡»åˆ‡æ¢æ—¶ï¼Œä¿®æ”¹ redux ä¸­è®°å½•çš„é«˜äº®çŠ¶æ€å€¼å³å¯ã€‚

**æ­¥éª¤**ï¼š

1. åœ¨ home reducer ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªçŠ¶æ€ channelActiveKey ç”¨æ¥è®°å½•å½“å‰é€‰ä¸­é¢‘é“çš„é”®
2. åœ¨ Channel ç»„ä»¶ä¸­æ‹¿åˆ°è¯¥çŠ¶æ€ï¼Œåœ¨æ¸²æŸ“æˆ‘çš„é¢‘é“åˆ—è¡¨æ—¶ï¼Œè®©å¯¹åº” key çš„é¢‘é“é«˜äº®
3. ä¸ºæ¯ä¸ªé¢‘é“é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œåœ¨ç‚¹å‡»äº‹ä»¶ä¸­æ‹¿åˆ°æ¯ä¸€ä¸ªé¢‘é“çš„ keyï¼Œå¹¶åˆ†å‘ action æ¥åˆ‡æ¢é€‰ä¸­é¡¹
5. åœ¨ home reducer ä¸­ï¼Œå¤„ç† action æ¥æ›´æ–° channelActiveKey çš„å€¼
6. åœ¨ home reducer è·å–é¦–é¡µé¡¶éƒ¨é¢‘é“æ•°æ®æ—¶ï¼Œä¸º channelActiveKey æŒ‡å®šé»˜è®¤å€¼
7. åˆ‡æ¢é¢‘é“æ—¶ï¼Œå…³é—­é¢‘é“å¼¹å‡ºå±‚

**æ ¸å¿ƒä»£ç **ï¼š

redcuers/home.js ä¸­ï¼š

```tsx

const initialState = {
  channelActiveKey: '',
};


const Home = (state = initialState, action) => {
  switch (action.type) {
    case 'home/getUserChannel':
      return {
        ...state,
        userChannel: action.payload,
        // è®¾ç½®é»˜è®¤å€¼
        channelActiveKey: action.payload[0]?.id + '',
      };
    // ...
    case 'home/changeTab':
      return {
        ...state,
        channelActiveKey: action.payload,
      };
  }
};
```

Channel/index.jsx ä¸­ï¼š

```tsx
import { useDispatch } from 'react-redux';


const Channels = ({ onClose }) => {
  const dispatch = useDispatch();


  const onChannelClick = (key) => {
    dispatch({ type: 'home/changeTab', payload: key });
    onClose();
  };


  return (
    // ...
    <div className="channel-list">
      {/* é€‰ä¸­æ—¶ï¼Œæ·»åŠ ç±»å selected */}
      {userChannel.map((item) => (
        <span
          key={item.id}
          className={classnames(
            'channel-list-item',
            channelActiveKey === item.id + '' && 'selected',
          )}
          onClick={() => onChannelClick(item.id + '')}
        >
          {item.name}
          <Icon type="iconbtn_tag_close" />
        </span>
      ))}
    </div>
  );
};
```

## 11-é¢‘é“ç®¡ç†-é¦–é¡µé¡¶éƒ¨é¢‘é“åˆ‡æ¢

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°é¦–é¡µé¢‘é“åˆ‡æ¢å’Œé«˜äº®åŠŸèƒ½

**æ­¥éª¤**ï¼š

1. åœ¨ Home ç»„ä»¶ä¸­æ‹¿åˆ°è¯¥çŠ¶æ€ï¼Œå¹¶è®¾ç½®ä¸º Tabs ç»„ä»¶çš„ activeKey
2. ä¸º Tabs ç»„ä»¶æ·»åŠ  onChangeï¼Œæ‹¿åˆ°å½“å‰é€‰ä¸­çš„ tab çš„é”®ï¼Œå¹¶ä¸”åˆ†å‘ action æ¥ä¿®æ”¹ channelActiveKey

**æ ¸å¿ƒä»£ç **ï¼š

Home/index.jsx ä¸­ï¼š

```tsx
import { useDispatch, useSelector } from 'react-redux';


const Home = () => {
  const dispatch = useDispatch();
  const { channelActiveKey } = useSelector((state) => state.home);


  const onTabChange = (key) => {
    dispatch({ type: 'home/changeTab', payload: key });
  };


  return (
    // ...
    <Tabs activeKey={channelActiveKey} onChange={onTabChange}></Tabs>
  );
};
```

## 12-é¢‘é“ç®¡ç†-åˆ é™¤é¢‘é“

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåˆ é™¤æˆ‘çš„é¢‘é“æ•°æ®

**åˆ†æè¯´æ˜**ï¼š

1. æ¨èé¢‘é“ä¸èƒ½åˆ é™¤
2. è‡³å°‘è¦ä¿ç•™ 4 ä¸ªé¢‘é“

**æ­¥éª¤**ï¼š

1. ä¿®æ”¹é¢‘é“é¡¹çš„ç‚¹å‡»äº‹ä»¶å‚æ•°ä¸º channel å³å½“å‰é¢‘é“æ•°æ®
2. åœ¨æˆ‘çš„é¢‘é“é¡¹çš„ç‚¹å‡»äº‹ä»¶ä¸­ï¼Œåˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºç¼–è¾‘çŠ¶æ€
3. å¦‚æœä¸æ˜¯ç¼–è¾‘çŠ¶æ€ï¼Œæ‰§è¡Œé¢‘é“åˆ‡æ¢æ“ä½œ
4. å¦‚æœæ˜¯ç¼–è¾‘çŠ¶æ€ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæ¨èé¢‘é“æˆ–é¢‘é“æ•°é‡å°äºç­‰äº 4
5. å¦‚æœæ˜¯ï¼Œé˜»æ­¢åˆ é™¤
6. å¦‚æœä¸æ˜¯ï¼Œåˆ†å‘åˆ é™¤é¢‘é“çš„ action

**æ ¸å¿ƒä»£ç **ï¼š

Channels/index.jsx ä¸­ï¼š

```tsx
import { delChannel } from '@/store/actions';


const Channels = () => {
  const onChannelClick = (channel: Channel) => {
    if (!isEdit) {
      dispatch({ type: 'home/changeTab', payload: channel.id + '' });
      onClose();
      return;
    }


    if (channel.id === 0) return;
    if (userChannel.length <= 4) return;
    dispatch(delChannel(channel));
  };
};
```

actions/home.jsx ä¸­ï¼š

```ts
export const delChannel = (channel) => {
  return async (dispatch, getState) => {
    const {
      login: { token },
    } = getState();


    if (token) {
      // å·²ç™»å½•
      await http.delete(`/user/channels/${channel.id}`);
    } else {
      // æœªç™»å½•
      const localChannels = JSON.parse(
        localStorage.getItem(CHANNEL_KEY) ?? '[]',
      )


      const userChannel = localChannels.filter(
        (item) => item.id !== channel.id,
      );
      localStorage.setItem(CHANNEL_KEY, JSON.stringify(userChannel));
    }
  };
};
```

## 13-é¢‘é“ç®¡ç†-åˆ é™¤é¢‘é“æ›´æ–°çŠ¶æ€

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåœ¨åˆ é™¤é¢‘é“åæ›´æ–°é¡µé¢çŠ¶æ€

**æ­¥éª¤**ï¼š

1. åœ¨åˆ é™¤é¢‘é“ action ä¸­ï¼Œåˆ†å‘ action åˆ° redux
2. åœ¨ reducers ä¸­åˆ é™¤é¢‘é“ï¼Œå¹¶å°†è¢«åˆ é™¤é¢‘é“æ·»åŠ åˆ°æ¨èé¢‘é“ä¸­

**æ ¸å¿ƒä»£ç **ï¼š

actions/home.js ä¸­ï¼š

```ts
export const delChannel = (channel) => {
  return async (dispatch, gejsxtate) => {
    // ...


    dispatch({ type: 'home/delChannel', payload: channel });
  };
};
```

reducers/home.jsx ä¸­ï¼š

```ts
import { sortBy } from 'lodash';


const Home = (state = initialState, action) => {
  switch (action.type) {
    // ...
    case 'home/delChannel':
      return {
        ...state,
        // åˆ é™¤å½“å‰é¢‘é“
        userChannel: state.userChannel.filter(
          (item) => item.id !== action.payload.id,
        ),
        // å°†è¢«åˆ é™¤é¢‘é“æ·»åŠ åˆ°æ¨èé¢‘é“ä¸­ï¼Œå¹¶ä¸”æ ¹æ® id è¿›è¡Œæ’åº
        restChannel: sortBy([...state.restChannel, action.payload], 'id'),
      };
  }
};
```

## 14-é¢‘é“ç®¡ç†-æ·»åŠ é¢‘é“

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°æ·»åŠ é¢‘é“åŠŸèƒ½**æ­¥éª¤**ï¼š

1. ä¸ºå¯é€‰é¢‘é“ä¸­çš„é¢‘é“é¡¹ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œå¹¶æ‹¿åˆ°å½“å‰è¢«ç‚¹å‡»çš„é¢‘é“
2. åœ¨ actions ä¸­æ ¹æ®æ˜¯å¦ç™»å½•å¤„ç†æ·»åŠ é¢‘é“é€»è¾‘
4. åœ¨æ·»åŠ é¢‘é“çš„ action ä¸­åˆ†å‘ action æ¥æ›´æ–° redux
5. åœ¨ reducers ä¸­å¤„ç†æ·»åŠ é¢‘é“çš„ action

**æ ¸å¿ƒä»£ç **ï¼š

Channels/index.jsx ä¸­ï¼š

```tsx
const Channels = () => {
  const onAddChannel = (channel) => {
    dispatch(addChannel(channel));
  };


  return (
    // ...
    <div className="channel-list">
      {restChannel.map((item) => (
        <span onClick={() => onAddChannel(item)}>+ {item.name}</span>
      ))}
    </div>
  );
};
```

actions/home.js ä¸­ï¼š

```ts
export const addChannel = (channel) => {
  return async (dispatch, getState) => {
    const {
      login: { token },
    } = getState();
    if (token) {
      // ç™»å½•
     await http.patch(`/user/channels`, {channels: [channel]})
    } else {
      // æœªç™»å½•
      const localChannels = JSON.parse(
        localStorage.getItem(CHANNEL_KEY) || '[]',
      )
      const userChannel = [...localChannels, channel];
      localStorage.setItem(CHANNEL_KEY, JSON.stringify(userChannel));
    }
    dispatch({ type: 'home/addChannel', payload: channel });
  };
};
```

reducers/home.js ä¸­ï¼š

```ts
const Home = () => {
  switch (action.type) {
    // ...
    case 'home/addChannel':
      return {
        ...state,
        userChannel: [...state.userChannel, action.payload],
        restChannel: state.restChannel.filter(
          (item) => item.id !== action.payload.id,
        ),
      };
  }
};
```

## 15-æ–‡ç« åˆ—è¡¨-æ ¹æ®æ¨¡æ¿æ­å»ºæ–‡ç« åˆ—è¡¨ç»“æ„

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ ¹æ®æ¨¡æ¿æ­å»ºé¢‘é“æ–‡ç« åˆ—è¡¨ç»“æ„

**æ­¥éª¤**ï¼š

1. å°†æ¨¡æ¿ ArticleItemå’ŒArticleList æ‹·è´åˆ° pages/home/componens å…¬å…±ç»„ä»¶ç›®å½•ä¸­
3. åœ¨ Home ç»„ä»¶ä¸­æ¸²æŸ“æ–‡ç« åˆ—è¡¨ç»“æ„
4. åˆ†ææ¯ä¸ªæ¨¡æ¿çš„ä½œç”¨ï¼Œä»¥åŠæ¨¡æ¿çš„ç»“æ„

**æ ¸å¿ƒä»£ç **ï¼š

Home/index.jsx ä¸­ï¼š

```tsx
import ArticleList from './componens/ArticleList';


const Home = () => {
  return (
    // ...
    <Tabs.TabPane>
      {/* åœ¨æ¯ä¸ª Tabs.TabPane ä¸­æ¸²æŸ“æ–‡ç« åˆ—è¡¨ç»„ä»¶ */}
      <ArticleList />
    </Tabs.TabPane>
  );
};
```

## 16-æ–‡ç« åˆ—è¡¨-InfiniteScroll ç»„ä»¶

**ç›®æ ‡**ï¼šèƒ½å¤Ÿä½¿ç”¨ antd-mobile çš„ InfiniteScroll ç»„ä»¶

**åˆ†æè¯´æ˜**ï¼š

InfiniteScroll ç»„ä»¶åœ¨æ¸²æŸ“æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ loadMore åŠ è½½æ–‡ç« åˆ—è¡¨æ•°æ®

- æ³¨æ„ï¼šå¯¹äº `InfiniteScroll` ç»„ä»¶æ¥è¯´ï¼Œå¦‚æœæ²¡æœ‰æ­£ç¡®å¤„ç† loadMore å‡½æ•°ï¼Œä¼šå¯¼è‡´åœ¨åŠ è½½æ•°æ®æ—¶ï¼Œé‡å¤æ‰§è¡Œå¤šæ¬¡ loadMore å‡½æ•°

```tsx
// æ­£ç¡®ï¼š
const loadMore = async () => {
  // æ­¤å¤„ï¼Œawait å¼‚æ­¥æ“ä½œå®Œæˆ
  await dispatch(getArticleListByChannelId(channelId, Date.now()));
};


// é”™è¯¯ï¼š
const loadMore = async () => {
  // æ­¤å¤„ï¼Œæ²¡æœ‰ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆï¼Œä¼šå¯¼è‡´é‡å¤å‘é€è¯·æ±‚ï¼ï¼ï¼
  dispatch(getArticleListByChannelId(channelId, Date.now()));
};
```

- å¯¹äºInfiniteScroolç»„ä»¶æ¥è¯´ï¼Œåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶ï¼Œä¼šè¿›è¡Œä»¥ä¸‹åˆ¤æ–­ï¼Œæ¥å†³å®šæ˜¯å¦åŠ è½½æ›´å¤šæ•°æ®ï¼š

  1. hasMore æ˜¯å¦ä¸º trueï¼Œå¦‚æœä¸º true è°ƒç”¨ loadMore åŠ è½½æ›´å¤šæ•°æ®
  2. è¯¥ç»„ä»¶æ‰€åœ¨ä½ç½® å‡å» å¯æ»šåŠ¨åŒºåŸŸçš„åº•éƒ¨ä½ç½®æ˜¯å¦å°äº threshold ï¼ˆé»˜è®¤å€¼ 250ï¼‰ï¼Œå¦‚æœå°äºå°±è¯´æ˜è§¦åº•äº†ï¼Œå°±ä¼šåŠ è½½æ›´å¤šæ•°æ®
  
- é€ æˆé€’å½’è·å–æ•°æ®çš„æƒ…å†µï¼šåªå‘é€è¯·æ±‚è·å–æ•°æ®ï¼Œä½†æ˜¯ï¼Œæ²¡æœ‰æ¸²æŸ“æ•°æ®ï¼Œå¯¼è‡´ä½ç½®åˆ¤æ–­ä¸€ç›´å°äº thresholdï¼Œå°±ä¼šä¸€ç›´è·å–æ•°æ®ã€‚

**æ­¥éª¤**ï¼š

1. æ‰¾åˆ° antd-mobile ç»„ä»¶åº“ä¸­çš„ InfiniteScroll ç»„ä»¶
2. æ‹·è´ç¤ºä¾‹ä»£ç åˆ° ArticleList ç»„ä»¶ä¸­
3. é€šè¿‡ç¤ºä¾‹ä»£ç ç»™å‡ºçš„æ•°æ®ï¼Œæ¸²æŸ“æ–‡ç« åˆ—è¡¨

**æ ¸å¿ƒä»£ç **ï¼š

ArticleList/index.jsx ä¸­ï¼š

```tsx
import { InfiniteScroll } from 'antd-mobile';
import { useState } from 'react';
import { sleep } from 'antd-mobile/es/utils/sleep';


let count = 0;


async function mockRequest() {
  if (count >= 5) {
    return [];
  }
  await sleep(2000);
  count++;
  return [
    'A',
    'B',
    'C',
    'D',
    'E',
    'F',
    'G',
    'H',
    'I',
    'J',
    'K',
    'L',
    'M',
    'N',
    'O',
    'P',
    'Q',
  ];
}
const ArticleList = () => {
  const [data, setData] = useState([]);
  const [hasMore, setHasMore] = useState(true);
  async function loadMore() {
    const append = await mockRequest();
    setData((val) => [...val, ...append]);
    setHasMore(append.length > 0);
  }

  return (
    <div className={styles.root}>
      {/* æ–‡ç« åˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹ */}
      {data.map((item, index) => (
        <div key={index} className="article-item">
          <ArticleItem type={1} />
        </div>
      ))}
      {/*
        loadMore åŠ è½½æ•°æ®çš„å‡½æ•°
        hasMore å¸ƒå°”å€¼ï¼Œtrue è¡¨ç¤ºè¿˜æœ‰æ›´å¤šæ•°æ®ï¼›false è¡¨ç¤ºæ²¡æœ‰æ›´å¤šæ•°æ®äº†
      */}
      <InfiniteScroll loadMore={loadMore} hasMore={hasMore} />
    </div>
  );
};
```

**æ€»ç»“**ï¼š

1. InfiniteScroll ç»„ä»¶ä¼šè‡ªåŠ¨è°ƒç”¨ loadMore åŠ è½½æ•°æ®å—ï¼Ÿå¦‚æœ hasMore ä¸º trueï¼Œå°±ä¼šè‡ªåŠ¨åŠ è½½æ•°æ®ï¼›å¦åˆ™ï¼Œä¸ä¼šè‡ªåŠ¨åŠ è½½

- è¯¥ç»„ä»¶ä¼šè‡ªåŠ¨å¡«æ»¡å¯æ»šåŠ¨åŒºåŸŸï¼Œå¹¶ä¸”ä¿è¯è§¦å‘åŠ è½½äº‹ä»¶çš„æ»šåŠ¨è§¦åº•è·ç¦»é˜ˆå€¼ï¼ˆthresholdï¼‰å¤§äºç­‰äº 250

## 17-æ–‡ç« åˆ—è¡¨-è·å–é¢‘é“æ–‡ç« åˆ—è¡¨æ•°æ®

**ç›®æ ‡**ï¼šèƒ½å¤Ÿè·å–é¢‘é“æ–‡ç« åˆ—è¡¨æ•°æ®

**æ­¥éª¤**ï¼š

1. ç»™ ArticleList ç»„ä»¶ä¼ é€’é¢‘é“ id
3. åœ¨ actions ä¸­åˆ›å»ºè·å–æ–‡ç« åˆ—è¡¨æ•°æ®çš„ action
4. å‘é€è¯·æ±‚ï¼Œè·å–é¢‘é“æ–‡ç« åˆ—è¡¨æ•°æ®
5. åœ¨ ArticleList ç»„ä»¶ä¸­çš„ loadMore å†…éƒ¨åˆ†å‘è·å–é¢‘é“æ–‡ç« åˆ—è¡¨æ•°æ®çš„ action

**æ ¸å¿ƒä»£ç **ï¼š

Home/index.jsx ä¸­ï¼š

```tsx
const Home = () => {
  return (
    // ...
    <Tabs>
      {userChannel.map((item) => (
        <Tabs.TabPane title={item.name} key={item.id}>
          {/* ä¼ é€’é¢‘é“ id */}
          <ArticleList channelId={item.id} />
        </Tabs.TabPane>
      ))}
    </Tabs>
  );
};
```

ArticleList/index.jsx ä¸­ï¼š

```tsx
import { getArticleList } from '@/store/actions';
import { useDispatch } from 'react-redux';


const ArticleList = ({ channelId }) => {
  const [data, setData] = useState([]);
  const [hasMore, setHasMore] = useState(true);
  const dispatch = useDispatch();


  const loadMore = async () => {
    const timestamp = +new Date() + '';
    await dispatch(getArticleList(channelId, timestamp));
  };


  return (
    <div className={styles.root}>
      {/* æ–‡ç« åˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹ */}


      {data.map((item, index) => (
        <div key={index} className="article-item">
          <ArticleItem type={1} />
        </div>
      ))}


      <InfiniteScroll loadMore={loadMore} hasMore={hasMore} />
    </div>
  );
};
```

actions/home.jsä¸­ï¼š

```ts



export const getArticleList = (
  channel_id,
  timestamp,
) => {
  return async (dispatch) => {
      const res = await http.get('/articles', {
        params: {
          channel_id,
          timestamp,
        },
      });


    console.log(res);
  };
};
```

## 18-æ–‡ç« åˆ—è¡¨-å°†é¢‘é“æ–‡ç« åˆ—è¡¨æ•°æ®å­˜å‚¨åˆ° redux

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ ¼å¼åŒ–é¢‘é“æ–‡ç« åˆ—è¡¨æ•°æ®å¹¶å­˜å‚¨åˆ° redux ä¸­

**åˆ†æè¯´æ˜**ï¼š

é—®é¢˜ï¼šç”¨ä»€ä¹ˆæ ·çš„æ•°æ®æ ¼å¼å­˜å‚¨é¢‘é“æ–‡ç« åˆ—è¡¨æ•°æ®ï¼Ÿ åˆ†æï¼šæ¯ä¸ªé¢‘é“ï¼Œéƒ½å¯¹åº”åˆ°ä¸€ä¸ªæ–‡ç« åˆ—è¡¨æ•°æ®

```ts
// æ¨èé¢‘é“
1 ==> {}
// html é¢‘é“
2 ==> {}
// å¼€å‘è€…èµ„è®¯é¢‘é“
3 ==> {}
```

ä¸ºäº†é«˜æ•ˆçš„å­˜å–æ•°æ®ï¼Œæˆ‘ä»¬ä½¿ç”¨ `å¯¹è±¡` æ¥å­˜å‚¨é¢‘é“æ–‡ç« åˆ—è¡¨æ•°æ®

```ts
// æ•°æ®æ ¼å¼ï¼š
channelArticles = {
  1: {},
  2: {},
  3: {}
}


// æ ¹æ®é¢‘é“ id å–æ•°æ®
channelArticles[2]


// æ ¹æ®é¢‘é“ id å­˜æ•°æ®
{
  ...channelArticles,
  [channelId]: articles
}
```

ä¸¾ä¾‹è¯´æ˜ æ•°ç»„ å’Œ å¯¹è±¡ å­˜å–æ•°æ®çš„å·®å¼‚ï¼š

```ts
// ä½¿ç”¨æ•°ç»„å­˜å–æ•°æ®
const arr = [{ id: 1 }, { id: 2 }, { id: 4 }]


// å–æ•°æ®ï¼š æ ¹æ® id æ¥è·å–
// 		ä¸ç®¡æ˜¯å¦ç”¨ find è¿™æ ·çš„æ–¹æ³•ï¼Œéƒ½éœ€è¦éå†
arr.find(item => item.id === 2)


// æ”¹æ•°æ®ï¼š
arr.map(item => {
  if (item.id === 2) {
    return { ...item, è¦ä¿®æ”¹çš„æ•°æ® }
  }
  return item
})




// -----




// ä½¿ç”¨å¯¹è±¡å­˜å–æ•°æ®
const obj = {
  // id: å€¼
  1: { id: 1 },
  2: { id: 2 },
  3: { id: 3 },
}


// å–æ•°æ®ï¼š æ ¹æ® id æ¥è·å–æ•°æ®
obj[2]


// æ”¹æ•°æ®ï¼š
{
  ...obj,
  2: è¦ä¿®æ”¹çš„æ•°æ®
}
```



**æ­¥éª¤**ï¼š



1. åœ¨ actions ä¸­ï¼Œåˆ†å‘ action å°†çŠ¶æ€ä¿å­˜åˆ° redux ä¸­
2. åœ¨ reducers ä¸­ï¼Œæ·»åŠ é¢‘é“æ–‡ç« åˆ—è¡¨æ•°æ®çš„ç±»å‹å’Œé»˜è®¤å€¼
3. å¤„ç†è·å–é¢‘é“æ–‡ç« åˆ—è¡¨çš„ actionï¼Œ**è¿½åŠ **æ–‡ç« åˆ—è¡¨æ•°æ®åˆ°çŠ¶æ€ä¸­

**æ ¸å¿ƒä»£ç **ï¼š

actions/home.js ä¸­ï¼š

```ts
export const getArticleList = () => {
  return async (dispatch) => {
    // ...


    // åˆ†å‘ action
    dispatch({
      type: 'home/getChannelArticles',
      payload: {
        channelId: channel_id,
        data: res.data.data,
      },
    });
  };
};
```

reducers/home.jsx ä¸­ï¼š

```ts
const initialState = {
    channelArticles: {},
};


const Home = (state = initialState, action) => {
  switch (action.type) {
    // ...
    case 'home/getChannelArticles':
      // æ³¨æ„ï¼šå½“å‰é¢‘é“çš„æ–‡ç« åˆ—è¡¨æ•°æ®å¯èƒ½ä¸ºç©ºï¼ˆæ¯”å¦‚ï¼Œç¬¬ä¸€æ¬¡åŠ è½½ï¼‰ï¼Œä¸ºäº†æ–¹ä¾¿åç»­æ“ä½œ
      //      æ­¤å¤„ä¸ºå…¶æŒ‡å®šé»˜è®¤å€¼
      const curChannelArticles = state.channelArticles[
        action.payload.channelId
      ] || {pre_timestamp: null, results: []}
      const {
        channelId,
        data: { pre_timestamp, results },
      } = action.payload;


      return {
        ...state,
        channelArticles: {
          ...state.channelArticles,
          // ä¿®æ”¹å½“å‰é¢‘é“å¯¹åº”çš„æ–‡ç« åˆ—è¡¨æ•°æ®
          [channelId]: {
            pre_timestamp,
            // è¿½åŠ æ–‡ç« åˆ—è¡¨æ•°æ®
            results: [...curChannelArticles.results, ...results],
          },
        },
      };
  }
};
```

## 19-æ–‡ç« åˆ—è¡¨-è§¦åº•åŠ è½½æ›´å¤šæ–‡ç« åˆ—è¡¨é¡¹

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°è§¦åº•åŠ è½½æ›´å¤šæ–‡ç« åˆ—è¡¨é¡¹

**åˆ†æè¯´æ˜**ï¼š

1. å¦‚ä½•åŠ è½½å‰ä¸€é¡µçš„æ•°æ®ï¼Ÿä¼ é€’æ¥å£è¿”å›çš„ pre_timestamp
2. æ˜¯å¦æœ‰æ›´å¤šæ•°æ®ï¼šå¦‚æœæ²¡æœ‰æ›´å¤šæ–‡ç« æ•°æ®ï¼Œåˆ™ pre_timestamp ä¸º null

- æ³¨æ„ï¼šå¯¹äº `InfiniteScroll` ç»„ä»¶æ¥è¯´ï¼Œå¦‚æœæ²¡æœ‰æ­£ç¡®å¤„ç† loadMore å‡½æ•°ï¼Œä¼šå¯¼è‡´åœ¨åŠ è½½æ•°æ®æ—¶ï¼Œé‡å¤æ‰§è¡Œå¤šæ¬¡ loadMore å‡½æ•°

```tsx
// æ­£ç¡®ï¼š
const loadMore = async () => {
  // æ­¤å¤„ï¼Œawait å¼‚æ­¥æ“ä½œå®Œæˆ
  await dispatch(getArticleListByChannelId(channelId, Date.now()));
};


// é”™è¯¯ï¼š
const loadMore = async () => {
  // æ­¤å¤„ï¼Œæ²¡æœ‰ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆï¼Œä¼šå¯¼è‡´é‡å¤å‘é€è¯·æ±‚ï¼ï¼ï¼
  dispatch(getArticleListByChannelId(channelId, Date.now()));
};
```

- å¯¹äºInfiniteScroolç»„ä»¶æ¥è¯´ï¼Œåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶ï¼Œä¼šè¿›è¡Œä»¥ä¸‹åˆ¤æ–­ï¼Œæ¥å†³å®šæ˜¯å¦åŠ è½½æ›´å¤šæ•°æ®ï¼š

  1. hasMore æ˜¯å¦ä¸º trueï¼Œå¦‚æœä¸º true è°ƒç”¨ loadMore åŠ è½½æ›´å¤šæ•°æ®
  2. è¯¥ç»„ä»¶æ‰€åœ¨ä½ç½® å‡å» å¯æ»šåŠ¨åŒºåŸŸçš„åº•éƒ¨ä½ç½®æ˜¯å¦å°äº threshold ï¼ˆé»˜è®¤å€¼ 250ï¼‰ï¼Œå¦‚æœå°äºå°±è¯´æ˜è§¦åº•äº†ï¼Œå°±ä¼šåŠ è½½æ›´å¤šæ•°æ®
  
- é€ æˆé€’å½’è·å–æ•°æ®çš„æƒ…å†µï¼šåªå‘é€è¯·æ±‚è·å–æ•°æ®ï¼Œä½†æ˜¯ï¼Œæ²¡æœ‰æ¸²æŸ“æ•°æ®ï¼Œå¯¼è‡´ä½ç½®åˆ¤æ–­ä¸€ç›´å°äº thresholdï¼Œå°±ä¼šä¸€ç›´è·å–æ•°æ®ã€‚

**æ­¥éª¤**ï¼š

1. åœ¨ ArticleList ç»„ä»¶ä¸­æ‹¿åˆ°é¢‘é“æ–‡ç« åˆ—è¡¨æ•°æ®
2. æ ¹æ®å½“å‰é¢‘é“ id æ‹¿åˆ°å½“å‰é¢‘é“çš„æ–‡ç« åˆ—è¡¨æ•°æ®ï¼Œå¹¶å¤„ç†é»˜è®¤å€¼é—®é¢˜(é¦–æ¬¡åŠ è½½æ²¡æœ‰æ–‡ç« æ•°æ®)
3. ä¿®æ”¹åˆ¤æ–­æ˜¯å¦æœ‰æ›´å¤šæ–‡ç« åˆ—è¡¨æ•°æ®çš„é€»è¾‘(é€šè¿‡è¿”å›çš„æ—¶é—´æˆ³å­—æ®µæ¥ç¡®å®š)
4. æ¸²æŸ“æ–‡ç« åˆ—è¡¨æ•°æ®

**æ ¸å¿ƒä»£ç **ï¼š

ArticleList/index.jsx ä¸­ï¼š

```jsx
import styles from './index.module.scss';
import { getArticleList } from '@/store/actions';
import { useDispatch, useSelector } from 'react-redux';


const ArticleList = ({ channelId }) => {
  const dispatch = useDispatch();
  // è·å–å½“å‰é¢‘é“çš„æ–‡ç« åˆ—è¡¨æ•°æ®
  const { channelArticles } = useSelector((state) => state.home);
  // æ³¨æ„ï¼šæ­¤å¤„çš„ é¢‘é“å¯¹åº”çš„ æ–‡ç« åˆ—è¡¨æ•°æ®ï¼Œå¯èƒ½æ˜¯ä¸å­˜åœ¨çš„ï¼Œæ‰€ä»¥ï¼Œæ­¤å¤„è®¾ç½®é»˜è®¤å€¼
  const currentChannelArticle = channelArticles[channelId] || {
    pre_timestamp: Date.now() + '',
    results: [],
  };
  // pre_timestamp æ—¶é—´æˆ³
  // resuljsx è¯¥é¢‘é“çš„æ–‡ç« åˆ—è¡¨æ•°æ®
  const { pre_timestamp, results } = currentChannelArticle;


  // åŠ è½½æ›´å¤šæ•°æ®çš„å‡½æ•°
  const loadMore = async () => {
    await dispatch(getArticleListByChannelId(channelId, pre_timestamp));
  };


  // æ˜¯å¦åŠ è½½æ›´å¤šæ•°æ®çš„æ¡ä»¶ï¼š
  // å¦‚æœ pre_timestamp å€¼ä¸º null è¯´æ˜æ²¡æœ‰æ›´å¤šæ•°æ®äº†
  // æ­¤æ—¶ï¼Œ hasMore å€¼ä¸º falseï¼Œé‚£ä¹ˆï¼ŒInfiniteScroll ç»„ä»¶å°±ä¸ä¼šå†æ¬¡è·å–æ•°æ®äº†
  const hasMore = pre_timestamp !== null;


  return (
    <div className={styles.root}>
      {articles.map((item, index) => (
        <div key={index} className="article-item">
          <ArticleItem type={1} />
        </div>
      ))}


      <InfiniteScroll loadMore={loadMore} hasMore={hasMore} />
    </div>
  );
};
```

è¯´æ˜ 1ï¼šä½¿ç”¨ InfiniteScroll ç»„ä»¶ï¼Œè¿›å…¥é¡µé¢å°±ä¼šä¸€ç›´ä¸åœçš„åŠ è½½æ‰€æœ‰æ–‡ç« åˆ—è¡¨æ•°æ®ï¼Œå¯èƒ½æ˜¯ä»¥ä¸‹åŸå› é€ æˆçš„ï¼š

1. åªæ›´æ–°æ–‡ç« åˆ—è¡¨çŠ¶æ€ï¼Œæ²¡æœ‰æ¸²æŸ“æ–‡ç« åˆ—è¡¨æ•°æ®ã€‚å¯¼è‡´ï¼ŒInfiniteScroll ç»„ä»¶æ„Ÿè§‰æœ‰æ›´å¤šæ•°æ®ï¼ˆä¸€ç›´æ²¡æœ‰è§¦åº•ï¼‰ï¼Œå°±ä¼šä¸€ç›´åŠ è½½æ•°æ®
2. æ ·å¼é€ æˆçš„é—®é¢˜ï¼šè¦ä¿è¯ä» html => body => #root => .app => Layout_root => Home_root => adm-tabs tabs => adm-tabs-content => ArticleList_root çš„é«˜åº¦éƒ½ä¸º 100%ï¼Œä¹Ÿå°±æ˜¯**æ–‡ç« åˆ—è¡¨å†…å®¹çš„å…¨éƒ¨çˆ¶çº§å…ƒç´ éƒ½è¦è®¾ç½®é«˜åº¦**ã€‚æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œè¦å æ»¡æ•´ä¸ªå±å¹•ï¼Œæ‰€ä»¥é«˜åº¦ä¸ºï¼š100%ã€‚è¿™æ ·ï¼Œæ‰èƒ½ä¿è¯æ–‡ç« åˆ—è¡¨å†…å®¹è¶…é•¿æ—¶ï¼Œå‡ºç°åŒºåŸŸï¼ˆæ–‡ç« åˆ—è¡¨åŒºåŸŸï¼‰æ»šåŠ¨ã€‚InfiniteScroll ç»„ä»¶æ˜¯ç›¸å¯¹äºæœ€è¿‘çš„ä¸€ä¸ª**å¯æ»šåŠ¨çš„çˆ¶å…ƒç´ **ï¼Œæ¥åˆ¤æ–­ä½ç½®çš„ï¼Œæ‰€ä»¥ï¼Œåœ¨ ArticleList_root çˆ¶å…ƒç´ ä¸­ è®¾ç½®äº† `overflow-y: scroll`ï¼Œä¹Ÿå°±æ˜¯ï¼Œ**åˆ¤æ–­ InfiniteScroll ç»„ä»¶æ‰€åœ¨ä½ç½®æ˜¯å¦è¶…è¿‡ ArticleLIist_root å…ƒç´ çš„è§†å£ threshold é˜ˆå€¼**ï¼Œæ²¡è¶…è¿‡ä¹Ÿå°±æ˜¯è§¦åº•äº†ï¼Œæ­¤æ—¶å°±ç»§ç»­è·å–æ•°æ®ï¼Œç›´åˆ°è¶…è¿‡ threshold é˜ˆå€¼ã€‚

è¯´æ˜ 2ï¼šæ–‡ç« åˆ—è¡¨æ•°æ®è§¦åº•åŠ è½½æ›´å¤šçš„æ¡ä»¶æ˜¯ï¼Œ**æ¯æ¬¡éƒ½æ‹¿åˆ°ä¸Šä¸€æ¬¡è¯·æ±‚è¿”å›çš„æ—¶é—´æˆ³ï¼Œæ ¹æ®è¯¥æ—¶é—´æˆ³æ¥è·å–ä¸‹ä¸€é¡µæ•°æ®**

```ts
ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼š ä¼ å…¥æœ€æ–°çš„æ—¶é—´æˆ³ Date.now() 				 ===> æ¥å£è¿”å›ï¼š { pre_timestamp1, resuljsx }
ç¬¬äºŒæ¬¡è¯·æ±‚ï¼š ä¼ å…¥ä¸Šæ¬¡è¿”å›çš„æ—¶é—´æˆ³ pre_timestamp1 	===> æ¥å£è¿”å›ï¼š { pre_timestamp2, resuljsx }
ç¬¬äºŒæ¬¡è¯·æ±‚ï¼š ä¼ å…¥ä¸Šæ¬¡è¿”å›çš„æ—¶é—´æˆ³ pre_timestamp2 	===> æ¥å£è¿”å›ï¼š { pre_timestamp3, resuljsx }


...
```

## 20-æ–‡ç« åˆ—è¡¨-ä¸‹æ‹‰åŠ è½½æ›´å¤šæ–‡ç« æ•°æ®

**ç›®æ ‡**ï¼šèƒ½å¤Ÿä¸‹æ‹‰åŠ è½½æ›´å¤šæ–‡ç« æ•°æ®

**æ­¥éª¤**ï¼š

1. å¯¼å…¥ antd-mobile çš„ PullToRefresh ä¸‹æ‹‰åˆ·æ–°ç»„ä»¶
2. ä½¿ç”¨ä¸‹æ‹‰åˆ·æ–°ç»„ä»¶è·å–æœ€æ–°æ•°æ®

**æ ¸å¿ƒä»£ç **ï¼š

Home/index.jsx ä¸­ï¼š

```tsx
import { PullToRefresh } from 'antd-mobile';


const ArticleList = () => {
  // ä¸‹æ‹‰åˆ·æ–°æ–‡ç« åˆ—è¡¨
  const onRefresh = async () => {
    await dispatch(getArticleList(channelId, Date.now() + ''));
  };


  return (
    // ...
    <PullToRefresh onRefresh={onRefresh}>
      {renderArticleList()}
      <InfiniteScroll loadMore={loadMore} hasMore={hasMore} />
    </PullToRefresh>
  );
};
```



## 20-æ–‡ç« åˆ—è¡¨-æ¸²æŸ“æ–‡ç« åˆ—è¡¨é¡¹å†…å®¹

**ç›®æ ‡**ï¼šèƒ½å¤Ÿé€šè¿‡æ–‡ç« åˆ—è¡¨æ•°æ®æ¸²æŸ“æ–‡ç« åˆ—è¡¨é¡¹å†…å®¹

**åˆ†æè¯´æ˜**ï¼š

æˆ‘ä»¬ä½¿ç”¨ dayjs æ¥æ ¼å¼åŒ–æ—¥æœŸï¼Œæ–‡ç« åˆ—è¡¨é¡¹éœ€è¦ç”¨åˆ°ç›¸å¯¹æ—¶é—´å’Œå›½é™…åŒ–ï¼š

[dayjs å›½é™…åŒ–æ–‡æ¡£](https://dayjs.gitee.io/docs/zh-CN/i18n/loading-into-browser)[dayjs ç›¸å¯¹æ—¶é—´æ’ä»¶](https://dayjs.gitee.io/docs/zh-CN/plugin/relative-time)

**æ­¥éª¤**ï¼š

1. å®‰è£… dayjsï¼š`yarn add dayjs`
2. å¯ç”¨ç›¸å¯¹æ—¶é—´æ’ä»¶ï¼Œå¹¶å°†è¯­è¨€è®¾ç½®ä¸º zh-cn ä¸­æ–‡
3. åˆ›å»º renderArticleList å‡½æ•°ï¼Œæ¥æ¸²æŸ“æ–‡ç« åˆ—è¡¨
4. æ ¹æ®æ–‡ç« åˆ—è¡¨é¡¹çš„æ•°æ®æ ¼å¼ï¼Œä¸º ArticleItem ç»„ä»¶è®¾ç½® props
5. ç»„è£…å¥½æ–‡ç« åˆ—è¡¨é¡¹æ•°æ®ï¼Œä¼ é€’ç»™ ArticleItem ç»„ä»¶
6. ArticleItem ç»„ä»¶å†…éƒ¨æ¥æ”¶æ•°æ®å¹¶æ¸²æŸ“

**æ ¸å¿ƒä»£ç **ï¼š

ArticleList/index.jsx ä¸­ï¼š

```tsx
const ArticleList = ({ channelId }) => {
  const renderArticleList = () => {
    return articles.map((item, index) => {
      const {
        title,
        pubdate,
        comm_count,
        aut_name,
        cover: { type, images },
      } = item;


      const articleData = {
        title,
        pubdate,
        comm_count,
        aut_name,
        type,
        images,
      };


      return (
        <div key={index} className="article-item">
          <ArticleItem {...articleData} />
        </div>
      );
    });
  };


  return (
    <div className={styles.root}>
      // ...
      {renderArticleList()}
    </div>
  );
};
```

ArticleItem/index.jsx ä¸­ï¼š

```tsx
import dayjs from 'dayjs';
// ç›¸å¯¹æ—¶é—´æ’ä»¶
import relativeTime from 'dayjs/plugin/relativeTime';
// å›½é™…åŒ– - ä¸­æ–‡
import 'dayjs/locale/zh-cn';
// å¯ç”¨ç›¸å¯¹æ—¶é—´
dayjs.extend(relativeTime);
// å¯ç”¨ä¸­æ–‡
dayjs.locale('zh-cn');


const ArticleItem = ({
  type,
  title,
  pubdate,
  comm_count,
  aut_name,
  images,
}) => {
  return (
    <div className={styles.root}>
      <div
        className={classnames(
          'article-content',
          type === 3 && 't3',
          type === 0 && 'none-mt',
        )}
      >
        <h3>{title}</h3>
        {type !== 0 && (
          <div className="article-imgs">
            {/* æ¸²æŸ“æ–‡ç« çš„å°é¢å›¾ç‰‡ */}
            {images.map((item, index) => (
              <div key={index} className="article-img-wrapper">
                <img src={item} alt="" />
              </div>
            ))}
          </div>
        )}
      </div>
      <div className={classnames('article-info', type === 0 && 'none-mt')}>
        <span>{aut_name}</span>
        <span>{comm_count} è¯„è®º</span>
        <span>{dayjs().from(dayjs(pubdate))}</span>
        <span className="close">
          <Icon type="iconbtn_essay_close" />
        </span>
      </div>
    </div>
  );
};
```

## 21-æ–‡ç« åˆ—è¡¨-ç‚¹å‡»æ–‡ç« é¡¹è·³è½¬åˆ°è¯¦æƒ…

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåœ¨ç‚¹å‡»æ–‡ç« é¡¹æ—¶è·³è½¬åˆ°æ–‡ç« è¯¦æƒ…é¡µé¢

**æ­¥éª¤**ï¼š

1. å°†æ–‡ç« è¯¦æƒ…é¡µé¢æ¨¡æ¿æ‹·è´åˆ° pages ç›®å½•ä¸­
2. åœ¨ App ç»„ä»¶ä¸­é…ç½®æ–‡ç« è¯¦æƒ…é¡µè·¯ç”±
3. ä¸ºæ¯ä¸ªæ–‡ç« åˆ—è¡¨é¡¹ç»‘å®šç‚¹å‡»äº‹ä»¶
4. ç‚¹å‡»æ—¶ï¼Œæ ¹æ®æ–‡ç«  idï¼Œè·³è½¬åˆ°æ–‡ç« è¯¦æƒ…é¡µå¯¹åº”çš„è·¯ç”±

**æ ¸å¿ƒä»£ç **ï¼š

ArticleList/index.jsx ä¸­ï¼š

```tsx
import { useHistory } from 'react-router-dom';


const ArticleList = () => {
  const history = useHistory();


  const renderArticleList = () => {
    return articles.map((item, index) => {
      return <div onClick={() => history.push(`/article/${art_id}`)}></div>;
    });
  };
};
```

App.jsx ä¸­ï¼š

```tsx
// å¯¼å…¥è·¯ç”±
import { Router, Route } from 'react-router-dom';


import Article from './pages/Article';


function App() {
  return (
    <Router history={history}>
      <div className="app">
        <Route path="/article/:artId">
          <Article />
        </Route>
      </div>
    </Router>
  );
}
```