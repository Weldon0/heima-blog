---
title: ğŸ“šæå®¢å›­M-7ã€æ–‡ç« è¯¦æƒ…ã€‘
---

## 01-æ–‡ç« è¯¦æƒ…ç»“æ„

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ ¹æ®æ¨¡æ¿æ­å»ºæ–‡ç« è¯¦æƒ…é¡µé¢ç»“æ„

**æ­¥éª¤**ï¼š

1. å°†æ–‡ç« è¯¦æƒ…é¡µé¢çš„æ¨¡æ¿æ‹·è´åˆ° pages ç›®å½•ä¸­
2. åœ¨ App ç»„ä»¶ä¸­é…ç½®æ–‡ç« è¯¦æƒ…é¡µé¢çš„è·¯ç”±

## 02-è·å–æ–‡ç« è¯¦æƒ…

**ç›®æ ‡**ï¼šèƒ½å¤Ÿè·å–æ–‡ç« è¯¦æƒ…æ•°æ®

**æ­¥éª¤**ï¼š

1. åˆ›å»ºæ–‡ç« è¯¦æƒ…çš„ reducer å¹¶åˆå¹¶åˆ°æ ¹ reducer ä¸­
2. åˆ›å»ºæ–‡ç« è¯¦æƒ…çš„ action å¹¶å‘é€è¯·æ±‚è·å–æ•°æ®
3. åœ¨æ–‡ç« è¯¦æƒ…é¡µé¢ä¸­åˆ†å‘ action è·å–æ•°æ®

**æ ¸å¿ƒä»£ç **ï¼š



reduers/article.js ä¸­ï¼š

```ts

const article = (state = initialState, action) => {
  if (action.type === 'article/get') {
    return {
      ...state,
      detail: action.payload,
    };
  }
  return state;
};


export default article;
```

reduers/index.js ä¸­ï¼š

```ts
import article from './article';


const rootReducer = combineReducers({
  // ...
  article,
});
```

actions/article.js ä¸­ï¼š

```ts

import { http } from '@/utils';


// è·å–æ–‡ç« è¯¦æƒ…
export const getArticleById = (id) => {
  return async (dispatch) => {
      const res = await http.get(`/articles/${id}`);
    dispatch({
      type: 'article/get',
      payload: res.data.data,
    });
  };
};
```

pages/Article/index.jsx ä¸­ï¼š

```tsx
import { useInitialState } from '@/utils/use-initial-state';
import { getArticleById } from '@/store/actions/article';


const Article = () => {
  // è·å–æ–‡ç« è¯¦æƒ…
  const { detail } = useInitialState(
    () => getArticleById(params.artId),
    'article',
  );
  // ...
};
```

## 03-æ¸²æŸ“æ–‡ç« è¯¦æƒ…

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ¸²æŸ“æ–‡ç« è¯¦æƒ…ä¿¡æ¯

**åˆ†æè¯´æ˜**ï¼š

[å‚è€ƒï¼šdayjs æœ¬åœ°æ¢åŒ–æ ¼å¼](https://day.js.org/docs/zh-CN/display/format#æœ¬åœ°åŒ–æ ¼å¼)

ä½¿ç”¨ dayjs çš„æœ¬åœ°åŒ–æ ¼å¼ï¼Œå¯ä»¥å±•ç¤ºï¼š`2021å¹´10å¹´24æ—¥` æ ¼å¼çš„æ—¥æœŸ

```ts
import dayjs from 'dayjs';
// å¯¼å…¥æœ¬åœ°åŒ–æ ¼å¼æ’ä»¶
import localizedFormat from 'dayjs/plugin/localizedFormat';
dayjs.extend(localizedFormat);


// '2021-10-24 10:24:00' => '2021å¹´10æœˆ24æ—¥'
dayjs(detail.pubdate).locale('zh-cn').format('LL');
```

**æ­¥éª¤**ï¼š

1. åœ¨è·å–æ–‡ç« è¯¦æƒ…çš„ action ä¸­ï¼Œæ ¼å¼åŒ–æ—¥æœŸ
2. åœ¨æ–‡ç« è¯¦æƒ…é¡µé¢ä¸­ï¼Œæ‹¿åˆ°æ–‡ç« è¯¦æƒ…æ•°æ®ï¼Œå¹¶æ¸²æŸ“åœ¨é¡µé¢ä¸­

**æ ¸å¿ƒä»£ç **ï¼š

actions/article.js ä¸­ï¼š

```ts
// å¯¼å…¥ dayjs ç›¸å…³åŒ…
import dayjs from 'dayjs';
import localizedFormat from 'dayjs/plugin/localizedFormat';
dayjs.extend(localizedFormat);


export const getArticleById = (id) => {
  return async (dispatch) => {
    const res = await http.get(`/articles/${id}`);
    const detail = res.data.data;
    dispatch({
      type: 'article/get',
      payload: {
        ...detail,
        // æ ¼å¼åŒ–æ—¥æœŸï¼š
        pubdate: dayjs(detail.pubdate).locale('zh-cn').format('LL'),
      },
    });
  };
};
```

pages/Article/index.jsx ä¸­ï¼š

```tsx
const { detail } = useInitialState(
  () => getArticleById(params.artId),
  'article',
);


// è§£æ„å‡ºæ–‡ç« è¯¦æƒ…æ•°æ®ï¼š
const {
  // art_id,
  // aut_id,
  // // æ˜¯å¦ç‚¹èµ
  // attitude,
  // // æ˜¯å¦æ”¶è—
  // is_collected,
  content,
  is_followed,
  aut_name,
  aut_photo,
  comm_count,
  like_count,
  pubdate,
  read_count,
  title,
} = detail;


// åœ¨ JSX ä¸­æ¸²æŸ“æ•°æ®...
```

## 04-æ¸²æŸ“æ–‡ç« å†…å®¹

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ¸²æŸ“ HTML å­—ç¬¦ä¸²æ ¼å¼çš„æ–‡ç« å†…å®¹

**åˆ†æè¯´æ˜**ï¼š

[å‚è€ƒï¼šReact çš„ dangerouslySetInnerHTML](https://zh-hans.reactjs.org/docs/dom-elements.html#dangerouslysetinnerhtml)

[å‚è€ƒï¼šMDN innerHTML å®‰å…¨é—®é¢˜](https://developer.mozilla.org/zh-CN/docs/Web/API/Element/innerHTML#å®‰å…¨é—®é¢˜)

`dangerouslySetInnerHTML` æ˜¯ React ä¸ºæµè§ˆå™¨ DOM æä¾› `innerHTML` çš„æ›¿æ¢æ–¹æ¡ˆï¼Œç”¨æ¥åœ¨ JSX ä¸­æ¸²æŸ“ HTML æ ¼å¼çš„å­—ç¬¦ä¸²å†…å®¹

é€šå¸¸æ¥è®²ï¼Œä½¿ç”¨ä»£ç ç›´æ¥è®¾ç½® HTML å­˜åœ¨é£é™©ï¼Œå› ä¸ºå¾ˆå®¹æ˜“æ— æ„ä¸­ä½¿ç”¨æˆ·æš´éœ²äº[è·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰](https://baike.baidu.com/item/è·¨ç«™è„šæœ¬æ”»å‡»/8186208)çš„æ”»å‡»

**HTML 5 ä¸­è§„å®šï¼šä¸æ‰§è¡Œç”± `innerHTML` æ’å…¥çš„ `<script>` æ ‡ç­¾ã€‚**

ä½†æ˜¯ï¼Œæœ‰å¾ˆå¤šä¸ä¾èµ– script æ ‡ç­¾å»æ‰§è¡Œ JavaScript çš„æ–¹å¼ã€‚æ¯”å¦‚ï¼Œä»¥ä¸‹ä»£ç ä¼šæ‰§è¡Œ alert å¼¹çª—ï¼Œé€ æˆå®‰å…¨é—®é¢˜ï¼š

```tsx
// æ³¨æ„ï¼šæ­¤å¤„å›¾ç‰‡çš„ onerror å±æ€§çš„ä»£ç ï¼Œè¿˜æ˜¯ä¼šè¢«æ‰§è¡Œï¼Œä¸ä»…å½±å“äº†ç”¨æˆ·ä½“éªŒï¼Œè¿˜ä¼šå­˜åœ¨ XSS æ”»å‡»é—®é¢˜
<div
  className="content-html dg-html"
  dangerouslySetInnerHTML={{
    __html: "<img src='x' onerror='alert(1)'>",
  }}
></div>
```

å› æ­¤ï¼Œä¸ºäº†å®‰å…¨å¯ä»¥é€šè¿‡ç±»ä¼¼äº `dompurify` åŒ…ï¼Œæ¥å¯¹ HTML å­—ç¬¦ä¸²å†…å®¹è¿›è¡Œâ€œæ¶ˆæ¯’â€ï¼š

```tsx
import DOMPurify from 'dompurify';


// æ¯”å¦‚ï¼Œå°† '<div><script>alert(111)</script></div>' è½¬åŒ–ä¸ºï¼š '<div></div>'
// æ¯”å¦‚ï¼Œå°† '<img src="x" onerror="alert(1)">' è½¬åŒ–ä¸ºï¼š'<img src="x" />'
const clean = DOMPurify.sanitize(dirty);
```

**æ­¥éª¤**ï¼š

1. å®‰è£… dompurify å’Œ ç±»å‹å£°æ˜æ–‡ä»¶ï¼š`yarn add dompurify`
2. å¯¼å…¥ dompurify åŒ…
3. é€šè¿‡ dangerouslySetInnerHTML æ¥å±•ç¤ºæ¶ˆæ¯’åçš„ HTML å†…å®¹

**æ ¸å¿ƒä»£ç **ï¼š

```tsx
import DOMPurify from 'dompurify';


<div
  className="content-html dg-html"
  dangerouslySetInnerHTML={{
    __html: DOMPurify.sanitize(content),
  }}
/>;
```

## 05-æ–‡ç« å†…å®¹ä»£ç å—é«˜äº®

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°æ–‡ç« å†…å®¹ä»£ç é«˜äº®åŠŸèƒ½

**åˆ†æè¯´æ˜**ï¼š

[highlight.js npm](https://www.npmjs.com/package/highlight.js)

**æ­¥éª¤**ï¼š

1. å®‰è£… highlight.jsï¼š`yarn add highlight.js`
2. åœ¨ useEffect ä¸­è·å–åˆ°åŒ…å« ä»£ç  çš„æ ‡ç­¾ï¼ˆå¯èƒ½æ˜¯ code æ ‡ç­¾ï¼Œä¹Ÿå¯èƒ½æ˜¯ pre æ ‡ç­¾ï¼‰
3. éå†è¿™äº› DOMï¼Œåˆ†åˆ«ä¸ºæ¯ä¸ª DOM å…ƒç´ ï¼Œåº”ç”¨ highlightElement å³å¯

**æ ¸å¿ƒä»£ç **ï¼š

```tsx
import hljs from 'highlight.js';
import 'highlight.js/styles/github.css';


// æ–‡ç« è¯¦æƒ… ä»£ç å†…å®¹ é«˜äº®
useEffect(() => {
  const dgHtmlDOM = document.querySelector('.dg-html');
  const codes = dgHtmlDOM?.querySelectorAll('pre code');
  // console.log(codes)
  if (codes && codes.length > 0) {
    codes.forEach((el) => {
      // è®©æ¯ä¸ª code å†…å®¹å®ç°ä»£ç é«˜äº®
      highlight.highlightElement(el);
    });
    return;
  }


  highlight.configure({
    // å¿½ç•¥è­¦å‘Š
    ignoreUnescapedHTML: true,
  });


  // ç›´æ¥æ‰¾åˆ°æ‰€æœ‰çš„ pre æ ‡ç­¾
  const pres = dgHtmlDOM?.querySelectorAll('pre');
  if (pres && pres.length > 0) {
    pres.forEach((el) => {
      highlight.highlightElement(el);
    });
  }
}, [detail]);
```

## 06-åŠ è½½ loading æ•ˆæœ

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåœ¨æ–‡ç« è¯¦æƒ…åŠ è½½ä¸­å±•ç¤º loading æ•ˆæœ

**åˆ†æè¯´æ˜**ï¼š

éª¨æ¶å±æ¸²æŸ“å†…å®¹

- [å‚è€ƒ 1ï¼šè€ƒæ‹‰å‰ç«¯éª¨æ¶å±ç”ŸæˆæŠ€æœ¯æ­ç§˜](https://zhuanlan.zhihu.com/p/114362353)
- [å‚è€ƒ 2ï¼šä¸€ç§è‡ªåŠ¨åŒ–ç”Ÿæˆéª¨æ¶å±çš„æ–¹æ¡ˆ](https://github.com/Jocs/jocs.github.io/issues/22)
- [react-content-loader åœ¨çº¿è®¾è®¡éª¨æ¶å±](https://skeletonreact.com/)

**æ­¥éª¤**ï¼š

1. å®‰è£…ï¼š`yarn add react-content-loader`
2. å¦‚æœæ˜¯åŠ è½½ä¸­ï¼Œå°±æ¸²æŸ“ loading æ•ˆæœ

```tsx
import ContentLoader from 'react-content-loader';


const Article = () => {
  // ...


  if (loading) {
    return (
      // æ ¹æ®å½“å‰é¡µé¢ç»“æ„ï¼Œè®¾è®¡å¥½çš„ loading æ•ˆæœ
      <ContentLoader
        speed={2}
        width={375}
        height={230}
        viewBox="0 0 375 230"
        backgroundColor="#f3f3f3"x
        foregroundColor="#ecebeb"
      >
        <rect x="16" y="8" rx="3" ry="3" width="340" height="10" />
        <rect x="16" y="26" rx="0" ry="0" width="70" height="6" />
        <rect x="96" y="26" rx="0" ry="0" width="50" height="6" />
        <rect x="156" y="26" rx="0" ry="0" width="50" height="6" />
        <circle cx="33" cy="69" r="17" />
        <rect x="60" y="65" rx="0" ry="0" width="45" height="6" />
        <rect x="304" y="65" rx="0" ry="0" width="52" height="6" />
        <rect x="16" y="114" rx="0" ry="0" width="340" height="15" />
        <rect x="263" y="208" rx="0" ry="0" width="94" height="19" />
        <rect x="16" y="141" rx="0" ry="0" width="340" height="15" />
        <rect x="16" y="166" rx="0" ry="0" width="340" height="15" />
      </ContentLoader>
    );
  }
};
```

:::tip å¤„ç†loading

ä¼˜åŒ–è‡ªå·±çš„useInitStateå¤„ç†loading

> useMemoizedFnæŒä¹…åŒ–å‡½æ•°ï¼Œç±»ä¼¼äºuseCallback(() => {}, [])

```jsx
// ä½¿ç”¨useInitialStateè·å–reduxé‡Œé¢çš„æ•°æ®ï¼ŒåŒæ—¶æ´¾å‘thunk
const {detail} = useInitialState(
  () => getArticleDetailById(params.artId),
  'article',
  useMemoizedFn(() => setLoading(false))
)

// useInitialStateå†…éƒ¨å¤„ç†
import {useDispatch, useSelector} from "react-redux";
import {useEffect} from "react";

export function useInitialState(action, stateName, afterAction = () => null) {
  const dispatch = useDispatch()
  const res = useSelector(state => state[stateName])
  useEffect(() => {
    const load = async () => {
      await  dispatch(action())
      afterAction()
    }
    load()
  }, [afterAction])
  return res
}
```

æ€è€ƒï¼šæ—¢ç„¶loadingåŠŸèƒ½é€šç”¨ï¼Œå¦‚ä½•åœ¨è‡ªå®šä¹‰hookså†…éƒ¨å†…ç½®loadingåŠŸèƒ½ï¼Œæä¾›ç»™æ‰€æœ‰ä½¿ç”¨å®ƒçš„ç»„ä»¶

:::



## 07-å¯¼èˆªæ ä¸­å±•ç¤ºä½œè€…ä¿¡æ¯

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°æ”¶è—æ–‡ç« åŠŸèƒ½

**åˆ†æè¯´æ˜**ï¼š

[å‚è€ƒï¼šMDN getBoundingClientRect](https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getBoundingClientRect)

`dom.getBoundingClientRect()` ç”¨æ¥è·å–å…ƒç´ ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼Œå…ƒç´ è‡ªèº«å¤§å°ã€å…ƒç´ ä½ç½®ç­‰

<img src="https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/image-20220324202528917.png" alt="image-20220324202528917" style="zoom:50%;" />

```ts
// top å…ƒç´ ç›¸å¯¹äºé¡µé¢é¡¶éƒ¨çš„è·ç¦»
// height å…ƒç´ è‡ªèº«é«˜åº¦
const { top, height } = dom.getBoundingClientRect();
```

**æ­¥éª¤**ï¼š

1. åˆ›å»ºä¸¤ä¸ª ref å¯¹è±¡ï¼š1 å¯æ»šåŠ¨åŒºåŸŸ DOM 2 å¯¼èˆªæ ä½œè€…ä¿¡æ¯ DOM
2. åˆ›å»ºæ§åˆ¶å¯¼èˆªæ ä½œè€…ä¿¡æ¯æ˜¯å¦æ˜¾ç¤ºçš„çŠ¶æ€
3. å¯¼å…¥ lodash çš„èŠ‚æµå‡½æ•° throttle
4. ç›‘å¬é¡µé¢æ»šåŠ¨ï¼Œåˆ¤æ–­æ˜¯å¦å±•ç¤ºå¯¼èˆªæ ä½œè€…ä¿¡æ¯ï¼Œæ¥ä¿®æ”¹çŠ¶æ€

**æ ¸å¿ƒä»£ç **ï¼š

article/index.jsx ä¸­ï¼š

```tsx
import throttle from 'lodash/throttle'


const Article = () => {
  const wrapperRef = useRef(null)
  const authorRef = useRef(null)
  const [showNavAuthor, setShowNavAuthor] = useState(false)


  // å¯¼èˆªæ ä¸­å±•ç¤ºä½œè€…ä¿¡æ¯
  useEffect(() => {
    if (loading) return


    const wrapperDOM = wrapperRef.current!


    // åˆ›å»ºä¸€ä¸ªèŠ‚æµå‡½æ•°
    const handleScroll = throttle(() => {
      const { bottom } = authorRef.current!.getBoundingClientRect()
      // 44 æ˜¯ NavBar çš„é«˜åº¦ï¼Œå› ä¸º NavBar ä¼šæŒ¡ä½é¡µé¢å†…å®¹ï¼Œæ‰€ä»¥ï¼Œæ­¤å¤„éœ€è¦å‡å»å®ƒçš„é«˜åº¦
      if (bottom - 44 <= 0) {
        setShowNavAuthor(true)
      } else {
        setShowNavAuthor(false)
      }
    }, 200)


    wrapperDOM.addEventListener('scroll', handleScroll)
    return () => wrapperDOM.removeEventListener('scroll', handleScroll)
  }, [loading])


  const renderArticle = () => {
    return (
      <div className="wrapper" ref={wrapperRef}>
        // ...
        <div className="author" ref={authorRef}>
        </div>
      </div>
    )
  }


  // ...


  return (
  	// ...
    <NavBar>
      {showNavAuthor && (
        <div className="nav-author">...</div>
      }
    </NavBar>
  )
}
```

## 08-ç‚¹å‡»æ»šåŠ¨åˆ°è¯„è®ºå†…å®¹ä½ç½®

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåœ¨ç‚¹å‡»è¯„è®ºå›¾æ ‡æ—¶æ»šåŠ¨åˆ°è¯„è®ºå†…å®¹ä½ç½®

**åˆ†æè¯´æ˜**ï¼š

[å‚è€ƒï¼šMDN getBoundingClientRect](https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getBoundingClientRect)

[å‚è€ƒï¼šMDN scrollTo()](https://developer.mozilla.org/zh-CN/docs/Web/API/Element/scrollTo)

**æ­¥éª¤**ï¼š

1. åˆ†æ CommentFooter ç»„ä»¶çš„ç»“æ„ï¼Œæ·»åŠ  onShowComment å±æ€§å¹¶ä½œä¸ºè¯„è®ºå›¾æ ‡çš„ç‚¹å‡»äº‹ä»¶
2. åœ¨æ–‡ç« è¯¦æƒ…é¡µé¢ä¸­ï¼Œåˆ›å»º onShowComment å‡½æ•°ï¼Œå¹¶æŒ‡å®šä¸º CommentFooter ç»„ä»¶çš„å±æ€§
3. åˆ›å»ºè·å–è¯„è®ºåŒºåŸŸ DOM çš„ ref å¯¹è±¡
4. è·å–åˆ°è¯„è®ºç›¸å¯¹äºé¡µé¢é¡¶éƒ¨çš„é«˜åº¦ï¼Œæ¥è·³è½¬åˆ°ç›¸åº”ä½ç½®
5. è·³è½¬é€»è¾‘
   1. ç‚¹å‡»è¯„è®ºçš„icon : é¡µé¢è·³è½¬åˆ°è¯„è®ºç»„ä»¶(è¯„è®ºç»„ä»¶é«˜åº¦-navBarçš„é«˜åº¦+é¡µé¢å·²ç»å·å»é«˜åº¦)

<img src="https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/image-20220328120144676.png" alt="image-20220328120144676" style="zoom:50%;" />


**æ ¸å¿ƒä»£ç **ï¼š

article/index.jsx ä¸­ï¼š

```tsx
/**
 * å¯¼èˆªæ é«˜åº¦çš„å¸¸é‡
 */
const NAV_BAR_HEIGTH = 45;


const Article = () => {
  const commentRef = useRef(null);
  const isShowComment = useRef(false);


  // å±•ç¤º or éšè—è¯„è®ºå†…å®¹
  const onShowComment = () => {
    const wrapper = wrapperRef.current;
    if (!wrapper) return;
    const comment = commentRef.current;
    if (!comment) return;


    const commentTop = comment.getBoundingClientRect().top;
    // console.log(commentTop)
    if (!isShowComment.current) {
      // è¿˜æ²¡æœ‰å±•ç¤ºè¯„è®ºä¿¡æ¯ï¼Œæ­¤æ—¶ï¼Œå°±å±•ç¤ºè¯„è®ºä¿¡æ¯
      wrapper.scrollTo({
        // wrapper.scrollTop è¡¨ç¤ºå·²ç»æ»šåŠ¨çš„è·ç¦»
        top: commentTop - NAV_BAR_HEIGTH + wrapper.scrollTop,
        // å¦‚æœæƒ³è¦æ»šåŠ¨æ—¶ï¼Œå¸¦æœ‰åŠ¨ç”»æ•ˆæœï¼Œå¯ä»¥ä½¿ç”¨ smooth å³å¯
        behavior: 'auto',
      });
      isShowComment.current = true;
    } else {
      // å·²ç»å±•ç¤ºè¯„è®ºä¿¡æ¯ï¼Œæ­¤æ—¶ï¼Œéœ€è¦è¿”å›é¡µé¢é¡¶éƒ¨
      wrapper.scrollTo(0, 0);
      isShowComment.current = false;
    }
  };


  const renderArticle = () => {
    return (
      // ...
      <div className="comment" ref={commentRef}></div>
    );
  };


  return (
    // ...
    <CommentFooter onShowComment={onShowComment} />
  );
};
```

article/components/CommentFooter.jsx ä¸­ï¼š

```jsx
const CommentFooter = ({ onShowComment }) => {
  return (
    <div className={styles.root}>
      // ...
      {type === 'normal' && (
        <>
          <div className="action-item" onClick={onShowComment}></div>
        </>
      )}
    </div>
  );
};
```

:::tip

ä¼˜åŒ–çš„onShowCommentæ–¹æ³•

```js
  const onShowComment = () => {
    const rootElement = document.getElementById('root')
    /**
     * è¯„è®ºçš„domå…ƒç´ 
     * @type {HTMLDivElement}
     */
    const comment = commentRef.current;
    // console.log(comment)
    if (!comment) return;

    //   è·å–è¯„è®ºåŒºåŸŸçš„é«˜åº¦
    const commentTop = comment.getBoundingClientRect().top
    // å¦‚æœæ²¡æœ‰å±•ç¤ºè¯„è®ºä¿¡æ¯å°±å±•ç¤º
    if (!isShowComment.current) {
      console.log('a')
      // è¿˜æ²¡æœ‰å±•ç¤ºè¯„è®ºä¿¡æ¯ï¼Œæ­¤æ—¶ï¼Œå°±å±•ç¤ºè¯„è®ºä¿¡æ¯
      rootElement.scrollTo({
        // wrapper.scrollTop è¡¨ç¤ºå·²ç»æ»šåŠ¨çš„è·ç¦»
        // è¯„è®ºåŒºåŸŸè·ç¦»é¡µé¢é¡¶éƒ¨çš„è·ç¦» - navBarçš„é«˜åº¦
        top: commentTop - NAV_BAR_HEIGTH
        // å¦‚æœæƒ³è¦æ»šåŠ¨æ—¶ï¼Œå¸¦æœ‰åŠ¨ç”»æ•ˆæœï¼Œå¯ä»¥ä½¿ç”¨ smooth å³å¯
        behavior: 'smooth',
      });
      isShowComment.current = true;
    } else {
      rootElement.scrollTo(0, 0)
      isShowComment.current = false;
    }
  }
```



:::

## 09-å…³æ³¨æ–‡ç« ä½œè€…

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°å…³æ³¨æ–‡ç« ä½œè€…åŠŸèƒ½

**åˆ†æè¯´æ˜**ï¼š

å…³æ³¨ä½œè€…ã€æ”¶è—æ–‡ç« ã€ç‚¹èµæ–‡ç« ï¼Œè¿™ä¸‰ä¸ªåŠŸèƒ½çš„å®ç°æ–¹å¼å‡ ä¹ä¸€æ ·ï¼Œåªæ˜¯ä¿®æ”¹çš„æ–‡ç« è¯¦æƒ…æ•°æ®ä¸åŒ

å› æ­¤ï¼Œå¯ä»¥å¤ç”¨åŒä¸€ä¸ª action typeï¼Œä»¥åŠ reducer æ›´æ–°é€»è¾‘

```ts
// reduer ä¸­ï¼š
// ç»Ÿä¸€å¤„ç† å…³æ³¨ã€æ”¶è—ã€ç‚¹èµ ä¸‰ä¸ªçŠ¶æ€
if (action.type === 'article/updateInfo') {
  return {
    ...state,
    detail: {
      ...state.detail,
      [action.payload.name]: action.payload.value,
    },
  };
}
```

**æ­¥éª¤**ï¼š

1. ç»™å…³æ³¨æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
2. åœ¨ç‚¹å‡»äº‹ä»¶ä¸­åˆ†å‘ actionï¼Œå¹¶ä¼ é€’ aut_idï¼ˆä½œè€… idï¼‰å’Œ is_followedï¼ˆæ˜¯å¦å…³æ³¨ï¼‰å‚æ•°
3. åœ¨ action ä¸­æ ¹æ®æ˜¯å¦å…³æ³¨æ¥å–æ¶ˆå…³æ³¨æˆ–å…³æ³¨
4. åœ¨ reducer ä¸­æ ¹æ® action ä¿®æ”¹å…³æ³¨çŠ¶æ€

**æ ¸å¿ƒä»£ç **ï¼š

Article/index.jsx ä¸­ï¼š

```tsx
const onFollow = () => {
  dispatch(followAuthor(aut_id, is_followed));
};


// ä¸¤ä¸ªå…³æ³¨æŒ‰é’®ï¼Œéƒ½è¦æ·»åŠ äº‹ä»¶
<span onClick={onFollow}>{is_followed ? 'å·²å…³æ³¨' : 'å…³æ³¨'}</span>;
```

actions/article.js ä¸­ï¼š

```ts
export const followAuthor = (
  id,
  isFollowed,
) => {
  return async (dispatch) => {
    if (isFollowed) {
      // å–å…³
      await http.delete(`/user/followings/${id}`);
    } else {
      // å…³æ³¨
      await http.post('/user/followings', {
        target: id,
      });
    }


    dispatch({
      type: 'article/updateInfo',
      payload: {
        name: 'is_followed',
        value: !isFollowed,
      },
    });
  };
};
```



reducers/article.js ä¸­ï¼š

```ts
const article = (state = initialState, action) => {
  // ...


  if (action.type === 'article/updateInfo') {
    return {
      ...state,
      detail: {
        ...state.detail,
        [action.payload.name]: action.payload.value,
      },
    };
  }
};
```

## 10-æ”¶è—æ–‡ç« 

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°æ”¶è—æ–‡ç« åŠŸèƒ½

**æ­¥éª¤**ï¼š

1. ä¸º CommentFooter ç»„ä»¶æ·»åŠ  onCollected ã€is_collected å±æ€§ï¼Œå¹¶ä½œä¸ºæ”¶è—æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
2. åœ¨æ–‡ç« è¯¦æƒ…ä¸­ï¼Œåˆ›å»º onCollected å‡½æ•°ï¼Œå¹¶ä½œä¼ é€’ç»™ CommentFooter ç»„ä»¶
3. åœ¨ onCollected å‡½æ•°ä¸­ï¼Œåˆ†å‘æ”¶è—æ–‡ç« çš„ action
4. åœ¨ action ä¸­å®ç°æ”¶è—æ–‡ç« åŠŸèƒ½ï¼Œå¹¶æ›´æ–° redux çŠ¶æ€

**æ ¸å¿ƒä»£ç **ï¼š

CommentFooter.j sx ä¸­ï¼š

```tsx

const CommentFooter = ({ onCollected, is_collected }) => {
  return (
    <div className={styles.root}>
      // ...
      {type === 'normal' && (
        <>
          <div className="action-item" onClick={onCollected}>
            <Icon
              type={is_collected ? 'iconbtn_collect_sel' : 'iconbtn_collect'}
            />
          </div>
        </>
      )}
    </div>
  );
};
```

article/index.jsx ä¸­ï¼š

```tsx
const Article = () => {
  // æ”¶è— or å–æ¶ˆæ”¶è— -- æ–‡ç« 
  const onCollected = async () => {
    await dispatch(collectArticle(art_id, is_collected));
    Toast.show(is_collected ? 'å–æ¶ˆæ”¶è—' : 'å·²æ”¶è—');
  };


  return (
    // ...
    <CommentFooter onCollected={onCollected} />
  );
};
```

actions/article.js ä¸­ï¼š

```ts
// æ”¶è— or å–æ¶ˆæ”¶è—æ–‡ç« 
export const collectArticle = (
  art_id,
  is_collected,
) => {
  return async (dispatch) => {
    // åˆ¤æ–­å½“å‰æ˜¯å¦æ”¶è—
    if (is_collected) {
      // å–æ¶ˆæ”¶è—
      http.delete(`/article/collections/${art_id}`);
    } else {
      // æ”¶è—
      http.post('/article/collections', {
        target: art_id,
      });
    }


    dispatch({
      type: 'article/updateInfo',
      payload: {
        name: 'is_collected',
        value: !is_collected,
      },
    });
  };
};
```

## 11-æ–‡ç« ç‚¹èµ

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°æ–‡ç« ç‚¹èµåŠŸèƒ½

**æ­¥éª¤**ï¼š

1. ä¸º CommentFooter ç»„ä»¶æ·»åŠ  onLikeã€attitude å±æ€§ï¼Œå¹¶ä½œä¸ºæ”¶è—æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
2. åœ¨æ–‡ç« è¯¦æƒ…ä¸­ï¼Œåˆ›å»º onLike å‡½æ•°ï¼Œå¹¶ä½œä¼ é€’ç»™ CommentFooter ç»„ä»¶
3. åœ¨ onLike å‡½æ•°ä¸­ï¼Œåˆ†å‘ç‚¹èµæ–‡ç« çš„ action
4. åœ¨ action ä¸­å®ç°ç‚¹èµæ–‡ç« åŠŸèƒ½ï¼Œå¹¶æ›´æ–° redux çŠ¶æ€

**æ ¸å¿ƒä»£ç **ï¼š

CommentFooter.jsx ä¸­ï¼š

```tsx


const CommentFooter = ({ onLike, attitude }) => {
  return (
    <div className={styles.root}>
      // ...
      {type === 'normal' && (
        <>
          <div className="action-item" onClick={onLike}>
            <Icon
              type={attitude === 1 ? 'iconbtn_like_sel' : 'iconbtn_like2'}
            />
          </div>
        </>
      )}
      {type === 'reply' && (
        <div className="action-item" onClick={onLike}>
          <Icon type={attitude === 1 ? 'iconbtn_like_sel' : 'iconbtn_like2'} />
        </div>
      )}
    </div>
  );
};
```

article/index.jsx ä¸­ï¼š

```tsx
const Article = () => {
  // ç‚¹èµ æˆ– å–æ¶ˆç‚¹èµ -- æ–‡ç« 
  const onLike = async () => {
    await dispatch(likeArticle(art_id, attitude));
    Toast.show(attitude ? 'å–æ¶ˆç‚¹èµ' : 'å·²ç‚¹èµ');
  };


  return (
    // ...
    <CommentFooter onLike={onLike} />
  );
};
```

actions/article.js ä¸­ï¼š

```ts
// ç‚¹èµ or å–æ¶ˆç‚¹èµæ–‡ç« 
export const likeArticle = (
  art_id,
  attitude,
) => {
  return async (dispatch) => {
    // åˆ¤æ–­å½“å‰æ˜¯å¦ç‚¹èµ
    // å¦‚æœæ˜¯ 1 è¡¨ç¤ºå·²ç‚¹èµ
    if (attitude === 1) {
      // å–æ¶ˆç‚¹èµ
      await http.delete(`/article/likings/${art_id}`);
    } else {
      // ç‚¹èµ
      await http.post('/article/likings', {
        target: art_id,
      });
    }


    dispatch({
      type: 'article/updateInfo',
      payload: {
        name: 'attitude',
        value: attitude === 1 ? 0 : 1,
      },
    });
  };
};
```



## 13-è·å–è¯„è®ºåˆ—è¡¨æ•°æ®

**ç›®æ ‡**ï¼šèƒ½å¤Ÿè·å–è¯„è®ºåˆ—è¡¨æ•°æ®

**åˆ†æè¯´æ˜**ï¼š

å¯¹äºè¯„è®ºåˆ—è¡¨æ•°æ®æ¥è¯´ï¼Œå¦‚æœ end_id å’Œ last_id ç›¸åŒï¼Œåˆ™è¯´æ˜å·²ç»æ²¡æœ‰æ›´å¤šè¯„è®ºæ•°æ®äº†

æ‰€ä»¥ï¼Œå¯ä»¥é€šè¿‡ `end_id !== last_id` ä½œä¸º InfiniteScroll ç»„ä»¶æ˜¯å¦è¿˜éœ€è¦åŠ è½½æ›´å¤šæ•°æ®çš„åˆ¤æ–­æ¡ä»¶

ä½†æ˜¯ï¼Œç”±äºç»„ä»¶ç¬¬ä¸€æ¬¡åŠ è½½æ•°æ®æ—¶ï¼Œ**end_id å’Œ last_id éƒ½æ²¡æœ‰å€¼**ï¼Œæ­¤æ—¶ï¼Œç¬¬ä¸€æ¬¡åˆ¤æ–­ `end_id !== last_id` ä¸º falseï¼Œå°±å¯¼è‡´ InfiniteScroll ç»„ä»¶æ— æ³•æ­£å¸¸åŠ è½½æ•°æ®

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥åœ¨ç¬¬ä¸€æ¬¡è¿›å…¥é¡µé¢æ—¶ï¼Œä¸»åŠ¨è·å–è¯„è®ºåˆ—è¡¨æ•°æ®ã€‚è¿™æ ·çš„è¯ï¼š

1. è¿›å…¥é¡µé¢æ—¶ï¼Œè‡ªå·±è·å–ç¬¬ä¸€é¡µè¯„è®ºåˆ—è¡¨æ•°æ®
2. æ»šåŠ¨æ—¶ï¼Œé€šè¿‡ `InfiniteScroll` ç»„ä»¶åŠ è½½æ•°æ®

**æ­¥éª¤**ï¼š

1. åœ¨æ–‡ç«  reducer ä¸­ï¼Œæ·»åŠ è¯„è®ºé¡¹çš„çŠ¶æ€ç±»å‹ä»¥åŠé»˜è®¤å€¼
2. æ ¹æ®æ¥å£ï¼Œåˆ›å»ºè·å–è¯„è®ºåˆ—è¡¨æ•°æ®çš„ action å¹¶æŒ‡å®šéœ€è¦ä½¿ç”¨çš„å‚æ•°
3. å‘é€è¯·æ±‚è·å–è¯„è®ºåˆ—è¡¨æ•°æ®
4. ç»„ä»¶ä¸­ï¼Œåœ¨è¯„è®ºåˆ—è¡¨çš„ InfiniteScroll ç»„ä»¶çš„ loadMore å‡½æ•°ä¸­ï¼Œåˆ†å‘è·å–è¯„è®ºåˆ—è¡¨æ•°æ®çš„ action
5. æ¸²æŸ“è¯„è®ºåˆ—è¡¨æ•°æ®

**æ ¸å¿ƒä»£ç **ï¼š

reducers/article.js ä¸­ï¼š

```ts
const initialState = {
  // ...
  // è¯„è®ºåˆ—è¡¨æ•°æ®
  comment: {
    // æ³¨æ„ï¼šæ­¤å¤„ä¸º results å±æ€§è®¾ç½®é»˜è®¤å€¼ä¸ºæ•°ç»„ã€‚è¿™æ ·ï¼Œä¸ç®¡æœ‰æ²¡æœ‰è¯„è®ºæ•°æ®ï¼Œresults éƒ½æ˜¯ä¸€ä¸ªæ•°ç»„
    results: []
  },
}
```

actions/article.js ä¸­ï¼š

> æå‰å®šä¹‰æ›´æ–°æ•°æ®çš„actionType       `export const UPDATECOMMENT = 'UPDATECOMMENT'`
>
> å®šä¹‰åˆ›å»ºactionçš„å‡½æ•°       `const updateComment = createAction(UPDATECOMMENT)`

```ts
// è·å–æ–‡ç« è¯„è®º - è¦†ç›–æ•°æ®
const getArticleComment = (type, id) => {
  return async (dispatch) => {
    const res = await http.get('/comments', {
      params: {
        type,
        source: id,
      },
    });
     dispatch(updateComment(res.data))
  };
};


// è·å–æ›´å¤šæ–‡ç« è¯„è®ºæ•°æ® - è¿½åŠ æ•°æ®
export const getMoreArticleComments = (
  type,
  id,
  offset,
) => {
  return async (dispatch) => {
    const res = await http.get('/comments', {
      params: {
        type,
        source: id,
        offset,
      },
    });
    dispatch(updateComment(res.data))
  };
};
```

Article/index.jsx ä¸­ï¼š

```tsx
// æ‹¿åˆ°å‡†å¤‡å¥½çš„ comment æ•°æ®
const { comment } = useInitialState(
  () => getArticleById(params.artId),
  'article',
  () => setLoading(false),
);


// ç¬¬ä¸€æ¬¡ï¼šè·å–è¯„è®ºæ•°æ®
useEffect(() => {
  dispatch(getArticleComments(CommentType.Article, id));
}, [dispatch, id]);


// æ–‡ç« è¯„è®º
const { end_id, last_id } = comment;
// æ˜¯å¦æœ‰æ›´å¤šè¯„è®º
const hasMoreComment = end_id !== last_id;


// ä»¥åæ¯æ¬¡ï¼šInfiniteScroll åŠ è½½è¯„è®ºæ•°æ®
const loadMoreComments = async () => {
  await dispatch(
    getMoreArticleComments(CommentType.Article, params.artId, comment.last_id),
  );
};
```

æ›´æ–°æ•°æ®åˆ°redux

> reducer/article.js

```js
case UPDATECOMMENT:
  return {
    ...state,
    comment: {
      ...state.comment,
      ...action.payload,
      results: [
        ...state.comment.results,
        ...action.payload.results
      ]
    }
  }
```



## 14-æ¸²æŸ“è¯„è®ºåˆ—è¡¨æ•°æ®

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ¸²æŸ“è¯„è®ºåˆ—è¡¨æ•°æ®

**åˆ†æè¯´æ˜**ï¼š

è¯„è®ºé¡¹ç»„ä»¶ CommentItem åœ¨ 3 ä¸ªåœ°æ–¹ä½¿ç”¨å¹¶ä¸”ç»“æ„ä¸åŒã€‚è¯¥ç»„ä»¶é€šè¿‡ type å±æ€§æ¥åŒºåˆ†ï¼Œä¹Ÿå› æ­¤ï¼Œè¯¥ç»„ä»¶ç»“æ„è¾ƒå¤æ‚ï¼Œä½¿ç”¨å‰å…ˆåˆ†æå…¶ç»“æ„

**æ­¥éª¤**ï¼š

1. åˆ†æå…¶ç»“æ„ CommentItem ç»„ä»¶æ¨¡æ¿
2. ä¸ºè¯„è®ºé¡¹ç»„ä»¶ CommentItem æ·»åŠ  Props å±æ€§ç±»å‹
3. æ¸²æŸ“ CommentItem ç»„ä»¶æ—¶ï¼Œä¼ é€’è¯„è®ºæ•°æ®
4. å°† NoneComment æ¨¡æ¿ä»¥åŠå›¾ç‰‡èµ„æºï¼Œæ‹·è´åˆ°å…¬å…±ç»„ä»¶ components ç›®å½•ä¸­
5. å¦‚æœæ²¡æœ‰è¯„è®ºé¡¹æ•°æ®ï¼Œæ¸²æŸ“ NoneComment ç»„ä»¶

**æ ¸å¿ƒä»£ç **ï¼š

Article/index.jsx ä¸­ï¼š

```tsx
// å¦‚æœæ²¡æœ‰è¯„è®ºæ•°æ®ï¼Œæ¸²æŸ“ NoneComment ç»„ä»¶
{
  comm_count === 0 ? (
    <NoneComment />
  ) : (
    <div className="comment-list">
      {results.map((item) => {
        return <CommentItem key={item.com_id} {...item} />;
      })}
    </div>
  );
}
```

CommentItem/index.jsx ä¸­ï¼š

```tsx


const CommentItem = ({
  aut_photo,
  aut_name,
  like_count,
  is_followed,
  is_liking,
  content,
  reply_count,
  pubdate,
}) => {
  // ...
};
```

## 15-å±•ç¤ºæ–‡ç« è¯„è®ºå¼¹å‡ºå±‚

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå±•ç¤ºæ–‡ç« è¯„è®ºå¼¹å‡ºå±‚

**æ­¥éª¤**ï¼š

1. æ‹·è´ CommentInput ç»„ä»¶æ¨¡æ¿åˆ° Article/components ç›®å½•ä¸­
2. åˆ›å»ºæ§åˆ¶æ–‡ç« è¯„è®ºå¼¹å‡ºå±‚å±•ç¤ºéšè—çš„çŠ¶æ€
3. ç‚¹å‡»åº•éƒ¨ CommentFooter æŠ¢æ²™å‘å†…å®¹æ—¶ï¼Œå±•ç¤ºå¼¹å‡ºå±‚
4. ç‚¹å‡»å¼¹å‡ºå±‚å†…è¿”å›æŒ‰é’®æ—¶ï¼Œéšè—å¼¹å‡ºå±‚

**æ ¸å¿ƒä»£ç **ï¼š

Article/index.jsx ä¸­ï¼š

```tsx
const Article = () => {
  const [commentVisible, setCommentVisible] = useState(false);


  const onCommentShow = () => setCommentVisible(true);
  const onCommentHide = () => setCommentVisible(false);


  // æ¸²æŸ“è¯„è®ºæŠ½å±‰
  const renderCommentPopup = () => {
    return (
      <Popup
        className="comment-popup"
        position="bottom"
        visible={commentVisible}
        onMaskClick={onCommentHide}
      >
        <div className="comment-popup-wrapper">
          <CommentInput onClose={onCommentHide} />
        </div>
      </Popup>
    );
  };


  return (
    // ...
    <div>
      <CommentFooter onCommentPopup={onCommentShow} />
      // åœ¨ Article ç»„ä»¶çš„æœ€åï¼Œæ¸²æŸ“è¯¥ Popup å³å¯
      {renderCommentPopup()}
    </div>
  );
};
```

CommentFooter/index.jsx ä¸­ï¼š

```tsx



const CommentFooter = ({ onCommentPopup }) => {
  return (
  	// ...
    <div className="input-btn" onClick={onCommentPopup}>
  )
}
```

## 16-æ–‡ç« å‘è¡¨è¯„è®º

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå®ç°æ–‡ç« è¯„è®ºåŠŸèƒ½

**æ­¥éª¤**ï¼š

1. ä¸º CommentInput ç»„ä»¶æ·»åŠ å‘è¡¨è¯„è®ºçš„å›è°ƒäº‹ä»¶ç±»å‹ï¼Œå¹¶è°ƒç”¨è¯¥å›è°ƒï¼Œå°†è¯„è®ºä¿¡æ¯å›ä¼ ç»™çˆ¶ç»„ä»¶
2. çˆ¶ç»„ä»¶ Article ä¸­åˆ›å»ºå‘è¡¨è¯„è®ºçš„å‡½æ•°ï¼Œå¹¶é€šè¿‡å‚æ•°æ‹¿åˆ°è¯„è®ºå†…å®¹
3. åˆ†å‘å‘è¡¨è¯„è®ºçš„ actionï¼Œå¹¶åœ¨å‘è¡¨è¯„è®ºåå…³é—­å¼¹å‡ºå±‚

**æ ¸å¿ƒä»£ç **ï¼š

CommentInput/index.jsx ä¸­ï¼š

```tsx

const CommentInput = ({ onAddComment }) => {
  return (
    // ...
    <span className="publish" onClick={() => onAddComment(value)}>
      å‘è¡¨
    </span>
  );
};
```

Article/index.jsx ä¸­ï¼š

```tsx
// å¯¹æ–‡ç« å‘è¡¨è¯„è®º
const onAddComment = async (content) => {
  await dispatch(addArticleComment(detail.art_id, content));
  // å…³é—­è¯„è®ºæŠ½å±‰
  onCommentHide();
};


<CommentInput onComment={onAddComment} />;
```

actions/article.js ä¸­ï¼š

```ts
// å¯¹æ–‡ç« å‘è¡¨è¯„è®º
export const addArticleComment = (
  target,
  content,
) => {
  return async (dispatch) => {
    const res = await http.post('/comments', {
      target,
      content,
    });


    dispatch({ type: 'article/addComment', payload: res.data.data.new_obj });
  };
};
```



reducers/article.js ä¸­ï¼š

```ts
if (action.type === 'article/addComment') {
  return {
    ...state,
    comment: {
      ...state.comment,
      total_count: state.comment.total_count + 1,
      results: [action.payload, ...state.comment.results],
    },
  };
}
```

## 17-è¯„è®ºç‚¹èµ

**ç›®æ ‡**ï¼šèƒ½å¤Ÿä¸ºæ–‡ç« çš„è¯„è®ºé¡¹ç‚¹èµ

**æ­¥éª¤**ï¼š

1. ä¸ºå­ç»„ä»¶ CommentItem ç‚¹èµæŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
2. åœ¨çˆ¶ç»„ä»¶ä¸­åˆ›å»ºå¯¹è¯„è®ºç‚¹èµçš„å‡½æ•°ï¼Œå¹¶ä¼ é€’ç»™å­ç»„ä»¶
3. æ ¹æ®æ¥å£æ–‡æ¡£ï¼Œä¸ºç‚¹èµçš„å‡½æ•°ä¼ é€’å‚æ•°
4. åˆ†å‘ç‚¹èµæˆ–å–æ¶ˆç‚¹èµçš„ action
5. åœ¨ action ä¸­æ ¹æ®å½“å‰ç‚¹èµçš„çŠ¶æ€ï¼Œæ¥åŒºåˆ†æ˜¯ç‚¹èµè¿˜æ˜¯å–æ¶ˆç‚¹èµ
6. å°†ç‚¹èµæˆ–å–æ¶ˆç‚¹èµåçŠ¶æ€ï¼Œæ›´æ–°åˆ° redux

**æ ¸å¿ƒä»£ç **ï¼š

Article/index.jsx ä¸­ï¼š

```tsx
// å¯¹è¯„è®ºç‚¹èµ
const onThumbsUp = async (id, is_liking) => {
  await dispatch(likeComment(id, is_liking));
};


<CommentItem onThumbsUp={() => onThumbsUp(item.com_id, item.is_liking)} />;
```

actions/article.js ä¸­ï¼š

```ts
// ç‚¹èµ or å–æ¶ˆç‚¹èµè¯„è®º
export const likeComment = (
  art_id,
  is_liking,
) => {
  return async (dispatch) => {
    if (is_liking) {
      // å–æ¶ˆç‚¹èµ
      await http.delete(`/comment/likings/${art_id}`);
    } else {
      // ç‚¹èµ
      await http.post('/comment/likings', {
        target: art_id,
      });
    }


    dispatch({
      type: 'comment/updateInfo',
      payload: {
        // name è¡¨ç¤ºè¦ä¿®æ”¹çŠ¶æ€ä¸­çš„å“ªä¸ªå±æ€§
        name: 'is_liking',
        // value è¡¨ç¤ºè¦ä¿®æ”¹æˆå“ªä¸ªå€¼
        value: !is_liking,
        // è¯„è®º id
        target: art_id,
        // æ•°é‡
        like_count: is_liking ? -1 : 1,
      },
    });
  };
};
```



reducers/article.js ä¸­ï¼š

:::tip

state.comment.resultså­˜å‚¨çš„æ˜¯è¯„è®ºçš„æ•°ç»„åˆ—è¡¨

ç‚¹èµçš„æ—¶å€™éœ€è¦æ‰¾åˆ°å…·ä½“å…¶ä¸­çš„å¤åˆæ¡ä»¶çš„é¡¹ï¼Œå†æ“ä½œå…¶é€‰ä¸­çŠ¶æ€æˆ–è€…ç‚¹èµçš„æ•°é‡å¢å‡

:::

```ts
if (action.type === 'comment/updateInfo') {
  return {
    ...state,
    comment: {
      ...state.comment,
      results: state.comment.results.map((item) => {
        if (item.com_id === action.payload.target) {
          return {
            ...item,
            [action.payload.name]: action.payload.value,
            like_count: item.like_count + action.payload.like_count,
          };
        }
        return item;
      }),
    },
  };
}
```



## 19-å±•ç¤ºè¯„è®ºå›å¤å¼¹å‡ºå±‚

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå±•ç¤ºè¯„è®ºå›å¤çš„å¼¹å‡ºå±‚

**æ­¥éª¤**ï¼š

1. å°†æ¨¡æ¿ Reply æ‹·è´åˆ° components ç›®å½•ä¸­
2. åˆ›å»ºæ§åˆ¶è¯„è®ºå›å¤å¼¹å‡ºå±‚å±•ç¤ºæˆ–éšè—çš„çŠ¶æ€
3. ä¸ºè¯„è®ºé¡¹çš„å›å¤æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»æ—¶æ‰“å¼€å¼¹å‡ºå±‚
4. åˆ›å»ºå›å¤çš„å¼¹å‡ºå±‚çš„æ¸²æŸ“å‡½æ•°ï¼Œæ¸²æŸ“ Popup å¼¹å‡ºå±‚ç»„ä»¶ä»¥åŠ Reply å›å¤ç»„ä»¶
5. ç‚¹å‡»å›å¤å¼¹å‡ºå±‚çš„è¿”å›æŒ‰é’®æ—¶ï¼Œå…³é—­å¼¹å‡ºå±‚

**æ ¸å¿ƒä»£ç **ï¼š

CommentItem/index.jsx ä¸­ï¼š

```tsx

const CommentItem = ({ onReply }) => {
  return (
    // ...
    <span className="replay" onClick={onReply}>
      0 å›å¤
    </span>
  );
};
```

Article/index.jsx ä¸­ï¼š

```tsx

const Article = () => {
  const [commentReply, setCommentReply] = useState({
    visible: false,
    commentItem: {},
  })


  // æ‰“å¼€
  const onCommentReplyShow = (commentItem) => {
    setCommentReply({
      visible: true,
      commentItem
    })
  }


  // å…³é—­
  const onCommentReplyHide = () =>
    setCommentReply({
      ...commentReply,
      visible: false
    })


  // æ¸²æŸ“è¯„è®ºå›å¤çš„å¼¹å‡ºå±‚
  const renderReply = () => {
    return (
      <Popup
        className="reply-popup"
        position="right"
        visible={commentReply.visible}
      >
        <div className="comment-popup-wrapper">
          <Reply onClose={onCommentReplyHide} />
        </div>
      </Popup>
    )
  }


  render() {
    return (
      // ...
      {renderReply()}
    )
  }
}
```

Rely/index.jsx ä¸­ï¼š

```tsx


const Reply = ({ onClose }) => {
  return (
    // ...
    <NavBar className="transparent-navbar" onBack={onClose}>
      {0}æ¡å›å¤
    </NavBar>
  );
};
```

## 20-å›å¤ç»„ä»¶ä¸­å±•ç¤ºè¯„è®ºæ•°æ®

**ç›®æ ‡**ï¼šèƒ½å¤Ÿä¸ºè¯„è®ºçš„å›å¤ç»„ä»¶ä¼ é€’è¦å±•ç¤ºçš„è¯„è®ºæ•°æ®

**åˆ†æè¯´æ˜**ï¼š

å¯¹æ–‡ç« è¯„è®ºå›å¤æ—¶ï¼Œéœ€è¦å±•ç¤ºè¦å›å¤çš„è¯„è®ºä¿¡æ¯ã€‚æ‰€ä»¥ï¼Œåœ¨æ‰“å¼€å›å¤å¼¹å‡ºå±‚æ—¶ï¼Œéœ€è¦æ‹¿åˆ°å½“å‰è¯„è®ºä¿¡æ¯ï¼Œä¼ é€’ç»™å¼¹å‡ºå±‚

**æ­¥éª¤**ï¼š

1. ä¸ºå›å¤è¯„è®ºç»„ä»¶æ·»åŠ è¯„è®ºé¡¹å†…å®¹ prop
2. åœ¨å±•ç¤ºå›å¤å¼¹å‡ºå±‚æ—¶ï¼Œä¸ºå›å¤ç»„ä»¶ä¼ é€’è¯„è®ºé¡¹å†…å®¹æ•°æ®

**æ ¸å¿ƒä»£ç **ï¼š

Reply/index.jsx ä¸­ï¼š

```tsx

const Reply = ({ commentItem }) => {};
```

Article/index.jsx ä¸­ï¼š

```tsx
<Reply
  // ...
  commentItem={commentReply.commentItem}
/>
```

## 21-æ¸²æŸ“è¯„è®ºçš„å›å¤åˆ—è¡¨

**ç›®æ ‡**ï¼šèƒ½å¤Ÿæ¸²æŸ“è¯„è®ºçš„å›å¤åˆ—è¡¨æ•°æ®

**åˆ†æè¯´æ˜**ï¼š

è¯„è®ºçš„å›å¤åŠŸèƒ½ï¼Œæˆ‘ä»¬ç›´æ¥é€šè¿‡ç»„ä»¶è‡ªå·±çš„çŠ¶æ€æ¥å®ç°ï¼Œæ¥å›é¡¾ä¸‹ useState/useEffect ç­‰çš„ä½¿ç”¨

å› ä¸ºåœ¨å›å¤ç»„ä»¶ä¸­ï¼Œä¹Ÿæœ‰å¯¹åŸå§‹è¯„è®ºæ•°æ®çš„ä¿®æ”¹æ“ä½œï¼Œæ¯”å¦‚ï¼Œå¯¹åŸå§‹è¯„è®ºè¿›è¡Œç‚¹èµã€å…³æ³¨è¯„è®ºçš„ä½œè€…ç­‰ç­‰

æ‰€ä»¥ï¼Œéœ€è¦å°†åŸå§‹è¯„è®ºæ•°æ®æ”¾åˆ° state ä¸­ã€‚è¿™æ ·ï¼Œå¯¹åŸå§‹è¯„è®ºæ•°æ®çš„ä¿®æ”¹å°±å¯ä»¥ç«‹å³æ˜¾ç¤ºåœ¨è¯¥ç»„ä»¶ä¸­ã€‚

ä½†æ˜¯ï¼Œè¯¥æ“ä½œåªä¼šä¿®æ”¹ å›å¤ç»„ä»¶ ä¸­çš„è¯„è®ºçŠ¶æ€ï¼Œè€Œçˆ¶ç»„ä»¶ Article ä¸­çš„è¯„è®ºæ•°æ®ä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥ï¼Œéœ€è¦åœ¨å…³é—­çª—å£æ—¶ï¼Œå°†æœ€æ–°çš„è¯„è®ºæ•°æ®è¿”å›ç»™çˆ¶ç»„ä»¶ï¼Œ

è®©çˆ¶ç»„ä»¶ä¹Ÿæ›´æ–°è¯¥æ•°æ®ï¼Œé‚£ä¹ˆï¼Œçˆ¶ç»„ä»¶ Article ä¸­çš„æ•°æ®æ‰ä¼šæ”¹å˜ã€‚

**æ³¨æ„ï¼šè¯¥æ“ä½œä¸å¥½ï¼Œå› ä¸ºè¿™ä¸ªæ“ä½œä¼šè®© çˆ¶ç»„ä»¶ Article å’Œ å­ç»„ä»¶ Reply åˆ†åˆ«æœ‰ä¸€ä»½æ•°æ®æºï¼ˆè¯„è®ºçš„çŠ¶æ€æ•°æ®ï¼‰ï¼Œå› ä¸ºæœ‰ä¸¤ä»½æ•°æ®æºï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ç»´æŠ¤è¿™ä¸¤ä»½æ•°æ®æºçš„æ•°æ®çš„åŒæ­¥ã€‚åªæœ‰è¿™æ ·æ‰èƒ½ç»´æŒä¸¤ä»½æ•°æ®æºçš„åŒæ­¥ï¼**

æ­£å¸¸çš„æƒ…å†µä¸‹ï¼šçˆ¶å­ç»„ä»¶ä¸­ï¼Œåº”è¯¥åªæœ‰ä¸€ä»½æ•°æ®æºï¼ˆ**Single Source of Truth**ï¼Œå•ä¸€æ•°æ®æºï¼‰ï¼Œåˆ©ç”¨ React ç»„ä»¶çš„å•å‘æ•°æ®æµæ¥å®ç°ä¸¤ä¸ªç»„ä»¶æ•°æ®çš„åŒæ­¥ã€‚

**æ­¥éª¤**ï¼š

1. åˆ›å»ºä¸¤ä¸ªçŠ¶æ€ï¼š1 åŸå§‹è¯„è®ºé¡¹çš„çŠ¶æ€ 2 è¯„è®ºé¡¹çš„å›å¤åˆ—è¡¨çŠ¶æ€
2. è¿›å…¥è¯¥ç»„ä»¶æ—¶ï¼Œå‘é€è¯·æ±‚ï¼Œè·å–å›å¤æ•°æ®
3. æ¸²æŸ“å›å¤åˆ—è¡¨æ•°æ®

**æ ¸å¿ƒä»£ç **ï¼š

Reply/index.jsx ä¸­ï¼š

```tsx
const Reply = ({ commentItem }) => {
  // åŸå§‹è¯„è®ºé¡¹çš„çŠ¶æ€
  const [originComment, setOriginComment] = useState(commentItem);
  // æ‹¿åˆ°åŸå§‹è¯„è®ºçš„ id
  const { com_id } = originComment;
  // è¯„è®ºé¡¹çš„å›å¤åˆ—è¡¨çŠ¶æ€
  const [commentReply, setCommentReply] = useState({});


  useEffect(() => {
    const loadDdata = async () => {
      const res = await http.get('/comments', {
        params: {
          type: 'c',
          source: com_id,
        },
      });
      setCommentReply(res.data.data);
    };
    loadDdata();
  }, [com_id]);


  return (
    <div className={styles.root}>
      <div className="reply-wrapper">
        <NavBar className="transparent-navbar" onBack={onClose}>
          {commentItem.reply_count}æ¡å›å¤
        </NavBar>


        {/* è¦å›å¤çš„è¯„è®º */}
        <div className="origin-comment">
          <CommentItem {...commentItem} type="origin" />
        </div>


        <div className="reply-list">
          <div className="reply-header">å…¨éƒ¨å›å¤</div>
          {commentReply.total_count > 0 ? (
            commentReply.results.map((item) => (
              <CommentItem key={item.com_id} {...item} type="reply" />
            ))
          ) : (
            <NoneComment />
          )}
        </div>
      </div>
    </div>
  );
};
```

## 22-å›å¤è¯„è®ºæ—¶ç‚¹èµè¯„è®º

**ç›®æ ‡**ï¼šèƒ½å¤Ÿåœ¨å›å¤è¯„è®ºæ—¶ç‚¹èµè¯„è®º

**åˆ†æè¯´æ˜**ï¼š

æ³¨æ„ï¼šå›å¤è¯„è®ºæ—¶ï¼Œå¯¹åŸå§‹è¯„è®ºç‚¹èµï¼Œéœ€è¦åŒæ—¶ä¿®æ”¹ä¸¤å¤„æ•°æ®

1. å›å¤ç»„ä»¶ä¸­è‡ªå·±çš„çŠ¶æ€
2. æ–‡ç« è¯¦æƒ…é¡µé¢ä¸­è¯¥è¯„è®ºçš„ç‚¹èµæ•°é‡

åŸå› è¯´æ˜ï¼šå¦‚æœåªä¿®æ”¹å½“å‰ç»„ä»¶çš„æ•°æ®ï¼Œè¿”å›æ–‡ç« è¯¦æƒ…é¡µé¢æ—¶ï¼Œæ–‡ç« è¯¦æƒ…é¡µé¢ä¸­çš„æ•°æ®ä¸ä¼šè‡ªåŠ¨æ›´æ–°

**æ­¥éª¤**ï¼š

1. ä¸ºåŸå§‹è¯„è®ºçš„ç‚¹èµæŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
2. åˆ›å»ºç‚¹èµå‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä¿®æ”¹ç‚¹èµçŠ¶æ€ä»¥åŠç‚¹èµæ•°é‡
3. ä¸ºè¯¥ç»„ä»¶æ·»åŠ é€šçŸ¥çˆ¶ç»„ä»¶æ›´æ–°è¯¥è¯„è®ºç‚¹èµæ•°é‡çš„å‡½æ•°ç±»å‹
4. åœ¨ç‚¹èµå‡½æ•°ä¸­ï¼Œé€šçŸ¥çˆ¶ç»„ä»¶æ›´æ–°è¯„è®ºæ•°æ®

**æ ¸å¿ƒä»£ç **ï¼š

Reply/index.jsx ä¸­ï¼š

```tsx

const Reply = ({ onReplyThumbsUp }) => {
	// ...
  const { com_id, is_liking, like_count } = originComment
  const onOriginThumbsUp = () => {
    // é€šçŸ¥çˆ¶ç»„ä»¶æ›´æ–°è¯¥è¯„è®ºçš„ç‚¹èµçŠ¶æ€
    onReplyThumbsUp(com_id, is_liking)
    const likeCount = is_liking ? -1 : 1
    setOriginComment({
      ...originComment,
      is_liking: !is_liking,
      like_count: like_count + likeCount
    })
  }


  const { results, total_count } = comment


  return (
    // ...
    {/* è¦å›å¤çš„è¯„è®º */}
    <div className="origin-comment">
      <CommentItem
        onThumbsUp={onOriginThumbsUp}
      />
    </div>
  )
}
```

Article/index.jsx ä¸­ï¼š

```jsx
<Reply onReplyThumbsUp={onThumbsUp} />
```

## 23-å¯¹è¯„è®ºè¿›è¡Œå›å¤

**ç›®æ ‡**ï¼šèƒ½å¤Ÿå¯¹è¯„è®ºå†…å®¹è¿›è¡Œå›å¤

**æ­¥éª¤**ï¼š

1. åˆ›å»ºæ§åˆ¶å›å¤è¾“å…¥çš„å¼¹å‡ºå±‚çš„çŠ¶æ€
2. ä¸º CommentFooter æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ‰“å¼€å›å¤è¾“å…¥çš„å¼¹å‡ºå±‚
3. åˆ›å»ºæ·»åŠ å›å¤çš„å‡½æ•°ï¼Œå‘é€è¯·æ±‚æ·»åŠ è¯¥è¯„è®ºçš„å›å¤æ•°æ®ï¼Œå¹¶æ›´æ–°çŠ¶æ€
4. å…³é—­å›å¤è¾“å…¥çš„å¼¹å‡ºå±‚
5. ä¿®æ”¹è¯¥ç»„ä»¶çš„ onClose å±æ€§ç±»å‹ï¼Œå°†è¯¥è¯„è®ºçš„ id ä»¥åŠ æ€»çš„å›å¤æ•°é‡ å›ä¼ ç»™çˆ¶ç»„ä»¶
6. çˆ¶ç»„ä»¶æ›´æ–°è¯¥è¯„è®ºçš„æ•°é‡å¹¶å…³é—­å¼¹å‡ºå±‚

**æ ¸å¿ƒä»£ç **ï¼š

Reply/index.jsx ä¸­ï¼š

```tsx

const Reply = ({ onClose }) => {
  const [replyInput, setReplyInput] = useState(false)


  const onReplyInputShow = () => setReplyVisible(true)
  const onReplyInputHide = () => setReplyVisible(false)


  const onAddReply = async (content) => {
    const res = await http.post('/comments', {
      target: com_id,
      content,
      art_id
    })


    setCommentReply({
      ...commentReply,
      total_count: commentReply.total_count + 1,
      results: [res.data.data.new_obj, ...commentReply.results]
    })


    onReplyInputHide()
  }


  // å…³é—­å¯¹å›å¤å¼¹å‡ºå±‚ï¼Œå°†å½“å‰è¯„è®ºçš„æ€»æ•°é‡ä¼ é€’ç»™çˆ¶ç»„ä»¶
  // å°†å½“å‰å›å¤çš„idï¼Œå’Œå½“å‰è¯„è®ºçš„å›å¤æ€»æ•°ä¼ é€’ç»™çˆ¶ç»„ä»¶ï¼Œç”±çˆ¶ç»„ä»¶æ›´æ–°å›å¤æ€»æ•°
  const onBackToArticle = () => {
    onClose(originComment.com_id, commentReply.total_count)
  }


  return (
  	// ...
    <CommentFooter
      placeholder="å»è¯„è®º"
      type="reply"
      onCommentPopup={onReplyInputShow}
    />


		<Popup className="reply-popup" position="bottom" visible={replyVisible}>
      <CommentInput
        name={aut_name}
        onClose={onReplyInputHide}
        onComment={onAddReply}
      />
    </Popup>
  )
}
```

Article/index.jsx ä¸­ï¼š

:::tip

è®¡ç®—æ€»æ•°çš„æ—¶å€™ï¼Œéœ€è¦æ‰‹åŠ¨çš„å»è®¡ç®—è¿›è¡Œæ§åˆ¶

:::

```tsx
const Artilce = () => {
  const onCloseReplyWithUpdate = (commentId, total) => {
    // ä¿®æ”¹reduxä¸­çš„è¯„è®ºåˆ—è¡¨æ•°æ®
    dispatch(updateCommentCount(commentId, total));
    onCloseReply();
  };


  return (
    // ...
    <Reply onClose={onCloseReplyWithUpdate} />
  );
};
```