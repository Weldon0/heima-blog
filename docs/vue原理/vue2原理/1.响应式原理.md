---
title: ğŸŒ¹1ã€å“åº”å¼åŸç†
---

> 1. æ•°æ®é©±åŠ¨
>
> 2. å“åº”å¼çš„æ ¸å¿ƒåŸç†
>
> 3. å‘å¸ƒè®¢é˜…æ¨¡å¼å’Œè§‚å¯Ÿè€…æ¨¡å¼

### ä¸€ã€æ•°æ®é©±åŠ¨

* å“åº”å¼ã€åŒå‘ç»‘å®šã€æ•°æ®é©±åŠ¨

* æ•°æ®å“åº”å¼
  * æ•°æ®æ¨¡å‹ä»…ä»…æ˜¯æ™®é€šçš„ JavaScript å¯¹è±¡ï¼Œè€Œå½“æˆ‘ä»¬ä¿®æ”¹æ•°æ®æ—¶ï¼Œè§†å›¾ä¼šè¿›è¡Œæ›´æ–°ï¼Œé¿å…äº†ç¹ççš„ DOM æ“ä½œï¼Œæé«˜å¼€å‘æ•ˆç‡

* åŒå‘ç»‘å®š
  * æ•°æ®æ”¹å˜ï¼Œè§†å›¾æ”¹å˜ï¼›è§†å›¾æ”¹å˜ï¼Œæ•°æ®ä¹Ÿéšä¹‹æ”¹å˜
  * æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ v-model åœ¨è¡¨å•å…ƒç´ ä¸Šåˆ›å»ºåŒå‘æ•°æ®ç»‘å®š

* æ•°æ®é©±åŠ¨æ˜¯ Vue æœ€ç‹¬ç‰¹çš„ç‰¹æ€§ä¹‹ä¸€
  * å¼€å‘è¿‡ç¨‹ä¸­ä»…éœ€è¦å…³æ³¨æ•°æ®æœ¬èº«ï¼Œä¸éœ€è¦å…³å¿ƒæ•°æ®æ˜¯å¦‚ä½•æ¸²æŸ“åˆ°è§†å›¾

### äºŒã€æ•°æ®å“åº”å¼çš„æ ¸å¿ƒåŸç†

#### vue2.x

* [Vue 2.xæ·±å…¥å“åº”å¼åŸç†](https://cn.vuejs.org/v2/guide/reactivity.html)

* [MDN - Object.defifineProperty](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty)

æµè§ˆå™¨å…¼å®¹ IE8 ä»¥ä¸Šï¼ˆä¸å…¼å®¹ IE8ï¼‰

```js
// æ¨¡æ‹Ÿ Vue ä¸­çš„ data é€‰é¡¹ 
let data = { msg: 'hello' }// æ¨¡æ‹Ÿ Vue çš„å®ä¾‹ 
let vm = {} // æ•°æ®åŠ«æŒï¼šå½“è®¿é—®æˆ–è€…è®¾ç½® vm ä¸­çš„æˆå‘˜çš„æ—¶å€™ï¼Œåšä¸€äº›å¹²é¢„æ“ä½œ

Object.defineProperty(vm, "msg", {
  // å¯æšä¸¾ï¼ˆå¯éå†ï¼‰ enumerable: true,
  // å¯é…ç½®ï¼ˆå¯ä»¥ä½¿ç”¨ delete åˆ é™¤ï¼Œå¯ä»¥é€šè¿‡ defineProperty é‡æ–°å®šä¹‰ï¼‰
  configurable: true,
  // å½“è·å–å€¼çš„æ—¶å€™æ‰§è¡Œ
  get() {
    console.log("get: ", data.msg);
    return data.msg;
  },
  // å½“è®¾ç½®å€¼çš„æ—¶å€™æ‰§è¡Œ
  set(newValue) {
    console.log("set: ", newValue);
    if (newValue === data.msg) {
      return;
    }
    data.msg = newValue;
    // æ•°æ®æ›´æ”¹ï¼Œæ›´æ–° DOM çš„å€¼
    document.querySelector("#app").textContent = data.msg;
  },
});
// æµ‹è¯•
vm.msg = "Hello World";
console.log(vm.msg);


```

#### vue3.x

[MDN - Proxy](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy)

ç›´æ¥ç›‘å¬å¯¹è±¡ï¼Œè€Œéå±æ€§ã€‚

ES 6ä¸­æ–°å¢ï¼ŒIE ä¸æ”¯æŒï¼Œæ€§èƒ½ç”±æµè§ˆå™¨ä¼˜åŒ–

```js
// æ¨¡æ‹Ÿ Vue ä¸­çš„ data é€‰é¡¹
let data = { msg: "hello", count: 0 };
// æ¨¡æ‹Ÿ Vue å®ä¾‹
let vm = new Proxy(data, {
  // å½“è®¿é—® vm çš„æˆå‘˜ä¼šæ‰§è¡Œ
  get(target, key) {
    console.log("get, key: ", key, target[key]);
    return target[key];
  },
  // å½“è®¾ç½® vm çš„æˆå‘˜ä¼šæ‰§è¡Œ
  set(target, key, newValue) {
    console.log("set, key: ", key, newValue);
    if (target[key] === newValue) {
      return;
    }
    target[key] = newValue;
    document.querySelector("#app").textContent = target[key];
  },
});

// æµ‹è¯• 
vm.msg = 'Hello World' 
console.log(vm.msg)

```



### å‘å¸ƒè®¢é˜…æ¨¡å¼å’Œè§‚å¯Ÿè€…æ¨¡å¼

#### å‘å¸ƒè®¢é˜…æ¨¡å¼

* å‘å¸ƒ/è®¢é˜…æ¨¡å¼

  * è®¢é˜…è€…
  * å‘å¸ƒè€…
  * ä¿¡å·ä¸­å¿ƒ

  > æˆ‘ä»¬å‡å®šï¼Œå­˜åœ¨ä¸€ä¸ª"ä¿¡å·ä¸­å¿ƒ"ï¼ŒæŸä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå°±å‘ä¿¡å·ä¸­å¿ƒ"å‘å¸ƒ"ï¼ˆpublishï¼‰ä¸€ä¸ªä¿¡
  >
  > å·ï¼Œå…¶ä»–ä»»åŠ¡å¯ä»¥å‘ä¿¡å·ä¸­å¿ƒ"è®¢é˜…"ï¼ˆsubscribeï¼‰è¿™ä¸ªä¿¡å·ï¼Œä»è€ŒçŸ¥é“ä»€ä¹ˆæ—¶å€™è‡ªå·±å¯ä»¥å¼€å§‹æ‰§
  >
  > è¡Œã€‚è¿™å°±å«åš"å‘å¸ƒ/è®¢é˜…æ¨¡å¼"ï¼ˆpublish-subscribe pattern)

* Vue çš„è‡ªå®šä¹‰äº‹ä»¶

  [https://cn.vuejs.org/v2/guide/migration.html#dispatch-%E5%92%8C-broadcast-%E6%9B%BF%E6%8D%A2](https://cn.vuejs.org/v2/guide/migration.html#dispatch-%E5%92%8C-broadcast-%E6%9B%BF%E6%8D%A2)

  ```js
  let vm = new Vue() 
  vm.$on('dataChange', () => { 
      console.log('dataChange') 
  })
  vm.$on('dataChange', () => { 
      console.log('dataChange1') 
  })
  vm.$emit('dataChange')
  ```

* å…„å¼Ÿç»„ä»¶é€šä¿¡è¿‡ç¨‹

  ```js
  // eventBus.js 
  // äº‹ä»¶ä¸­å¿ƒ 
  let eventHub = new Vue() 
  // ComponentA.vue 
  // å‘å¸ƒè€… 
  addTodo: function () { 
    // å‘å¸ƒæ¶ˆæ¯(äº‹ä»¶) 
    eventHub.$emit('add-todo', { text: this.newTodoText })
    this.newTodoText = '' 
  },
    // ComponentB.vue
    // è®¢é˜…è€… 
    created: function() {
    // è®¢é˜…æ¶ˆæ¯(äº‹ä»¶) 
      eventHub.$on('add-todo', this.addTodo) 
    }
  ```

* æ¨¡æ‹Ÿvueè‡ªå®šä¹‰äº‹ä»¶å®ç°

  ```js
  class EventEmitter {
    constructor() {
      // { eventType: [ handler1, handler2 ] }
      this.subs = {}
    }
  
  // è®¢é˜…é€šçŸ¥
    $on(eventType, handler) {
      this.subs[eventType] = this.subs[eventType] || []
      this.subs[eventType].push(handler)
    }
  
  
  // å‘å¸ƒé€šçŸ¥
    $emit(eventType) {
      if (this.subs[eventType]) {
        this.subs[eventType].forEach(handler => {
          handler()
        })
      }
    }
  }
  
  // æµ‹è¯•
  var bus = new EventEmitter()
  // æ³¨å†Œäº‹ä»¶
  bus.$on('click', function () {
    console.log('click')
  })
  bus.$on('click', function () {
    console.log('click1')
  })// è§¦å‘äº‹ä»¶ bus.$emit('click')
  
  ```

  

### **è§‚å¯Ÿè€…æ¨¡å¼**

* è§‚å¯Ÿè€…(è®¢é˜…è€…) -- Watcher
  * update()ï¼šå½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå…·ä½“è¦åšçš„äº‹æƒ…
* ç›®æ ‡(å‘å¸ƒè€…) -- Dep
  * subs æ•°ç»„ï¼šå­˜å‚¨æ‰€æœ‰çš„è§‚å¯Ÿè€…
  * addSub()ï¼šæ·»åŠ è§‚å¯Ÿè€…
  * notify()ï¼šå½“äº‹ä»¶å‘ç”Ÿï¼Œè°ƒç”¨æ‰€æœ‰è§‚å¯Ÿè€…çš„ update() æ–¹æ³•
* æ²¡æœ‰äº‹ä»¶ä¸­å¿ƒ

```js
// ç›®æ ‡(å‘å¸ƒè€…) 
// Dependency
class Dep { 
  constructor () { 
    // å­˜å‚¨æ‰€æœ‰çš„è§‚å¯Ÿè€… 
    this.subs = [] 
  }
  // æ·»åŠ è§‚å¯Ÿè€… 
  addSub (sub) { 
    if (sub && sub.update) {
      this.subs.push(sub) 
    }
  }
  // é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€… 
  notify () { 
    this.subs.forEach(sub => { sub.update() }) 
  }
}
// è§‚å¯Ÿè€…(è®¢é˜…è€…) 
class Watcher { 
  update () { 
    console.log('update') 
  } 
}
// æµ‹è¯• 
let dep = new Dep() 
let watcher = new Watcher() 
dep.addSub(watcher) 
dep.notify()
```

**æ€»ç»“**

**è§‚å¯Ÿè€…æ¨¡å¼**:æ˜¯ç”±å…·ä½“ç›®æ ‡è°ƒåº¦ï¼Œæ¯”å¦‚å½“äº‹ä»¶è§¦å‘ï¼ŒDep å°±ä¼šå»è°ƒç”¨è§‚å¯Ÿè€…çš„æ–¹æ³•ï¼Œæ‰€ä»¥è§‚å¯Ÿè€…æ¨¡å¼çš„è®¢é˜…è€…ä¸å‘å¸ƒè€…ä¹‹é—´æ˜¯å­˜åœ¨ä¾èµ–çš„ã€‚

**å‘å¸ƒ/è®¢é˜…**æ¨¡å¼: ç”±ç»Ÿä¸€è°ƒåº¦ä¸­å¿ƒè°ƒç”¨ï¼Œå› æ­¤å‘å¸ƒè€…å’Œè®¢é˜…è€…ä¸éœ€è¦çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ã€‚

<img src="https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/%E7%AC%AC5%E9%A1%B5-2.PNG" alt="ç¬¬5é¡µ-2" style="zoom:50%;" />

### vueå“åº”å¼åŸç†æ¨¡æ‹Ÿ

#### æ•´ä½“åˆ†æ

<img src="https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/%E7%AC%AC6%E9%A1%B5-3.PNG" alt="ç¬¬6é¡µ-3" style="zoom:50%;" />

* Vue
  * æŠŠ data ä¸­çš„æˆå‘˜æ³¨å…¥åˆ° Vue å®ä¾‹ï¼Œå¹¶ä¸”æŠŠ data ä¸­çš„æˆå‘˜è½¬æˆ getter/setter
* Observer
  * èƒ½å¤Ÿå¯¹æ•°æ®å¯¹è±¡çš„æ‰€æœ‰å±æ€§è¿›è¡Œç›‘å¬ï¼Œå¦‚æœ‰å˜åŠ¨å¯æ‹¿åˆ°æœ€æ–°å€¼å¹¶é€šçŸ¥ Dep

* Compiler
  * è§£ææ¯ä¸ªå…ƒç´ ä¸­çš„æŒ‡ä»¤/æ’å€¼è¡¨è¾¾å¼ï¼Œå¹¶æ›¿æ¢æˆç›¸åº”çš„æ•°æ®

* Dep
  * æ·»åŠ è§‚å¯Ÿè€…(watcher)ï¼Œå½“æ•°æ®å˜åŒ–é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…

* Watcher
  * æ•°æ®å˜åŒ–æ›´æ–°è§†å›¾

#### vue

* è´Ÿè´£æ¥æ”¶åˆå§‹åŒ–çš„å‚æ•°(é€‰é¡¹)
* è´Ÿè´£æŠŠ data ä¸­çš„å±æ€§æ³¨å…¥åˆ° Vue å®ä¾‹ï¼Œè½¬æ¢æˆ getter/setter
* è´Ÿè´£è°ƒç”¨ observer ç›‘å¬ data ä¸­æ‰€æœ‰å±æ€§çš„å˜åŒ–
* è´Ÿè´£è°ƒç”¨ compiler è§£ææŒ‡ä»¤/æ’å€¼è¡¨è¾¾å¼

<img src="https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/%E7%AC%AC7%E9%A1%B5-4.PNG" alt="ç¬¬7é¡µ-4" style="zoom:50%;" />

```js
class Vue {
  constructor(options) {
    //1.ä¿å­˜é€‰é¡¹çš„æ•°æ®
    this.$options = options || {}
    this.$data = options.data || {}
    const el = options.el
    this.$el = typeof options.el === 'string' ? document.querySelector(el) : el;
    //2.è´Ÿè´£æŠŠdataæ³¨å…¥åˆ°Vueå®ä¾‹
    this._proxyData(this.$data)
    //3.è´Ÿè´£è°ƒç”¨Observerå®ç°æ•°æ®åŠ«æŒ
    //4.è´Ÿè´£è°ƒç”¨Compilerè§£ææŒ‡ä»¤/æ’å€¼è¡¨è¾¾å¼ç­‰
  }

  _proxyData(data) {
    //éå†dataçš„æ‰€æœ‰å±æ€§
    Object.keys(data).forEach(key => {
      Object.defineProperty(this, key, {
        get() {
          return data[key]
        },
        set(newValue) {
          if (data[key] === newValue) {
            return
          }
          data[key] = newValue
        }
      })
    })
  }
}

```

#### Observer

* åŠŸèƒ½

  * è´Ÿè´£æŠŠ data é€‰é¡¹ä¸­çš„å±æ€§è½¬æ¢æˆå“åº”å¼æ•°æ®
  * data ä¸­çš„æŸä¸ªå±æ€§ä¹Ÿæ˜¯å¯¹è±¡ï¼ŒæŠŠè¯¥å±æ€§è½¬æ¢æˆå“åº”å¼æ•°æ®
  * æ•°æ®å˜åŒ–å‘é€é€šçŸ¥

* ç»“æ„

  <img src="https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/%E7%AC%AC8%E9%A1%B5-5.PNG" alt="ç¬¬8é¡µ-5" style="zoom:50%;" />

  

```js
// è´Ÿè´£æ•°æ®åŠ«æŒ
// æŠŠ$dataä¸­çš„æˆå‘˜è½¬æ¢æˆgetter/setter
class Observer {
  constructor(data) {
    this.walk(data)
  }
  // 1.åˆ¤æ–­æ•°æ®æ˜¯å¦æ˜¯å¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯å¯¹è±¡è¿”å›
  // 2.å¦‚æœæ˜¯å¯¹è±¡ï¼Œéå†å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œè®¾ç½®ä¸ºgetter/setter
  walk(data) {
    if (!data || typeof data !== 'object') {
      return
    }

    Object.keys(data).forEach(key => {
      this.defineReactive(data, key, data[key])
    })
  }

  // å®šä¹‰å“åº”å¼æˆå‘˜
  defineReactive(data, key, val) {
    const that = this
    // å¦‚æœvalæ˜¯å¯¹è±¡ï¼Œç»§ç»­è®¾ç½®å®ƒä¸‹é¢çš„æˆå‘˜ä¸ºå“åº”å¼æ•°æ®
    this.walk(val)
    Object.defineProperty(data, key, {
      configurable: true,
      enumerable: true,
      get() {
        return val
      },
      set(newValue) {
        if (newValue === val) {
          return
        }
        // å¦‚æœnewValueæ˜¯å¯¹è±¡ï¼Œè®¾ç½®newValueçš„æˆå‘˜ä¸ºå“åº”å¼
        that.walk(newValue)
        val = newValue
      }
    })
  }
}


```

### Compiler

* åŠŸèƒ½

  * è´Ÿè´£ç¼–è¯‘æ¨¡æ¿ï¼Œè§£ææŒ‡ä»¤/æ’å€¼è¡¨è¾¾å¼
  * è´Ÿè´£é¡µé¢çš„é¦–æ¬¡æ¸²æŸ“
  * å½“æ•°æ®å˜åŒ–åé‡æ–°æ¸²æŸ“è§†å›¾

* ç»“æ„

  ![ç¬¬9é¡µ-6](https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/%E7%AC%AC9%E9%A1%B5-6.PNG)

  

```js
//è´Ÿè´£è§£ææŒ‡ä»¤/æ’å€¼è¡¨è¾¾å¼
class Compiler {
  constructor(vm) {
    this.vm = vm
    this.el = vm.$el
    //ç¼–è¯‘æ¨¡æ¿
    this.compile(this.el)
  }

  // ç¼–è¯‘æ¨¡æ¿
  // å¤„ç†æ–‡æœ¬èŠ‚ç‚¹å’Œå…ƒç´ èŠ‚ç‚¹
  compile(el) {
    const nodes = el.childNodes
    Array.from(nodes).forEach(node => { // åˆ¤æ–­æ˜¯æ–‡æœ¬èŠ‚ç‚¹è¿˜æ˜¯å…ƒç´ èŠ‚ç‚¹
      if (this.isTextNode(node)) {
        this.compileText(node)
      } else if (this.isElementNode(node)) {
        this.compileElement(node)
      }

      if (node.childNodes && node.childNodes.length) { // å¦‚æœå½“å‰èŠ‚ç‚¹ä¸­è¿˜æœ‰å­èŠ‚ç‚¹ï¼Œé€’å½’ç¼–è¯‘
        this.compile(node)
      }
    })
  }

  //åˆ¤æ–­æ˜¯å¦æ˜¯æ–‡æœ¬èŠ‚ç‚¹
  isTextNode(node) {
    return node.nodeType === 3
  }

  //åˆ¤æ–­æ˜¯å¦æ˜¯å±æ€§èŠ‚ç‚¹
  isElementNode(node) {
    return node.nodeType === 1
  }

  //åˆ¤æ–­æ˜¯å¦æ˜¯ä»¥v-å¼€å¤´çš„æŒ‡ä»¤
  isDirective(attrName) {
    return attrName.startsWith('v-')
  }

  //ç¼–è¯‘æ–‡æœ¬èŠ‚ç‚¹
  compileText(node) {
  }

  //ç¼–è¯‘å±æ€§èŠ‚ç‚¹
  compileElement(node) {
  }

}

```

#### compileText()

* è´Ÿè´£ç¼–è¯‘æ’å€¼è¡¨è¾¾å¼

```js
//ç¼–è¯‘æ–‡æœ¬èŠ‚ç‚¹
  compileText(node) {
    const reg = /\{\{(.+)\}\}/
    //è·å–æ–‡æœ¬èŠ‚ç‚¹çš„å†…å®¹
    const value = node.textContent
    if (reg.test(value)) {
      //æ’å€¼è¡¨è¾¾å¼ä¸­çš„å€¼å°±æ˜¯æˆ‘ä»¬è¦çš„å±æ€§åç§°
      const key = RegExp.$1.trim()
      //æŠŠæ’å€¼è¡¨è¾¾å¼æ›¿æ¢æˆå…·ä½“çš„å€¼
      node.textContent = value.replace(reg, this.vm[key])
    }
  }
```

#### **compileElement()**

* è´Ÿè´£ç¼–è¯‘å…ƒç´ çš„æŒ‡ä»¤

* å¤„ç† v-text çš„é¦–æ¬¡æ¸²æŸ“

* å¤„ç† v-model çš„é¦–æ¬¡æ¸²æŸ“

```js
// ç¼–è¯‘å±æ€§èŠ‚ç‚¹
  compileElement(node) {
    // éå†å…ƒç´ èŠ‚ç‚¹ä¸­çš„æ‰€æœ‰å±æ€§ï¼Œæ‰¾åˆ°æŒ‡ä»¤
    Array.from(node.attributes).forEach((attr) => {
      // è·å–å…ƒç´ å±æ€§çš„åç§°
      let attrName = attr.name;
      // åˆ¤æ–­å½“å‰çš„å±æ€§åç§°æ˜¯å¦æ˜¯æŒ‡ä»¤
      if (this.isDirective(attrName)) {
        // attrName çš„å½¢å¼ v-text v-model
        // æˆªå–å±æ€§çš„åç§°ï¼Œè·å– text model
        attrName = attrName.substr(2);
        // è·å–å±æ€§çš„åç§°ï¼Œå±æ€§çš„åç§°å°±æ˜¯æˆ‘ä»¬æ•°æ®å¯¹è±¡çš„å±æ€§ v-text="name"ï¼Œè·å–çš„æ˜¯ name
        const key = attr.value;
        // å¤„ç†ä¸åŒçš„æŒ‡ä»¤
        this.update(node, key, attrName);
      }
    });
  }

  // è´Ÿè´£æ›´æ–° DOM
  // åˆ›å»º Watcher
  update(node, key, dir) {
    // node èŠ‚ç‚¹ï¼Œkey æ•°æ®çš„å±æ€§åç§°ï¼Œdir æŒ‡ä»¤çš„ååŠéƒ¨åˆ†
    const updaterFn = this[dir + "Updater"];
    updaterFn && updaterFn(node, this.vm[key]);
  }

  // v-text æŒ‡ä»¤çš„æ›´æ–°æ–¹æ³•
  textUpdater(node, value) {
    node.textContent = value;
  }

  // v-model æŒ‡ä»¤çš„æ›´æ–°æ–¹æ³•
  modelUpdater(node, value) {
    node.value = value;
  }
```

### Dep(Dependency)

![ç¬¬12é¡µ-8](https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/%E7%AC%AC12%E9%A1%B5-8.PNG)



* åŠŸèƒ½
  * æ‰‹æœºä¾èµ–ï¼Œæ·»åŠ è§‚å¯Ÿè€…(watcher)
  * é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…
* ç»“æ„

<img src="https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/%E7%AC%AC12%E9%A1%B5-7.PNG" alt="ç¬¬12é¡µ-7" style="zoom:40%;" />

* ä»£ç 

```js
class Dep {
  constructor() {
    // å­˜å‚¨æ‰€æœ‰çš„è§‚å¯Ÿè€…
    this.subs = [];
  }

  // æ·»åŠ è§‚å¯Ÿè€…
  addSub(sub) {
    if (sub && sub.update) {
      this.subs.push(sub);
    }
    // é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…
  }
  notify() {
    this.subs.forEach((sub) => {
      sub.update();
    });
  }
}

```

* åœ¨compiler.jsä¸­æ”¶é›†ä¾èµ–ï¼Œå‘é€é€šçŸ¥

  ```js
  //defineReactiveä¸­
  //åˆ›å»ºdepå¯¹è±¡æ”¶é›†ä¾èµ–
  const dep = new Dep();
  //getterä¸­
  //getçš„è¿‡ç¨‹ä¸­æ”¶é›†ä¾èµ–
  Dep.target && dep.addSub(Dep.target);
  
  //setterä¸­
  //å½“æ•°æ®å˜åŒ–ä¹‹åï¼Œå‘é€é€šçŸ¥
  dep.notify();
  
  ```

  

### watcher

![ç¬¬13é¡µ-10](https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/%E7%AC%AC13%E9%A1%B5-10.PNG)

* åŠŸèƒ½

  * å½“æ•°æ®å˜åŒ–è§¦å‘ä¾èµ–ï¼Œ dep é€šçŸ¥æ‰€æœ‰çš„ Watcher å®ä¾‹æ›´æ–°è§†å›¾

  * è‡ªèº«å®ä¾‹åŒ–çš„æ—¶å€™å¾€ dep å¯¹è±¡ä¸­æ·»åŠ è‡ªå·±

* ç»“æ„

  

![ç¬¬13é¡µ-9](https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/%E7%AC%AC13%E9%A1%B5-9.PNG)

* ä»£ç 

  ```js
  class Watcher {
    constructor(vm, key, cb) {
      this.vm = vm;
      //dataä¸­çš„å±æ€§åç§°
      this.key = key;
      //å½“æ•°æ®å˜åŒ–çš„æ—¶å€™ï¼Œè°ƒç”¨cbæ›´æ–°è§†å›¾
      this.cb = cb;
      // åœ¨Depçš„é™æ€å±æ€§ä¸Šè®°å½•å½“å‰watcherå¯¹è±¡ï¼Œå½“è®¿é—®æ•°æ®çš„æ—¶å€™æŠŠwatcheræ·»åŠ åˆ°depçš„subsä¸­
      Dep.target = this;
      //è§¦å‘ä¸€æ¬¡getterï¼Œè®©depä¸ºå½“å‰keyè®°å½•watcher
      this.oldValue = vm[key];
      //æ¸…ç©ºtarget
      Dep.target = null;
    }
    update() {
      const newValue = this.vm[this.key];
      if (this.oldValue === newValue) {
        return;
      }
      this.cb(newValue);
    }
  }
  
  ```

  

* åœ¨ compiler.js ä¸­ä¸ºæ¯ä¸€ä¸ªæŒ‡ä»¤/æ’å€¼è¡¨è¾¾å¼åˆ›å»º watcher å¯¹è±¡ï¼Œç›‘è§†æ•°æ®çš„å˜åŒ–

  ```js
  // å› ä¸ºåœ¨ textUpdaterç­‰ä¸­è¦ä½¿ç”¨
  this.updaterFn && updaterFn.call(this, node, this.vm[key], key);
  // v-text æŒ‡ä»¤çš„æ›´æ–°æ–¹æ³•
  textUpdater(node, value, key) {
    node.textContent = value;
    // æ¯ä¸€ä¸ªæŒ‡ä»¤ä¸­åˆ›å»ºä¸€ä¸ª watcherï¼Œè§‚å¯Ÿæ•°æ®çš„å˜åŒ–
    new Watcher(this.vm, key, (value) => {
      node.textContent = value;
    });
  }
  
  ```

  

### è§†å›¾å˜åŒ–æ›´æ–°æ•°æ®

```js
// v-model æŒ‡ä»¤çš„æ›´æ–°æ–¹æ³• 
modelUpdater (node, value, key) { 
	node.value = value 
  // æ¯ä¸€ä¸ªæŒ‡ä»¤ä¸­åˆ›å»ºä¸€ä¸ª watcherï¼Œè§‚å¯Ÿæ•°æ®çš„å˜åŒ– 
  new Watcher(this.vm, key, value => { 
    node.value = value 
  })
  // ç›‘å¬è§†å›¾çš„å˜åŒ– 
  node.addEventListener('input', () => { this.vm[key] = node.value }) 
}
```





## æ€»ç»“

<img src="https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/%E7%AC%AC15%E9%A1%B5-11.PNG" alt="ç¬¬15é¡µ-11" style="zoom:80%;" />

* Vue

  * è®°å½•ä¼ å…¥çš„é€‰é¡¹ï¼Œè®¾ç½® $data/$el

  * æŠŠ data çš„æˆå‘˜æ³¨å…¥åˆ° Vue å®ä¾‹
  * è´Ÿè´£è°ƒç”¨ Observer å®ç°æ•°æ®å“åº”å¼å¤„ç†ï¼ˆæ•°æ®åŠ«æŒï¼‰
  * è´Ÿè´£è°ƒç”¨ Compiler ç¼–è¯‘æŒ‡ä»¤/æ’å€¼è¡¨è¾¾å¼ç­‰

* Observer
  * æ•°æ®åŠ«æŒ
    * è´Ÿè´£æŠŠ data ä¸­çš„æˆå‘˜è½¬æ¢æˆ getter/setter
    * è´Ÿè´£æŠŠå¤šå±‚å±æ€§è½¬æ¢æˆ getter/setter
    * å¦‚æœç»™å±æ€§èµ‹å€¼ä¸ºæ–°å¯¹è±¡ï¼ŒæŠŠæ–°å¯¹è±¡çš„æˆå‘˜è®¾ç½®ä¸º getter/setter
  * æ·»åŠ  Dep å’Œ Watcher çš„ä¾èµ–å…³ç³»
  * æ•°æ®å˜åŒ–å‘é€é€šçŸ¥

* Compiler
  * è´Ÿè´£ç¼–è¯‘æ¨¡æ¿ï¼Œè§£ææŒ‡ä»¤/æ’å€¼è¡¨è¾¾å¼
  * è´Ÿè´£é¡µé¢çš„é¦–æ¬¡æ¸²æŸ“è¿‡ç¨‹
  * å½“æ•°æ®å˜åŒ–åé‡æ–°æ¸²æŸ“

* Dep
  * æ”¶é›†ä¾èµ–ï¼Œæ·»åŠ è®¢é˜…è€…(watcher)
  * é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…

* Watcher

  * è‡ªèº«å®ä¾‹åŒ–çš„æ—¶å€™å¾€depå¯¹è±¡ä¸­æ·»åŠ è‡ªå·±

  * å½“æ•°æ®å˜åŒ–depé€šçŸ¥æ‰€æœ‰çš„ Watcher å®ä¾‹æ›´æ–°è§†å›¾
