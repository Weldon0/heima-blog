---
title: ğŸ“š 02-ç™»å½•æ³¨å†Œ
---
# äºŒã€ç™»å½•æ³¨å†Œ

> ç›®æ ‡
> - èƒ½å®ç°ç™»å½•é¡µé¢çš„å¸ƒå±€
> - èƒ½å®ç°åŸºæœ¬ç™»å½•åŠŸèƒ½
> - èƒ½æŒæ¡ Vant ä¸­ Toast æç¤ºç»„ä»¶çš„ä½¿ç”¨
> - èƒ½ç†è§£ API è¯·æ±‚æ¨¡å—çš„å°è£…
> - èƒ½ç†è§£å‘é€éªŒè¯ç çš„å®ç°æ€è·¯
> - èƒ½ç†è§£ Vant Form å®ç°è¡¨å•éªŒè¯çš„ä½¿ç”¨

<img src="https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/image-20200228161041266.png" alt="image-20200228161041266" style="zoom:50%;" />

## å‡†å¤‡

### åˆ›å»ºç»„ä»¶å¹¶é…ç½®è·¯ç”±

1ã€åˆ›å»º `src/views/login/index.vue` å¹¶å†™å…¥ä»¥ä¸‹å†…å®¹

```html
<template>
  <div class="login-container">ç™»å½•é¡µé¢</div>
</template>

<script>
export default {
  name: 'LoginPage',
  components: {},
  props: {},
  data () {
    return {}
  },
  computed: {},
  watch: {},
  created () {},
  mounted () {},
  methods: {}
}
</script>
<style scoped lang="less"></style>
```

2ã€ç„¶ååœ¨ `src/router/index.js` ä¸­é…ç½®ç™»å½•é¡µçš„è·¯ç”±è¡¨

```javascript
{
  path: '/login',
  name: 'login',
  component: () => import('@/views/login')
}
```


æœ€åï¼Œè®¿é—® `/login` æŸ¥çœ‹æ˜¯å¦èƒ½è®¿é—®åˆ°ç™»å½•é¡µé¢ã€‚

<img src="https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/image-20200229115109026.png" alt="image-20200229115109026" style="zoom:50%;" />

:::info å¦‚ä½•ä¿®æ”¹vantç»„ä»¶ä¸»é¢˜ï¼Ÿ

1. ä¿®æ”¹vue.config.jsé…ç½®é¡¹(æ–‡æ¡£ä¸­ç²˜è´´)
2. å®šä¹‰è‡ªå·±çš„ä¸»é¢˜æ–‡ä»¶ theme.less
3. åœ¨vue.config.jsä¸­é€šè¿‡ç»å¯¹è·¯å¾„å½¢å¼è¿›è¡Œå¼•å…¥
4. é€šè¿‡æŸ¥é˜…æ–‡æ¡£ï¼Œæ›¿æ¢è‡ªå·±æƒ³è¦æ›¿æ¢çš„ä¸»é¢˜å˜é‡å³å¯


:::

### å¸ƒå±€ç»“æ„

è¿™é‡Œä¸»è¦ä½¿ç”¨åˆ°ä¸‰ä¸ª Vant ç»„ä»¶ï¼š

- [NavBar å¯¼èˆªæ ](https://youzan.github.io/vant/#/zh-CN/nav-bar)
- [Form è¡¨å•](https://youzan.github.io/vant/#/zh-CN/form)
  - [Field è¾“å…¥æ¡†](https://youzan.github.io/vant/#/zh-CN/field)
  - [Button æŒ‰é’®](https://youzan.github.io/vant/#/zh-CN/button)

> > ä¸€ä¸ªç»éªŒï¼šä½¿ç”¨ç»„ä»¶åº“ä¸­çš„ç°æœ‰ç»„ä»¶å¿«é€Ÿå¸ƒå±€ï¼Œå†æ…¢æ…¢è°ƒæ•´ç»†èŠ‚ï¼Œæ•ˆç‡æ›´é«˜ï¼ˆåˆšå¼€å§‹å¯èƒ½ä¼šæ„Ÿè§‰æœ‰ç‚¹éº»çƒ¦ï¼Œè¶Šç”¨è¶Šç†Ÿï¼Œæ…¢æ…¢çš„å°±æœ‰äº†è‡ªå·±çš„æ€æƒ³ï¼‰ã€‚

1. ç™»é™†åŸºæœ¬ç»“æ„

> ```html
> <van-nav-bar title="ç™»å½•" />
> <van-form @submit="onSubmit">
> <van-field
>    name="ç”¨æˆ·å"
>    placeholder="ç”¨æˆ·å"
>    />
> <van-field
>    type="password"
>    name="å¯†ç "
>    placeholder="å¯†ç "
>    />
> <div style="margin: 16px;">
> <van-button block type="info" native-type="submit">
> æäº¤
> </van-button>
> </div>
> </van-form>
> ```

2. å®šä¹‰onSubmitæ–¹æ³•

> ```js
> onSubmit (values) {
> console.log('submit', values)
> }
> ```
>

### å¸ƒå±€æ ·å¼

11ï¼š32ç§’æš‚åœï¼šå®Œæˆå›¾æ ‡æ˜¾ç¤º

> å†™æ ·å¼çš„åŸåˆ™ï¼šå°†å…¬å…±æ ·å¼å†™åˆ°å…¨å±€ï¼ˆ`src/styles/index.less`ï¼‰ï¼Œå°†å±€éƒ¨æ ·å¼å†™åˆ°ç»„ä»¶å†…éƒ¨ã€‚


1ã€`src/styles/index.less`

```less
body {
  background-color: #f5f7f9;
}

.page-nav-bar {
  background-color: #3296fa;
  .van-nav-bar__title {
    color: #fff;
  }
}
```

2ã€`src/views/login/index.vue`

```html
<template>
  <div class="login-container">
    <!-- å¯¼èˆªæ  -->
    <van-nav-bar class="page-nav-bar" title="ç™»å½•" />
    <!-- /å¯¼èˆªæ  -->

    <!-- ç™»å½•è¡¨å• -->
    <van-form @submit="onSubmit">
      <van-field
        name="ç”¨æˆ·å"
        placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
      >
        <i slot="left-icon" class="toutiao toutiao-shouji"></i>
      </van-field>
      <van-field
        type="password"
        name="éªŒè¯ç "
        placeholder="è¯·è¾“å…¥éªŒè¯ç "
      >
        <i slot="left-icon" class="toutiao toutiao-yanzhengma"></i>
        <template #button>
          <van-button class="send-sms-btn" round size="small" type="default">å‘é€éªŒè¯ç </van-button>
        </template>
      </van-field>
      <div class="login-btn-wrap">
        <van-button class="login-btn" block type="info" native-type="submit">
          ç™»å½•
        </van-button>
      </div>
    </van-form>
    <!-- /ç™»å½•è¡¨å• -->
  </div>
</template>
<script>
export default {
  name: 'LoginIndex',
  components: {},
  props: {},
  data () {
    return {
    }
  },
  computed: {},
  watch: {},
  created () {},
  mounted () {},
  methods: {
    onSubmit (values) {
      console.log('submit', values)
    }
  }
}
</script>
<style scoped lang="less">
.login-container {
  .toutiao {
    font-size: 37px;
  }
  .send-sms-btn {
    width: 152px;
    height: 46px;
    line-height: 46px;
    background-color: #ededed;
    font-size: 22px;
    color: #666;
  }
  .login-btn-wrap {
    padding: 53px 33px;
    .login-btn {
      background-color: #6db4fb;
      border: none;
    }
  }
}
</style>
```

## å®ç°åŸºæœ¬ç™»å½•åŠŸèƒ½

å®ç°è¾“å…¥æ¡†çš„åŒå‘ç»‘å®šï¼Œå°è£…ç™»é™†è¯·æ±‚æ–¹æ³•

æ€è·¯ï¼š

- æ³¨å†Œç‚¹å‡»ç™»å½•çš„äº‹ä»¶
- è·å–è¡¨å•æ•°æ®ï¼ˆæ ¹æ®æ¥å£è¦æ±‚ä½¿ç”¨ v-model ç»‘å®šï¼‰
- è¡¨å•éªŒè¯
- å‘è¯·æ±‚æäº¤
- æ ¹æ®è¯·æ±‚ç»“æœåšä¸‹ä¸€æ­¥å¤„ç†

**ä¸€ã€æ ¹æ®æ¥å£è¦æ±‚ç»‘å®šè·å–è¡¨å•æ•°æ®**

1ã€åœ¨ç™»å½•é¡µé¢ç»„ä»¶çš„å®ä¾‹é€‰é¡¹ data ä¸­æ·»åŠ  `user` æ•°æ®å­—æ®µ

```javascript
...
data () {
  return {
    user: {
      mobile: '',
      code: ''
    }
  }
}
```

2ã€åœ¨è¡¨å•ä¸­ä½¿ç”¨ `v-model` ç»‘å®šå¯¹åº”æ•°æ®

```html
<!-- van-cell-group ä»…ä»…æ˜¯æä¾›äº†ä¸€ä¸ªä¸Šä¸‹å¤–è¾¹æ¡†ï¼Œèƒ½çœ‹åˆ°åŒ…è£¹çš„åŒºåŸŸ -->
<van-cell-group>
  <van-field
    v-model="user.mobile"
    required
    clearable
    label="æ‰‹æœºå·"
    placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
  />
  <van-field
    v-model="user.code"
    type="number"
    label="éªŒè¯ç "
    placeholder="è¯·è¾“å…¥éªŒè¯ç "
    required
  />
</van-cell-group>
```

æœ€åæµ‹è¯•ã€‚

> ä¸€ä¸ªå°æŠ€å·§ï¼šä½¿ç”¨ VueDevtools è°ƒè¯•å·¥å…·æŸ¥çœ‹æ˜¯å¦ç»‘å®šæˆåŠŸã€‚



**äºŒã€è¯·æ±‚ç™»å½•**

1ã€åˆ›å»º `src/api/user.js` å°è£…è¯·æ±‚æ–¹æ³•

```js
/**
 * ç”¨æˆ·ç›¸å…³çš„è¯·æ±‚æ¨¡å—
 */
import request from "@/utils/request"
/**
 * ç”¨æˆ·ç™»å½•
 */
export const login = data => {
  return request({
    method: 'POST',
    url: '/app/v1_0/authorizations',
    data
  })
}
```

2ã€å¼•å…¥loginè¯·æ±‚æ–¹æ³•

```js
import { login } from '@/api/user.js'
```

3ã€å®Œå–„è¡¨å•æäº¤äº‹ä»¶å‡½æ•°

```javascript
async onSubmit () {
    const user = this.user
    try {
        const res = await login(user)
        console.log('ç™»å½•æˆåŠŸ', res)
    } catch (err) {
        if (err.response.status === 400) {
            console.log('ç™»å½•å¤±è´¥', err)
        }
    }
}
```

æœ€åæµ‹è¯•ã€‚

## ç™»å½•çŠ¶æ€æç¤º

Vant ä¸­å†…ç½®äº†[Toast è½»æç¤º](https://youzan.github.io/vant/#/zh-CN/toast)ç»„ä»¶ï¼Œå¯ä»¥å®ç°ç§»åŠ¨ç«¯å¸¸è§çš„æç¤ºæ•ˆæœã€‚

```javascript
// ç®€å•æ–‡å­—æç¤º
Toast("æç¤ºå†…å®¹");

// loading è½¬åœˆåœˆæç¤º
Toast.loading({
  duration: 0, // æŒç»­å±•ç¤º toast
  message: "åŠ è½½ä¸­...",
  forbidClick: true // æ˜¯å¦ç¦æ­¢èƒŒæ™¯ç‚¹å‡»
});

// æˆåŠŸæç¤º
Ttoast.success("æˆåŠŸæ–‡æ¡ˆ");

// å¤±è´¥æç¤º
Toast.fail("å¤±è´¥æ–‡æ¡ˆ");
```

> æç¤ºï¼šåœ¨ç»„ä»¶ä¸­å¯ä»¥ç›´æ¥é€šè¿‡ `this.$toast` è°ƒç”¨ã€‚


å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼šToast é»˜è®¤é‡‡ç”¨å•ä¾‹æ¨¡å¼ï¼Œå³åŒä¸€æ—¶é—´åªä¼šå­˜åœ¨ä¸€ä¸ª Toastï¼Œå¦‚æœéœ€è¦åœ¨åŒä¸€æ—¶é—´å¼¹å‡ºå¤šä¸ª Toastï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„ç¤ºä¾‹

```javascript
Toast.allowMultiple();
const toast1 = Toast('ç¬¬ä¸€ä¸ª Toast');
const toast2 = Toast.success('ç¬¬äºŒä¸ª Toast');
toast1.clear();
toast2.clear();
```

ä¸‹é¢æ˜¯ä¸ºæˆ‘ä»¬çš„ç™»å½•åŠŸèƒ½å¢åŠ  toast äº¤äº’æç¤ºã€‚

```javascript
async onLogin () {
  // å¼€å§‹è½¬åœˆåœˆ
  this.$toast.loading({
    duration: 0, // æŒç»­æ—¶é—´ï¼Œ0è¡¨ç¤ºæŒç»­å±•ç¤ºä¸åœæ­¢
    forbidClick: true, // æ˜¯å¦ç¦æ­¢èƒŒæ™¯ç‚¹å‡»
    message: 'ç™»å½•ä¸­...' // æç¤ºæ¶ˆæ¯
  })

  try {
    const res = await request({
      method: 'POST',
      url: '/app/v1_0/authorizations',
      data: this.user
    })
    console.log('ç™»å½•æˆåŠŸ', res)
    // æç¤º success æˆ–è€… fail çš„æ—¶å€™ï¼Œä¼šå…ˆæŠŠå…¶å®ƒçš„ toast å…ˆæ¸…é™¤
    this.$toast.success('ç™»å½•æˆåŠŸ')
  } catch (err) {
    console.log('ç™»å½•å¤±è´¥', err)
    this.$toast.fail('ç™»å½•å¤±è´¥ï¼Œæ‰‹æœºå·æˆ–éªŒè¯ç é”™è¯¯')
  }
}
```

å‡å¦‚è¯·æ±‚éå¸¸å¿«çš„è¯å°±çœ‹ä¸åˆ° loading æ•ˆæœäº†ï¼Œè¿™é‡Œå¯ä»¥æ‰‹åŠ¨å°†è°ƒè¯•å·¥å…·ä¸­çš„ç½‘ç»œè®¾ç½®ä¸ºæ…¢é€Ÿç½‘ç»œã€‚

æµ‹è¯•ç»“æŸï¼Œå†æŠŠç½‘ç»œè®¾ç½®æ¢å¤ä¸º `Online` æ­£å¸¸ç½‘ç»œã€‚

## è¡¨å•éªŒè¯



> å‚è€ƒæ–‡æ¡£ï¼š[Form è¡¨å•éªŒè¯](https://youzan.github.io/vant/#/zh-CN/form#xiao-yan-gui-ze)

```html
<template>
  <div class="login-container">
    <!-- å¯¼èˆªæ  -->
    <van-nav-bar class="page-nav-bar" title="ç™»å½•" />
    <!-- /å¯¼èˆªæ  -->

    <!-- ç™»å½•è¡¨å• -->
    <!--
      è¡¨å•éªŒè¯ï¼š
        1ã€ç»™ van-field ç»„ä»¶é…ç½® rules éªŒè¯è§„åˆ™
          å‚è€ƒæ–‡æ¡£ï¼šhttps://youzan.github.io/vant/#/zh-CN/form#rule-shu-ju-jie-gou
        2ã€å½“è¡¨å•æäº¤çš„æ—¶å€™ä¼šè‡ªåŠ¨è§¦å‘è¡¨å•éªŒè¯
           å¦‚æœéªŒè¯é€šè¿‡ï¼Œä¼šè§¦å‘ submit äº‹ä»¶
           å¦‚æœéªŒè¯å¤±è´¥ï¼Œä¸ä¼šè§¦å‘ submit
     -->
    <van-form @submit="onSubmit">
      <van-field
        v-model="user.mobile"
        name="æ‰‹æœºå·"
        placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
        :rules="userFormRules.mobile"
        type="number"
        maxlength="11"
      >
        <i slot="left-icon" class="toutiao toutiao-shouji"></i>
      </van-field>
      <van-field
        v-model="user.code"
        name="éªŒè¯ç "
        placeholder="è¯·è¾“å…¥éªŒè¯ç "
        :rules="userFormRules.code"
        type="number"
        maxlength="6"
      >
        <i slot="left-icon" class="toutiao toutiao-yanzhengma"></i>
        <template #button>
          <van-button class="send-sms-btn" round size="small" type="default">å‘é€éªŒè¯ç </van-button>
        </template>
      </van-field>
      <div class="login-btn-wrap">
        <van-button class="login-btn" block type="info" native-type="submit">
          ç™»å½•
        </van-button>
      </div>
    </van-form>
    <!-- /ç™»å½•è¡¨å• -->
  </div>
</template>
<script>
import { login } from '@/api/user'
export default {
  name: 'LoginIndex',
  components: {},
  props: {},
  data () {
    return {
      user: {
        mobile: '', // æ‰‹æœºå·
        code: '' // éªŒè¯ç 
      },
      userFormRules: {
        mobile: [{
          required: true,
          message: 'æ‰‹æœºå·ä¸èƒ½ä¸ºç©º'
        }, {
          pattern: /^1[3|5|7|8]\d{9}$/,
          message: 'æ‰‹æœºå·æ ¼å¼é”™è¯¯'
        }],
        code: [{
          required: true,
          message: 'éªŒè¯ç ä¸èƒ½ä¸ºç©º'
        }, {
          pattern: /^\d{6}$/,
          message: 'éªŒè¯ç æ ¼å¼é”™è¯¯'
        }]
      }
    }
  },
  computed: {},
  watch: {},
  created () {},
  mounted () {},
  methods: {
    async onSubmit () {
      // 1. è·å–è¡¨å•æ•°æ®
      const user = this.user

      // TODO: 2. è¡¨å•éªŒè¯

      // 3. æäº¤è¡¨å•è¯·æ±‚ç™»å½•
      this.$toast.loading({
        message: 'ç™»å½•ä¸­...',
        forbidClick: true, // ç¦ç”¨èƒŒæ™¯ç‚¹å‡»
        duration: 0 // æŒç»­æ—¶é—´ï¼Œé»˜è®¤ 2000ï¼Œ0 è¡¨ç¤ºæŒç»­å±•ç¤ºä¸å…³é—­
      })
      try {
        const res = await login(user)
        console.log('ç™»å½•æˆåŠŸ', res)
        this.$toast.success('ç™»å½•æˆåŠŸ')
      } catch (err) {
        if (err.response.status === 400) {
          this.$toast.fail('æ‰‹æœºå·æˆ–éªŒè¯ç é”™è¯¯')
        } else {
          this.$toast.fail('ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
        }
      }
      // 4. æ ¹æ®è¯·æ±‚å“åº”ç»“æœå¤„ç†åç»­æ“ä½œ
    }
  }
}
</script>
<style scoped lang="less">
.login-container {
  .toutiao {
    font-size: 37px;
  }
  .send-sms-btn {
    width: 152px;
    height: 46px;
    line-height: 46px;
    background-color: #ededed;
    font-size: 22px;
    color: #666;
  }
  .login-btn-wrap {
    padding: 53px 33px;
    .login-btn {
      background-color: #6db4fb;
      border: none;
    }
  }
}
</style>
```

## éªŒè¯ç å¤„ç†

### éªŒè¯æ‰‹æœºå·

1. æ¸…é™¤å‘é€éªŒè¯ç æŒ‰é’®æäº¤è¡¨å•

   ```html
   <template #button>
      <van-button native-type="button" class="send-code-btn" size="mini" round type="default">
          å‘é€éªŒè¯ç 
      </van-button>
   </template>
   ```

2. ç»™å‘é€éªŒè¯ç æŒ‰é’®æ³¨å†Œç‚¹å‡»äº‹ä»¶

3. ä¿®æ”¹æ‰‹æœºå·è¾“å…¥æ¡†çš„nameä¸ºmobile

   ```html
    <van-field
           v-model="user.mobile"
           name="mobile"
           placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
           :rules="rules.mobile"
           required
         >
           <template #left-icon>
             <i class="toutiao toutiao-shouji"></i>
           </template>
         </van-field>
   ```

4. éªŒè¯æ‰‹æœºå·

```js
async onSendSms () {
  console.log('onSendSms')
  // 1. æ ¡éªŒæ‰‹æœºå·
  try {
    await this.$refs.loginForm.validate('mobile')
  } catch (err) {
    return console.log('éªŒè¯å¤±è´¥', err)
  }
  // 2. éªŒè¯é€šè¿‡ï¼Œæ˜¾ç¤ºå€’è®¡æ—¶
  // 3. è¯·æ±‚å‘é€éªŒè¯ç 
}
```

### ä½¿ç”¨å€’è®¡æ—¶ç»„ä»¶

1ã€åœ¨ data ä¸­æ·»åŠ æ•°æ®ç”¨æ¥æ§åˆ¶å€’è®¡æ—¶çš„æ˜¾ç¤ºå’Œéšè—

```javascript
data () {
  return {
    ...
    isCountDownShow: false
  }
}
```

2ã€ä½¿ç”¨å€’è®¡æ—¶ç»„ä»¶

```html
<van-field
  v-model="user.code"
  placeholder="è¯·è¾“å…¥éªŒè¯ç "
>
  <i class="icon icon-mima" slot="left-icon"></i>
  <van-count-down
    v-if="isCountDownShow"
    slot="button"
    :time="1000 * 5"
    format="ss s"
    @finish="isCountDownShow = false"
  />
  <van-button
    v-else
    slot="button"
    size="small"
    type="primary"
    round
    @click="onSendSmsCode"
  >å‘é€éªŒè¯ç </van-button>
</van-field>
```

3ã€ç‚¹å‡»å€’è®¡æ—¶åˆ‡æ¢å€’è®¡æ—¶ç»„ä»¶å’Œå‘é€éªŒè¯ç æŒ‰é’®æ˜¾ç¤º

```js
async onSendSms () {
    console.log('onSendSms')
    // 1. æ ¡éªŒæ‰‹æœºå·
    try {
        await this.$refs.loginForm.validate('mobile')
    } catch (err) {
        return console.log('éªŒè¯å¤±è´¥', err)
    }
    // 2. éªŒè¯é€šè¿‡ï¼Œæ˜¾ç¤ºå€’è®¡æ—¶
    this.isCountDownShow = true
    // 3. è¯·æ±‚å‘é€éªŒè¯ç 
}
```

### å‘é€éªŒè¯ç 

1ã€åœ¨ `api/user.js` ä¸­æ·»åŠ å°è£…æ•°æ®æ¥å£

```javascript
export const getSmsCode = mobile => {
  return request({
    method: 'GET',
    url: `/app/v1_0/sms/codes/${mobile}`
  })
}
```

2ã€ç»™å‘é€éªŒè¯ç æŒ‰é’®æ³¨å†Œç‚¹å‡»äº‹ä»¶

3ã€å‘é€å¤„ç†

```javascript
async onSendSms () {
  // 1. æ ¡éªŒæ‰‹æœºå·
  try {
    await this.$refs.loginForm.validate('mobile')
  } catch (err) {
    return console.log('éªŒè¯å¤±è´¥', err)
  }
  // 2. éªŒè¯é€šè¿‡ï¼Œæ˜¾ç¤ºå€’è®¡æ—¶
  this.isCountDownShow = true
  // 3. è¯·æ±‚å‘é€éªŒè¯ç 
  try {
    await sendSms(this.user.mobile)
    this.$toast('å‘é€æˆåŠŸ')
  } catch (err) {
    // å‘é€å¤±è´¥ï¼Œå…³é—­å€’è®¡æ—¶
    this.isCountDownShow = false
    if (err.response.status === 429) {
      this.$toast('å‘é€å¤ªé¢‘ç¹äº†ï¼Œè¯·ç¨åé‡è¯•')
    } else {
      this.$toast('å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
    }
  }
}
```

## å¤„ç†ç”¨æˆ· Token

<img src="https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/image-20200329121650635.png" alt="image-20200329121650635"  />

Token æ˜¯ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åæœåŠ¡ç«¯è¿”å›çš„ä¸€ä¸ªèº«ä»½ä»¤ç‰Œï¼Œåœ¨é¡¹ç›®ä¸­çš„å¤šä¸ªä¸šåŠ¡ä¸­éœ€è¦ä½¿ç”¨åˆ°ï¼š

- è®¿é—®éœ€è¦æˆæƒçš„ API æ¥å£
- æ ¡éªŒé¡µé¢çš„è®¿é—®æƒé™
- ...

ä½†æ˜¯æˆ‘ä»¬åªæœ‰åœ¨ç¬¬ä¸€æ¬¡ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åæ‰èƒ½æ‹¿åˆ° Tokenã€‚

æ‰€ä»¥ä¸ºäº†èƒ½åœ¨å…¶å®ƒæ¨¡å—ä¸­è·å–åˆ° Token æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒå­˜å‚¨åˆ°ä¸€ä¸ªå…¬å…±çš„ä½ç½®ï¼Œæ–¹ä¾¿éšæ—¶å–ç”¨ã€‚

å¾€å“ªå„¿å­˜ï¼Ÿ

- æœ¬åœ°å­˜å‚¨
  - è·å–éº»çƒ¦
  - æ•°æ®ä¸æ˜¯å“åº”å¼
- Vuex å®¹å™¨ï¼ˆæ¨èï¼‰
  - è·å–æ–¹ä¾¿
  - å“åº”å¼çš„



ä½¿ç”¨å®¹å™¨å­˜å‚¨ Token çš„æ€è·¯ï¼š

![image-20200109192157006](https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/image-20200109192157006.png)

- ç™»å½•æˆåŠŸï¼Œå°† Token å­˜å‚¨åˆ° Vuex å®¹å™¨ä¸­
  - è·å–æ–¹ä¾¿
  - å“åº”å¼
- ä¸ºäº†æŒä¹…åŒ–ï¼Œè¿˜éœ€è¦æŠŠ Token æ”¾åˆ°æœ¬åœ°å­˜å‚¨
  - æŒä¹…åŒ–

ä¸‹é¢æ˜¯å…·ä½“å®ç°ã€‚

1ã€åœ¨ `src/store/index.js` ä¸­

```js
import Vue from 'vue'
import Vuex from 'vuex'
Vue.use(Vuex)
export default new Vuex.Store({
  state: {
    // ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ä¿¡æ¯
    user: JSON.parse(window.localStorage.getItem('TOUTIAO_USER'))
    // user: null
  },
  mutations: {
    setUser (state, user) {
      state.user = user
      window.localStorage.setItem('TOUTIAO_USER', JSON.stringify(user))
    }
  },
  actions: {
  },
  modules: {
  }
})
```

2ã€ç™»å½•æˆåŠŸä»¥åå°†åç«¯è¿”å›çš„ token ç›¸å…³æ•°æ®å­˜å‚¨åˆ°å®¹å™¨ä¸­

```js
async onLogin () {
  // const loginToast = this.$toast.loading({
  this.$toast.loading({
    duration: 0, // æŒç»­æ—¶é—´ï¼Œ0è¡¨ç¤ºæŒç»­å±•ç¤ºä¸åœæ­¢
    forbidClick: true, // æ˜¯å¦ç¦æ­¢èƒŒæ™¯ç‚¹å‡»
    message: 'ç™»å½•ä¸­...' // æç¤ºæ¶ˆæ¯
  })
  try {
    const res = await login(this.user)

    // res.data.data => { token: 'xxx', refresh_token: 'xxx' }
+    this.$store.commit('setUser', res.data.data)

    // æç¤º success æˆ–è€… fail çš„æ—¶å€™ï¼Œä¼šå…ˆæŠŠå…¶å®ƒçš„ toast å…ˆæ¸…é™¤
    this.$toast.success('ç™»å½•æˆåŠŸ')
  } catch (err) {
    console.log('ç™»å½•å¤±è´¥', err)
    this.$toast.fail('ç™»å½•å¤±è´¥ï¼Œæ‰‹æœºå·æˆ–éªŒè¯ç é”™è¯¯')
  }

  // åœæ­¢ loadingï¼Œå®ƒä¼šæŠŠå½“å‰é¡µé¢ä¸­æ‰€æœ‰çš„ toast éƒ½ç»™æ¸…é™¤
  // loginToast.clear()
}
```

## ä¼˜åŒ–å°è£…æœ¬åœ°å­˜å‚¨æ“ä½œæ¨¡å—

1. åˆ›å»º `src/utils/storage.js` æ¨¡å—

   ```js
   export const getItem = name => {
     const data = window.localStorage.getItem(name)
     try {
       return JSON.parse(data)
     } catch (err) {
       return data
     }
   }
   
   export const setItem = (name, value) => {
     if (typeof value === 'object') {
       value = JSON.stringify(value)
     }
     window.localStorage.setItem(name, value)
   }
   
   export const removeItem = name => {
     window.localStorage.removeItem(name)
   }
   ```


2. åœ¨store/index.jså¼•å…¥æ–¹æ³•

   ```js
   import { getItem, setItem } from '@/utils/storage.js'
   const TOKEN = 'TOUTIAO_USER'
   ```

3. ä½¿ç”¨æ–¹æ³•

   ```js
   export default new Vuex.Store({
     state: {
       // è·å–æœ¬åœ°æ•°æ®
       user: getItem(TOKEN)
     },
     mutations: {
       setUser (state, data) {
         state.user = data
         // ä¿å­˜æœ¬åœ°æ•°æ®
         setItem(TOKEN)
       }
     }
   })
   ```

## å…³äº Token è¿‡æœŸé—®é¢˜

ç™»å½•æˆåŠŸä¹‹ååç«¯ä¼šè¿”å›ä¸¤ä¸ª Tokenï¼š

- `token`ï¼šè®¿é—®ä»¤ç‰Œï¼Œæœ‰æ•ˆæœŸ2å°æ—¶
- `refresh_token`ï¼šåˆ·æ–°ä»¤ç‰Œï¼Œæœ‰æ•ˆæœŸ14å¤©ï¼Œç”¨äºè®¿é—®ä»¤ç‰Œè¿‡æœŸä¹‹åé‡æ–°è·å–æ–°çš„è®¿é—®ä»¤ç‰Œ



æˆ‘ä»¬çš„é¡¹ç›®æ¥å£ä¸­è®¾å®šçš„ `Token` æœ‰æ•ˆæœŸæ˜¯ `2 å°æ—¶`ï¼Œè¶…è¿‡æœ‰æ•ˆæœŸæœåŠ¡ç«¯ä¼šè¿”å› `401` è¡¨ç¤º Token æ— æ•ˆæˆ–è¿‡æœŸäº†ã€‚

ä¸ºä»€ä¹ˆè¿‡æœŸæ—¶é—´è¿™ä¹ˆçŸ­ï¼Ÿ

- ä¸ºäº†å®‰å…¨ï¼Œä¾‹å¦‚ Token è¢«åˆ«äººç›—ç”¨



è¿‡æœŸäº†æ€ä¹ˆåŠï¼Ÿ

- ~~è®©ç”¨æˆ·é‡æ–°ç™»å½•~~ï¼Œç”¨æˆ·ä½“éªŒå¤ªå·®äº†
- ä½¿ç”¨ `refresh_token` è§£å†³ `token` è¿‡æœŸ



å¦‚ä½•ä½¿ç”¨ `refresh_token` è§£å†³ `token` è¿‡æœŸï¼Ÿ

> åˆ°è¯¾ç¨‹çš„åé¢æˆ‘ä»¬å¼€å‘çš„ä¸šåŠ¡åŠŸèƒ½ä¸°å¯Œèµ·æ¥ä¹‹åï¼Œå†ç»™å¤§å®¶è®²è§£ Token è¿‡æœŸå¤„ç†ã€‚
>
> å¤§å®¶éœ€è¦æ³¨æ„çš„æ˜¯**åœ¨å­¦ä¹ æµ‹è¯•çš„æ—¶å€™å¦‚æœæ”¶åˆ° 401 å“åº”ç ï¼Œè¯·é‡æ–°ç™»å½•å†æµ‹è¯•**ã€‚



![img](https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/v2-8f29f24dd291ddf46abda5d5ab7bec6c_720w.jpg)

æ¦‚è¿°ï¼šæœåŠ¡å™¨ç”Ÿæˆtokençš„è¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰ä¸¤ä¸ªæ—¶é—´ï¼Œä¸€ä¸ªæ˜¯tokenå¤±æ•ˆæ—¶é—´ï¼Œä¸€ä¸ªæ˜¯tokenåˆ·æ–°æ—¶é—´ï¼Œåˆ·æ–°æ—¶é—´è‚¯å®šæ¯”å¤±æ•ˆæ—¶é—´é•¿ï¼Œå½“ç”¨æˆ·çš„ `token` è¿‡æœŸæ—¶ï¼Œä½ å¯ä»¥æ‹¿ç€è¿‡æœŸçš„tokenå»æ¢å–æ–°çš„tokenï¼Œæ¥ä¿æŒç”¨æˆ·çš„ç™»é™†çŠ¶æ€ï¼Œå½“ç„¶ä½ è¿™ä¸ªè¿‡æœŸtokençš„è¿‡æœŸæ—¶é—´å¿…é¡»åœ¨åˆ·æ–°æ—¶é—´ä¹‹å†…ï¼Œå¦‚æœè¶…å‡ºäº†åˆ·æ–°æ—¶é—´ï¼Œé‚£ä¹ˆè¿”å›çš„ä¾æ—§æ˜¯ 401ã€‚

å¤„ç†æµç¨‹ï¼š

1. åœ¨axiosçš„æ‹¦æˆªå™¨ä¸­åŠ å…¥tokenåˆ·æ–°é€»è¾‘
2. å½“ç”¨æˆ·tokenè¿‡æœŸæ—¶ï¼Œå»å‘æœåŠ¡å™¨è¯·æ±‚æ–°çš„ token
3. æŠŠæ—§çš„tokenæ›¿æ¢ä¸ºæ–°çš„token
4. ç„¶åç»§ç»­ç”¨æˆ·å½“å‰çš„è¯·æ±‚

åœ¨è¯·æ±‚çš„å“åº”æ‹¦æˆªå™¨ä¸­ç»Ÿä¸€å¤„ç† token è¿‡æœŸï¼š

```js
/**
 * å°è£… axios è¯·æ±‚æ¨¡å—
 */
import axios from "axios";
import jsonBig from "json-bigint";
import store from "@/store";
import router from "@/router";
// axios.create æ–¹æ³•ï¼šå¤åˆ¶ä¸€ä¸ª axios
const request = axios.create({
  baseURL: "http://ttapi.research.itcast.cn/" // åŸºç¡€è·¯å¾„
});
/**
 * é…ç½®å¤„ç†åç«¯è¿”å›æ•°æ®ä¸­è¶…å‡º js å®‰å…¨æ•´æ•°èŒƒå›´é—®é¢˜
 */
request.defaults.transformResponse = [
  function(data) {
    try {
      return jsonBig.parse(data);
    } catch (err) {
      return {};
    }
  }
];
// è¯·æ±‚æ‹¦æˆªå™¨
request.interceptors.request.use(
  function(config) {
    const user = store.state.user;
    if (user) {
      config.headers.Authorization = `Bearer ${user.token}`;
    }
    // Do something before request is sent
    return config;
  },
  function(error) {
    // Do something with request error
    return Promise.reject(error);
  }
);
// å“åº”æ‹¦æˆªå™¨
request.interceptors.response.use(
  // å“åº”æˆåŠŸè¿›å…¥ç¬¬1ä¸ªå‡½æ•°
  // è¯¥å‡½æ•°çš„å‚æ•°æ˜¯å“åº”å¯¹è±¡
  function(response) {
    // Any status code that lie within the range of 2xx cause this function to trigger
    // Do something with response data
    return response;
  },
  // å“åº”å¤±è´¥è¿›å…¥ç¬¬2ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°çš„å‚æ•°æ˜¯é”™è¯¯å¯¹è±¡
  async function(error) {
    // Any status codes that falls outside the range of 2xx cause this function to trigger
    // Do something with response error
    // å¦‚æœå“åº”ç æ˜¯ 401 ï¼Œåˆ™è¯·æ±‚è·å–æ–°çš„ token
    // å“åº”æ‹¦æˆªå™¨ä¸­çš„ error å°±æ˜¯é‚£ä¸ªå“åº”çš„é”™è¯¯å¯¹è±¡
    console.dir(error);
    if (error.response && error.response.status === 401) {
      // æ ¡éªŒæ˜¯å¦æœ‰ refresh_token
      const user = store.state.user;
      if (!user || !user.refresh_token) {
        router.push("/login");

        // ä»£ç ä¸è¦å¾€åæ‰§è¡Œäº†
        return;
      }
      // å¦‚æœæœ‰refresh_tokenï¼Œåˆ™è¯·æ±‚è·å–æ–°çš„ token
      try {
        const res = await axios({
          method: "PUT",
          url: "http://ttapi.research.itcast.cn/app/v1_0/authorizations",
          headers: {
            Authorization: `Bearer ${user.refresh_token}`
          }
        });
        // å¦‚æœè·å–æˆåŠŸï¼Œåˆ™æŠŠæ–°çš„ token æ›´æ–°åˆ°å®¹å™¨ä¸­
        console.log("åˆ·æ–° token  æˆåŠŸ", res);
        store.commit("setUser", {
          token: res.data.data.token, // æœ€æ–°è·å–çš„å¯ç”¨ token
          refresh_token: user.refresh_token // è¿˜æ˜¯åŸæ¥çš„ refresh_token
        });
        // æŠŠä¹‹å‰å¤±è´¥çš„ç”¨æˆ·è¯·æ±‚ç»§ç»­å‘å‡ºå»
        // config æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«æœ¬æ¬¡å¤±è´¥è¯·æ±‚ç›¸å…³çš„é‚£äº›é…ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚ urlã€method éƒ½æœ‰
        // return æŠŠ request çš„è¯·æ±‚ç»“æœç»§ç»­è¿”å›ç»™å‘è¯·æ±‚çš„å…·ä½“ä½ç½®
        return request(error.config);
      } catch (err) {
        // å¦‚æœè·å–å¤±è´¥ï¼Œç›´æ¥è·³è½¬ ç™»å½•é¡µ
        console.log("è¯·æ±‚åˆ·çº¿ token å¤±è´¥", err);
        router.push("/login");
      }
    }
    return Promise.reject(error);
  }
);
export default request;
```
