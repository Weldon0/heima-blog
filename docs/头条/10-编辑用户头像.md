---
title: ğŸ“š 10-ç¼–è¾‘ç”¨æˆ·å¤´åƒ
---
## ä¿®æ”¹å¤´åƒ

### å›¾ç‰‡ä¸Šä¼ é¢„è§ˆ

1ã€å‡†å¤‡fileç±»å‹è¾“å…¥æ¡†,å¹¶é€šè¿‡ç‚¹å‡»å¤´åƒè§¦å‘ä¸Šä¼ 

```html
<input type="file" hidden ref="inputFile">
    <!-- å¯¼èˆªæ  -->
    <van-nav-bar
    class="page-nav-bar"
    title="ä¸ªäººä¿¡æ¯"
    left-arrow @click-left="$router.back()" />
    <!-- /å¯¼èˆªæ  -->
    <van-cell title="å¤´åƒ" is-link @click="$refs.inputFile.click()">
      <van-image
        class="avatar"
        fit="cover"
        round
        :src="user.photo"
      />
    </van-cell>
```

2ã€ç»™inputå®šä¹‰changeäº‹ä»¶

3ã€è·å–ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯

```js
inputChange () {
      // è·å–æ–‡ä»¶å¯¹è±¡
      const file = this.$refs.inputFile.files[0]
      // è·å–blobæ•°æ®
      const imgUrl = window.URL.createObjectURL(file)
      console.log(imgUrl)
    }
```

### å›¾ç‰‡ä¸Šä¼ é¢„è§ˆåŠŸèƒ½å¤„ç†

1ã€å®šä¹‰æ˜¾ç¤ºå¼¹å±‚

```html
<!-- ç¼–è¾‘å¤´åƒå¼¹å±‚ -->
    <van-popup
    v-model="isShowUpdateAvatar"
    style="height: 100%"
    position="bottom">
      hello
    </van-popup>
    <!-- ç¼–è¾‘å¤´åƒå¼¹å±‚ -->
```

```js
inputChange () {
    // è·å–ä¸Šä¼ æ–‡ä»¶
    const file = this.$refs.inputFile.files[0]
    const data = window.URL.createObjectURL(file)
    console.log(data)
    this.isShowUpdateAvatar = true
}
```

2ã€å®šä¹‰æ›´æ–°å›¾ç‰‡ç»„ä»¶

3ã€å¼•ç”¨ã€æ³¨å†Œã€ä½¿ç”¨

```js
import updateAvatar from './components/update-avatar.vue'
```

```js
components: {
    updateName,
    updateGender,
    updateBirthdy,
    updateAvatar
}
```

```html
<!-- ç¼–è¾‘å¤´åƒå¼¹å±‚ -->
    <van-popup
    v-model="isShowUpdateAvatar"
    style="height: 100%"
    position="bottom">
      <update-avatar : />
    </van-popup>
    <!-- ç¼–è¾‘å¤´åƒå¼¹å±‚ -->
```

4ã€å°†å›¾ç‰‡ä¿å­˜åˆ°dataä¸­å¹¶ä¼ é€’ç»™update-avatarç»„ä»¶

```js
inputChange () {
    // è·å–ä¸Šä¼ æ–‡ä»¶
    const file = this.$refs.inputFile.files[0]
    this.img = window.URL.createObjectURL(file)
    this.isShowUpdateAvatar = true
    this.$refs.inputFile.value = ''
}
```

```html
<!-- ç¼–è¾‘å¤´åƒå¼¹å±‚ -->
    <van-popup
    v-model="isShowUpdateAvatar"
    style="height: 100%"
    position="bottom">
      <update-avatar :img="img" />
    </van-popup>
    <!-- ç¼–è¾‘å¤´åƒå¼¹å±‚ -->
```

5ã€update-avatarç»„ä»¶æ¥æ”¶å¹¶ä½¿ç”¨

```html
<template>
    <div>
      <img :src="img" />
    </div>
</template>

<script>
export default {
  props: {
    img: {
      type: [String, Object],
      retuired: true
    }
  }
}
</script>

<style scoped lang='less'>

</style>

```

### å›¾ç‰‡ä¸Šä¼ é¢„è§ˆæ ·å¼å¤„ç†

1ã€ç»“æ„

```html
<div class="update-avatar">
    <img :src="img" />
    <div class="toolbar">
      <span>å–æ¶ˆ</span>
      <span>å®Œæˆ</span>
    </div>
  </div>
```

2ã€css

```css
.update-avatar {
  background: #000;
  width: 100%;
  height: 100%;
  .toolbar {
    position: fixed;
    bottom: 10px;
    width: 100%;
    display: flex;
    justify-content: space-between;
    font-size: 28px;
    color: #fff;
    padding: 0 15px;
    box-sizing: border-box;
  }
}
```

3ã€ç‚¹å‡»å–æ¶ˆ

```html
<span @click="$emit('close')">å–æ¶ˆ</span>
```

````html
<!-- ç¼–è¾‘å¤´åƒå¼¹å±‚ -->
<van-popup
           v-model="isShowUpdateAvatar"
           style="height: 100%"
           position="bottom">
    <update-avatar @close="isShowUpdateAvatar = false" :img="img" />
</van-popup>
<!-- ç¼–è¾‘å¤´åƒå¼¹å±‚ -->
````

### å¤´åƒè£åˆ‡

æ–¹å¼ä¸€ï¼šç»“åˆæœåŠ¡å™¨çš„å›¾ç‰‡ä¸Šä¼ é¢„è§ˆ

![1567067894388](https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/1567067894388.png)

æ–¹å¼äºŒï¼šçº¯å®¢æˆ·ç«¯å®ç°ä¸Šä¼ å›¾ç‰‡é¢„è§ˆ

æ–¹æ¡ˆä¸€ï¼šç»“åˆæœåŠ¡ç«¯çš„å›¾ç‰‡è£åˆ‡ä¸Šä¼ æµç¨‹

<img src="https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/image-20200418015503681.png" alt="image-20200418015503681"  />

æ–¹æ¡ˆäºŒï¼šçº¯å®¢æˆ·ç«¯çš„å›¾ç‰‡è£åˆ‡ä¸Šä¼ æµç¨‹



- [\<input type="file"\>](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/Input/file)
- [åœ¨webåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨æ–‡ä»¶](https://developer.mozilla.org/zh-CN/docs/Web/API/File/Using_files_from_web_applications)

```
viewMode: 1,
dragMode: 'move',
aspectRatio: 1,
autoCropArea: 1,
cropBoxMovable: false,
cropBoxResizable: false,
background: false,
movable: true
```

#### ä½¿ç”¨cropperjs

1ã€å®‰è£…cropperjs

```js
npm install cropperjs
```

2ã€å¼•å…¥cssã€js

```js
import 'cropperjs/dist/cropper.css'
import Cropper from 'cropperjs'
```

3ã€åœ¨mountedä¸­åˆå§‹åŒ–

```js
const image = this.$refs.img
const cropper = new Cropper(image, {
    aspectRatio: 16 / 9,
    crop (event) {
        console.log(event.detail.x)
        console.log(event.detail.y)
        console.log(event.detail.width)
        console.log(event.detail.height)
        console.log(event.detail.rotate)
        console.log(event.detail.scaleX)
        console.log(event.detail.scaleY)
    }
})
console.log(cropper)
```

#### é…ç½®cropperjs

```js
const cropper = new Cropper(image, {
    viewMode: 1, // åªèƒ½åœ¨è£å‰ªçš„å›¾ç‰‡èŒƒå›´å†…ç§»åŠ¨
    dragMode: 'move', // ç”»å¸ƒå’Œå›¾ç‰‡éƒ½å¯ä»¥ç§»åŠ¨
    aspectRatio: 1, // è£å‰ªåŒºé»˜è®¤æ­£æ–¹å½¢
    autoCropArea: 1, // è‡ªåŠ¨è°ƒæ•´è£å‰ªå›¾ç‰‡
    cropBoxMovable: false, // ç¦æ­¢è£å‰ªåŒºç§»åŠ¨
    cropBoxResizable: false, // ç¦æ­¢è£å‰ªåŒºç¼©æ”¾
    background: false // å…³é—­é»˜è®¤èƒŒæ™¯
})
```

#### è£åˆ‡çš„ä¸¤ç§æ–¹å¼- æœåŠ¡ç«¯

è·å–å‚æ•°

1ã€è·å–cropperå®ä¾‹

```js
this.cropper = new Cropper(image, {
      viewMode: 1, // åªèƒ½åœ¨è£å‰ªçš„å›¾ç‰‡èŒƒå›´å†…ç§»åŠ¨
      dragMode: 'move', // ç”»å¸ƒå’Œå›¾ç‰‡éƒ½å¯ä»¥ç§»åŠ¨
      aspectRatio: 1, // è£å‰ªåŒºé»˜è®¤æ­£æ–¹å½¢
      autoCropArea: 1, // è‡ªåŠ¨è°ƒæ•´è£å‰ªå›¾ç‰‡
      cropBoxMovable: false, // ç¦æ­¢è£å‰ªåŒºç§»åŠ¨
      cropBoxResizable: false, // ç¦æ­¢è£å‰ªåŒºç¼©æ”¾
      background: false // å…³é—­é»˜è®¤èƒŒæ™¯
    })
```

2ã€ç»™ç¡®å®šæ³¨å†Œç‚¹å‡»äº‹ä»¶ï¼Œåœ¨äº‹ä»¶å‡½æ•°ä¸­è·å–å‚æ•°

```js
<span @click="confirm">å®Œæˆ</span>
```

```js
confirm () {
    console.log(this.cropper.getData())
}
```

#### å®¢æˆ·ç«¯æ–¹å¼

```js
confirm () {
      // console.log(this.cropper.getData())
      this.cropper.getCroppedCanvas().toBlob(blob => {
        console.log(blob)
      })
    }
```

### å®ç°è£å‰ªå›¾ç‰‡æäº¤

1ã€å°è£…æ›´æ–°å¤´åƒapi

```js
/**
 * æ›´æ–°å¤´åƒ
 */
export const updateUserAvatar = data => {
  return request({
    method: 'PATCH',
    url: '/app/v1_0/user/photo',
    data
  })
}
```

2ã€å¼•å…¥æ–¹æ³•å¹¶è°ƒç”¨

```js
import { updateUserAvatar } from '@/api/user.js'
```

```js
confirm () {
      this.cropper.getCroppedCanvas().toBlob(async blob => {
        // åˆ›å»ºformDataæ•°æ®
        const formData = new FormData()
        formData.append('photo', blob)
        const res = await updateUserAvatar(formData)
        console.log(res)
      })
    }
```

3ã€å…³é—­å¼¹å±‚ã€æ›´æ–°è§†å›¾

```js
this.cropper.getCroppedCanvas().toBlob(async blob => {
        const formData = new FormData()
        formData.append('photo', blob)
        const { data } = await updateUserAvatar(formData)
        // å…³é—­å¼¹å±‚ï¼Œæ›´æ–°è§†å›¾
        this.$emit('close')
        this.$emit('update-avatar', data.data.photo)
      })
```

```html
<update-avatar
      @update-avatar="user.photo = $event"
      @close="isShowUpdateAvatar = false"
      :img="img" />
```

4ã€åˆ©ç”¨v-ifé‡ç½®æ•°æ®

```html
<update-avatar
      v-if="isShowUpdateAvatar"
      @update-avatar="user.photo = $event"
      @close="isShowUpdateAvatar = false"
      :img="img" />
```

5ã€ä¼˜åŒ–loadingæ•ˆæœ

```js
async updateAvatar (blob) {
      this.$toast.loading({
        message: 'ä¿å­˜ä¸­...',
        forbidClick: true,
        loadingType: 'spinner',
        duration: 0
      })
      try {
        const formData = new FormData()
        formData.append('photo', blob)
        const { data } = await updateUserAvatar(formData)
        // å…³é—­å¼¹å±‚ï¼Œæ›´æ–°è§†å›¾
        this.$emit('close')
        this.$emit('update-avatar', data.data.photo)
        this.$toast('æ›´æ–°æˆåŠŸ')
      } catch (err) {
        this.$toast('æ›´æ–°å¤±è´¥')
      }
    }
```



