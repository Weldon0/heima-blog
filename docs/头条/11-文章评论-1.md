---
title: 🌹文章评论-1
---
# 八、文章评论

## [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_1、业务功能分析)1、业务功能分析

## [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_2、展示文章评论列表)2、展示文章评论列表

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_2-1、准备组件)2.1、准备组件

为了更好的开发和维护，这里我们把文章评论单独封装到一个组件中来处理。

**创建组件** `src/views/article/components/comment-list.vue`

```html
<template>
    <van-list
      v-model="loading"
      :finished="finished"
      finished-text="没有更多了"
      @load="onLoad"
    >
        <van-cell v-for="item in list" :key="item" :title="item"></van-cell>
    </van-list>
</template>
<script>
  export default {
    name: "CommentList",
    components:{},
    props: {},
    data() {
      return {
        list: [], // 评论列表
        loading: false, // 上拉加载更多的 loading
        finished: false // 是否加载结束
      };
    },

    methods: {
      onLoad() {
        // 异步更新数据
        setTimeout(() => {
          for (let i = 0; i < 10; i++) {
            this.list.push(this.list.length + 1);
          }
          // 加载状态结束
          this.loading = false;

          // 数据全部加载完成
          if (this.list.length >= 40) {
            this.finished = true;
          }
        }, 500);
      }
    }
  };
</script>
```

**`article/index.vue`导入、注册、使用组件**

```js
import CommentList from './components/comment-list'
```

```js
components:{
    // 其他注册...
    CommentList
}
```

```html
<van-divider>正文结束</van-divider>
<!------------------------------ 文章评论列表-------------------------------------->
<comment-list/>
<!------------------------------ /文章评论列表 ------------------------------------->
```

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_2-2、获取数据并展示)2.2、获取数据并展示

> 提示：有评论数据的文章 id ：短文章==>1323981393964826624， 长文章==>138671

步骤：

- 封装接口
- 请求获取数据
- 处理模板

------

实现：

1、在 `api/comment.js` 中添加封装请求方法

```js
/**
 * 评论请求模块
 */
import request from '@/utils/request'

/**
 * 获取文章评论列表
 */
export const getComments = params => {
  return request({
    method: 'GET',
    url: '/v1_0/comments',
    params
  })
}
```

2、请求获取数据

- 父组件`article/index.vue` 传入文章id

  ```html
  <comment-list :source="article.art_id"/>
  ```

  1

- 子组件`commnent-list`定义自定义属性接收

  ```js
  props: {
      source: {
        type: [Number, String, Object],
        required: true
      }
   }   
  ```

- 导入请求方法

  ```js
  import { getComments } from '@/api/comment'
  ```

- 定义相关变量

  ```js
  data(){
      return{
          //其他变量..
          offset: null, // 获取下一页数据的标记
          limit: 10,
          error: false
      }
  }
  ```

- 书写处理事件函数

  ```js
    methods: {
      async onLoad () {
        try {
          // 1. 请求获取数据
          const { data } = await getComments({
            type: 'a', //  评论类型，a-对文章(article)的评论，c-对评论(comment)的回复
            source: this.source.toString(), // 源id，文章id或评论id,【可能有大数字，所以执行一下toString 方法】
            offset: this.offset, // 评论数据的偏移量，值为评论id，表示从此id的数据向后取，不传表示从第一页开始读取数据
            limit: this.limit // 获取的评论数据个数，不传表示采用后端服务设定的默认每页数据量
          })
  
          // 2. 将数据添加到列表中(一定要注意是追加数据，否则列表高度不增加，形成死循环)
          const { results } = data.data
          this.list.push(...results)
  
          // 3. 将 loading 设置为 false
          this.loading = false
  
          // 4. 判断是否还有数据
          if (results.length) {
            // 有就更新获取下一页的数据页码
            this.offset = data.data.last_id
          } else {
            // 没有就将 finished 设置结束
            this.finished = true
          }
        } catch (err) {
          this.error = true
          this.loading = false
        }
      }
    }
  ```

  

- 显示评论内容

  ```html
   <van-cell v-for="(item,index) in list" :key="index" :title="item.content"></van-cell>
  ```

  

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_2-3、展示文章评论总数量)2.3、展示文章评论总数量

**子组件`comment-list.vue`触发自定义事件**

- `onLoad`事件函数里面 触发自定义

  ```js
   // 2. 将数据添加到列表中
   const { results } = data.data
   this.list.push(...results)
  
  // 把文章评论的总数量传递到外部
  this.$emit('onload-success', data.data)  // <========== 增加这一句
  
  // 3. 将 loading 设置为 false
  this.loading = false
  ```

- 默认情况下只有滚动到了评论列表区域才会触发`onLoad`事件，所以我们需要再`created`里面主动触发一次，保证一开始就触发

  ```js
    created () {
      this.onLoad()
    }
  ```

**父组件`article/index.vue`中监听自定事件**

- 定义变量存放总数量

  ```js
  data(){
      //其他变量...
      totalCommentCount:0  // 文章评论总数量
  }
  ```

- 绑定给展示组件的属性

  ```html
  <van-icon
     class="comment-icon"
     name="comment-o"
     :info="totalCommentCount"
   />
  ```

- 监听自定义事件，赋值给变量

  ```html
   <!-- 文章评论列表 -->
  <comment-list
       :source="article.art_id"
       @onload-success="totalCommentCount = $event.total_count"
  />
  <!-- /文章评论列表 -->
  ```

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_2-4、文章评论项)2.4、文章评论项

**创建 `article/components/comment-item.vue`**

```html
<template>
  <van-cell class="comment-item">
    <van-image
      slot="icon"
      class="avatar"
      round
      fit="cover"
      src="https://img.yzcdn.cn/vant/cat.jpeg"
    />
    <div slot="title" class="title-wrap">
      <div class="user-name">用户名称</div>
      <van-button
        class="like-btn"
        icon="good-job-o"
      >赞</van-button>
    </div>

    <div slot="label">
      <p class="comment-content">这是评论内容</p>
      <div class="bottom-info">
        <span class="comment-pubdate">4天前</span>
        <van-button
          class="reply-btn"
          round
        >回复 0</van-button>
      </div>
    </div>
  </van-cell>
</template>

<script>
export default {
  name: 'CommentItem',
  props: {
    //每行的评论信息  
    comment: {
      type: Object,
      required: true
    }
  },
  methods: {}
}
</script>

<style scoped lang="less">
.comment-item {
  .avatar {
    width: 72px;
    height: 72px;
    margin-right: 25px;
  }
  .title-wrap {
    display: flex;
    justify-content: space-between;
    align-items: center;
    .user-name {
      color: #406599;
      font-size: 26px;
    }
  }
  .comment-content {
    font-size: 32px;
    color: #222222;
    word-break: break-all;
    text-align: justify;
  }
  .comment-pubdate {
    font-size: 19px;
    color: #222;
    margin-right: 25px;
  }
  .bottom-info {
    display: flex;
    align-items: center;
  }
  .reply-btn {
    width: 135px;
    height: 48px;
    line-height: 48px;
    font-size: 21px;
    color: #222;
  }
  .like-btn {
    height: 30px;
    padding: 0;
    border: none;
    font-size: 19px;
    line-height: 30px;
    margin-right: 7px;
    .van-icon {
      font-size: 30px;
    }   
  }
  .liked{
   	  background-color:orange;   
   }
}
</style>
```

**在`comment-list.vue`中导入、注册、使用**

```js
import CommentItem from './comment-item'
```

```js
 components: {
    CommentItem  // 注册组件
 }
```

```html
<!--删除 van-cell 组件-->
<!--<van-cell v-for="(item,index) in list" :key="index" :title="item.content"></van-cell>-->

<!--使用 comment-item组件-->
<comment-item
  v-for="(item, index) in list"
  :key="index"
  :comment="item"/>
```

**渲染展示数据信息**

```html
<template>
  <van-cell class="comment-item">
    <van-image
      slot="icon"
      class="avatar"
      round
      fit="cover"
      :src="comment.aut_photo"
    />
    <div slot="title" class="title-wrap">
      <div class="user-name">{{ comment.aut_name }}</div>
      <van-button
        class="like-btn"
        icon="good-job-o"
      >{{ comment.like_count || '赞' }}</van-button>
    </div>

    <div slot="label">
      <p class="comment-content">{{ comment.content }}</p>
      <div class="bottom-info">
        <span class="comment-pubdate">{{ comment.pubdate | relativeTime }}</span>
        <van-button
          class="reply-btn"
          round
        >回复 {{ comment.reply_count }}</van-button>
      </div>
    </div>
  </van-cell>
</template>
```



### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_2-5、评论点赞)2.5、评论点赞

1、在 `api/comment.js` 中添加封装两个数据接口

```js
/**
 * 对评论或评论回复点赞
 */
export function addCommentLike(commentId) {
  return request({
    method: "POST",
    url: "/v1_0/comment/likings",
    data: {
      target: commentId
    }
  });
}

/**
 * 取消对评论或评论回复点赞
 */
export function deleteCommentLike(commentId) {
  return request({
    method: "DELETE",
    url: `/v1_0/comment/likings/${commentId}`
  });
}
```



2、然后给评论项中的 `like` 图标注册点击事件

```js
data(){
    return{
        commentLoading:true  // 是否点赞中
    }
}
```



```html
<van-button
   class="like-btn"
   :class="{ liked:comment.is_liking  }"    
   :icon="comment.is_liking ? 'good-job' : 'good-job-o'"  
   :loading="commentLoading"                                                            
    @click="onCommentLike"         
>{{ comment.like_count || '赞' }}</van-button>
```

3、在事件处理函数中

```js
import {
   // 其他导入...
    addCommentLike,deleteCommentLik  
} from '@/api/comment'
```

```js
// 点赞或取消点赞事件
async onCommentLike () {
  // loading 开启  
  this.commentLoading = true
  try{
       // 如果已经赞了则取消点赞
      if (this.comment.is_liking) {
        await deleteCommentLike(this.comment.com_id)
        this.comment.like_count--  
      } else {
        // 如果没有赞，则点赞
        await addCommentLike(this.comment.com_id)
        this.comment.like_count++
      }
      // 更新视图状态
      this.comment.is_liking = !this.comment.is_liking
      this.$toast('操作成功')
  }catch(e){
      this.$toast('操作失败，请重试')
  }
  // loading 关闭
  this.commentLoading = false  
}
```



## [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_3、发布文章评论)3、发布文章评论

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_3-1、准备弹出层)3.1、准备弹出层

在`article/index.vue`中准备弹出层，使用弹出层组件[Popup(opens new window)](https://vant-contrib.gitee.io/vant/#/zh-CN/popup)

- 定义控制变量

```js
data(){
    return{
        //其他变量...
        isPostShow:false // 发布评论弹层控制
    }
}
```



- 使用弹层组件

```html
<!--/底部区域-->

<!--------------------------------  发布评论 -------------------------------------->
<van-popup v-model="isPostShow" position="bottom">
	测试内容
</van-popup>
<!-------------------------------- /发布评论 -------------------------------------->
```

- 绑定事件打开弹层

```html
<van-button
    class="comment-btn"
    type="default"
    round
    size="small"
    @click="isPostShow=true"   
    >写评论</van-button>
```

> 提示：不设置高度的时候，内容会自动撑开弹层高度

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_3-2、封装组件)3.2、封装组件

- 创建`views/article/components/comment-post.vue` 组件

```html
<template>
  <div class="comment-post">
    <van-field
      class="post-field"
      v-model="message"
      rows="2"
      autosize
      type="textarea"
      maxlength="50"
      placeholder="请输入留言"
      show-word-limit
    />
    <van-button
      class="post-btn"
    >发布</van-button>
  </div>
</template>

<script>
export default {
  name: 'CommentPost',
  data () {
    return {
      message: ''
    }
  },
  computed: {},
  watch: {},
  created () {},
  mounted () {},
  methods: {}
}
</script>

<style scoped lang="less">
.comment-post {
  display: flex;
  align-items: center;
  padding: 32px 0 32px 32px;
  .post-field {
    background-color: #f5f7f9;
  }
  .post-btn {
    width: 150px;
    border: none;
    padding: 0;
    color: #6ba3d8;
    &::before {
      display: none;
    }
  }
}
</style>
```



- 在`article/index.vue` 中导入、注册、使用

```js
import CommentPost from './components/comment-post'
```

1

```js
  components: {
    // 其他注册...
    CommentPost
  },
```

1
2
3
4

```html
<!--------------------------------  发布评论 -------------------------------------->
<van-popup v-model="isPostShow"  position="bottom">
    <comment-post />
</van-popup>
<!---------------------------------- /发布评论 ------------------------------------>
```

1
2
3
4
5

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_3-3、请求发布)3.3、请求发布

基本思路：

- 找到数据接口
- 封装请求方法
- 注册发布点击事件
  - 请求发布
  - 成功：将发布的内容展示到列表中
  - 失败：提示失败

------

**封装api请求方法**

在 `api/comment.js` 中添加封装数据接口

```js
/**
 * 发布文章评论或评论回复
 */
export const addComment = data=>{
  return request({
    method: "POST",
    url: "/v1_0/comments",
    data
  });
}
```

**父子通信，传递文章id**

`article/index.vue` 传递文章id

```html
<!-- 发布评论 -->
<van-popup v-model="isPostShow" position="bottom">
    <comment-post :target="article.art_id" />
</van-popup>
<!-- 发布评论 -->
```

`comment-post.vue` 定义接收

```js
  props: {
    // 目标id，接收文章id或者评论id   
    target: {
      type: [Number, String, Object],
      required: true
    }
  }
```

**`comment-post.vue`导入请求方法、绑定事件、书写事件函数、发送请求**

```js
import { addComment } from '@/api/comment'
```

```html
<van-button
      class="post-btn"
      @click="onPost"
    >发布</van-button>
```

```js
    async onPost () {
      this.$toast.loading({
        message: '发布中...',
        forbidClick: true, // 禁用背景点击
        duration: 0 // 持续时间，默认 2000，0 表示持续展示不关闭
      })

      try {
        const { data } = await addComment({
          target: this.target.toString(), // 评论目标id（评论文章即文章id，对评论进行回复则为评论id） 防止有大数字最好也执行一下toString方法！
          content: this.message, // 评论内容
          art_id: null // 文章id，对评论内容发表回复时，需要传递此参数，表明所属文章id。对文章进行评论，不要传此参数。
        })
        
        this.$toast.success('发布成功')
		
         // TODO==>
            // 关闭弹出层
            // 将发布内容显示到列表顶部
            // 清空文本框
      } catch (err) {
        this.$toast.fail('发布失败')
      }
    }
```

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_3-4、成功处理☆☆)3.4、成功处理☆☆

- 核心要点
  - 清空文本框
  - 关闭弹出层
  - 将发布内容显示到列表顶部

------

子组件`comment-post.vue`中清除`message`内容，通过自定义事件向外抛出 添加成功的数据

```js
    async onPost () {
        // 其他代码...
        
        // 关闭弹出层
        // 将发布内容显示到列表顶部
        // 清空文本框
        this.message = ''
        this.$emit('post-success',data.data)
      
        
        // 其他代码...
    }
```

父组件`article/index.vue` 中监听`post-success`自定义事件，执行关闭弹层和将数据放入顶部的操作

```html
<!-- 发布评论 -->
<van-popup v-model="isPostShow" position="bottom" >
    <comment-post
       :target="article.art_id"
       @post-success="onPostSuccess"
    />
</van-popup>
<!-- 发布评论 -->
```



```js
 onPostSuccess (data) {
     // 关闭弹出层
     this.isPostShow = false
     // 将发布内容显示到列表顶部
     // todo...
     console.log(data) // comment-post.vue 传递出来的数据
 }
```

至此，已经完成了，关闭弹层，和清空输入框操作，但是将数据放入到列表顶部还没有实现，这是一个难点，我们将开始操作

**思路分析：**

- 我们已经实现了将`comment-post.vue` 里面的发布成功数据传递给了父组件`article/index.vue`

  

我们已经把数据传递给父组件了，现在最重要的就是如何放到列表组件`comment-list`中去

**思考：** 父组件如何将数据传递给子组件`comment-list` 呢？

**回顾：** 我们之前在 首页频道功能里面`Tab`的数据，和弹出层里面`我的频道`数据是一个内容，是通过`props`将这个数组传递进入，然后在弹出层里面点击我的频道删除的时候直接删除这个 数组里面的对应元素，可以实现同步更新。

![image-20210713212348610](data:image/png;base64,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)

![image-20210713212431553](https://hw-xiansheng.github.io/toutiao-notes/assets/img/image-20210713212431553.3cf619ea.png)

**结论：** 父子通信的`props` 如果是一个 数组，我们只要不重新赋值这个`props`里面的数组，就都不算修改`props`，而可以实现父子之间共享数据，实时变化。（**其本质是父子用了一个引用数据类型的数据**）

**实现：** 既然如此，我们可以依然可以实现`article/index.vue` 和 `comment-list.vue` 去共享 评论列表数据

- 子组件`comment-list`将 `data`里面的变量`list`修改成 `props`里面的属性`list` 用于去接收外面的空数组`commentList`

  ```js
  data () {
      return {
        // 其他变量...  
        // list: [],   // <===注释掉
      }
  }    
  ```

  ```js
  props: {
    // 其他属性...
    // 定义自定义属性list，去接收外面的commentList 变量    
    list: {
        type: Array,
        default: () => []
    }
  }
  ```

- 父组件`article/index.vue` 在 `data` 中定义数组变量，去共享儿子的数据

  ```js
  data(){
  	return{
  		// 其他变量...
  		 commentList: [] // 评论列表
  	}
  }
  ```

- 绑定给子组件

  ```html
  <!-- 文章评论列表 -->
  <comment-list
      :source="article.art_id"
      :list="commentList" 
      @onload-success="totalCommentCount = $event.total_count"
  />
  ```

  

**疑问？？？** 可能有同学会问，为什么接收空数组呢，其实父组件的空数组不是为了传递给子组件，反而是让子组件把数据列表共享给父组件，因为父子通信关联的是引用数据类型，任何人一方改变了，另外一方都会变化。

![image-20210713213529540](https://hw-xiansheng.github.io/toutiao-notes/assets/img/image-20210713213529540.b7b9b15e.png)

**测试：** 通过vue调试器，去观察发现父组件`article/index.vue`里面的变量`commentList` 也有数据了

![image-20210713213732033](https://hw-xiansheng.github.io/toutiao-notes/assets/img/image-20210713213732033.f67e8569.png)

------

已经实现了，父组件和评论列表组件共享列表数据，我们只需要将评论组件传递的数据插入到父组件的这个commentList中即可！

```js
onPostSuccess (data) {
    // 关闭弹出层
    this.isPostShow = false
    // 将发布内容显示到列表顶部
    this.commentList.unshift(data.new_obj)  // <=== 精华之句！！！
    // 评论数量+1
    this.totalCommentCount++
    
}
```

**总结：数据思路图如下**

![image-20210713225611052](https://hw-xiansheng.github.io/toutiao-notes/assets/img/image-20210713225611052.d985428c.png)

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_3-5、空内容处理)3.5、空内容处理

- 对输入的内容进行去除空格处理，增加`trim` 修饰符

  ```html
  <van-field
        class="post-field"
        v-model.trim="message"
        rows="2"
        autosize
        type="textarea"
        maxlength="50"
        placeholder="请输入留言"
        show-word-limit
      />
  ```

- 内容没有输入的时候我们禁用 按钮

  ```html
      <van-button
        class="post-btn"
        @click="onPost"
        :disabled="!message.length"
      >发布</van-button>
  ```

  

## [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_4、评论回复)4、评论回复

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_4-1、准备回复弹层)4.1、准备回复弹层

一、在详情页中使用弹层用来展示文章的回复

1、在`article/index.vue` 中`data`添加数据用来控制展示回复弹层的显示状态

```js
data () {
  return {
    // 其他变量...
    isReplyShow: false
  }
}
```

1
2
3
4
5
6

2、在详情页`article/index.vue`中添加使用弹层组件

```html
<!------------------------ 评论回复 ------------------------------>
<van-popup
  v-model="isReplyShow"
  position="bottom"
  style="height: 100%"
>
  评论回复
</van-popup>
<!------------------------ /评论回复 ------------------------------>
```

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_4-2、点击回复显示弹出层)4.2、点击回复显示弹出层

- `comment-item.vue`组件里面给回复按钮绑定事件，触发向外传递点击行数据（自定义事件）

  ```html
  <van-button
            class="reply-btn"
            round
            @click="$emit('reply-click', comment)" 
   >回复 {{ comment.reply_count }}</van-button>
  ```

- 父组件`comment-list.vue`监听自定义事件，继续向外传递收到的数据（自定义事件）

  ```html
  <comment-item
        v-for="(item, index) in list"
        :key="index"
        :comment="item"
        @reply-click="$emit('reply-click', $event)" 
      />
  ```

- 爷爷组件`article/index.vue` 监听自定事件，打开弹框，输出收到的数据

  ```html
  <!-- 文章评论列表 -->
  <comment-list
     :source="article.art_id"
     :list="commentList"
     @onload-success="totalCommentCount = $event.total_count"
     @reply-click="onReplyClick" 
  />             
  <!-- /文章评论列表 -->
  ```

  ```js
  onReplyClick (comment) {
     console.log(comment) // comment-item组件传递出来的数据
     // 显示评论回复弹出层
     this.isReplyShow = true
  }
  ```

- **思路图**

- ![image-20210714213711299](https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/image-20210714213711299.932b6060.png)

  

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_4-3、封装内容组件)4.3、封装内容组件

- 创建`views/article/components/comment-reply.vue`组件

```html
<template>
  <div class="comment-reply">
     评论回复内容
  </div>
</template>

<script>
export default {
  name: 'CommentReply',
  components: {},
  props: {},
  data () {
    return {}
  },
  computed: {},
  watch: {},
  created () {},
  mounted () {},
  methods: {}
}
</script>
<style scoped lang="less"></style>
```

- 在`article/index.vue`中导入，注册，使用组件

```js
import CommentReply from './components/comment-reply'
```

```js
components: {
  // 其他注册...
  CommentReply
}
```

```html
<!-- 评论回复 -->
<van-popup v-model="isReplyShow"  position="bottom" style="height: 100%;">
   <comment-reply/>
</van-popup>
<!-- /评论回复 -->
```

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_4-4、传递当前点击回复的评论项)4.4、传递当前点击回复的评论项

**思路：** 回顾4.2节，我们已经在`article/index.vue`中得到了`comment-item.vue`里面回复按钮传递出来的数据，我们定义变量接收，然后通过父子通信传递给`comment-reply.vue`组件

**实现：**

- `article/index.vue` 定义变量存储 传递出来的数据

  ```js
  data(){
  	return{
           // 其他变量...
  		 currentComment: {} // 当前点击回复的评论项
  	}
  }
  ```

- 存储数据

  ```js
  onReplyClick (comment) {
      // 存储起来  
      this.currentComment = comment
  
      // 显示评论回复弹出层
      this.isReplyShow = true
  }
  ```

- 将数据传递给`comment-reply.vue` 组件

  ```html
  <comment-reply :comment="currentComment"/>
  ```

  

- 子组件`comment-reply.vue` 中定义`props`接收数据

  ```js
  props: {
      // 点击的那行的评论信息
      comment: {
        type: Object,
        required: true
      }
  }
  ```


> 通过`vue-devtools`来调试数据，判断是否传递成功

![image-20210714220605603](https://hw-xiansheng.github.io/toutiao-notes/assets/img/image-20210714220605603.fa5677d3.png)

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_4-5、处理头部及当前评论项)4.5、处理头部及当前评论项

**`comment-reply.vue` 布局内容，绑定数据**

```vue
<template>
  <div class="comment-reply">
    <van-nav-bar
      :title="comment.reply_count > 0 ? `${comment.reply_count}条回复` : '暂无回复'"
    >
      <van-icon
        slot="left"
        name="cross"
        @click="$emit('close')"
      />
    </van-nav-bar>

    <div class="scroll-wrap">
      <!-- 当前评论项 -->
      <comment-item :comment="comment" />
      <!-- /当前评论项 -->

      <!-- 评论的回复列表 -->
      <!-- /评论的回复列表 -->
    </div>

    <!-- 底部区域 -->
    <div class="reply-bottom">
      <van-button
        class="write-btn"
        size="small"
        round
      >写评论</van-button>
    </div>
    <!-- /底部区域 -->

    <!-- 发布评论 -->
    <!-- /发布评论 -->
  </div>
</template>

<script>
import CommentItem from './comment-item'

export default {
  name: 'CommentReply',
  components: {
    CommentItem,
  },
  props: {
    // 点击回复的那行评论信息  
    comment: {
      type: Object,
      required: true
    }
  },
  data () {
    return {
    }
  }
}
</script>

<style scoped lang="less">
.scroll-wrap {
  position: fixed;
  top: 92px;
  left: 0;
  right: 0;
  bottom: 88px;
  overflow-y: auto;
}

.reply-bottom {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 88px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #fff;
  border-top: 1px solid #d8d8d8;
  .write-btn {
    width: 60%;
  }
}
</style>
```



**父组件`article/index.vue`中监听关闭事件**





 





```html
<comment-reply
   :comment="currentComment"
   @close="isReplyShow = false"  
/>
```

1
2
3
4

![image-20210714223218110](https://hw-xiansheng.github.io/toutiao-notes/assets/img/image-20210714223218110.2989cd76.png)

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_4-6、展示评论回复列表)4.6、展示评论回复列表

基本思路：

- 回复列表和文章的评论列表几乎是一样的，所以我们复用`comment-list.vue`组件
- 修改 `comment-list.vue` 组件，因为既要让他满足文章列表要求又要满足评论列表要求

------

代码实现：

**1、修改`comment-list.vue`组件**

定义自定义属性`type`接收不同类型，判断是文章列表，还是评论列表，用于提供给接口



```js
props: {
    // 文章id或者评论id===> 此刻 接收的是评论id
    source: {
      type: [Number, String, Object],
      required: true
    },
    // 用于和父组件共享数据，实现添加评论列表更新，插入    
    list: {
      type: Array,
      default: () => []
    },
    // 【新增这个type】判断是文章还是评论    
    type: {
      type: String,
      // 自定义 Prop 数据验证
      validator (value) {
        return ['a', 'c'].includes(value)
      },
      default: 'a'
    }
}
```

```js
async onLoad(){
    // 很多代码...
    
    // 获取文章的评论和获取评论的回复是同一个接口
    // 唯一的区别是接口参数不一样
    //    type
    //      a 文章的评论
    //      c 评论的回复
    //    source
    //      文章的评论，则传递文章的 ID
    //      评论的回复，则传递评论的 ID
    // 1. 请求获取数据
    const { data } = await getComments({
        type: this.type, //  评论类型，a-对文章(article)的评论，c-对评论(comment)的回复
        source: this.source.toString(), // 源id，文章id或评论id  【文章id或者评论id都有可能存在大数字】
        offset: this.offset, // 获取评论数据的偏移量，值为评论id，表示从此id的数据向后取，不传表示从第一页开始读取数据
        limit: this.limit // 获取的评论数据个数，不传表示采用后端服务设定的默认每页数据量
    })
    
    // 很多代码...
}
```

**2、在`comment-reply.vue`中导入`comment-list.vue`，注册，使用**

```js
import CommentList from './comment-list'
```

```js
components: {
    // 其他注册...
    CommentList
}
```

```html
<!-- 评论的回复列表 -->
<comment-list
   :source="comment.com_id"
   type="c"
/>
<!-- /评论的回复列表 -->
```

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_4-7、回复列表数据重复数据问题)4.7、回复列表数据重复数据问题

**原因：** `van-list` 组件有个特点，就是只有在可视范围内才会自动调用`load`事件，所以我们之前文章内容过长，就不会触发请求文章评论列表，故而 我们手动在`created`里面调用了`onLoad`方法，但是现在我们这里的回复列表一开始就在可是范围内，故而会触发2次请求，1次是可视范围内自动触发，1次是我们主动调用触发。所以我们要关闭 自动检测可视范围自动调用。

**实现：**

- 给`van-list`组件设置`immediate-check` 属性，关闭可视范围自动调用检测

```html
  <!--
    只有 List 在可视范围内才会检查滚动位置触发 onLoad
   -->
  <van-list
    v-model="loading"
    :finished="finished"
    finished-text="已显示全部评论"
    :error="error"
    error-text="加载失败，请点击重试"
    :immediate-check="false" 
    @load="onLoad"
  >
```

- 关闭了自动检测，需要在`created` 里面开启加载状态，和主动调用加载数据

```js
  created () {
    // 当你手动初始 onLoad 的话，它不会自动开始初始的 loading
    // 所以我们要手动的开启初始 loading
    this.loading = true
    this.onLoad()
  }
```

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_4-8、回复列表内容不更新问题)4.8、回复列表内容不更新问题

弹层组件：

- 如果初始的条件是 false，则弹层的内容不会渲染
- 程序运行期间，当条件变为 true 的时候，弹层才渲染了内容
- 之后切换弹层的展示，弹层只是通过 CSS 控制隐藏和显示

**原因：** 弹层渲染出来以后就只是简单的切换显示和隐藏，里面的内容也不再重新渲染了，所以会导致我们的评论的回复列表不会动态更新了。解决办法就是在每次弹层显示的时候重新渲染组件。

```html
<!-- 评论回复 -->
<!--
弹出层是懒渲染的：只有在第一次展示的时候才会渲染里面的内容，之后它的关闭和显示都是在切换内容的显示和隐藏
-->
<van-popup v-model="isReplyShow"position="bottom"  style="height: 100%;">
    <!--
            v-if 条件渲染
            true：渲染元素节点
            false：不渲染
	-->
    <comment-reply
        v-if="isReplyShow"   
        :comment="currentComment"
        @close="isReplyShow = false"
     />
</van-popup>
<!-- /评论回复 -->
```

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_4-9、发布回复)4.9、发布回复

**1、处理底部视图 `comment-reply.vue`**

- 绘制回复按钮和回复弹框

  ```js
  data () {
      return {
          isPostShow: false  // 弹框是否显示
      }
  }
  ```

  ```html
  <!-- 底部区域 -->
  <div class="reply-bottom">
      <van-button
          class="write-btn"
          size="small"
          round
          @click="isPostShow = true"        
      >写评论</van-button>
  </div>
  <!-- /底部区域 -->
  
  <!-- 发布评论 -->
  <van-popup v-model="isPostShow" position="bottom">
     评论回复评论回复
  </van-popup>
  <!-- /发布评论 -->
  ```
  
- 整理评论项和回复列表，用容器包裹

  ```html
  <div class="scroll-wrap">
      <!-- 当前评论项 -->
      <!-- /当前评论项 -->
  
      <!-- 评论的回复列表 -->
      <!-- /评论的回复列表 -->
  </div>
  ```

- 样式

  ```less
  <style scoped lang="less">
  .scroll-wrap {
    position: fixed;
    top: 92px;
    left: 0;
    right: 0;
    bottom: 88px;
    overflow-y: auto;
  }
  
  .reply-bottom {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 88px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #fff;
    border-top: 1px solid #d8d8d8;
    .write-btn {
      width: 60%;
    }
  }
  </style>
  ```


**2、参数处理**

- 在`comment-reply.vue`导入`comment-post.vue` 组件

```js
import CommentPost from './comment-post'
```

```js
components: {
    // 其他注册...
    CommentPost
}
```

```html
<!-- 发布评论 -->
<van-popup v-model="isPostShow" position="bottom">
    <comment-post 
         :target="comment.com_id"/>
</van-popup>
<!-- /发布评论 -->
```

- 梳理 评论回复接口的时候我们发现`comment-post.vue`不仅需要评论id，还需要文章的对应id，这个时候 我们父组件`comment-reply.vue`并没有， 而 `article/index.vue` 组件是有的，这个时候就需要有一个祖先后代通信过程（不选择多层父子的原因是因为比较复杂）

  

  **祖先后代通信**

  `article/index.vue` 提供数据

  ```js
  // 给所有的后代组件提供数据
  // 注意：不要滥用
  provide: function () {
      return {
          articleId: this.articleId  // 或者写成 this.$route.params.articleId  也可以
      }
  }
  ```

  `comment-post.vue` 注入数据
  
  ```js
  // inject:['articleId']
  inject: {
      articleId: {
          type: [Number, String, Object],
          default: null
      }
  }
  ```
  
  改造发送请求方法

~~~js
const { data } = await addComment({
      target: this.target.toString(), // 评论的目标id（评论文章即为文章id，对评论进行回复则为评论id）
      content: this.message, // 评论内容
      // art_id: this.articleId.toString()
      art_id: this.articleId ? this.articleId.toString() : this.articleId // 文章id，对评论内容发表回复时，需要传递此参数，表明所属文章id。对文章进行评论，不要传此参数。
})
~~~



注意： 对`target` 和 `articleId` 都要进行`toString` 处理。

------

此刻发现请求可以发送了，实现了复用了comment-post.vue组件，但是有同学已经发现， 其实有问题，就是comment-post.vue 在作为文章评论的时候是充当article/index.vue 的子组件的，同样也接收到了 articleId,且也发送出去了，也就是在对文章进行评论的时候我们也提交了art_id ，这样如果后台严格的话是不行的，所以要优化

![image-20210717231805872](https://hw-xiansheng.github.io/toutiao-notes/assets/img/image-20210717231805872.75a44725.png)

所以要在`comment-post.vue`里面进行判断，如果是充当 评论回复的时候则 使用 `articleId`，否则不使用。

```js
props: {
    // 目标ID（文章ID或评论ID）
    target: {
        type: [Number, String, Object],
        required: true
    },
    // 增加一个type，进行判断，如果是a则说明是文章回复，不需要使用inject注入的数据， 不是a则使用。   
    type: {
      type: String,
      // 自定义 Prop 数据验证
      validator (value) {
        return ['a', 'c'].includes(value)
      },
      default: 'a'
    }  
}
```

```js
const { data } = await addComment({
    target: this.target.toString(), // 评论的目标id（评论文章即为文章id，对评论进行回复则为评论id）
    content: this.message, // 评论内容
    art_id: this.type === 'a'  ? null : this.articleId.toString() 
})
```

在`comment-reply.vue`中传递一下`type`

```html
<!-- 发布评论 -->
<van-popup v-model="isPostShow" position="bottom">
    <comment-post 
          type="c"        
         :target="comment.com_id"/>
</van-popup>
<!-- /发布评论 -->
```

**3、回复成功操作**

`comment-post.vue` 回复成功会触发`post-success`，所以只需要在`comment-reply.vue`中监听即可

```html
<!-- 发布评论 -->
<van-popup v-model="isPostShow" position="bottom">
    <comment-post
         type="c"    
        :target="comment.com_id"
        @post-success="onPostSuccess"
    />
</van-popup>
<!-- /发布评论 -->
```

`data` 里面定义变量`commentList` ， 实现`comment-list.vue` 和 `comment-post.vue` 和 `comment-reply.vue` 三者共享数据

```js
data () {
    return {
        isPostShow: false,
        commentList: [] // 评论的回复列表  
    }
}
```

`methods` 定义方法

```js
methods: {
	onPostSuccess (data) {
        // 更新回复的数量
        this.comment.reply_count++

        // 关闭弹层
        this.isPostShow = false

        // 将最新回复的内容展示到列表的顶部
        this.commentList.unshift(data.new_obj)
    }
}
```

```html
<!-- 评论的回复列表 -->
<comment-list
   :source="comment.com_id"
   type="c"
   :list="commentList"
/>
<!-- /评论的回复列表 -->
```

------

**数据流图**

![image-20210717234635092](https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/image-20210717234635092.5d8ba997.png)

### [#](https://hw-xiansheng.github.io/toutiao-notes/guide/08-文章评论.html#_4-10、评论回复总结)4.10、评论回复总结

![image-20210717235958419](https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/uPic/image-20210717235958419.e157b3ee.png)

