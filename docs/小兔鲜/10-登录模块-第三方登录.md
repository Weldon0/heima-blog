# ğŸ“š 10. ç¬¬ä¸‰æ–¹ç™»å½•

##  ç™»å½•ç®€è¦æµç¨‹æ¢³ç†

`æœ¬èŠ‚ç›®æ ‡:` æŒæ¡ç¬¬ä¸‰æ–¹ç™»å½•çš„å®ç°æµç¨‹

![image-20220226162639253](https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/2022/05/31/image20220226162639253.png)

1. åœ¨ç™»å½•é¡µé¢ï¼ŒQQç™»å½•æŒ‰é’®å¤„ï¼Œèµ‹äºˆå…¶æ‰“å¼€QQç™»å½•é¡µé¢åŠŸèƒ½
2. å›è·³çš„é¡µé¢å¾—åˆ°QQç»™çš„å”¯ä¸€æ ‡è¯† openIdï¼Œæ ¹æ®openIdå»åå°æŸ¥è¯¢æ˜¯å¦å·²ç»ç»‘å®šè¿‡è´¦æˆ·
   - å¦‚æœç»‘å®šè¿‡ï¼Œå®Œæˆç™»å½•
   - æ²¡æœ‰ç»‘å®šè¿‡
     - æœ‰è´¦å·çš„ï¼Œç»‘å®šæ‰‹æœºå·ï¼Œå³ä¸ºç™»å½•
     - æ²¡è´¦å·çš„ï¼Œå®Œå–„è´¦æˆ·ä¿¡æ¯ï¼Œå³ä¸ºç™»å½•
3. ç™»å½•æˆåŠŸåï¼Œè·³è½¬é¦–é¡µï¼Œæˆ–è€…æ¥æºé¡µé¢



## å‰ç½®å·¥ä½œå‡†å¤‡ - äº†è§£

1ï¼‰å‚è€ƒæ–‡æ¡£

1. [å‡†å¤‡å·¥ä½œ(opens new window)](https://wiki.connect.qq.com/%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C_oauth2-0)
2. [QQäº’è”JS_SDK(opens new window)](https://wiki.connect.qq.com/js_sdk%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E#3..E8.87.AA.E5.AE.9A.E4.B9.89.E7.99.BB.E5.BD.95.E6.8C.89.E9.92.AE)

2ï¼‰å¤§æ¦‚æ­¥éª¤

1. å‡†å¤‡ä¸€ä¸ªå·²ç»**å¤‡æ¡ˆ**çš„ç½‘ç«™éœ€è¦æœ‰QQç™»å½•çš„é€»è¾‘ï¼ˆç™»å½•é¡µé¢ï¼Œå›è·³é¡µé¢ï¼‰
2. ç„¶ååœ¨QQäº’è”ä¸Šè¿›è¡Œ`èº«ä»½è®¤è¯`ï¼Œå¹¶ä¸”`å®¡æ ¸é€šè¿‡`
3. åœ¨QQäº’è”ä¸Šåˆ›å»ºåº”ç”¨ï¼Œåº”ç”¨éœ€è¦åŸŸåï¼Œå¤‡æ¡ˆå·ï¼Œå›è°ƒåœ°å€ç­‰
4. ç­‰å¾…äººå·¥å®¡æ ¸ï¼Œå®¡æ ¸é€šè¿‡ä¼šå¾—åˆ°`åº”ç”¨ID` `åº”ç”¨key` `å›è°ƒåœ°å€`
5. å¸®å¤§å®¶ç”³è¯·çš„ç»“æœå¦‚ä¸‹ï¼š

```
# æµ‹è¯•ç”¨ appid 
# 100556005
# æµ‹è¯•ç”¨ redirect_uri
# http://www.corho.com:8080/#/login/callback
```

å¸¸è§ç–‘é—®â“

1. è¿™ä¸ªç”³è¯·å·¥ä½œä¸€èˆ¬ç”±è°å»åšï¼Ÿ

   - å…¬å¸çš„è¿ç»´ ï¼ˆè´Ÿè´£ç®¡ç†å…¬å¸è´¦å·çš„äººï¼‰ã€‚

2. ç”³è¯·ä¸‹æ¥çš„ idï¼Œåº”ç”¨ keyï¼Œå›è°ƒåœ°å€ uri èƒ½æ”¹å—ï¼Ÿ

   1. éƒ½ä¸èƒ½ä¿®æ”¹ï¼Œå¦åˆ™æ— æ•ˆã€‚
   2. ğŸ› å›è°ƒåœ°å€ uri çš„åŒ…å«**å››éƒ¨åˆ†**ï¼š 1. åŸŸåï¼Œ2. ç«¯å£å· 3. å“ˆå¸Œè·¯ç”±æ¨¡å¼ 4. è·¯ç”±åœ°å€ **éƒ½å¿…é¡»å®Œå…¨ä¸€è‡´**ï¼Œå¦åˆ™ä¸èƒ½å±•ç¤ºã€‚

3. ğŸš¨å›è°ƒ uri æ‰“å¼€çœ‹ä¸åˆ°å†…å®¹ï¼Ÿ

   http://www.corho.com:8080/#/login/callback

   1. ä¿®æ”¹ `vite.config.ts` é…ç½®ã€‚
   2. ä¿®æ”¹ç”µè„‘çš„ `host` æ–‡ä»¶ï¼Œè®¿é—®æœ¬åœ°æœåŠ¡å™¨ã€‚
   3. é…ç½® `VueRouter`è·¯ç”± å’Œ `vue` ç»„ä»¶ã€‚

##  ç”µè„‘ç¯å¢ƒè®¾ç½®

> ç›®æ ‡ï¼šæµè§ˆå™¨è®¿é—® [http://www.corho.com:8080/#/login/callback](http://www.corho.com:8080/#/login/callback) åœ°å€ï¼Œèƒ½æ‰“å¼€æ­£åœ¨å¼€å‘çš„ Vue é¡¹ç›®ã€‚

 æ ¸å¿ƒæ­¥éª¤

1. é…ç½® `VueRouter` å’Œ `vue` ç»„ä»¶ã€‚
2. ä¿®æ”¹ `vite.config.ts` é…ç½®ã€‚
3. ä¿®æ”¹ç”µè„‘çš„ `host` æ–‡ä»¶ã€‚

ï¼ˆ1ï¼‰ä¿®æ”¹ `vite.config.ts` é…ç½®ã€‚

```typescript
export default defineConfig({
  // é…ç½®å¼€å‘æœåŠ¡å™¨
  server: {
    // QQä¸‰æ–¹ç™»å½•çš„å›è°ƒuriä¸ºï¼šhttp://www.corho.com:8080/#/login/callback
    // vite ä¸­é…ç½®ï¼š www.corho.com:8080
    host: "www.corho.com",
    port: 8080,
    // å…¶ä»–æœ‰ä»·å€¼çš„é…ç½®é¡¹
    open: true, // å¸®æˆ‘ä»¬æ‰“å¼€æµè§ˆå™¨
    cors: true, // å…è®¸å¼€å‘æ—¶ ajax è·¨åŸŸ
  },
  ...
});
```

ï¼ˆ2ï¼‰ä¿®æ”¹`host`æ–‡ä»¶

windows ç³»ç»Ÿ

æé†’ï¼šä¿®æ”¹ç”µè„‘é…ç½®ï¼Œéœ€è¦å…ˆé€€å‡º 360 æˆ– å„ç§ç®¡å®¶ å„ç§ æ€æ¯’è½¯ä»¶

æé†’ï¼šå¦‚æœä¿®æ”¹ hosts æ–‡ä»¶æœ‰å¼¹çª—è­¦å‘Šï¼Œç‚¹å‡»ä¿¡ä»»ï¼ˆå› ä¸ºè¿™æ˜¯æˆ‘ä»¬è‡ªå·±è¿›è¡Œçš„å®‰å…¨æ“ä½œï¼‰

```
1. æ‰¾åˆ° C:\Windows\System32\drivers\etc ä¸‹hostsæ–‡ä»¶
2. åœ¨æ–‡ä»¶ä¸­åŠ å…¥  127.0.0.1       www.corho.com
3. ä¿å­˜å³å¯
# å¦‚æœæç¤ºæ²¡æœ‰æƒé™
1. å°†hostsæ–‡ä»¶ç§»åˆ°æ¡Œé¢ï¼Œç„¶åè¿›è¡Œä¿®æ”¹ï¼Œç¡®è®¤ä¿å­˜ã€‚
2. å°†æ¡Œé¢hostsæ–‡ä»¶æ›¿æ¢cç›˜æ–‡ä»¶
```

mac OS ç³»ç»Ÿ

```
1. æ‰“å¼€å‘½ä»¤è¡Œçª—å£
2. è¾“å…¥ï¼šsudo vim /etc/hosts
3. æŒ‰ä¸‹ï¼ši é”®    						 (è¿›å…¥ç¼–è¾‘çŠ¶æ€ => åˆ©ç”¨å…‰æ ‡æŒªä½ç½®)
4. è¾“å…¥ï¼š127.0.0.1       www.corho.com     (æ”¹å®Œå¦‚ä½•ä¿å­˜? çœ‹ä¸‹ä¸€æ­¥)
5. æŒ‰ä¸‹ï¼šesc
6. æŒ‰ä¸‹ï¼šshift + :
7. è¾“å…¥ï¼šwq å›è½¦å³å¯
```

æ­¥éª¤éªŒè¯ï¼šæµè§ˆå™¨è®¿é—® [http://www.corho.com:8080/#/](http://www.corho.com:8080/#/) èƒ½çœ‹åˆ°è‡ªå·±å¼€å‘çš„ Vue3 é¡¹ç›®è¡¨ç¤ºç¬¬äºŒæ­¥é…ç½®æˆåŠŸã€‚

ï¼ˆ3ï¼‰é…ç½®è·¯ç”±å’Œç»„ä»¶

æ–°å»ºç»„ä»¶ï¼š`views/login/callback.vue`

```typescript
<script setup lang="ts" name="LoginCallback">
//
</script>

<template>
  <h1>callback-QQç™»å½•å›è·³é¡µé¢æµ‹è¯•</h1>
</template>
```

é…ç½®è·¯ç”±ï¼š

2ï¼‰ç»‘å®šè·¯ç”± (ä¸€çº§è·¯ç”±)

```typescript
{
  path: '/login/callback',
  component: () => import('@/views/login/callback.vue')
}
```

æ­¥éª¤éªŒè¯ï¼šhttp://www.corho.com:8080/#/login/callbackçœ‹åˆ°å›è°ƒé¡µé¢ç»„ä»¶ã€‚

## DNS è§£ææ¦‚å¿µ - äº†è§£

> ç”±äºæœ¬åœ°æˆ‘ä»¬çš„ç½‘ç«™æ˜¯è®¿é—®`http://localhost:8080`   =>  `http://127.0.0.1:8080`
>
> è€Œå›è°ƒåœ°å€çš„åŸŸåæ˜¯`http://www.corho.com:8080`ï¼Œä¿©ä¸ªåœ°å€ä¸ä¸€è‡´æ˜¯æ— æ³•è¿›è¡Œè·³è½¬çš„ï¼Œ
>
> éœ€è¦æˆ‘ä»¬ä¿®æ”¹æœ¬åœ°çš„ hosts æ–‡ä»¶ï¼Œè®©åŸŸåè®¿é—®æ—¶è§£æåˆ°æˆ‘ä»¬æœ¬åœ°çš„ipä¸Š
>
> DNS è§£æï¼šï¼ˆ**ç½‘ç»œä¸­ï¼ŒæœåŠ¡å™¨ä¸è®¤åŸŸåçš„ï¼Œè®¤çš„æ˜¯ ip**ï¼‰ [www.jd.com](https://gitee.com/link?target=http%3A%2F%2Fwww.jd.com)
>
> 1. ä½œç”¨æ˜¯å°†åŸŸååœ°å€è§£ææˆipåœ°å€
> 2. ä¼˜å…ˆçº§ å…ˆä»¥æœ¬åœ°çš„ hosts æ–‡ä»¶ä¸ºä¸» ç„¶åæ‰èµ°çº¿ä¸Šçš„dnsæœåŠ¡å™¨

DSNè§£æè¯´æ˜

DNSè§£æ: å°†åŸŸåè§£ææˆipåœ°å€çš„è¿‡ç¨‹ã€‚

æƒ³çœ‹ä¸€ä¸ªç½‘ç«™ [www.jd.com](https://gitee.com/link?target=http%3A%2F%2Fwww.jd.com) => ç”µè„‘ä¸çŸ¥é“ä»€ä¹ˆæ˜¯ [www.jd.comï¼Œéœ€è¦è¯¢é—®çš„](https://gitee.com/link?target=http%3A%2F%2Fwww.jd.com%EF%BC%8C%E9%9C%80%E8%A6%81%E8%AF%A2%E9%97%AE%E7%9A%84)

1. å…ˆé—®æœ¬åœ° hosts æ–‡ä»¶ï¼ˆä¸€èˆ¬ä¸æ”¹ï¼‰ å¦‚æœæœ¬åœ°é…ç½®äº† åŸŸå å’Œ åœ°å€çš„æ˜ å°„å…³ç³»ï¼Œä¼˜å…ˆä½¿ç”¨ hosts ä¸­çš„æ˜ å°„

   ```
   127.0.0.1           www.jd.com
   ```

2. å¦‚æœæœ¬åœ°hostsæ–‡ä»¶é‡Œé¢æ²¡é…ï¼ˆé»˜è®¤ä¸€èˆ¬éƒ½æ²¡é…ï¼‰æ¯”å¦‚ï¼šæ‰¾www.baidu.com

   ```
   ä¼šæ‰¾çº¿ä¸Šçš„ dns æœåŠ¡å™¨ï¼Œ dns æœåŠ¡å™¨å°±åƒä¸€ä¸ªå­—å…¸ï¼Œ å­—å…¸ä¸­è®°å½•å¤§é‡çš„ ç½‘ç«™åŸŸå å’Œ ç½‘ç«™ip çš„å¯¹åº”å…³ç³»

   dns æœåŠ¡å™¨
   112.80.248.75      www.baidu.com
   xxx.xx.xxx.xx      www.xxx.com
   ```

##  QQæˆæƒç™»å½•å®ç°

![image-20220226165952149](https://wuxiaohui-1254415986.cos.ap-nanjing.myqcloud.com/2022/05/31/image20220226165952149.png)

[QQäº’è”JS_SDK(opens new window)](https://wiki.connect.qq.com/js_sdk%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E#3..E8.87.AA.E5.AE.9A.E4.B9.89.E7.99.BB.E5.BD.95.E6.8C.89.E9.92.AE)

ï¼ˆ1ï¼‰åœ¨index.htmlä¸­æ·»åŠ 

```typescript
<script
  type="text/javascript"
  charset="utf-8"
  src="http://connect.qq.com/qc_jssdk.js"
  data-appid="100556005"
  data-redirecturi="http://www.corho.com:8080/#/login/callback"
></script>
```

ï¼ˆ2ï¼‰åœ¨ç»„ä»¶`src/views/login/components/login-form.vue`ä¸­æ·»åŠ ç™»å½•å›¾æ ‡

```vue
<a
  href="https://graph.qq.com/oauth2.0/authorize?client_id=100556005&amp;response_type=token&amp;scope=all&amp;redirect_uri=http%3A%2F%2Fwww.corho.com%3A8080%2F%23%2Flogin%2Fcallback"
  ><img
    src="https://qzonestyle.gtimg.cn/qzone/vas/opensns/res/img/Connect_logo_7.png"
    alt="QQç™»å½•"
    border="0"
/></a>
```

## QQç™»å½•-åŸºæœ¬ç»“æ„

ï¼ˆ1ï¼‰å‡†å¤‡ç»“æ„

```vue
<script lang="ts" setup name="LoginCallback">
import LoginHeader from './components/login-header.vue'
import LoginFooter from './components/login-footer.vue'
</script>

<template>
  <LoginHeader></LoginHeader>
  <section class="container">
    <nav class="tab">
      <a href="javascript:;">
        <i class="iconfont icon-bind" />
        <span>å·²æœ‰å°å…”é²œè´¦å·ï¼Œè¯·ç»‘å®šæ‰‹æœº</span>
      </a>
      <a href="javascript:;">
        <i class="iconfont icon-edit" />
        <span>æ²¡æœ‰å°å…”é²œè´¦å·ï¼Œè¯·å®Œå–„èµ„æ–™</span>
      </a>
    </nav>
    <div class="tab-content" v-if="true">ç»‘å®šæ‰‹æœº</div>
    <div class="tab-content" v-else>å®Œå–„èµ„æ–™</div>
  </section>
  <LoginFooter></LoginFooter>
</template>

<style scoped lang="less">
.container {
  padding: 25px 0;
}
.tab {
  background: #fff;
  height: 80px;
  padding-top: 40px;
  font-size: 18px;
  text-align: center;
  a {
    color: #666;
    display: inline-block;
    width: 350px;
    line-height: 40px;
    border-bottom: 2px solid #e4e4e4;
    i {
      font-size: 22px;
      vertical-align: middle;
    }
    span {
      vertical-align: middle;
      margin-left: 4px;
    }
    &.active {
      color: @xtxColor;
      border-color: @xtxColor;
    }
  }
}
.tab-content {
  min-height: 600px;
  background: #fff;
}
</style>
```

ï¼ˆ2ï¼‰åˆ‡æ¢æ•ˆæœ

```diff
<script lang="ts" setup name="LoginCallback">
import LoginHeader from './components/login-header.vue'
import LoginFooter from './components/login-footer.vue'
+import { ref } from 'vue'
+const hasAccount = ref(true)
</script>

<template>
  <LoginHeader></LoginHeader>
  <section class="container">
    <nav class="tab">
      <a
+        :class="{ active: hasAccount }"
        href="javascript:;"
+        @click="hasAccount = true"
      >
        <i class="iconfont icon-bind" />
        <span>å·²æœ‰å°å…”é²œè´¦å·ï¼Œè¯·ç»‘å®šæ‰‹æœº</span>
      </a>
      <a
+        :class="{ active: !hasAccount }"
        href="javascript:;"
+        @click="hasAccount = false"
      >
        <i class="iconfont icon-edit" />
        <span>æ²¡æœ‰å°å…”é²œè´¦å·ï¼Œè¯·å®Œå–„èµ„æ–™</span>
      </a>
    </nav>
+    <div class="tab-content" v-if="hasAccount">ç»‘å®šæ‰‹æœº</div>
+    <div class="tab-content" v-else>å®Œå–„èµ„æ–™</div>
  </section>
  <LoginFooter></LoginFooter>
</template>

```

## QQç™»å½•-åˆ›å»ºç»„ä»¶

##  QQç™»å½•-ç»„ä»¶åˆ›å»º

ï¼ˆ1ï¼‰`src/views/login/components/callback-bind.vue` ç»‘å®šæ‰‹æœº

```vue
<script name="CallbackBind" lang="ts" setup></script>
<template>
  <div class="xtx-form">
    <div class="user-info">
      <img
        src="http://qzapp.qlogo.cn/qzapp/101941968/57C7969540F9D3532451374AA127EE5B/50"
        alt=""
      />
      <p>Hiï¼ŒTom æ¬¢è¿æ¥å°å…”é²œï¼Œå®Œæˆç»‘å®šåå¯ä»¥QQè´¦å·ä¸€é”®ç™»å½•å“¦~</p>
    </div>
    <div class="xtx-form-item">
      <div class="field">
        <i class="icon iconfont icon-phone"></i>
        <input class="input" type="text" placeholder="ç»‘å®šçš„æ‰‹æœºå·" />
      </div>
      <div class="error"></div>
    </div>
    <div class="xtx-form-item">
      <div class="field">
        <i class="icon iconfont icon-code"></i>
        <input class="input" type="text" placeholder="çŸ­ä¿¡éªŒè¯ç " />
        <span class="code">å‘é€éªŒè¯ç </span>
      </div>
      <div class="error"></div>
    </div>
    <a href="javascript:;" class="submit">ç«‹å³ç»‘å®š</a>
  </div>
</template>

<style scoped lang="less">
.user-info {
  width: 320px;
  height: 70px;
  margin: 0 auto;
  display: flex;
  background: #f2f2f2;
  align-items: center;
  padding: 0 10px;
  margin-bottom: 25px;
  img {
    background: #f2f2f2;
    width: 50px;
    height: 50px;
  }
  p {
    padding-left: 10px;
  }
}
.code {
  position: absolute;
  right: 0;
  top: 0;
  line-height: 50px;
  width: 80px;
  color: #999;
  &:hover {
    cursor: pointer;
  }
}
</style>
```

ï¼ˆ2ï¼‰`src/views/login/components/callback-patch.vue` å®Œå–„ä¿¡æ¯

```vue
<script lang="ts" setup name="CallbackPatch"></script>
<template>
  <div class="xtx-form">
    <div class="xtx-form-item">
      <div class="field">
        <i class="icon iconfont icon-user"></i>
        <input class="input" type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" />
      </div>
      <div class="error"></div>
    </div>
    <div class="xtx-form-item">
      <div class="field">
        <i class="icon iconfont icon-phone"></i>
        <input class="input" type="text" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
      </div>
      <div class="error"></div>
    </div>
    <div class="xtx-form-item">
      <div class="field">
        <i class="icon iconfont icon-code"></i>
        <input class="input" type="text" placeholder="è¯·è¾“å…¥éªŒè¯ç " />
        <span class="code">å‘é€éªŒè¯ç </span>
      </div>
      <div class="error"></div>
    </div>
    <div class="xtx-form-item">
      <div class="field">
        <i class="icon iconfont icon-lock"></i>
        <input class="input" type="password" placeholder="è¯·è¾“å…¥å¯†ç " />
      </div>
      <div class="error"></div>
    </div>
    <div class="xtx-form-item">
      <div class="field">
        <i class="icon iconfont icon-lock"></i>
        <input class="input" type="password" placeholder="è¯·ç¡®è®¤å¯†ç " />
      </div>
      <div class="error"></div>
    </div>
    <a href="javascript:;" class="submit">ç«‹å³æäº¤</a>
  </div>
</template>

<style scoped lang="less">
.code {
  position: absolute;
  right: 0;
  top: 0;
  line-height: 50px;
  width: 80px;
  color: #999;
  &:hover {
    cursor: pointer;
  }
}
</style>
```

ï¼ˆ3ï¼‰æ¸²æŸ“ç»„ä»¶

```diff
<script lang="ts" setup name="LoginCallback">
import LoginHeader from './components/login-header.vue'
import LoginFooter from './components/login-footer.vue'
+import CallbackBind from './components/callback-bind.vue'
+import CallbackPatch from './components/callback-patch.vue'
import { ref } from 'vue'
const hasAccount = ref(true)
</script>

<template>
  <LoginHeader></LoginHeader>
  <section class="container">
    <nav class="tab">
      <a
        :class="{ active: hasAccount }"
        href="javascript:;"
        @click="hasAccount = true"
      >
        <i class="iconfont icon-bind" />
        <span>å·²æœ‰å°å…”é²œè´¦å·ï¼Œè¯·ç»‘å®šæ‰‹æœº</span>
      </a>
      <a
        :class="{ active: !hasAccount }"
        href="javascript:;"
        @click="hasAccount = false"
      >
        <i class="iconfont icon-edit" />
        <span>æ²¡æœ‰å°å…”é²œè´¦å·ï¼Œè¯·å®Œå–„èµ„æ–™</span>
      </a>
    </nav>
    <div class="tab-content" v-if="hasAccount">
+      <CallbackBind></CallbackBind>
    </div>
    <div class="tab-content" v-else>
+      <CallbackPatch></CallbackPatch>
    </div>
  </section>
  <LoginFooter></LoginFooter>
</template>
```

## QQç™»å½•-å·²ç»‘å®šè´¦å·

QQç™»å½•ä¹‹åä¼šæœ‰ä¸‰ç§æƒ…å†µéœ€è¦å¤„ç†

1. è¯¥QQè´¦å·å·²ç»ç»‘å®šè¿‡è´¦å·,ç›´æ¥è·³è½¬åˆ°é¦–é¡µ
2. è¯¥QQè´¦å·æ²¡æœ‰ç»‘å®šæœ‰è´¦å·
   1. æœ‰è´¦å·ï¼Œç›´æ¥ç»‘å®šQQå·
   2. æ²¡æœ‰è´¦å·ï¼Œå®Œå–„æ³¨å†Œä¿¡æ¯å¹¶ç»‘å®šQQå·

**å®ç°æ€è·¯**

1. å›è·³ç»„ä»¶åˆå§‹åŒ–çš„æ—¶å€™æ ¹æ®QQçš„æ¥å£è·å–openId
2. æ ¹æ®openIdå»è‡ªå·±åå°å°è¯•è¿›è¡Œç™»å½•
3. å¦‚æœæˆåŠŸï¼Œå°±ä»£è¡¨å·²æ³¨å†Œå·²ç»‘å®šï¼Œè®°å½•è¿”å›çš„ç”¨æˆ·ä¿¡æ¯ï¼Œè·³è½¬åˆ°é¦–é¡µæˆ–è€…æ¥æºé¡µé¢

js dkå…¬å¼€æ–¹æ³•

1. QC.Login.check() æ£€æŸ¥QQæ˜¯å¦å·²ç»ç™»å½• true
2. QC.Login.getMe() è·å–ç”¨æˆ·æ ‡è¯†openId å°†æ¥ä¼ ç»™userQQLoginä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°
3. QC.api("get_user_info") è·å–ç”¨æˆ·èµ„æ–™

ï¼ˆ1ï¼‰æ–°å¢QCçš„ç±»å‹å£°æ˜ åœ¨æ–‡ä»¶ä¸­ `env.d.ts`

ç›´æ¥ä½¿ç”¨QCåœ¨TSä¸­ä¼šæŠ¥é”™ï¼Œå› ä¸ºTSæ— æ³•è¯†åˆ«QCï¼Œä¸”QQç¬¬ä¸‰æ–¹ç™»å½•é»˜è®¤æ˜¯ä¸æ”¯æŒtsçš„ï¼Œéœ€è¦è‡ªå®šä¹‰å‘½åç©ºé—´æ¥å®ç°è¯¥æ•ˆæœã€‚

å¦‚ä½•è®©æˆ‘ä»¬çš„è´¦å·, ä¸€å¼€å§‹, å°±æ˜¯ç»‘å®šçš„ => è·‘æˆ‘çš„ä»£ç  => è¿›è¡Œç»‘å®šå³å¯

è§£ç»‘ => é€šè¿‡é“¾æ¥è§£ç»‘

```typescript
declare namespace QC {
  const Login: {
    /**
     * æ£€æŸ¥QQæ˜¯å¦ç™»å½•æˆåŠŸ
     */
    check: () => boolean
    /**
     * è·å–openId
     */
    getMe: (callback: (openId: string) => void) => void
  }
  const api: (api: 'get_user_info') => { success: (res: any) => void }
}
```

ï¼ˆ2ï¼‰ç¡®è®¤å½“å‰qqæ˜¯å¦ç™»å½•æˆåŠŸ

```typescript
// è·å–ç”¨æˆ·ä¿¡æ¯
const isLogin = QC.Login.check()
console.log(isLogin)
```

ï¼ˆ3ï¼‰è·å–openId

```typescript
// 1. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•
const isLogin = QC.Login.check()
// console.log(isLogin)
if (isLogin) {
  // 2. è·å–openId
  QC.Login.getMe((openId) => {
    console.log(openId)
  })
}
```

ï¼ˆ4ï¼‰å°è£…æ–¹æ³•ï¼Œä½¿ç”¨qqç™»å½•

```typescript
//  source: 1ä¸ºpcï¼Œ2ä¸ºwebappï¼Œ3ä¸ºå¾®ä¿¡å°ç¨‹åº, 4ä¸ºAndroid, 5ä¸ºios, 6ä¸ºqq, 7ä¸ºå¾®ä¿¡
async qqLogin(openId: string) {
  const res = await request.post<ApiRes<Profile>>('/login/social', {
    unionId: openId,
    source: 6
  })
  // 1. ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° state ä¸­
  this.profile = res.data.result
  setProfile(res.data.result)
},
```

ï¼ˆ5ï¼‰ç™»å½•æˆåŠŸ

```typescript
// 1. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•
const isLogin = QC.Login.check()
// console.log(isLogin)
if (isLogin) {
  // 2. è·å–openId
  QC.Login.getMe(async (openId) => {
    // 3. å‘é€è¯·æ±‚è¿›è¡ŒQQç™»å½•
    await user.qqLogin(openId)
    Message.success('ç™»å½•æˆåŠŸ')
    router.push('/')
  })
}
```

## QQç™»å½•-æœªç»‘å®š-æœ‰è´¦å·

å¦‚æœè´¦å·æ˜¯ç»‘å®šçš„çŠ¶æ€ï¼Œæ‰‹åŠ¨è°ƒç”¨ä¸€ä¸‹è§£ç»‘æ¥å£

http://pcapi-xiaotuxian-front.itheima.net/login/social/unbind?mobile=æ‰‹æœºå·

https://apipc-xiaotuxian-front.itheima.net/login/social/unbind?mobile=æ‰‹æœºå·

### è·å–QQå¤´åƒå’Œæ˜µç§°

> å¦‚æœQQæ²¡ç»‘å®šè¿‡è´¦å·ï¼Œéœ€è¦ç»‘å®šå·²å­˜åœ¨çš„è´¦å·æˆ–è€…æ³¨å†Œæ–°çš„è´¦å·

ï¼ˆ1ï¼‰è·å–qqä¿¡æ¯

```typescript
<script name="CallbackBind" lang="ts" setup>
import { QQUserInfo, QQUserInfoRes } from '@/types/user'
import { ref } from 'vue'
const qqInfo = ref<QQUserInfo>({} as QQUserInfo)
// 1. åˆ¤æ–­QQæ˜¯å¦ç™»å½•
if (QC.Login.check()) {
  // 2. è·å–QQç”¨æˆ·ä¿¡æ¯
  QC.api('get_user_info').success((res: QQUserInfoRes) => {
    console.log(res)
    qqInfo.value = res.data
  })
}
</script>
```

ï¼ˆ2ï¼‰æä¾›æ•°æ®ç±»å‹

```typescript
// QQä¿¡æ¯-ç”¨æˆ·è¯¦æƒ…
export interface QQUserInfo {
  ret: number
  msg: string
  is_lost: number
  nickname: string
  gender: string
  gender_type: number
  province: string
  city: string
  year: string
  constellation: string
  figureurl: string
  figureurl_1: string
  figureurl_2: string
  figureurl_qq_1: string
  figureurl_qq_2: string
  figureurl_qq: string
  figureurl_type: string
  is_yellow_vip: string
  vip: string
  yellow_vip_level: string
  level: string
  is_yellow_year_vip: string
}
// QQè¿”å›ä¿¡æ¯
export interface QQUserInfoRes {
  status: string
  fmt: string
  ret: number
  code: number
  data: QQUserInfo
  seq: string
  dataText: string
}
```

ï¼ˆ3ï¼‰æ¸²æŸ“QQä¿¡æ¯

```typescript
<div class="user-info">
  <img :src="qqInfo.figureurl_2" alt="" />
  <p>
    Hiï¼Œ{{ qqInfo.nickname }}
    æ¬¢è¿æ¥å°å…”é²œï¼Œå®Œæˆç»‘å®šåå¯ä»¥QQè´¦å·ä¸€é”®ç™»å½•å“¦~
  </p>
</div>
```

### è¡¨å•æ ¡éªŒ

ï¼ˆ1ï¼‰æå–æ ¡éªŒè§„åˆ™ `src/utils/validate.ts`

```typescript
export function accountRule(value: string) {
  // valueæ˜¯å°†æ¥ä½¿ç”¨è¯¥è§„åˆ™çš„è¡¨å•å…ƒç´ çš„å€¼
  // 1. å¿…å¡«
  // 2. 6-20ä¸ªå­—ç¬¦ï¼Œéœ€è¦ä»¥å­—æ¯å¼€å¤´
  // å¦‚ä½•åé¦ˆæ ¡éªŒæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œè¿”å›trueæ‰æ˜¯æˆåŠŸï¼Œå…¶ä»–æƒ…å†µå¤±è´¥ï¼Œè¿”å›å¤±è´¥åŸå› ã€‚
  if (!value) return 'è¯·è¾“å…¥ç”¨æˆ·å'
  if (!/^[a-zA-Z]\w{5,19}$/.test(value)) return 'å­—æ¯å¼€å¤´ä¸”6-20ä¸ªå­—ç¬¦'
  return true
}
export function passwordRule(value: string) {
  if (!value) return 'è¯·è¾“å…¥å¯†ç '
  if (!/^\w{6,24}$/.test(value)) return 'å¯†ç æ˜¯6-24ä¸ªå­—ç¬¦'
  return true
}
export function mobileRule(value: string) {
  if (!value) return 'è¯·è¾“å…¥æ‰‹æœºå·'
  if (!/^1[3-9]\d{9}$/.test(value)) return 'æ‰‹æœºå·æ ¼å¼é”™è¯¯'
  return true
}
export function codeRule(value: string) {
  if (!value) return 'è¯·è¾“å…¥éªŒè¯ç '
  if (!/^\d{6}$/.test(value)) return 'éªŒè¯ç æ˜¯6ä¸ªæ•°å­—'
  return true
}
export function isAgreeRule(value: string) {
  if (!value) return 'è¯·å‹¾é€‰åŒæ„ç”¨æˆ·åè®®'
  return true
}

```

ï¼ˆ2ï¼‰ä¿®æ”¹ç™»å½•åŠŸèƒ½

```typescript
import {
  accountRule,
  mobileRule,
  codeRule,
  passwordRule,
  isAgreeRule
} from '@/utils/validate'

useForm({
  validationSchema: {
    account: accountRule,
    mobile: mobileRule,
    code: codeRule,
    password: passwordRule,
    isAgree: isAgreeRule
  },
  initialValues: {
    mobile: '13666666666',
    code: '123456',
    account: 'xiaotuxian001',
    password: '123456',
    isAgree: true
  }
})
```

ï¼ˆ3ï¼‰åœ¨`callback-bind.vue`æ·»åŠ è¡¨å•æ ¡éªŒ

```typescript
// è¡¨å•æ ¡éªŒ
const { validate } = useForm({
  validationSchema: {
    mobile: mobileRule,
    code: codeRule
  }
})
const { value: mobile, errorMessage: mobileError } = useField('mobile')
const { value: code, errorMessage: codeError } = useField('code')


<div class="xtx-form-item">
  <div class="field">
    <i class="icon iconfont icon-phone"></i>
    <input
      class="input"
      v-model="mobile"
      type="text"
      placeholder="ç»‘å®šçš„æ‰‹æœºå·"
    />
  </div>
  <div class="error">{{ mobileError }}</div>
</div>
<div class="xtx-form-item">
  <div class="field">
    <i class="icon iconfont icon-code"></i>
    <input
      v-model="code"
      class="input"
      type="text"
      placeholder="çŸ­ä¿¡éªŒè¯ç "
    />
    <span class="code">å‘é€éªŒè¯ç </span>
  </div>
  <div class="error">{{ codeError }}</div>
</div>
```

ï¼ˆ4ï¼‰ç»‘å®šæ—¶å®Œæˆè¡¨å•æ ¡éªŒ

```typescript
<a href="javascript:;" class="submit" @click="bind">ç«‹å³ç»‘å®š</a>


const bind = async () => {
  const res = await validate()
  if (!res.valid) return
    // å¦‚æœæ ¡éªŒï¼Œå‘é€è¯·æ±‚è¿›è¡Œç»‘å®š
}
```

### å‘é€éªŒè¯ç 

ï¼ˆ1ï¼‰æä¾›actionsï¼Œç”¨äºè·å–çŸ­ä¿¡ç»‘å®šqq

```typescript
// ç»‘å®šqqçš„çŸ­ä¿¡éªŒè¯ç 
async sendQQBindMsg(mobile: string) {
  await request.get('/login/social/code', {
    params: {
      mobile
    }
  })
}
```

ï¼ˆ2ï¼‰ç‚¹å‡»è·å–çŸ­ä¿¡éªŒè¯ç æ—¶ï¼Œå‘é€è¯·æ±‚è·å–éªŒè¯ç 

```typescript
const { time, start } = useCountDown(10)
const send = async () => {
  if (time.value > 0) return
  const res = await validateMobile()
  console.log(res)
  if (!res.valid) return
  // å‘é€è¯·æ±‚ç»‘å®šqq
  await user.sendQQBindMsg(mobile.value)
  // å¼€å¯å€’è®¡æ—¶
  start()
}
```

ï¼ˆ3ï¼‰æ¸²æŸ“å€’è®¡æ—¶

```vue
<span class="code" @click="send">
  {{ time === 0 ? 'å‘é€éªŒè¯ç ' : `${time}såå‘é€` }}
</span>
```

### QQç»‘å®šå®Œæˆ

ï¼ˆ1ï¼‰æä¾›ç»‘å®šçš„actions

```typescript
async qqBindLogin(openId: string, mobile: string, code: string) {
  const res = await request.post<ApiRes<Profile>>('/login/social/bind', {
    mobile,
    code,
    unionId: openId
  })
  // 1. ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° state ä¸­
  this.profile = res.data.result
  setProfile(res.data.result)
},
```

ï¼ˆ2ï¼‰æ ¡éªŒåï¼Œå‘é€è¯·æ±‚ç»‘å®š

```typescript
// 1. åˆ¤æ–­QQæ˜¯å¦ç™»å½•
if (QC.Login.check()) {
  // 2. è·å–QQç”¨æˆ·ä¿¡æ¯
  QC.api('get_user_info').success((res: QQUserInfoRes) => {
    console.log(res)
    qqInfo.value = res.data
  })
  // 3. è·å–openId
  QC.Login.getMe((id) => {
    openId = id
  })
}

const bind = async () => {
  const res = await validForm()
  if (!res.valid) return
  // å¦‚æœæ ¡éªŒï¼Œå‘é€è¯·æ±‚è¿›è¡Œç»‘å®š
  await user.qqBindLogin(openId, mobile.value, code.value)
  Message.success('QQç»‘å®šæˆåŠŸ')
  router.push('/')
}
```

## QQç™»å½•-æœªç»‘å®š-æ— è´¦å·

ï¼ˆ1ï¼‰å¢åŠ æ ¡éªŒç±»å‹

```typescript
export function rePasswordRule(value: string, { form }: any) {
  if (!value) return 'è¯·è¾“å…¥ç¡®è®¤å¯†ç '
  if (!/^\w{6,24}$/.test(value)) return 'å¯†ç æ˜¯6-24ä¸ªå­—ç¬¦'
  // æ ¡éªŒå¯†ç æ˜¯å¦ä¸€è‡´  formè¡¨å•æ•°æ®å¯¹è±¡
  if (value !== form.password) return 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´'
  return true
}
```

ï¼ˆ2ï¼‰æä¾›ä¸¤ä¸ªactions

```typescript
async sendQQPathMsg(mobile: string) {
  await request.get('/register/code', {
    params: {
      mobile
    }
  })
},

async qqPatchLogin(data: any) {
  const res = await request.post<ApiRes<Profile>>(
    `/login/social/${data.openId}/complement`,
    data
  )
  // 1. ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° state ä¸­
  this.profile = res.data.result
  setProfile(res.data.result)
}
```

ï¼ˆ3ï¼‰å®Œæ•´ä»£ç 

```vue
<script lang="ts" setup name="CallbackPatch">
import {
  useField,
  useForm,
  useValidateForm,
  useValidateField
} from 'vee-validate'
import {
  accountRule,
  mobileRule,
  codeRule,
  passwordRule,
  rePasswordRule
} from '@/utils/validate'
import { useCountDown } from '@/utils/hooks'
import Message from '@/components/message'
import useStore from '@/store'
import { useRouter } from 'vue-router'
const { user } = useStore()
const router = useRouter()
// 1. è·å–openId
let openId = ''
// åˆ¤æ–­QQæ˜¯å¦ç™»å½•
if (QC.Login.check()) {
  // è·å–openId
  QC.Login.getMe((id) => {
    openId = id
  })
}

// è¡¨å•æ ¡éªŒ

useForm({
  validationSchema: {
    account: accountRule,
    mobile: mobileRule,
    code: codeRule,
    password: passwordRule,
    repassword: rePasswordRule
  }
})

const { errorMessage: accountError, value: account } =
  useField<string>('account')

const { errorMessage: passwordError, value: password } =
  useField<string>('password')
const { errorMessage: mobileError, value: mobile } = useField<string>('mobile')
const { errorMessage: codeError, value: code } = useField<string>('code')
const { errorMessage: repasswordError, value: repassword } =
  useField<string>('repassword')

const validForm = useValidateForm()
const bind = async () => {
  const res = await validForm()
  if (!res.valid) return
  await user.qqPatchLogin({
    openId,
    mobile: mobile.value,
    code: code.value,
    account: account.value,
    password: password.value
  })
  Message.success('æ³¨å†ŒæˆåŠŸ')
  router.push('/')
}

// è·å–éªŒè¯ç 
const validMobile = useValidateField('mobile')
const { time, start } = useCountDown(60)
const send = async () => {
  if (time.value > 0) return
  // console.log('è·å–éªŒè¯ç ')
  // å•ç‹¬æ ¡éªŒæ‰‹æœºå·
  const res = await validMobile()
  if (!res.valid) {
    return
  }
  await user.sendQQPathMsg(mobile.value)
  Message.success('è·å–éªŒè¯ç æˆåŠŸ')

  start()
}
</script>
<template>
  <div class="xtx-form">
    <div class="xtx-form-item">
      <div class="field">
        <i class="icon iconfont icon-user"></i>
        <input
          class="input"
          v-model="account"
          type="text"
          placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
        />
      </div>
      <div class="error">{{ accountError }}</div>
    </div>
    <div class="xtx-form-item">
      <div class="field">
        <i class="icon iconfont icon-phone"></i>
        <input
          class="input"
          v-model="mobile"
          type="text"
          placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
        />
      </div>
      <div class="error">{{ mobileError }}</div>
    </div>
    <div class="xtx-form-item">
      <div class="field">
        <i class="icon iconfont icon-code"></i>
        <input
          class="input"
          v-model="code"
          type="text"
          placeholder="è¯·è¾“å…¥éªŒè¯ç "
        />
        <span class="code" @click="send">{{
          time === 0 ? 'å‘é€éªŒè¯ç ' : `${time}såå‘é€`
        }}</span>
      </div>
      <div class="error">{{ codeError }}</div>
    </div>
    <div class="xtx-form-item">
      <div class="field">
        <i class="icon iconfont icon-lock"></i>
        <input
          class="input"
          v-model="password"
          type="password"
          placeholder="è¯·è¾“å…¥å¯†ç "
        />
      </div>
      <div class="error">{{ passwordError }}</div>
    </div>
    <div class="xtx-form-item">
      <div class="field">
        <i class="icon iconfont icon-lock"></i>
        <input
          class="input"
          v-model="repassword"
          type="password"
          placeholder="è¯·ç¡®è®¤å¯†ç "
        />
      </div>
      <div class="error">{{ repasswordError }}</div>
    </div>
    <a href="javascript:;" class="submit" @click="bind">ç«‹å³æäº¤</a>
  </div>
</template>

<style scoped lang="less">
.code {
  position: absolute;
  right: 0;
  top: 0;
  line-height: 50px;
  width: 80px;
  color: #999;
  &:hover {
    cursor: pointer;
  }
}
</style>

```

